# .github/workflows/manual-release.yml
name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (must be higher and end with .0, e.g. 25.12.0)'
        required: true

jobs:
  build-vscode:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ github.event.inputs.version }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          npm install -g @vscode/vsce semver

      - name: Install dependencies
        working-directory: bbj-vscode
        run: npm ci

      - name: Validate version input
        working-directory: bbj-vscode
        env:
          VERSION_INPUT: ${{ github.event.inputs.version }}
        run: |
          VERSION="$VERSION_INPUT"
          echo "Target version: $VERSION"

          CURRENT=$(jq -r .version package.json)
          echo "Current version in package.json: $CURRENT"

          # Must be in x.y.0 format
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0]+$ ]]; then
            echo "❌ Error: Version must be in format x.y.0, e.g. 25.12.0"
            exit 1
          fi

          # Ensure new version is greater
          if npx semver "$VERSION" -r ">$CURRENT"; then
            echo "✅ Version $VERSION is valid and greater than $CURRENT"
          else
            echo "❌ Error: Version $VERSION is not greater than current version $CURRENT"
            exit 1
          fi

      - name: Set package.json version
        working-directory: bbj-vscode
        env:
          VERSION_INPUT: ${{ github.event.inputs.version }}
        run: |
          VERSION="$VERSION_INPUT"
          jq ".version = \"$VERSION\"" package.json > tmp && mv tmp package.json

      - name: Commit and tag version
        working-directory: bbj-vscode
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION_INPUT: ${{ github.event.inputs.version }}
        run: |
          VERSION="$VERSION_INPUT"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add package.json
          git commit -m "Release version $VERSION"
          git tag "v$VERSION"
          git push origin main
          git push origin "v$VERSION"

      - name: Package and publish to VS Code Marketplace
        working-directory: bbj-vscode
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          npx vsce package
          npx vsce publish -p $VSCE_PAT

      - name: Upload language server
        uses: actions/upload-artifact@v4
        with:
          name: language-server
          path: bbj-vscode/out/language/main.cjs
          retention-days: 1

      - name: Upload VS Code extension
        uses: actions/upload-artifact@v4
        with:
          name: vscode-extension
          path: bbj-vscode/*.vsix
          retention-days: 1

  build-intellij:
    runs-on: ubuntu-latest
    needs: build-vscode

    steps:
      - uses: actions/checkout@v4

      - name: Download language server
        uses: actions/download-artifact@v4
        with:
          name: language-server
          path: bbj-vscode/out/language/

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build IntelliJ plugin
        working-directory: bbj-intellij
        run: ./gradlew buildPlugin -Pversion=${{ needs.build-vscode.outputs.version }}

      - name: Verify plugin compatibility
        working-directory: bbj-intellij
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./gradlew verifyPlugin

      - name: Publish to JetBrains Marketplace
        working-directory: bbj-intellij
        run: ./gradlew publishPlugin -PintellijPlatformPublishingToken=${{ secrets.JETBRAINS_MARKETPLACE_TOKEN }}

      - name: Upload IntelliJ plugin
        uses: actions/upload-artifact@v4
        with:
          name: intellij-plugin
          path: bbj-intellij/build/distributions/bbj-intellij-*.zip
          retention-days: 1

  create-release:
    runs-on: ubuntu-latest
    needs: [build-vscode, build-intellij]
    permissions:
      contents: write

    steps:
      - name: Download VS Code extension
        uses: actions/download-artifact@v4
        with:
          name: vscode-extension
          path: ./artifacts

      - name: Download IntelliJ plugin
        uses: actions/download-artifact@v4
        with:
          name: intellij-plugin
          path: ./artifacts

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.build-vscode.outputs.version }}
        run: |
          gh release create "v$VERSION" \
            --title "v$VERSION" \
            --generate-notes \
            --notes "## Installation

          ### VS Code
          Install from [VS Code Marketplace](https://marketplace.visualstudio.com/items?itemName=basis-intl.bbj-lang) or download the \`.vsix\` file below and install via **Extensions > ... > Install from VSIX...**

          ### IntelliJ IDEA
          Install from [JetBrains Marketplace](https://plugins.jetbrains.com/plugin/30033-bbj-language-support) (may take a few days for review) or download \`bbj-intellij-$VERSION.zip\` from the Assets below and install via **Settings > Plugins > ⚙ > Install Plugin from Disk...**

          ---
          " \
            ./artifacts/*.vsix \
            ./artifacts/*.zip
