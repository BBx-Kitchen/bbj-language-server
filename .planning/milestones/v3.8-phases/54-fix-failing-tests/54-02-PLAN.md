---
phase: 54-fix-failing-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/language/bbj-scope-local.ts
  - bbj-vscode/test/completion-test.test.ts
  - bbj-vscode/src/language/bbj-validator.ts
  - bbj-vscode/test/imports.test.ts
autonomous: true
requirements:
  - TEST-03
  - TEST-04

must_haves:
  truths:
    - "DEF FN parameters with $ suffix complete correctly inside class methods"
    - "USE referencing a file with no classes produces a file-path error diagnostic"
  artifacts:
    - path: "bbj-vscode/src/language/bbj-scope-local.ts"
      provides: "Scope computation that makes DEF FN parameters visible inside class method contexts"
    - path: "bbj-vscode/src/language/bbj-validator.ts"
      provides: "USE validation that checks file contains BbjClass nodes, not just document existence"
  key_links:
    - from: "bbj-vscode/test/completion-test.test.ts"
      to: "bbj-vscode/src/language/bbj-scope-local.ts"
      via: "Completion items derive from local scope computation"
      pattern: "processNode.*isDefFunction"
    - from: "bbj-vscode/test/imports.test.ts"
      to: "bbj-vscode/src/language/bbj-validator.ts"
      via: "USE validation produces file-path error diagnostics"
      pattern: "checkUsedClassExists"
---

<objective>
Fix two source-level bugs exposed by failing tests: (1) DEF FN parameters with `$` suffix not completing inside class methods, and (2) USE referencing a file with no classes not producing a warning diagnostic.

Purpose: TEST-03 reveals a scope chain issue where DEF FN params are invisible inside class methods. TEST-04 reveals missing validation — a USE can reference a parseable file that contains no BbjClass nodes, but no diagnostic is produced.

Output: Both TEST-03 and TEST-04 pass. If either fix proves disproportionately complex, fall back to `.skip` with a clear reason comment (per user decision).
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-fix-failing-tests/54-CONTEXT.md
@bbj-vscode/src/language/bbj-scope-local.ts
@bbj-vscode/src/language/bbj-completion-provider.ts
@bbj-vscode/src/language/bbj-validator.ts
@bbj-vscode/test/completion-test.test.ts
@bbj-vscode/test/imports.test.ts
@bbj-vscode/test/bbj-test-module.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix DEF FN parameter completion inside class methods (TEST-03)</name>
  <files>bbj-vscode/src/language/bbj-scope-local.ts, bbj-vscode/test/completion-test.test.ts</files>
  <action>
**Problem:** The test "DEF FN parameters with $ suffix inside class method" fails. The completion provider returns 0 items matching `_f$` or `_t$` when the cursor is inside a DEF FN body that is nested inside a class method.

**Root cause investigation:**
The scope computation in `bbj-scope-local.ts` `processNode()` (around line 128-142) adds DEF FN parameters to the DEF FN node's own scope. When the completion provider resolves scope for a node inside the DEF FN body, it should walk up the container chain (DEF FN -> MethodDecl -> BbjClass -> Program) and collect scopes at each level.

The issue is likely one of:
1. The scope chain traversal skips the DefFunction scope when inside a class method
2. The DEF FN parameters are being added under the wrong scope key when nested in a method

**Fix approach:**
1. First, add debug logging inside `processNode` for isDefFunction to confirm parameters are being added.
2. Run the failing test in isolation with logging to see what scopes exist.
3. Check if the Langium ScopeProvider's `getScope()` properly chains through DefFunction when nested in MethodDecl.

**Likely fix location:** `bbj-scope-local.ts` `processNode()` method. The `this.addToScope(scopes, node, description)` call adds the param to the DefFunction's scope. But when completion requests scope at a cursor position inside the DEF FN body, Langium's default scope provider may not include the DefFunction level if the DefFunction is not the direct container of the completion node (e.g., the PRINT statement's context may resolve to the MethodDecl, not the DefFunction).

**If fix is straightforward:** Modify `processNode` to additionally add DEF FN parameters to a scope that the completion resolution can find. The existing code adds params to `node` (DefFunction). If the completion cursor resolves to a different container, the scope won't include them. Consider also adding the params to the DefFunction's own internal statement scope if there's a mismatch.

**If fix is disproportionately complex (per user decision):** Mark the test as `.skip` with comment:
```typescript
test.skip('DEF FN parameters with $ suffix inside class method', async () => {
    // SKIP: DEF FN parameter scope not resolved inside class methods due to
    // Langium scope chain traversal not including DefFunction when nested in MethodDecl.
    // Tracked for future fix — works correctly at program scope level.
```

**Investigation checklist:**
- Check what `node.$container` chain looks like for the PRINT statement inside DEF FN inside method
- Check if `BbjScopeProvider.getScope()` or `DefaultScopeProvider.getScope()` properly walks the container chain through DefFunction
- Check if completion provider's `createReferenceCompletionItem` or scope resolution uses a different path than validation scope
- Look at how the other DEF FN tests pass (program-level, single-line) vs fail (class method) to identify the difference
  </action>
  <verify>Run `cd bbj-vscode && npx vitest run test/completion-test.test.ts` — "DEF FN parameters with $ suffix inside class method" passes (or is `.skip`ped with reason if fix was too complex).</verify>
  <done>TEST-03 is resolved: either the completion works correctly inside class methods, or the test is `.skip`ped with a clear documented reason.</done>
</task>

<task type="auto">
  <name>Task 2: Add USE validation for files with no BbjClass nodes (TEST-04)</name>
  <files>bbj-vscode/src/language/bbj-validator.ts, bbj-vscode/test/imports.test.ts</files>
  <action>
**Problem:** The test "USE referencing file with no classes (e.g., binary) shows file-path error" fails. The test pre-parses a "binary-like" file (`<<bbj>>`) that has no BbjClass nodes, then uses `use ::BinaryFile/BinaryFile.bbj::SomeClass`. The test expects a file-path error diagnostic, but gets 0 errors.

**Root cause:** In `bbj-validator.ts` `checkUsedClassExists()` (line 285-326), the validation for `use.bbjFilePath` only checks if a document exists at the candidate URI (`this.langiumDocuments.hasDocument(uri)`). If the document exists but contains no BbjClass nodes, no error is emitted. The test expects a diagnostic starting with `"File '"` (`USE_FILE_NOT_RESOLVED_PREFIX`).

**Fix:** After the existing "file not found" check, add a second check: if the file IS found but contains no BbjClass nodes in the index, emit a **warning** (not error — per user decision, because the file might not be fully parsed yet).

In `bbj-validator.ts`, inside `checkUsedClassExists()`, after the `if (!resolved)` block (around line 323), add:

```typescript
if (resolved) {
    // File exists but check if it actually contains any BBj classes
    const resolvedUri = adjustedFileUris.find(uri =>
        this.langiumDocuments.hasDocument(uri)
    );
    if (resolvedUri) {
        const resolvedDoc = this.langiumDocuments.getDocument(resolvedUri);
        if (resolvedDoc) {
            const hasClasses = AstUtils.streamAllContents(resolvedDoc.parseResult.value)
                .some(isBbjClass);
            if (!hasClasses) {
                accept('warning', `${USE_FILE_NOT_RESOLVED_PREFIX}${cleanPath}' could not be resolved. The file exists but contains no BBj classes.`, {
                    node: use,
                    property: 'bbjFilePath'
                });
            }
        }
    }
}
```

**Important:** The warning message MUST start with `USE_FILE_NOT_RESOLVED_PREFIX` (`"File '"`) and contain `"could not be resolved"` to match the test expectations at imports.test.ts:232-235.

**Also update the test assertion:** The test currently filters for `d.severity === 1` (Error). Since the user decided on Warning, update the test to filter for `d.severity === 2` (Warning):
```typescript
// Change from:
const filePathErrors = document.diagnostics?.filter(d =>
    d.severity === 1 && d.message.startsWith("File '")
) ?? [];
// Change to:
const filePathErrors = document.diagnostics?.filter(d =>
    (d.severity === 1 || d.severity === 2) && d.message.startsWith("File '")
) ?? [];
```

This way the test accepts both Error (file not found) and Warning (file found but no classes) diagnostics with the "File '" prefix.

**Required import:** Ensure `isBbjClass` is imported in bbj-validator.ts (check existing imports — it's already imported on line 11).
  </action>
  <verify>Run `cd bbj-vscode && npx vitest run test/imports.test.ts` — "USE referencing file with no classes (e.g., binary) shows file-path error" passes. Also verify no regressions in other import tests.</verify>
  <done>TEST-04 passes. USE referencing a file with no BbjClass nodes produces a warning diagnostic with the expected message format.</done>
</task>

</tasks>

<verification>
Run the full test suite: `cd bbj-vscode && npm test`

Confirm:
1. completion-test.test.ts: "DEF FN parameters with $ suffix inside class method" passes or is `.skip`ped
2. imports.test.ts: "USE referencing file with no classes" passes
3. No regressions in other tests
4. If TEST-03 was `.skip`ped, the skip reason is documented in the test file
</verification>

<success_criteria>
- TEST-03 resolved (passing or `.skip`ped with documented reason)
- TEST-04 passes with warning-level diagnostic for files with no classes
- No other tests regressed
- `npm test` exits zero (all non-skipped tests green)
</success_criteria>

<output>
After completion, create `.planning/phases/54-fix-failing-tests/54-02-SUMMARY.md`
</output>
