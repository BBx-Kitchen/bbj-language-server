# Milestone v3.1: PRIO 1+2 Issue Burndown

**Status:** SHIPPED 2026-02-07
**Phases:** 28-31
**Total Plans:** 13

## Overview

Close all PRIO 1+2 GitHub issues -- fix variable scoping bugs, inheritance resolution, Java reflection staleness, and make extension settings configurable.

## Phases

### Phase 28: Variable Scoping & Declaration Order

**Goal**: Program-scope variables respect declaration order, DIM-declared arrays are recognized by DREAD, and DECLARE type info propagates correctly
**Depends on**: Nothing (first phase of v3.1)
**Requirements**: SCOPE-01, SCOPE-04, SCOPE-05
**Success Criteria**:
  1. A variable used before its DIM/LET/assignment in program scope shows a "not declared" warning; the same variable used after its declaration resolves correctly
  2. A DREAD statement referencing a variable previously DIM'd as an array (subscript form) resolves without error
  3. A DECLARE statement anywhere in a method causes the declared type to apply to the variable throughout the entire method scope (not just after the DECLARE)
  4. Existing tests pass -- no regressions in class-scope or method-scope variable resolution

Plans:
- [x] 28-01-PLAN.md -- Grammar auto property + use-before-assignment validation + conflicting DECLARE detection
- [x] 28-02-PLAN.md -- Comprehensive test suite + edge case fixes

### Phase 29: DEF FN & Inheritance Resolution

**Goal**: DEF FN definitions inside class methods work without false errors and with correct parameter scoping; super class fields and inherited Java methods resolve through the inheritance chain
**Depends on**: Phase 28 (scoping infrastructure may be shared)
**Requirements**: SCOPE-02, SCOPE-03, PARSE-01, JAVA-01
**Success Criteria**:
  1. A DEF FN defined inside a class method does not produce a line-break validation error
  2. Parameters declared in a DEF FN expression are visible inside the FN body and do not leak into the enclosing method scope
  3. Accessing `#field!` where the field is defined in a super class (not the current class) resolves without a "field not found" warning
  4. Calling `#method()` or `#super!.method()` where the method is inherited from a Java super class resolves without a linking error
  5. Existing completion and go-to-definition features continue working for directly-declared fields and methods

Plans:
- [x] 29-01-PLAN.md -- DEF FN line-break validation fix + parameter scoping
- [x] 29-02-PLAN.md -- Inheritance chain depth cap + BBj super class resolution tests
- [x] 29-03-PLAN.md -- Gap closure: field inheritance tests + DEF FN parameter non-leakage test

### Phase 30: Java Reflection & Error Reporting

**Goal**: Java interop reflection finds recently-added methods; cyclic reference errors report the specific file and line number
**Depends on**: Phase 29 (Java interop changes build on inheritance work)
**Requirements**: JAVA-02, PARSE-02
**Success Criteria**:
  1. Methods added in recent BBj versions (e.g., `setSlot()` on BBjControl) are found by the Java interop reflection and appear in completion results
  2. Cyclic reference error messages in the Problems panel include the source filename and line number where the cycle was detected
  3. No regression in existing Java class/method completion for standard BBj API classes

Plans:
- [x] 30-01-PLAN.md -- Java reflection investigation & fix for missing methods (e.g., setSlot)
- [x] 30-02-PLAN.md -- Cyclic reference error reporting with file/line info and Error severity
- [x] 30-03-PLAN.md -- Refresh Java Classes command for VS Code and IntelliJ
- [x] 30-04-PLAN.md -- Gap closure: fix false positive cyclic detection + add cyclic inheritance validator

### Phase 31: Extension Settings & File Types

**Goal**: .bbx files get full BBj treatment; BBj paths, interop connection, and EM auth are configurable in extension settings
**Depends on**: Nothing (independent of Phases 28-30; can run in parallel if needed)
**Requirements**: IDE-01, CONF-01, CONF-02, CONF-03
**Success Criteria**:
  1. Opening a .bbx file in VS Code shows the BBj icon, provides language intelligence (completion, diagnostics), and enables run commands -- same as .bbj files
  2. The extension settings include a field for config.bbx path and other BBj-specific options; changing these settings takes effect without restarting the extension
  3. The interop hostname and port are configurable in extension settings (not hardcoded to localhost:5008); connecting to a remote java-interop service works
  4. EM access uses token-based authentication; no plaintext passwords are stored in settings

Plans:
- [x] 31-01-PLAN.md -- .bbx merged into BBj + configurable interop host/port + config.bbx path (VS Code + LS)
- [x] 31-02-PLAN.md -- .bbx merged into BBj + configurable interop host + config.bbx path (IntelliJ)
- [x] 31-03-PLAN.md -- EM token-based auth: BBj login stub + VS Code SecretStorage + auto-prompt run commands
- [x] 31-04-PLAN.md -- EM token-based auth: IntelliJ CredentialStore + auto-prompt login + run command updates

---

## Milestone Summary

**Key Decisions:**

- Plain assignments are LetStatements in grammar (no ExpressionStatement handling needed)
- Hint severity for use-before-assignment (gentle guidance, not blocking)
- DEF FN parameters scoped to DefFunction node (visible in FN body, don't leak)
- MAX_INHERITANCE_DEPTH = 20 for both scope traversal and cyclic detection
- Re-entrancy guard in type inferer prevents false cyclic errors on self-referencing patterns
- Dedicated cyclic inheritance validator with visited Set (Langium's built-in can't detect semantic cycles)
- Merged .bbx into BBj language (not separate language ID)
- JWT token-based EM auth via BBjAdminFactory.getAuthToken()
- Token as 8th parameter to web.bbj for backward compatibility

**Issues Resolved:**

- #4: Program variable scope (vars only visible after declaration)
- #85: Linking error invoking method from Java super class
- #180: setSlot() not found by Java reflection
- #226: DEF FN in methods — line-break validation + parameter scoping
- #240: Super class #field! access resolved via inheritance
- #244: config.bbx and BBj options configurable
- #245: Cyclic reference error includes filename and line number
- #247: DREAD with DIM'd array variables resolves correctly
- #256: EM token-based auth (no plaintext password)
- #257: Interop hostname and port configurable
- #314: False positive cyclic detection on self-referencing variables eliminated
- #340: .bbx files treated as BBj programs

**Issues Deferred:**

- CPU stability mitigations (#232) — root cause known, mitigations documented
- PRIO 3 false error fixes (#162, #164, #183, #214, #295, #296, #297, #317)

**Technical Debt Incurred:**

- Single-line DEF FN inside class methods not parsed correctly by validate test helper (parser/lexer issue)
- JAVA-01 requires human verification with live Java interop service

---

_For current project status, see .planning/ROADMAP.md_
