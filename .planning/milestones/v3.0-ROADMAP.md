# Milestone v3.0: Improving BBj Language Support

**Status:** SHIPPED 2026-02-06
**Phases:** 24-27
**Total Plans:** 11 (including 1 gap closure)

## Overview

**Milestone Goal:** Fix false errors on common BBj patterns, resolve crashes, improve type resolution for completion, and polish IDE features -- eliminating the most-reported pain points in the language server.

- [x] **Phase 24: Grammar & Parsing Fixes** - Eliminate false errors from valid BBj syntax patterns (completed 2026-02-06)
- [x] **Phase 25: Type Resolution & Crash Fixes** - Fix type conveyance for completion and USE statement crash (completed 2026-02-06)
- [x] **Phase 26: CPU Stability** - Investigate root causes of 100% CPU in multi-project workspaces (completed 2026-02-06)
- [x] **Phase 27: IDE Polish** - Improve Structure View, run icons, completion triggers, and error messages (completed 2026-02-06)

## Phase Details

### Phase 24: Grammar & Parsing Fixes
**Goal**: Common BBj syntax patterns that currently produce false errors are accepted by the parser without diagnostics
**Depends on**: Nothing (first phase of v3.0)
**Requirements**: GRAM-01, GRAM-02, GRAM-03, GRAM-04, GRAM-05
**Success Criteria** (what must be TRUE):
  1. `endif` or `swend` followed by `;rem` comment on the same line parses without error
  2. Camel-case method names containing embedded BBj keywords (e.g., `getResult`, `isNew`) parse as single identifiers, not split into keyword + identifier
  3. `DREAD` verb and `DATA` statement are recognized by the grammar and do not produce diagnostics
  4. `DEF FN` / `FNEND` blocks inside class methods parse without error
  5. A comment after colon line-continuation (`: REM ...`) parses without error
**Plans**: 2 plans

Plans:
- [x] 24-01-PLAN.md -- Lexer fix: keyword/identifier disambiguation via longer_alt (GRAM-02)
- [x] 24-02-PLAN.md -- Grammar fixes: inline REM, DREAD/DATA, DEF FN in methods (GRAM-01, GRAM-03, GRAM-04, GRAM-05)

### Phase 25: Type Resolution & Crash Fixes
**Goal**: CAST(), super class fields, implicit getters, and DECLARE all correctly contribute type information for downstream completion, and USE statements with inner classes no longer crash the server
**Depends on**: Phase 24 (grammar must be correct before type resolution can work on parsed AST)
**Requirements**: TYPE-01, TYPE-02, TYPE-03, TYPE-04, STAB-01
**Success Criteria** (what must be TRUE):
  1. `CAST(object!, BBjString)` conveys `BBjString` type so that method completion works on the result
  2. Accessing a super class field via `#field!` shorthand does not produce a warning when the field exists on a parent class
  3. Implicit getter calls (e.g., `obj!.Name$`) correctly convey return type for downstream method chaining and completion
  4. A `DECLARE` statement placed anywhere in a method body (not just before first use) is recognized for type resolution
  5. A `USE` statement referencing a Java inner class (e.g., jSoup `Element`) does not crash the language server
  6. Type resolution warnings can be disabled via workspace setting for heavily dynamic codebases
**Plans**: 4 plans

Plans:
- [x] 25-01-PLAN.md -- CAST() and implicit getter type conveyance + CAST warning diagnostic (TYPE-01, TYPE-03)
- [x] 25-02-PLAN.md -- Super class field resolution with cycle-safe inheritance traversal + unresolvable super warning (TYPE-02)
- [x] 25-03-PLAN.md -- DECLARE method-scoped visibility, USE crash resistance + USE warning diagnostic (TYPE-04, STAB-01)
- [x] 25-04-PLAN.md -- Workspace setting to disable type resolution warnings

### Phase 26: CPU Stability
**Goal**: Investigate root causes of 100% CPU usage in multi-project workspaces and document findings with ranked mitigations
**Depends on**: Nothing (independent investigation, can run in parallel with other phases)
**Requirements**: STAB-02
**Success Criteria** (what must be TRUE):
  1. FINDINGS.md documents root cause analysis with evidence from code path tracing for all 5 hypothesized causes
  2. Mitigations are ranked by likelihood and effort, with enough specificity for a follow-up implementation phase
**Plans**: 1 plan

Plans:
- [x] 26-01-PLAN.md -- Investigate CPU hot paths: analyze rebuild pipeline, index invalidation, and 3 secondary hypotheses; produce FINDINGS.md

### Phase 27: IDE Polish
**Goal**: Structure View differentiates symbol kinds, run icons are scoped to BBj files, field completion triggers on `#`, and error messages include source filenames
**Depends on**: Nothing (independent fixes, can run in parallel with other phases)
**Requirements**: IDE-01, IDE-02, IDE-03, IDE-04, IDE-05
**Success Criteria** (what must be TRUE):
  1. Labels, variables, and fields show distinct icons/kinds in Structure View and completion popups (not all SymbolKind.Field)
  2. Run icons (GUI/BUI/DWC) appear only on BBj file types (.bbj, .bbl, .bbx, .src), not on all files
  3. Typing `#` inside a class triggers completion of the class's fields (global field completion)
  4. Cyclic reference and linker error messages include the source filename where the error originates
**Plans**: 3 plans

Plans:
- [x] 27-01-PLAN.md -- Symbol kind differentiation and run icon scoping (IDE-01, IDE-02, IDE-03)
- [x] 27-02-PLAN.md -- Field completion on # trigger character (IDE-04)
- [x] 27-03-PLAN.md -- Error message enhancement with source filenames (IDE-05)

## Progress

**Execution Order:** 24 -> 25 -> 26 -> 27 (26 and 27 are independent and could run in parallel after 25)

| Phase | Milestone | Plans Complete | Status | Completed |
|-------|-----------|----------------|--------|-----------|
| 24. Grammar & Parsing Fixes | v3.0 | 2/2 | Complete | 2026-02-06 |
| 25. Type Resolution & Crash Fixes | v3.0 | 4/4 | Complete | 2026-02-06 |
| 26. CPU Stability | v3.0 | 1/1 | Complete | 2026-02-06 |
| 27. IDE Polish | v3.0 | 3/3 | Complete | 2026-02-06 |

---

## Milestone Summary

**Key Decisions:**

- LONGER_ALT for keyword/identifier disambiguation (Rationale: Chevrotain tokenizer splits camel-case names; LONGER_ALT on all keywords fixes it)
- CAST with unresolvable type returns undefined (Rationale: Treats as untyped rather than error; warning severity for diagnostics)
- DECLARE method-scoped not block-scoped (Rationale: Matches BBj runtime behavior)
- USE statements wrapped in try/catch (Rationale: Independent processing prevents single bad USE from crashing entire file)
- Inner class dollar-sign fallback (Rationale: Attempts `Outer$Inner` on resolution failure for nested Java classes)
- Module-level config for type resolution warnings (Rationale: `bbj.typeResolution.warnings` defaults to true; runtime toggleable)
- basename() for error message file paths (Rationale: Cleaner than full paths; 1-based line numbers for readability)

**Issues Resolved:**

- False parser errors on 5 common BBj patterns (#318, #316, #247, #226, #118)
- Server crash on USE with unresolvable classes (#314)
- Missing type conveyance for CAST, implicit getters, super class fields (#352, #241, #240)
- DECLARE not recognized when placed after first use (#265)
- All symbols showing same SymbolKind.Field in Structure View (#353)
- Run icons appearing on non-BBj files (#354, #340)
- Error messages missing source file context (#245)

**Issues Deferred:**

- CPU stability mitigations documented but not implemented (Phase 26 was investigation-only; 4 mitigations ranked for future implementation)

**Technical Debt Incurred:**

- None new â€” pre-existing TODOs unchanged

---

_For current project status, see .planning/ROADMAP.md_
