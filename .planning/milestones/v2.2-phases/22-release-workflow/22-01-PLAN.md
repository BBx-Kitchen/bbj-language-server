---
phase: 22-release-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/manual-release.yml
autonomous: true

must_haves:
  truths:
    - "Manual workflow dispatch triggers build of both VS Code and IntelliJ extensions"
    - "Both extensions receive the input version (x.y.0 format)"
    - "GitHub Release is created with .vsix and .zip as downloadable assets"
    - "Release body contains step-by-step IntelliJ installation instructions"
  artifacts:
    - path: ".github/workflows/manual-release.yml"
      provides: "Three-job release workflow (VS Code, IntelliJ, GitHub Release)"
      contains: "build-intellij"
    - path: ".github/workflows/manual-release.yml"
      provides: "GitHub Release creation"
      contains: "gh release create"
  key_links:
    - from: "manual-release job"
      to: "build-intellij job"
      via: "needs + artifact upload/download"
      pattern: "needs:.*manual-release"
    - from: "build-intellij job"
      to: "create-release job"
      via: "needs dependency"
      pattern: "needs:.*build-intellij"
    - from: "create-release job"
      to: "GitHub Release API"
      via: "gh release create with assets"
      pattern: "gh release create.*\\.vsix.*\\.zip"
---

<objective>
Extend manual-release.yml to build both VS Code and IntelliJ extensions, then create a GitHub Release with both artifacts attached and IntelliJ installation instructions.

Purpose: Enable unified production releases where both extensions get the same version and are distributed through a single GitHub Release, making it easy for users to find and download the IntelliJ plugin.

Output: Updated manual-release.yml with three jobs (VS Code build/publish, IntelliJ build, GitHub Release creation) that produces a GitHub Release containing both .vsix and .zip artifacts with installation instructions.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-release-workflow/22-CONTEXT.md
@.planning/phases/22-release-workflow/22-RESEARCH.md
@.planning/phases/21-preview-workflow/21-01-SUMMARY.md
@.github/workflows/manual-release.yml
@.github/workflows/preview.yml
@bbj-intellij/build.gradle.kts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add IntelliJ build job to manual-release workflow</name>
  <files>.github/workflows/manual-release.yml</files>
  <action>
Extend manual-release.yml following the pattern established in preview.yml (Phase 21):

1. Rename existing job from `manual-release` to `build-vscode` for clarity

2. Add `outputs` section to build-vscode job:
   - version: The input version (${{ github.event.inputs.version }})

3. After the existing "Package and publish to VS Code Marketplace" step, add:
   - Upload language server artifact step (same as preview.yml):
     ```yaml
     - name: Upload language server
       uses: actions/upload-artifact@v4
       with:
         name: language-server
         path: bbj-vscode/out/language/main.cjs
         retention-days: 1
     ```
   - Upload VS Code extension step to capture .vsix for release:
     ```yaml
     - name: Upload VS Code extension
       uses: actions/upload-artifact@v4
       with:
         name: vscode-extension
         path: bbj-vscode/*.vsix
         retention-days: 1
     ```

4. Add `build-intellij` job after build-vscode:
   ```yaml
   build-intellij:
     runs-on: ubuntu-latest
     needs: build-vscode

     steps:
       - uses: actions/checkout@v4

       - name: Download language server
         uses: actions/download-artifact@v4
         with:
           name: language-server
           path: bbj-vscode/out/language/

       - name: Set up Java
         uses: actions/setup-java@v4
         with:
           distribution: 'temurin'
           java-version: '17'

       - name: Build IntelliJ plugin
         working-directory: bbj-intellij
         run: ./gradlew buildPlugin -Pversion=${{ needs.build-vscode.outputs.version }}

       - name: Rename plugin with version
         working-directory: bbj-intellij/build/distributions
         run: |
           VERSION="${{ needs.build-vscode.outputs.version }}"
           mv bbj-lang-*.zip "bbj-intellij-${VERSION}.zip"

       - name: Upload IntelliJ plugin
         uses: actions/upload-artifact@v4
         with:
           name: intellij-plugin
           path: bbj-intellij/build/distributions/bbj-intellij-*.zip
           retention-days: 1
   ```

Key differences from preview.yml:
- Use input version directly (no patch bump)
- Rename output .zip to include "intellij" and version for clarity
- Shorter retention (1 day) since artifacts go to GitHub Release
  </action>
  <verify>Validate YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/manual-release.yml'))"`</verify>
  <done>manual-release.yml has build-vscode job (renamed from manual-release) with artifact uploads, and build-intellij job that produces versioned bbj-intellij-x.y.z.zip</done>
</task>

<task type="auto">
  <name>Task 2: Add GitHub Release creation job</name>
  <files>.github/workflows/manual-release.yml</files>
  <action>
Add `create-release` job after build-intellij that creates GitHub Release with both artifacts:

```yaml
create-release:
  runs-on: ubuntu-latest
  needs: [build-vscode, build-intellij]
  permissions:
    contents: write

  steps:
    - name: Download VS Code extension
      uses: actions/download-artifact@v4
      with:
        name: vscode-extension
        path: ./artifacts

    - name: Download IntelliJ plugin
      uses: actions/download-artifact@v4
      with:
        name: intellij-plugin
        path: ./artifacts

    - name: Create GitHub Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        VERSION: ${{ needs.build-vscode.outputs.version }}
      run: |
        gh release create "v$VERSION" \
          --title "v$VERSION" \
          --generate-notes \
          --notes "## Installation

### VS Code
Install from [VS Code Marketplace](https://marketplace.visualstudio.com/items?itemName=basis-intl.bbj-lang) or download the \`.vsix\` file below and install via **Extensions > ... > Install from VSIX...**

### IntelliJ IDEA
1. Download \`bbj-intellij-$VERSION.zip\` from the Assets below
2. Open IntelliJ IDEA
3. Go to **Settings** > **Plugins**
4. Click the gear icon and select **Install Plugin from Disk...**
5. Select the downloaded ZIP file
6. Restart IntelliJ when prompted

---
" \
          ./artifacts/*.vsix \
          ./artifacts/*.zip
```

Key implementation details:
- `permissions: contents: write` required for gh release create
- `--generate-notes` auto-generates changelog from commits since last tag
- `--notes` prepends installation instructions before auto-generated notes
- Both artifacts uploaded as release assets
- Tag already exists (created by build-vscode job's commit step)
  </action>
  <verify>Validate YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/manual-release.yml'))"`</verify>
  <done>manual-release.yml has create-release job that creates GitHub Release with title "v{version}", auto-generated changelog, IntelliJ installation instructions, and both .vsix and .zip as downloadable assets</done>
</task>

</tasks>

<verification>
1. YAML syntax valid (no parse errors)
2. Workflow has three jobs: build-vscode, build-intellij, create-release
3. Job dependencies correct: build-intellij needs build-vscode, create-release needs both
4. Version flows through all jobs via outputs
5. Artifact names match between upload and download steps
6. create-release has contents: write permission
7. gh release create includes both .vsix and .zip assets
8. Release notes contain IntelliJ installation instructions
</verification>

<success_criteria>
- [ ] manual-release.yml has three jobs (build-vscode, build-intellij, create-release)
- [ ] build-vscode outputs version and uploads language-server + vscode-extension artifacts
- [ ] build-intellij downloads language-server, builds plugin, renames to bbj-intellij-{version}.zip, uploads as intellij-plugin artifact
- [ ] create-release downloads both extension artifacts and creates GitHub Release with gh CLI
- [ ] Release body includes IntelliJ installation instructions (5 numbered steps)
- [ ] Both .vsix and .zip attached as release assets
- [ ] YAML syntax validates without errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-release-workflow/22-01-SUMMARY.md`
</output>
