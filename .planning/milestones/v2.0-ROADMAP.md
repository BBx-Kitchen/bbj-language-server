# Milestone v2.0: Langium 4 Upgrade

**Status:** SHIPPED 2026-02-04
**Phases:** 14-20
**Total Plans:** 11

## Overview

Upgrade the language server from Langium 3.2 to Langium 4.1.3 with zero feature regressions, then publish updated VS Code extension and IntelliJ plugin. The migration follows a strict sequential dependency chain: install new packages, regenerate grammar, apply mechanical renames, resolve complex API changes, verify builds, confirm runtime behavior, and release. All 34 requirements address infrastructure migration -- no new user-facing features.

## Phases

### Phase 14: Dependency Update & Grammar Regeneration

**Goal**: New Langium 4 packages installed and grammar regenerated with generated code that compiles cleanly
**Depends on**: Nothing (first phase of milestone)
**Plans**: 1 plan

Plans:
- [x] 14-01-PLAN.md -- Update langium packages to 4.1.3/4.1.0, regenerate grammar, verify generated code compiles

**Details:**
- Updated langium from ~3.2.1 to ~4.1.3 and langium-cli from ~3.2.0 to ~4.1.0
- Verified clean dependency tree with single chevrotain 11.0.3 instance
- Regenerated grammar with zero errors, documented new Langium 4 type constant pattern
- Confirmed generated files compile cleanly

### Phase 15: Core API Renames & Type Constants

**Goal**: All mechanical renames and type constant migrations applied so scope computation, validators, and type-checking code reference Langium 4 APIs correctly
**Depends on**: Phase 14
**Plans**: 2 plans

Plans:
- [x] 15-01-PLAN.md -- Migrate type constants to .$type in provider files (node-kind, description, semantic-token, completion)
- [x] 15-02-PLAN.md -- Rename PrecomputedScopes to LocalSymbols, scope methods, and type constants in scope files

**Details:**
- Every TypeName constant usage updated to TypeName.$type pattern (25+ sites across 10+ files)
- All PrecomputedScopes references renamed to LocalSymbols with correct interface usage
- All document.precomputedScopes property accesses updated to new name
- Scope computation methods renamed: computeExports → collectExportedSymbols, computeLocalScopes → collectLocalSymbols

### Phase 16: API Signature & Deprecated API Migration

**Goal**: All complex API shape changes resolved -- linker handles new Reference union type, completion provider uses new signature, parser creation updated, and no deprecated API usages remain
**Depends on**: Phase 15
**Plans**: 1 plan

Plans:
- [x] 16-01-PLAN.md -- Update completion provider signature and linker type guards for Langium 4 API compatibility

**Details:**
- Linker and scope provider handle Reference | MultiReference union type with proper narrowing
- Completion provider's createReferenceCompletionItem calls use the new 3-parameter signature
- Zero remaining usages of APIs removed in Langium 4 PR #1991

### Phase 17: Build Verification & Test Suite

**Goal**: The entire project compiles, bundles, and passes all tests -- both VS Code extension and IntelliJ plugin produce valid build artifacts
**Depends on**: Phase 16
**Plans**: 2 plans

Plans:
- [x] 17-01-PLAN.md -- Fix all 21 TypeScript compilation errors across 7 source files (LocalSymbols API, CstNode API, method signatures, type constants)
- [x] 17-02-PLAN.md -- Fix test failures, build esbuild bundle, smoke-test main.cjs, verify IntelliJ Gradle build

**Details:**
- tsc compiles the full project with zero errors
- esbuild produces valid main.cjs bundle (1.8MB)
- 56/58 tests pass (2 initialization failures from false positive Chevrotain warnings)
- VS Code and IntelliJ packages build successfully

### Phase 18: Functional Verification & Release

**Goal**: Every existing language server feature works identically in both VS Code and IntelliJ after the upgrade, and release artifacts are built for user to publish
**Depends on**: Phase 17
**Plans**: 2 plans

Plans:
- [x] 18-01-PLAN.md -- Chevrotain token runtime verification and LSP feature functional tests
- [x] 18-02-PLAN.md -- Build release artifacts (.vsix + .zip) and produce verification report

**Details:**
- All 9 language features work in VS Code: syntax highlighting, diagnostics, completion (BBj + Java), hover, signature help, go-to-definition, document symbols, semantic tokens
- IntelliJ plugin provides the same feature set as before the upgrade (no regressions)
- VS Code .vsix artifact: 1.67 MB
- IntelliJ .zip artifact: 701 KB

### Phase 19: Test Plan

**Goal:** Fix failing tests, add coverage infrastructure, and establish quality gates for the test suite
**Depends on:** Phase 18
**Plans:** 2 plans

Plans:
- [x] 19-01-PLAN.md -- Fix 2 failing tests (parser.test.ts type constant, linking.test.ts BBjAPI case)
- [x] 19-02-PLAN.md -- Add coverage infrastructure (@vitest/coverage-v8) with thresholds

**Details:**
- All tests pass (332 tests, 0 failures)
- Coverage reporting configured with @vitest/coverage-v8
- Coverage thresholds: 50% lines, 45% functions, 40% branches
- Baseline coverage: 88% lines

### Phase 20: Human QA Testing

**Goal:** Create documentation for human QA testing with recurring testing checklists
**Depends on:** Phase 19
**Plans:** 1 plan

Plans:
- [x] 20-01-PLAN.md -- Create QA directory with testing guide, full test checklist, and smoke test checklist

**Details:**
- Human QA testing instructions documented in QA/TESTING-GUIDE.md
- Recurring testing checklists: 27-item full test, 8-item smoke test
- No-exceptions release gate policy

---

## Milestone Summary

**Key Decisions:**

- Langium 4 type constant pattern: export const TypeName = { $type: 'TypeName', ... }
- LocalSymbols type for precomputed scope data
- V8 coverage over Istanbul (native Node.js profiler)
- Conservative coverage thresholds to allow flexibility

**Issues Resolved:**

- 77 TypeScript compilation errors from Langium 4 API changes
- PrecomputedScopes → LocalSymbols across all scope files
- Reference | MultiReference union type handling in linker
- Chevrotain false positive warnings documented (non-blocking)

**Technical Debt Incurred:**

- 2 test files fail during initialization due to Chevrotain lexer validation false positives (56/58 tests pass, runtime unaffected)
- Pre-existing TODO/FIXME comments not addressed (not introduced by upgrade)

---

_For current project status, see .planning/ROADMAP.md_

---

*Archived: 2026-02-04 as part of v2.0 milestone completion*
