---
phase: 15-core-api-renames-type-constants
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - bbj-vscode/src/language/bbj-scope-local.ts
  - bbj-vscode/src/language/bbj-scope.ts
autonomous: true

must_haves:
  truths:
    - "PrecomputedScopes import replaced with LocalSymbols"
    - "computeExports method renamed to collectExportedSymbols"
    - "computeLocalScopes method renamed to collectLocalSymbols"
    - "computeExportsForNode call renamed to collectExportedSymbolsForNode"
    - "All document.precomputedScopes accesses renamed to document.localSymbols"
    - "All type constant usages in scope files use .$type suffix"
    - "processNode parameter type updated from PrecomputedScopes to LocalSymbols"
  artifacts:
    - path: "bbj-vscode/src/language/bbj-scope-local.ts"
      provides: "Scope computation with Langium 4 method names and types"
      contains: "collectExportedSymbols"
    - path: "bbj-vscode/src/language/bbj-scope.ts"
      provides: "Scope provider with localSymbols property access and .$type constants"
      contains: "localSymbols"
  key_links:
    - from: "bbj-scope-local.ts"
      to: "langium"
      via: "import LocalSymbols, extend DefaultScopeComputation"
      pattern: "import.*LocalSymbols.*from 'langium'"
    - from: "bbj-scope-local.ts"
      to: "DefaultScopeComputation"
      via: "override collectExportedSymbols and collectLocalSymbols"
      pattern: "override async collectExportedSymbols"
    - from: "bbj-scope.ts"
      to: "LangiumDocument"
      via: "document.localSymbols property access"
      pattern: "\\.localSymbols"
    - from: "bbj-scope.ts"
      to: "generated/ast.js"
      via: "type constants with .$type for allElements, getGlobalScope, isSubtype, switch cases, equality"
      pattern: "allElements\\(\\w+\\.\\$type\\)"
---

<objective>
Rename PrecomputedScopes to LocalSymbols, rename scope computation methods, update document property accesses, and migrate all remaining type constant usages in scope files.

Purpose: Langium 4 renamed `PrecomputedScopes` to `LocalSymbols`, changed `computeExports`/`computeLocalScopes` to `collectExportedSymbols`/`collectLocalSymbols`, and renamed `document.precomputedScopes` to `document.localSymbols`. The scope files also contain type constant usages that need the `.$type` suffix (from Plan 01's pattern) -- `allElements()` calls, `getGlobalScope()` calls, `isSubtype()` calls, switch cases, equality comparisons, and `type:` property literals.

Output: Two scope files fully updated with Langium 4 API names, property accesses, and type constant patterns.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-core-api-renames-&-type-constants/15-RESEARCH.md
@.planning/phases/15-core-api-renames-&-type-constants/15-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename PrecomputedScopes, scope methods, and type constants in bbj-scope-local.ts</name>
  <files>bbj-vscode/src/language/bbj-scope-local.ts</files>
  <action>
Apply ALL of the following changes in `bbj-scope-local.ts`:

**Import rename (line 12):**
- `PrecomputedScopes` -> `LocalSymbols` in the import from 'langium'

**Method renames:**
- Line 54: `override async computeExports(` -> `override async collectExportedSymbols(`
- Line 56: `this.computeExportsForNode(` -> `this.collectExportedSymbolsForNode(`
- Line 59: `override async computeLocalScopes(` -> `override async collectLocalSymbols(`

**Type annotation updates:**
- Line 59: `Promise<PrecomputedScopes>` -> `Promise<LocalSymbols>` (return type of collectLocalSymbols)
- Line 81: `scopes: PrecomputedScopes` -> `scopes: LocalSymbols` (processNode parameter)
- Line 260: `scopes: PrecomputedScopes` -> `scopes: LocalSymbols` (addToScope parameter)

**Type constant .$type migrations:**
- Line 109: `type: FieldDecl,` -> `type: FieldDecl.$type,`
- Line 122: `type: FieldDecl,` -> `type: FieldDecl.$type,`
- Line 132: `type: FieldDecl,` -> `type: FieldDecl.$type,`
- Line 163: `type: FieldDecl,` -> `type: FieldDecl.$type,`
- Line 261: `scopeHolder.$type === CompoundStatement` -> `scopeHolder.$type === CompoundStatement.$type`
- Line 282: `type: MethodDecl,` -> `type: MethodDecl.$type,`

Note: The `type:` property in `AstNodeDescription` objects expects a string. Since `FieldDecl` and `MethodDecl` are now objects, we must use `FieldDecl.$type` and `MethodDecl.$type` to get the string values.

Do NOT change any `is*()` type guard calls -- those are generated functions that still work correctly.
Do NOT change `CompoundStatement` in the import -- it's still a valid import, just needs `.$type` when comparing.
  </action>
  <verify>
Run: `grep -n 'PrecomputedScopes' bbj-vscode/src/language/bbj-scope-local.ts`
Expected: Zero matches.

Run: `grep -n 'computeExports\|computeLocalScopes\|computeExportsForNode' bbj-vscode/src/language/bbj-scope-local.ts`
Expected: Zero matches.

Run: `grep -c 'LocalSymbols' bbj-vscode/src/language/bbj-scope-local.ts`
Expected: 3 (1 import + 1 return type + 1 parameter type)

Run: `grep -c 'collectExportedSymbols\|collectLocalSymbols\|collectExportedSymbolsForNode' bbj-vscode/src/language/bbj-scope-local.ts`
Expected: 3 (2 method names + 1 helper call)

Run: `grep -c '\.\$type' bbj-vscode/src/language/bbj-scope-local.ts`
Expected: 6 (5 FieldDecl.$type + 1 CompoundStatement.$type... wait: 4 FieldDecl.$type + 1 MethodDecl.$type + 1 CompoundStatement.$type = 6)
  </verify>
  <done>bbj-scope-local.ts uses LocalSymbols type, collectExportedSymbols/collectLocalSymbols method names, and all 6 type constant usages migrated to .$type.</done>
</task>

<task type="auto">
  <name>Task 2: Update property accesses and type constants in bbj-scope.ts</name>
  <files>bbj-vscode/src/language/bbj-scope.ts</files>
  <action>
Apply ALL of the following changes in `bbj-scope.ts`:

**Property access renames (precomputedScopes -> localSymbols):**
- Line 133: `doc.precomputedScopes` -> `doc.localSymbols`
- Line 248: `document.precomputedScopes?.get(program)` -> `document.localSymbols?.get(program)`
- Line 337: `document?.precomputedScopes?.get(bbjType)` -> `document?.localSymbols?.get(bbjType)`

**Switch case type constants (in getGlobalScope, line 278-288):**
- Line 279: `case Class:` -> `case Class.$type:`
- Line 285: `case LibEventType:` -> `case LibEventType.$type:`
- Line 288: `case NamedElement:` -> `case NamedElement.$type:`

**allElements() calls -- these take a string param, so must use .$type:**
- Line 224: `allElements(BbjClass)` -> `allElements(BbjClass.$type)`
- Line 269: `allElements(LibMember)` -> `allElements(LibMember.$type)`
- Line 283: `allElements(JavaClass)` -> `allElements(JavaClass.$type)` (first occurrence)
- Line 286: `allElements(LibEventType)` -> `allElements(LibEventType.$type)`
- Line 295: `allElements(JavaClass)` -> `allElements(JavaClass.$type)` (second occurrence)

**getGlobalScope() calls -- these take a string param:**
- Line 212: `this.getGlobalScope(LibEventType, context)` -> `this.getGlobalScope(LibEventType.$type, context)`
- Line 251: `this.getGlobalScope(Class, context)` -> `this.getGlobalScope(Class.$type, context)`

**isSubtype() call -- takes string params:**
- Line 249: `this.astReflection.isSubtype(descr.type, Class)` -> `this.astReflection.isSubtype(descr.type, Class.$type)`

**Equality comparison:**
- Line 340: `member.type === MethodDecl` -> `member.type === MethodDecl.$type`

Do NOT change string literal case statements in `getScope()` (lines 78, 85, 93: `case 'SimpleTypeRef':`, `case 'BBjTypeRef':`, `case 'JavaSymbol':`) -- these are already string literals.
Do NOT change any `is*()` type guard calls.
Do NOT change the `precomputed` local variable name (line 133-145) -- only the property access changes.
  </action>
  <verify>
Run: `grep -n 'precomputedScopes' bbj-vscode/src/language/bbj-scope.ts`
Expected: Zero matches.

Run: `grep -c 'localSymbols' bbj-vscode/src/language/bbj-scope.ts`
Expected: 3

Run: `grep -c '\.\$type' bbj-vscode/src/language/bbj-scope.ts`
Expected: 14 (3 switch cases + 5 allElements + 2 getGlobalScope + 1 isSubtype + 1 equality + any others... let me count: 3+5+2+1+1 = 12... but also the `precomputed.get(classPath)` on line 145 accesses the variable not the property, so no change there. Final count: 12)

Run: `grep -n 'allElements([A-Z]' bbj-vscode/src/language/bbj-scope.ts`
Expected: Zero matches (all should now have .$type).
  </verify>
  <done>bbj-scope.ts uses localSymbols property, and all 12 type constant usages (switch cases, allElements, getGlobalScope, isSubtype, equality) migrated to .$type.</done>
</task>

</tasks>

<verification>
1. `grep -rn 'precomputedScopes\|PrecomputedScopes' bbj-vscode/src/language/bbj-scope-local.ts bbj-vscode/src/language/bbj-scope.ts` returns zero matches
2. `grep -rn 'computeExports\b\|computeLocalScopes\b\|computeExportsForNode\b' bbj-vscode/src/language/bbj-scope-local.ts` returns zero matches
3. `grep -rn 'allElements([A-Z][a-zA-Z]*[^.])' bbj-vscode/src/language/bbj-scope.ts` returns zero matches (all should use .$type)
4. `grep -c 'localSymbols' bbj-vscode/src/language/bbj-scope.ts` returns 3
5. `grep -c 'collectExportedSymbols\|collectLocalSymbols' bbj-vscode/src/language/bbj-scope-local.ts` returns at least 3
</verification>

<success_criteria>
- PrecomputedScopes fully replaced by LocalSymbols (import + all type annotations)
- computeExports/computeLocalScopes/computeExportsForNode fully renamed to Langium 4 equivalents
- All 3 document.precomputedScopes property accesses renamed to document.localSymbols
- All type constant usages in both scope files use .$type suffix (18 total: 6 in scope-local + 12 in scope)
- No is*() type guard calls modified
- No string literal comparisons modified
</success_criteria>

<output>
After completion, create `.planning/phases/15-core-api-renames-&-type-constants/15-02-SUMMARY.md`
</output>
