---
phase: 15-core-api-renames-type-constants
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/language/bbj-node-kind.ts
  - bbj-vscode/src/language/bbj-nodedescription-provider.ts
  - bbj-vscode/src/language/bbj-semantic-token-provider.ts
  - bbj-vscode/src/language/bbj-completion-provider.ts
autonomous: true

must_haves:
  truths:
    - "Every switch case using an imported type constant uses .$type suffix"
    - "Every equality comparison (=== TypeConstant) uses .$type suffix"
    - "Every type: property in object literals uses .$type suffix"
    - "Every allElements() call passes .$type string"
    - "Every getGlobalScope() and isSubtype() call passes .$type string"
    - "String literal comparisons (=== 'JavaClass') remain unchanged"
  artifacts:
    - path: "bbj-vscode/src/language/bbj-node-kind.ts"
      provides: "Symbol/completion kind mapping with .$type switch cases"
      contains: "MethodDecl.\\$type"
    - path: "bbj-vscode/src/language/bbj-nodedescription-provider.ts"
      provides: "Node description creation with .$type switch cases"
      contains: "MethodDecl.\\$type"
    - path: "bbj-vscode/src/language/bbj-semantic-token-provider.ts"
      provides: "Semantic token highlighting with .$type switch cases"
      contains: "ParameterDecl.\\$type"
    - path: "bbj-vscode/src/language/bbj-completion-provider.ts"
      provides: "Completion item customization with .$type comparisons"
      contains: "LibSymbolicLabelDecl.\\$type"
  key_links:
    - from: "bbj-node-kind.ts"
      to: "generated/ast.js"
      via: "import type constants, access .$type"
      pattern: "case \\w+\\.\\$type"
    - from: "bbj-completion-provider.ts"
      to: "generated/ast.js"
      via: "import type constants, compare .type === X.$type"
      pattern: "\\.type === \\w+\\.\\$type"
---

<objective>
Migrate all type constant usages in provider files (node-kind, description, semantic-token, completion) from bare constant references to .$type property access.

Purpose: In Langium 4, generated type constants changed from strings (`'MethodDecl'`) to objects (`{ $type: 'MethodDecl', ... }`). All switch cases, equality comparisons, and string-parameter usages must append `.$type` to get the string value, otherwise comparisons silently fail at runtime.

Output: Four provider files updated with correct `.$type` suffix on all type constant usages.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-deps-grammar/14-01-SUMMARY.md
@.planning/phases/15-core-api-renames-&-type-constants/15-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate type constants in bbj-node-kind.ts and bbj-semantic-token-provider.ts</name>
  <files>
    bbj-vscode/src/language/bbj-node-kind.ts
    bbj-vscode/src/language/bbj-semantic-token-provider.ts
  </files>
  <action>
In `bbj-node-kind.ts`, append `.$type` to every switch case that uses an imported type constant:
- Line 11: `case MethodDecl:` -> `case MethodDecl.$type:`
- Line 12: `case LibFunction:` -> `case LibFunction.$type:`
- Line 14: `case BbjClass:` -> `case BbjClass.$type:`
- Line 16: `case ArrayDecl:` -> `case ArrayDecl.$type:`
- Line 18: `case LibEventType:` -> `case LibEventType.$type:`
- Line 20: `case JavaPackage:` -> `case JavaPackage.$type:`
- Line 29: `case LibEventType:` -> `case LibEventType.$type:`
- Line 31: `case MethodDecl:` -> `case MethodDecl.$type:`
- Line 32: `case JavaMethod:` -> `case JavaMethod.$type:`
- Line 33: `case LibFunction:` -> `case LibFunction.$type:`
- Line 35: `case JavaClass:` -> `case JavaClass.$type:`
- Line 36: `case BbjClass:` -> `case BbjClass.$type:`
- Line 38: `case JavaPackage:` -> `case JavaPackage.$type:`

Total: 13 case statements (the research said 14 but the actual count is 13).

In `bbj-semantic-token-provider.ts`, append `.$type` to all 3 switch cases:
- Line 13: `case ParameterDecl:` -> `case ParameterDecl.$type:`
- Line 15: `case SymbolRef:` -> `case SymbolRef.$type:`
- Line 17: `case MethodCall:` -> `case MethodCall.$type:`

Do NOT change any imports -- the imported constants are still correct, we just need to access their `.$type` property.
Do NOT change string literal comparisons like `=== "JavaClass"` -- those are already comparing strings.
  </action>
  <verify>
Run: `grep -n 'case [A-Z][a-zA-Z]*:' bbj-vscode/src/language/bbj-node-kind.ts bbj-vscode/src/language/bbj-semantic-token-provider.ts`
Expected: Zero matches (all cases should now have `.$type:` suffix).

Run: `grep -c '\.\$type:' bbj-vscode/src/language/bbj-node-kind.ts`
Expected: 13

Run: `grep -c '\.\$type:' bbj-vscode/src/language/bbj-semantic-token-provider.ts`
Expected: 3
  </verify>
  <done>All 16 switch case statements across bbj-node-kind.ts and bbj-semantic-token-provider.ts use .$type suffix.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate type constants in bbj-nodedescription-provider.ts and bbj-completion-provider.ts</name>
  <files>
    bbj-vscode/src/language/bbj-nodedescription-provider.ts
    bbj-vscode/src/language/bbj-completion-provider.ts
  </files>
  <action>
In `bbj-nodedescription-provider.ts`, append `.$type` to the 4 switch cases in `createDescription()`:
- Line 10: `case MethodDecl:` -> `case MethodDecl.$type:`
- Line 11: `case LibFunction:` -> `case LibFunction.$type:`
- Line 12: `case JavaMethod:` -> `case JavaMethod.$type:`
- Line 13: `case LibEventType:` -> `case LibEventType.$type:`

Do NOT change the string literal comparisons in `getFQNFullname()` (line 36-38: `case 'BBjTypeRef':`, `case 'SimpleTypeRef':`, `case "JavaTypeRef":`) -- these are already string literals.
Do NOT change the string literal comparisons in `getClassRefNode()` (line 46-49) or `getClass()` (line 58-64) or `getClassRef()` (line 73-79) -- all use string literals.
Do NOT change `symbol.ref.$type === "JavaClass"` (lines 64, 79) -- these are string literal comparisons.

In `bbj-completion-provider.ts`, append `.$type` to the 2 equality comparisons:
- Line 43: `nodeDescription.type === LibSymbolicLabelDecl` -> `nodeDescription.type === LibSymbolicLabelDecl.$type`
- Line 46: `nodeDescription.type === LibEventType` -> `nodeDescription.type === LibEventType.$type`

Do NOT change imports -- the same constants are imported but now accessed via `.$type`.
  </action>
  <verify>
Run: `grep -n 'case [A-Z][a-zA-Z]*:' bbj-vscode/src/language/bbj-nodedescription-provider.ts | grep -v "case '"  | grep -v 'case "'`
Expected: Zero matches (only string-literal cases should remain without .$type).

Run: `grep -c '\.\$type' bbj-vscode/src/language/bbj-nodedescription-provider.ts`
Expected: 4

Run: `grep -c '\.\$type' bbj-vscode/src/language/bbj-completion-provider.ts`
Expected: 2
  </verify>
  <done>All 4 switch cases in bbj-nodedescription-provider.ts and 2 equality comparisons in bbj-completion-provider.ts use .$type suffix.</done>
</task>

</tasks>

<verification>
1. `grep -rn 'case [A-Z][a-zA-Z]*:$' bbj-vscode/src/language/bbj-node-kind.ts bbj-vscode/src/language/bbj-semantic-token-provider.ts bbj-vscode/src/language/bbj-nodedescription-provider.ts` should return zero matches
2. `grep -rn '\.\$type' bbj-vscode/src/language/bbj-node-kind.ts bbj-vscode/src/language/bbj-semantic-token-provider.ts bbj-vscode/src/language/bbj-nodedescription-provider.ts bbj-vscode/src/language/bbj-completion-provider.ts` should show 22 total .$type usages (13+3+4+2)
3. String literal cases (`case 'BBjTypeRef':`, `case "JavaTypeRef":`, etc.) remain unchanged
</verification>

<success_criteria>
- All 22 type constant usages in 4 provider files migrated to .$type pattern
- No string literal comparisons accidentally modified
- Imports remain unchanged (same constants, just accessed differently)
</success_criteria>

<output>
After completion, create `.planning/phases/15-core-api-renames-&-type-constants/15-01-SUMMARY.md`
</output>
