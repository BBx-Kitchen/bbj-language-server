---
phase: 17-build-verification-test-suite
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/language/bbj-scope-local.ts
  - bbj-vscode/src/language/bbj-scope.ts
  - bbj-vscode/src/language/bbj-validator.ts
  - bbj-vscode/src/language/bbj-hover.ts
  - bbj-vscode/src/language/bbj-ws-manager.ts
  - bbj-vscode/src/language/bbj-document-builder.ts
  - bbj-vscode/src/language/validations/line-break-validation.ts
autonomous: true

must_haves:
  truths:
    - "`tsc -b tsconfig.json` in bbj-vscode/ completes with zero errors"
    - "All 21 TypeScript compilation errors from the Langium 4 migration are resolved"
    - "No new compilation errors introduced by the fixes"
  artifacts:
    - path: "bbj-vscode/src/language/bbj-scope-local.ts"
      provides: "LocalSymbols stream API usage (.getStream() instead of .get()), MultiMap cast for .add(), processNode without invalid override"
    - path: "bbj-vscode/src/language/bbj-scope.ts"
      provides: "LocalSymbols stream API, CstNode .astNode property, typed member parameter"
    - path: "bbj-vscode/src/language/bbj-validator.ts"
      provides: "FieldDecl.$type constant, CompositeCstNode .content property"
    - path: "bbj-vscode/src/language/bbj-hover.ts"
      provides: "getAstNodeHoverContent returns MaybePromise<string | undefined>"
    - path: "bbj-vscode/src/language/bbj-ws-manager.ts"
      provides: "Updated traverseFolder signature, shouldIncludeEntry rename"
    - path: "bbj-vscode/src/language/bbj-document-builder.ts"
      provides: "override modifier on buildDocuments"
    - path: "bbj-vscode/src/language/validations/line-break-validation.ts"
      provides: "CstNode .astNode property instead of .element"
  key_links:
    - from: "bbj-scope-local.ts"
      to: "langium LocalSymbols interface"
      via: ".getStream() and MultiMap cast for .add()"
      pattern: "getStream\\(|as MultiMap"
    - from: "bbj-hover.ts"
      to: "langium AstNodeHoverProvider"
      via: "override getAstNodeHoverContent returning string"
      pattern: "MaybePromise<string"
---

<objective>
Fix all 21 TypeScript compilation errors remaining from the Langium 3-to-4 migration across 7 source files.

Purpose: Compilation must be clean before tests, bundling, and build verification can proceed. These are all Phase 14-16 migration gaps -- mechanical fixes following documented Langium 4 API patterns.

Output: All 7 files compile cleanly with `tsc -b tsconfig.json` producing zero errors.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-build-verification-test-suite/17-RESEARCH.md

@bbj-vscode/src/language/bbj-scope-local.ts
@bbj-vscode/src/language/bbj-scope.ts
@bbj-vscode/src/language/bbj-validator.ts
@bbj-vscode/src/language/bbj-hover.ts
@bbj-vscode/src/language/bbj-ws-manager.ts
@bbj-vscode/src/language/bbj-document-builder.ts
@bbj-vscode/src/language/validations/line-break-validation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix LocalSymbols API and CstNode property errors (16 errors across 4 files)</name>
  <files>
    bbj-vscode/src/language/bbj-scope-local.ts
    bbj-vscode/src/language/bbj-scope.ts
    bbj-vscode/src/language/bbj-validator.ts
    bbj-vscode/src/language/validations/line-break-validation.ts
  </files>
  <action>
Fix errors by category. Read each file, apply fixes, verify with `tsc`.

**LocalSymbols API in bbj-scope-local.ts (5 errors at lines ~81, 104, 158, 262):**
- Line 81: Remove `override` keyword from `processNode` method (not in base class anymore, or was never there)
- Lines 104 and 158: Replace `scopes.get(node)` with `scopes.getStream(node).toArray()` and add explicit type annotation to the `.filter()` callback parameter (e.g., `(descr: AstNodeDescription) => ...`) to fix the implicit `any` errors
- Line 262: Replace `scopes.add(...)` with `(scopes as MultiMap<AstNode, AstNodeDescription>).add(...)` -- import `MultiMap` from `langium`

**LocalSymbols API in bbj-scope.ts (4 errors at lines ~145, 248, 249, 337, 340):**
- Lines 145, 248, 337: Replace `scopes.get(node)` with `scopes.getStream(node).toArray()`
- Line 249: Add explicit type annotation to callback parameter to fix implicit `any`
- Line 340: Add explicit type annotation to `member` parameter to fix implicit `any`

**CstNode API in bbj-scope.ts (2 errors at lines ~206, 208):**
- Replace `.element` with `.astNode` on CstNode references

**CstNode API in bbj-validator.ts (2 errors at lines ~271, 276):**
- Replace `.children` with `.content` on CompositeCstNode references

**Type constant in bbj-validator.ts (1 error at line ~71):**
- Replace string `'FieldDecl'` with `FieldDecl.$type` -- import `FieldDecl` from generated ast if not already imported

**CstNode API in line-break-validation.ts (1 error at line ~114):**
- Replace `.element` with `.astNode` on LeafCstNode reference

After all fixes, run: `cd bbj-vscode && npx tsc -b tsconfig.json --pretty 2>&1 | head -80`

If new errors appear, fix them iteratively until tsc reports zero errors.
  </action>
  <verify>
Run `cd bbj-vscode && npx tsc -b tsconfig.json` -- must exit with code 0 and produce no error output.
If any errors remain, iterate until clean.
  </verify>
  <done>bbj-scope-local.ts, bbj-scope.ts, bbj-validator.ts, and line-break-validation.ts compile without errors. The 16 LocalSymbols + CstNode + type constant errors are resolved.</done>
</task>

<task type="auto">
  <name>Task 2: Fix method signature errors (5 errors across 3 files)</name>
  <files>
    bbj-vscode/src/language/bbj-hover.ts
    bbj-vscode/src/language/bbj-ws-manager.ts
    bbj-vscode/src/language/bbj-document-builder.ts
  </files>
  <action>
Fix the remaining 5 method signature mismatches. Read each file, apply targeted fixes.

**bbj-hover.ts (1 error at line ~20):**
- Change `getAstNodeHoverContent` return type from `Promise<Hover | undefined>` to `MaybePromise<string | undefined>`
- Instead of returning a `Hover` object `{ contents: { kind: MarkupKind.Markdown, value: content } }`, return just the markdown string
- Import `MaybePromise` from `langium` if not already imported
- Remove `Hover` and `MarkupKind` imports from `vscode-languageserver` if no longer used

**bbj-ws-manager.ts (2 errors at lines ~118, 121):**
- Line 118: The `traverseFolder` override has wrong signature (4 params instead of 2). Read the Langium 4 base class signature from `node_modules/langium/lib/workspace/workspace-manager.d.ts` to understand the new 2-param signature. If the custom logic in the override is still needed, rewrite for the new signature. If the override only called `super.traverseFolder()` with extra filtering, check if the new API already handles it. Consider removing the override entirely if the base class behavior suffices.
- Line 121: Rename `this.includeEntry(entry)` to `this.shouldIncludeEntry(entry)` (method was renamed in Langium 4)

**bbj-document-builder.ts (1 error at line ~13):**
- Add `override` keyword to the `buildDocuments` method declaration

After fixing, run: `cd bbj-vscode && npx tsc -b tsconfig.json --pretty 2>&1 | head -40`
  </action>
  <verify>
Run `cd bbj-vscode && npx tsc -b tsconfig.json` -- must exit with code 0 and zero errors. All 21 original compilation errors resolved.
  </verify>
  <done>All 7 files compile cleanly. `tsc -b tsconfig.json` exits with zero errors. The full TypeScript project compiles successfully.</done>
</task>

</tasks>

<verification>
```bash
cd bbj-vscode && npx tsc -b tsconfig.json 2>&1
echo "Exit code: $?"
```
Expected: No output, exit code 0.
</verification>

<success_criteria>
- `tsc -b tsconfig.json` produces zero errors and zero output
- All 21 documented compilation errors are fixed
- No new errors introduced
- All fixes follow Langium 4 API patterns documented in 17-RESEARCH.md
</success_criteria>

<output>
After completion, create `.planning/phases/17-build-verification-test-suite/17-01-SUMMARY.md`
</output>
