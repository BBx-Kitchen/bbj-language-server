---
phase: 14-deps-grammar
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/package.json
  - bbj-vscode/package-lock.json
  - bbj-vscode/src/language/generated/ast.ts
  - bbj-vscode/src/language/generated/grammar.ts
  - bbj-vscode/src/language/generated/module.ts
autonomous: true

must_haves:
  truths:
    - "npm install completes with zero peer dependency conflicts"
    - "langium and langium-cli are at target versions (4.1.3 and 4.1.0)"
    - "Only a single chevrotain version exists in node_modules (11.0.x)"
    - "langium generate runs without errors or warnings"
    - "Generated files (ast.ts, grammar.ts, module.ts) compile with tsc"
    - "No grammar syntax changes were required (or necessary changes applied)"
  artifacts:
    - path: "bbj-vscode/package.json"
      provides: "Updated langium and langium-cli version ranges"
      contains: "\"langium\": \"~4.1.3\""
    - path: "bbj-vscode/src/language/generated/ast.ts"
      provides: "Langium 4 AST type definitions with new type constant structure"
      contains: "\\$type"
    - path: "bbj-vscode/src/language/generated/grammar.ts"
      provides: "Regenerated serialized grammar JSON"
    - path: "bbj-vscode/src/language/generated/module.ts"
      provides: "Langium 4 DI module with AstReflection and Grammar"
  key_links:
    - from: "bbj-vscode/package.json"
      to: "node_modules/langium"
      via: "npm install resolution"
      pattern: "\"langium\": \"~4.1.3\""
    - from: "bbj-vscode/langium-config.json"
      to: "bbj-vscode/src/language/generated/"
      via: "langium generate reads config, writes generated files"
      pattern: "\"out\": \"src/language/generated\""
---

<objective>
Update langium from ~3.2.1 to ~4.1.3 and langium-cli from ~3.2.0 to ~4.1.0, then regenerate all grammar-derived code. This establishes the Langium 4 baseline that all subsequent migration phases (15-18) build upon.

Purpose: Install the new Langium 4 packages and regenerate the three auto-generated TypeScript files (ast.ts, grammar.ts, module.ts) so that generated code compiles cleanly. Hand-written source files WILL have compilation errors after this -- that is expected and intentional (deferred to Phase 15+).

Output: Updated package.json/package-lock.json with Langium 4 versions, and freshly regenerated generated/ files using Langium 4 patterns.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-deps-grammar/14-RESEARCH.md
@.planning/phases/14-deps-grammar/14-CONTEXT.md
@bbj-vscode/package.json
@bbj-vscode/langium-config.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Langium packages and verify dependency tree</name>
  <files>bbj-vscode/package.json, bbj-vscode/package-lock.json</files>
  <action>
    From the `bbj-vscode/` directory, update both langium packages atomically in a single npm install command:

    ```bash
    cd bbj-vscode
    npm install langium@~4.1.3 langium-cli@~4.1.0
    ```

    This updates both `dependencies.langium` from ~3.2.1 to ~4.1.3 and `devDependencies.langium-cli` from ~3.2.0 to ~4.1.0.

    IMPORTANT: Both packages MUST be updated in the same command. Do NOT update one before the other -- mismatched CLI and runtime versions produce incompatible generated code.

    After install completes:
    1. Run `npm list langium langium-cli` to confirm versions are 4.1.3 and 4.1.0 respectively
    2. Run `npm list chevrotain` to confirm a single chevrotain instance at 11.0.x (NOT duplicate versions)
    3. If duplicate chevrotain versions appear, run `npm dedupe` and re-check
    4. Check for any peer dependency warnings in the install output

    Do NOT change any other dependencies. Specifically:
    - chevrotain stays at ~11.0.3 (compatible with Langium 4.1.x, directly imported by bbj-token-builder.ts)
    - typescript stays at ^5.8.3 (already satisfies Langium 4's requirement)
    - All other packages remain unchanged
  </action>
  <verify>
    Run these commands from bbj-vscode/:
    - `npm list langium` shows langium@4.1.3
    - `npm list langium-cli` shows langium-cli@4.1.0
    - `npm list chevrotain` shows single instance at 11.0.x (no nested duplicates)
    - `npm ls 2>&1 | grep "peer dep"` shows no peer dependency issues (empty or no critical errors)
  </verify>
  <done>
    package.json has langium ~4.1.3 in dependencies and langium-cli ~4.1.0 in devDependencies. npm install completed without peer dependency conflicts. Single chevrotain 11.0.x instance in node_modules.
  </done>
</task>

<task type="auto">
  <name>Task 2: Regenerate grammar and verify generated code compiles</name>
  <files>bbj-vscode/src/language/generated/ast.ts, bbj-vscode/src/language/generated/grammar.ts, bbj-vscode/src/language/generated/module.ts</files>
  <action>
    From the `bbj-vscode/` directory, regenerate all grammar-derived code:

    ```bash
    cd bbj-vscode
    npx langium generate
    ```

    Check the output carefully:
    1. Confirm it says "Langium generator version: 4.1.0" (or similar 4.x header)
    2. Confirm it processes `src/language/bbj.langium` and `src/language/java-types.langium` without errors
    3. Check for ANY `[ERROR]` or `[WARN]` lines -- if grammar validation fails, the grammar files need fixing before proceeding
    4. Confirm it writes to `src/language/generated/`

    If grammar validation fails (unlikely but possible):
    - Read the error message carefully
    - The BBj grammar is fully owned, so fix forward (adapt grammar to Langium 4 expectations)
    - Both `bbj.langium` and `java-types.langium` can be modified freely
    - Re-run `npx langium generate` after fixes until it succeeds

    After successful generation, inspect the new generated code:
    1. Check `generated/ast.ts` for the new type constant pattern -- search for a known type like `MethodDecl` to see if it changed from `export const MethodDecl = 'MethodDecl'` to `export const MethodDecl = { $type: 'MethodDecl' }` (or similar)
    2. Note the new pattern -- this information is critical for Phase 15

    Then verify generated files compile in isolation:
    ```bash
    npx tsc --noEmit --skipLibCheck src/language/generated/ast.ts src/language/generated/grammar.ts src/language/generated/module.ts 2>&1 || true
    ```

    Note: The full project `tsc` WILL fail because hand-written source files reference Langium 3 APIs. That is expected. We only need to confirm the generated files themselves are valid TypeScript that imports correctly from the installed langium package. If the isolated tsc check above also fails (due to imports from hand-written code), check whether the errors are IN the generated files or just FROM files that import them. Generated file errors = problem. Errors in hand-written files = expected, Phase 15+.

    A simpler verification: just run `npx tsc --noEmit 2>&1` on the full project and confirm that NONE of the errors are in `src/language/generated/*.ts` files. Errors in other files are expected and acceptable for Phase 14.
  </action>
  <verify>
    Run these from bbj-vscode/:
    - `npx langium generate` exits with code 0 (no errors)
    - `npx tsc --noEmit 2>&1 | grep "src/language/generated/"` returns empty (no errors in generated files)
    - `ls -la src/language/generated/` shows all 3 files (ast.ts, grammar.ts, module.ts) with recent timestamps
    - `grep -c '\$type' src/language/generated/ast.ts` returns a positive number (confirming Langium 4 pattern)
  </verify>
  <done>
    `langium generate` completed successfully with zero errors/warnings. All three generated files (ast.ts, grammar.ts, module.ts) are freshly generated with Langium 4 patterns. No TypeScript errors exist in generated files (errors in hand-written source are expected and deferred to Phase 15+). No grammar syntax changes were required (or any necessary changes have been applied to .langium files).
  </done>
</task>

</tasks>

<verification>
Phase 14 is complete when ALL of these hold true:

1. **DEPS-01**: `npm list langium` shows 4.1.3
2. **DEPS-02**: `npm list langium-cli` shows 4.1.0
3. **DEPS-03**: `npm list chevrotain` shows single 11.0.x instance (no duplicates)
4. **DEPS-04**: `npm ls 2>&1 | grep -i "peer dep"` shows no unresolved peer dependency conflicts
5. **GRAM-01**: `npx langium generate` exits 0 and produces ast.ts + grammar.ts + module.ts
6. **GRAM-02**: `npx tsc --noEmit 2>&1 | grep "src/language/generated/"` returns empty (generated files compile)
7. **GRAM-03**: Grammar files (.langium) are unchanged OR changes are documented with rationale
</verification>

<success_criteria>
- langium@~4.1.3 in dependencies, langium-cli@~4.1.0 in devDependencies
- npm install clean (no peer dep conflicts)
- Single chevrotain instance at 11.0.x
- langium generate succeeds (exit 0)
- Generated ast.ts uses Langium 4 type constant pattern ($type property)
- Zero TypeScript errors in src/language/generated/ files
- Hand-written source errors are present but NOT addressed (Phase 15+ scope)
</success_criteria>

<output>
After completion, create `.planning/phases/14-deps-grammar/14-01-SUMMARY.md`

The summary MUST document:
1. Exact versions installed (langium, langium-cli, chevrotain)
2. Whether grammar changes were needed (and what, if any)
3. The new type constant pattern observed in generated ast.ts (critical for Phase 15)
4. Any warnings or unexpected behavior during install/generate
5. Count of tsc errors in hand-written source (for Phase 15 scoping)
</output>
