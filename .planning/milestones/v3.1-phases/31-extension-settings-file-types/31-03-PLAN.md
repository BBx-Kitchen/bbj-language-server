---
phase: 31-extension-settings-file-types
plan: 03
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - bbj-vscode/tools/em-login.bbj
  - bbj-vscode/tools/web.bbj
  - bbj-vscode/package.json
  - bbj-vscode/src/extension.ts
  - bbj-vscode/src/Commands/Commands.cjs
autonomous: true

must_haves:
  truths:
    - "Running 'BBj: Login to EM' command in VS Code prompts for credentials, launches BBj login stub and stores the returned token securely"
    - "BUI and DWC run commands in VS Code use the stored token instead of plaintext username/password"
    - "If no token is stored when a BUI/DWC run is triggered, the user is auto-prompted to log in first"
    - "No plaintext passwords are stored in VS Code settings after migration"
    - "The bbj.em.url setting is visible in VS Code settings"
  artifacts:
    - path: "bbj-vscode/tools/em-login.bbj"
      provides: "BBj stub program that authenticates via BBjAdminFactory and returns auth result to stdout"
    - path: "bbj-vscode/package.json"
      provides: "bbj.em.url setting and bbj.loginEM command registration"
      contains: "bbj.em.url"
    - path: "bbj-vscode/src/extension.ts"
      provides: "Login to EM command implementation using SecretStorage"
      contains: "loginEM"
  key_links:
    - from: "bbj-vscode/src/extension.ts"
      to: "bbj-vscode/tools/em-login.bbj"
      via: "child_process exec to launch BBj with em-login.bbj stub"
    - from: "bbj-vscode/src/extension.ts"
      to: "VS Code SecretStorage"
      via: "context.secrets.store/get for token"
    - from: "bbj-vscode/src/Commands/Commands.cjs"
      to: "bbj-vscode/src/extension.ts"
      via: "getEMToken callback for run commands"
---

<objective>
Create the BBj login stub program and implement token-based EM authentication in VS Code using SecretStorage. Remove plaintext EM credentials from settings and update BUI/DWC run commands to use the stored token with auto-prompt login.

Purpose: Delivers CONF-03 (token-based EM auth) for VS Code. Eliminates the security tech debt of plaintext EM passwords in settings.
Output: em-login.bbj stub, VS Code "BBj: Login to EM" command, SecretStorage-backed token, updated run commands with auto-prompt.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-extension-settings-file-types/31-CONTEXT.md
@.planning/phases/31-extension-settings-file-types/31-RESEARCH.md
@.planning/phases/31-extension-settings-file-types/31-01-SUMMARY.md
@bbj-vscode/tools/web.bbj
@bbj-vscode/src/extension.ts
@bbj-vscode/src/Commands/Commands.cjs
@bbj-vscode/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Research BBj Admin API and create em-login.bbj stub + update web.bbj</name>
  <files>
    bbj-vscode/tools/em-login.bbj
    bbj-vscode/tools/web.bbj
  </files>
  <action>
**PREREQUISITE: Verify BBj Admin API capabilities BEFORE implementation.**

1. Check the BBj Admin API javadoc in the local BBj installation:
   - Look in `{bbj.home}/documentation/javadoc/` for BBjAdmin class docs
   - Search for `getAuthToken`, `getToken`, `getJWT`, or any token-related method on the `BBjAdmin` interface
   - Search for token-accepting overloads of `BBjAdminFactory.getBBjAdmin()`
   - Run: `grep -r "getAuthToken\|getToken\|getJWT\|AuthToken" {bbjdir}/documentation/javadoc/ 2>/dev/null`
   - Also check: `find {bbjdir}/documentation -name "*.html" | head -20` to see what javadoc is available

2. If `getAuthToken()` (or equivalent) EXISTS on BBjAdmin:
   - Implement em-login.bbj as described below (token-based flow)
   - Update web.bbj to accept token parameter

3. If NO token-based API exists:
   - **Fallback design**: em-login.bbj still authenticates via `BBjAdminFactory.getBBjAdmin(username!, password!)` to VALIDATE credentials, then prints "OK" to stdout (confirms creds are valid)
   - Store the encrypted username/password in SecretStorage instead of a JWT
   - web.bbj continues using username/password (no token param needed)
   - The key outcome is still achieved: no plaintext passwords in VS Code settings -- credentials are stored in SecretStorage/PasswordSafe instead
   - NOTE: If using this fallback, adjust Task 2 and Task 3 to store username+password in SecretStorage instead of a JWT token

**Create em-login.bbj (primary implementation -- token-based):**

Create a new BBj program `bbj-vscode/tools/em-login.bbj` that:
1. Accepts command line parameters: username, password
2. Calls `BBjAdminFactory.getBBjAdmin(username!, password!)` to authenticate
3. Gets the auth token via `admin!.getAuthToken()` (or the discovered method name)
4. Prints the token to stdout using `PRINT` so the calling IDE can capture it
5. Handles errors gracefully by printing "ERROR:" prefix

Pattern:
```bbj
rem BBj EM Login Stub - Authenticates and returns token
rem Parameters:
rem   1) username
rem   2) password

? 'HIDE'

username! = ARGV(1,err=*next)
password! = ARGV(2,err=*next)

if (username! = null()) then
    print "ERROR:Username required"
    release
fi
if (password! = null()) then
    print "ERROR:Password required"
    release
fi

rem Authenticate and get token
admin! = BBjAdminFactory.getBBjAdmin(username!, password!, err=authFailed)
token! = admin!.getAuthToken()
print token!
release

authFailed:
print "ERROR:Authentication failed - invalid credentials"
release
```

**Update web.bbj (only if token-based API exists):**

The existing web.bbj takes username and password as params 5 and 6. Add a new optional parameter (param 8) for the auth token:
```bbj
token! = ARGV(8,err=*next)
```

Change the authentication logic to prefer token if provided:
```bbj
if (token! <> null() and token! > "") then
    rem Token-based auth
    admin! = BBjAdminFactory.getBBjAdmin(token!)
else
    rem Legacy username/password auth (backwards compatible)
    if (username! = null()) username! = "admin"
    if (password! = null()) password! = "admin123"
    admin! = BBjAdminFactory.getBBjAdmin(username!, password!)
fi
```

If BBjAdminFactory has no token-accepting overload, skip the web.bbj changes -- web.bbj will continue using username/password parameters passed from the IDE's SecretStorage.
  </action>
  <verify>
1. File `bbj-vscode/tools/em-login.bbj` exists and contains BBjAdminFactory authentication code
2. If token API exists: web.bbj handles token parameter with fallback
3. If token API does not exist: em-login.bbj validates credentials and prints "OK", web.bbj unchanged
  </verify>
  <done>
BBj Admin API has been investigated. em-login.bbj stub created with appropriate authentication approach (token-based if API supports it, credential-validation if not). web.bbj updated if token-based factory method exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: VS Code EM settings + login command + SecretStorage</name>
  <files>
    bbj-vscode/package.json
    bbj-vscode/src/extension.ts
  </files>
  <action>
**package.json changes:**

1. Add new setting `bbj.em.url`:
   ```json
   "bbj.em.url": {
       "type": ["string", "null"],
       "default": null,
       "description": "Enterprise Manager URL (e.g., http://localhost:8888). Used for EM login and web-based run commands.",
       "scope": "window"
   }
   ```

2. REMOVE the plaintext credential settings:
   - Remove `bbj.web.username`
   - Remove `bbj.web.password`

   NOTE: Keep `bbj.web.apps` and `bbj.web.AutoSaveUponRun` since those aren't credentials.

3. Add new command in `contributes.commands`:
   ```json
   {
       "category": "BBj",
       "command": "bbj.loginEM",
       "title": "Login to Enterprise Manager"
   }
   ```

4. Add `"onCommand:bbj.loginEM"` to `activationEvents`.

**extension.ts changes:**

1. Register the new login command. Implementation:
   ```typescript
   vscode.commands.registerCommand("bbj.loginEM", async () => {
       const config = vscode.workspace.getConfiguration("bbj");
       const bbjHome = config.get<string>("home");

       if (!bbjHome) {
           vscode.window.showErrorMessage("Please set bbj.home first", "Open Settings").then(sel => {
               if (sel === "Open Settings") {
                   vscode.commands.executeCommand('workbench.action.openSettings', 'bbj.home');
               }
           });
           return;
       }

       // Prompt for credentials
       const username = await vscode.window.showInputBox({
           prompt: "EM Username",
           value: "admin",
           ignoreFocusOut: true
       });
       if (!username) return;

       const password = await vscode.window.showInputBox({
           prompt: "EM Password",
           password: true,
           ignoreFocusOut: true
       });
       if (password === undefined) return;

       // Launch em-login.bbj to get token
       const bbj = path.join(bbjHome, 'bin', `bbj${process.platform === 'win32' ? '.exe' : ''}`);
       const emLoginPath = context.asAbsolutePath(path.join('tools', 'em-login.bbj'));

       try {
           const result = await new Promise<string>((resolve, reject) => {
               const { exec } = require('child_process');
               exec(`"${bbj}" -q "${emLoginPath}" - "${username}" "${password}"`,
                   { timeout: 15000 },
                   (err: any, stdout: string, stderr: string) => {
                       if (err) {
                           reject(new Error(stderr || err.message));
                           return;
                       }
                       const output = stdout.trim();
                       if (output.startsWith('ERROR:')) {
                           reject(new Error(output.substring(6)));
                           return;
                       }
                       resolve(output);
                   }
               );
           });

           // Store token in SecretStorage (JWT if token API exists, or username:password if fallback)
           await context.secrets.store('bbj.em.token', result);
           vscode.window.showInformationMessage('Successfully logged in to Enterprise Manager');
       } catch (error) {
           vscode.window.showErrorMessage(`EM login failed: ${error}`);
       }
   });
   ```

2. Export a function `getEMToken` that Commands.cjs can use:
   Create a module-level variable to hold the secrets reference and a getter:
   ```typescript
   let secretStorage: vscode.SecretStorage;

   export async function getEMToken(): Promise<string | undefined> {
       return secretStorage?.get('bbj.em.token');
   }
   ```
   Set `secretStorage = context.secrets` in activate().

3. Export the `getEMToken` function so Commands.cjs can import it.
  </action>
  <verify>
1. `node -e "const p = require('./bbj-vscode/package.json'); console.log(p.contributes.configuration.properties['bbj.em.url']); console.log(p.contributes.configuration.properties['bbj.web.username'])"` -- em.url exists, web.username is undefined
2. `grep -c "loginEM" bbj-vscode/src/extension.ts` returns >= 2 (registration + implementation)
3. `grep -c "SecretStorage\|secrets" bbj-vscode/src/extension.ts` returns >= 1
4. `grep -c "web\.username\|web\.password" bbj-vscode/package.json` returns 0 (removed)
  </verify>
  <done>
VS Code has bbj.em.url setting, "BBj: Login to EM" command with SecretStorage token storage, and plaintext EM credentials removed from settings.
  </done>
</task>

<task type="auto">
  <name>Task 3: VS Code BUI/DWC run command wiring with auto-prompt login</name>
  <files>
    bbj-vscode/src/Commands/Commands.cjs
    bbj-vscode/src/extension.ts
  </files>
  <action>
**Commands.cjs changes:**

1. Update `runWeb(params, client)` to accept an optional 3rd parameter `token`:
   `function runWeb(params, client, token)`

2. When token is provided, add it as ARGV(8) to web.bbj command line (if Task 1 determined token-based API exists).
   When token is not provided, fall back to reading username/password from config (backwards compatible during transition).

   If the fallback design was used in Task 1 (no JWT API, credentials stored in SecretStorage), the token parameter will contain "username:password" format. Parse and pass as params 5 and 6 to web.bbj.

3. Update the module.exports to pass token through:
   ```javascript
   module.exports = {
       // ...
       runBUI: (params, token) => runWeb(params, "BUI", token),
       runDWC: (params, token) => runWeb(params, "DWC", token),
       // ...
   };
   ```

**extension.ts changes (BUI/DWC command wiring):**

Replace the direct command registrations for BUI and DWC with wrappers that auto-prompt login per locked decision ("auto-prompt on first EM access if not logged in"):

```typescript
vscode.commands.registerCommand("bbj.runBUI", async (params) => {
    let token = await getEMToken();
    if (!token) {
        const login = await vscode.window.showInformationMessage(
            'EM login required for BUI. Login now?', 'Login', 'Cancel'
        );
        if (login === 'Login') {
            await vscode.commands.executeCommand('bbj.loginEM');
            token = await getEMToken();
        }
        if (!token) return; // User cancelled login
    }
    Commands.runBUI(params, token);
});

vscode.commands.registerCommand("bbj.runDWC", async (params) => {
    let token = await getEMToken();
    if (!token) {
        const login = await vscode.window.showInformationMessage(
            'EM login required for DWC. Login now?', 'Login', 'Cancel'
        );
        if (login === 'Login') {
            await vscode.commands.executeCommand('bbj.loginEM');
            token = await getEMToken();
        }
        if (!token) return; // User cancelled login
    }
    Commands.runDWC(params, token);
});
```

For the `bbj.run` (GUI) command -- it doesn't use web.bbj, so no EM auth needed. Leave unchanged.
  </action>
  <verify>
1. `grep "getEMToken\|token" bbj-vscode/src/Commands/Commands.cjs` -- token handling present
2. `grep -c "showInformationMessage.*Login now" bbj-vscode/src/extension.ts` returns >= 2 (BUI + DWC auto-prompt)
3. `npx tsc --noEmit -p bbj-vscode/tsconfig.json` compiles without errors
  </verify>
  <done>
BUI/DWC run commands retrieve token from SecretStorage and pass to web.bbj. If no token stored, user is auto-prompted to log in first (per locked decision). GUI run command unchanged.
  </done>
</task>

</tasks>

<verification>
1. em-login.bbj exists in tools/ directory with BBjAdminFactory auth
2. BBj Admin API was investigated before implementation (prerequisite research)
3. web.bbj updated if token-based API exists (backward compatible), unchanged if fallback
4. package.json has bbj.em.url, bbj.loginEM command, no bbj.web.username/password
5. extension.ts registers loginEM command with SecretStorage
6. Commands.cjs runWeb accepts and passes token to web.bbj
7. BUI/DWC commands auto-prompt login if no token stored (not just error -- auto-prompt per locked decision)
8. TypeScript compiles: `npx tsc --noEmit -p bbj-vscode/tsconfig.json`
</verification>

<success_criteria>
- "BBj: Login to EM" command prompts for credentials, launches em-login.bbj, stores token in SecretStorage
- BUI/DWC run commands retrieve token from SecretStorage and pass to web.bbj
- If no token stored, user is auto-prompted to log in before BUI/DWC run (not just an error)
- No plaintext passwords in VS Code settings
- bbj.em.url setting available in VS Code settings
</success_criteria>

<output>
After completion, create `.planning/phases/31-extension-settings-file-types/31-03-SUMMARY.md`
</output>
