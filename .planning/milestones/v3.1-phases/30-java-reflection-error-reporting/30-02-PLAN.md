---
phase: 30-java-reflection-error-reporting
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/language/bbj-linker.ts
  - bbj-vscode/src/language/bbj-document-validator.ts
autonomous: true

must_haves:
  truths:
    - "Cyclic reference errors appear in the Problems panel with Error severity (red)"
    - "Cyclic reference error messages include the source filename and line number where the cycle was detected"
    - "Users can click related information links to navigate to other files in the cycle"
    - "Existing linking error behavior (unresolved references showing as warnings) is unchanged"
  artifacts:
    - path: "bbj-vscode/src/language/bbj-linker.ts"
      provides: "Override of throwCyclicReferenceError that converts thrown errors to diagnostic-compatible data"
    - path: "bbj-vscode/src/language/bbj-document-validator.ts"
      provides: "Cyclic reference errors reported as Error severity (not downgraded to Warning)"
  key_links:
    - from: "bbj-vscode/src/language/bbj-linker.ts"
      to: "bbj-vscode/src/language/bbj-document-validator.ts"
      via: "Linking errors flow through document validation to become LSP diagnostics"
      pattern: "LinkingError|toDiagnostic"
---

<objective>
Make cyclic reference errors include source filename and line number, appear with Error severity in the Problems panel, and provide clickable LSP relatedInformation links for navigating to other files in the cycle.

Purpose: Currently, cyclic reference errors thrown by Langium's DefaultLinker only include an AST path like `/statements@0/assignments@0/value/method/member` but no file or line info. Users cannot find the source of the cycle. This makes debugging cyclic references extremely frustrating.

Output: Enhanced cyclic reference diagnostics with file+line info and LSP relatedInformation links.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bbj-vscode/src/language/bbj-linker.ts
@bbj-vscode/src/language/bbj-document-validator.ts
@bbj-vscode/node_modules/langium/lib/references/linker.js (for throwCyclicReferenceError signature)
@bbj-vscode/node_modules/langium/src/validation/document-validator.ts (for processLinkingErrors signature and LinkingErrorData type)
@.planning/phases/30-java-reflection-error-reporting/30-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Override throwCyclicReferenceError in BbjLinker</name>
  <files>bbj-vscode/src/language/bbj-linker.ts</files>
  <action>
Override `throwCyclicReferenceError` in `BbjLinker` to convert the thrown error into a LinkingError with enhanced context instead of a bare Error. The Langium DefaultLinker signature is:

```typescript
protected throwCyclicReferenceError(node: AstNode, property: string, refText: string): never;
```

This method is called from within the reference proxy's `ref` getter (in `buildReference`/`buildMultiReference`). It throws an Error that bubbles up and is caught by Langium's `getLinkedNode()` method which then stores the error as a LinkingError on the reference.

**Approach:** Override `throwCyclicReferenceError` to throw an error with enhanced information. Since the method must throw (return type `never`), we cannot convert it to a diagnostic here. Instead, enhance the error message to include:
1. The document URI and line number
2. The symbol name (`refText`)

Then also enhance `createLinkingError` to detect cyclic reference errors and add `relatedInformation`.

Implementation steps:

1. Add necessary imports at the top of `bbj-linker.ts`:
   - `AstNode` (already imported)
   - `DiagnosticRelatedInformation`, `Location`, `Range` from `vscode-languageserver` (add if not present)

2. Override `throwCyclicReferenceError` in `BbjLinker`:
   ```typescript
   protected override throwCyclicReferenceError(node: AstNode, property: string, refText: string): never {
       // Get source location information
       const document = AstUtils.getDocument(node);
       const cstNode = node.$cstNode;
       const line = cstNode ? cstNode.range.start.line + 1 : 0;
       const sourceInfo = this.getSourceLocationForNode(document, line);

       const message = sourceInfo
           ? `Cyclic reference resolution detected for '${refText}' [in ${sourceInfo}]`
           : `Cyclic reference resolution detected for '${refText}'`;

       // Throw with enhanced message — Langium's getLinkedNode catches this
       // and stores it as a LinkingError on the reference
       throw new Error(message);
   }
   ```

3. Add a helper method `getSourceLocationForNode` that extracts file+line from a document:
   ```typescript
   protected getSourceLocationForNode(document: LangiumDocument | undefined, line: number): string | undefined {
       if (!document) return undefined;
       try {
           const wsManager = this.wsManager();
           let workspaceRoot: string | undefined;
           const folders = wsManager.workspaceFolders;
           if (folders && folders.length > 0) {
               const wsUri = URI.parse(folders[0].uri);
               workspaceRoot = wsUri.fsPath;
           }
           if (!workspaceRoot) {
               workspaceRoot = dirname(document.uri.fsPath);
           }
           const relativePath = relative(workspaceRoot, document.uri.fsPath);
           return line > 0 ? `${relativePath}:${line}` : relativePath;
       } catch {
           return undefined;
       }
   }
   ```

Note: `dirname` and `relative` are already imported from `node:path`. `AstUtils` and `LangiumDocument` are already imported. `URI` is already imported from `vscode-uri`.

**IMPORTANT:** The error thrown here gets caught by Langium's internal `getLinkedNode()`, which converts it to a LinkingError stored on the reference. This LinkingError then flows through the validation pipeline where `BBjDocumentValidator.toDiagnostic()` converts it to an LSP Diagnostic. The message enhancement done here ensures the user sees file+line in the Problems panel.
  </action>
  <verify>
1. Run `cd /Users/beff/_workspace/bbj-language-server && npx vitest run` — all tests pass
2. Review: `throwCyclicReferenceError` override includes file+line in error message
3. Review: New helper method properly handles missing document/workspace gracefully
  </verify>
  <done>
throwCyclicReferenceError is overridden in BbjLinker with enhanced error messages that include source filename and line number. Helper method handles edge cases gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Keep cyclic reference errors as Error severity and populate relatedInformation</name>
  <files>bbj-vscode/src/language/bbj-document-validator.ts</files>
  <action>
Currently, `BBjDocumentValidator.toDiagnostic()` downgrades ALL linking errors to Warning severity (line 14). Cyclic reference errors are a specific kind of linking error that should remain as Error severity per user decision. Additionally, per user decision, cyclic reference diagnostics must populate the LSP `relatedInformation` field so users can click to navigate to other files in the cycle.

**The challenge:** `throwCyclicReferenceError` must throw (return type `never`), so relatedInformation cannot be set at throw-time. Instead, the pipeline is:
1. `throwCyclicReferenceError` throws an `Error` with enhanced message including `[in path/file.bbj:line]`
2. Langium's `getLinkedNode()` catches it and creates a `LinkingError` with `{ info: refInfo, message: errorMessage }`
3. `processLinkingErrors` in `DefaultDocumentValidator` creates a `DiagnosticInfo` from the `LinkingError`
4. `toDiagnostic` converts the `DiagnosticInfo` into the final `Diagnostic`

The `relatedInformation` must be populated at step 3 or 4, since that's after the throw. The best approach is to override `processLinkingErrors` to detect cyclic reference errors and populate `relatedInformation` on the `DiagnosticInfo` before it reaches `toDiagnostic`.

**Part A: Override `processLinkingErrors` to populate relatedInformation for cyclic references**

Add the following imports to `bbj-document-validator.ts`:
- `DiagnosticRelatedInformation`, `Location`, `Range` from `vscode-languageserver` (some may already be imported)
- `LangiumDocument` from `langium`
- `ValidationOptions` from `langium` (needed for override signature)

Override `processLinkingErrors`:
```typescript
protected override processLinkingErrors(document: LangiumDocument, diagnostics: Diagnostic[], _options: ValidationOptions): void {
    for (const reference of document.references) {
        const linkingError = reference.error;
        if (linkingError) {
            const info: DiagnosticInfo<AstNode, string> = {
                node: linkingError.info.container,
                range: reference.$refNode?.range,
                property: linkingError.info.property,
                index: linkingError.info.index,
                data: {
                    code: DocumentValidator.LinkingError,
                    containerType: linkingError.info.container.$type,
                    property: linkingError.info.property,
                    refText: linkingError.info.reference.$refText
                } satisfies LinkingErrorData
            };

            // For cyclic reference errors, extract source location from
            // the enhanced message and populate relatedInformation
            if (linkingError.message.includes('Cyclic reference')) {
                const relatedInfo = this.extractCyclicReferenceRelatedInfo(linkingError.message, document);
                if (relatedInfo.length > 0) {
                    info.relatedInformation = relatedInfo;
                }
            }

            diagnostics.push(this.toDiagnostic('error', linkingError.message, info));
        }
    }
}
```

Note: This duplicates Langium's `processLinkingErrors` logic but adds the relatedInformation population for cyclic references. The `LinkingErrorData` type needs to be imported — check Langium's exports. If `LinkingErrorData` is not exported, define the satisfies inline as `{ code: string, containerType: string, property: string, refText: string }`.

**Part B: Add helper method to extract related information from cyclic reference messages**

The enhanced message from Task 1's `throwCyclicReferenceError` has format:
`"... Cyclic reference resolution detected for 'SymbolName' [in relative/path.bbj:42]"`

Extract the file path and line number, then build `DiagnosticRelatedInformation` entries:

```typescript
private extractCyclicReferenceRelatedInfo(
    message: string,
    currentDocument: LangiumDocument
): DiagnosticRelatedInformation[] {
    const relatedInfo: DiagnosticRelatedInformation[] = [];

    // Extract source location from "[in path:line]" in the error message
    const sourceMatch = message.match(/\[in ([^\]]+)\]/);
    if (sourceMatch) {
        const sourceRef = sourceMatch[1]; // e.g., "relative/path.bbj:42"
        const colonIdx = sourceRef.lastIndexOf(':');
        let filePath = sourceRef;
        let line = 0;

        if (colonIdx > 0) {
            const lineStr = sourceRef.substring(colonIdx + 1);
            const parsedLine = parseInt(lineStr, 10);
            if (!isNaN(parsedLine)) {
                filePath = sourceRef.substring(0, colonIdx);
                line = parsedLine - 1; // Convert to 0-based
            }
        }

        // Resolve the relative path against the workspace root or current document directory
        // The current document's URI can be used as the base for resolution
        // The relatedInformation location uses the CURRENT document URI since the cycle
        // involves the current file referencing itself or another file
        const range: Range = {
            start: { line: Math.max(0, line), character: 0 },
            end: { line: Math.max(0, line), character: Number.MAX_SAFE_INTEGER }
        };

        relatedInfo.push({
            location: {
                uri: currentDocument.uri.toString(),
                range: range
            },
            message: `Cyclic reference detected in this file`
        });
    }

    return relatedInfo;
}
```

**IMPORTANT:** The `relatedInformation` links here point to the current document since the cyclic reference is detected within the same document's reference resolution. If in the future more context about the OTHER files in the cycle becomes available (e.g., by tracking resolution chain), additional entries can be added. For now, the source location in the message (from Task 1) provides the file+line that the user needs.

**Part C: Modify `toDiagnostic()` to distinguish severity**

Update `toDiagnostic()` to keep cyclic reference errors as Error severity while downgrading other linking errors to Warning:

```typescript
protected override toDiagnostic<N extends AstNode>(severity: 'error' | 'warning' | 'info' | 'hint', message: string, info: DiagnosticInfo<N, string>): Diagnostic {
    let diagnosticSeverity: DiagnosticSeverity;

    if ((info.data as DiagnosticData)?.code === DocumentValidator.LinkingError) {
        // Cyclic reference errors stay as Error severity; other linking errors downgrade to Warning
        diagnosticSeverity = message.includes('Cyclic reference')
            ? DiagnosticSeverity.Error
            : DiagnosticSeverity.Warning;
    } else {
        diagnosticSeverity = toDiagnosticSeverity(severity);
    }

    return {
        message,
        range: getDiagnosticRange(info),
        severity: diagnosticSeverity,
        code: info.code,
        codeDescription: info.codeDescription,
        tags: info.tags,
        relatedInformation: info.relatedInformation,
        data: info.data,
        source: this.getSource()
    };
}
```

This preserves the existing behavior for regular linking errors (unresolved references -> Warning) while ensuring cyclic reference errors appear as Error (red) in the Problems panel, with clickable relatedInformation links.
  </action>
  <verify>
1. Run `cd /Users/beff/_workspace/bbj-language-server && npx vitest run` — all tests pass
2. Review: Regular linking errors still become Warnings
3. Review: Cyclic reference errors are Error severity
4. Review: Cyclic reference errors have populated `relatedInformation` array with location entries
5. Review: `processLinkingErrors` override correctly replicates Langium's base behavior plus adds relatedInformation
  </verify>
  <done>
BBjDocumentValidator correctly distinguishes cyclic reference errors (Error severity) from regular linking errors (Warning severity). Cyclic reference diagnostics populate the LSP `relatedInformation` field with clickable location links extracted from the enhanced error message. No regressions in existing diagnostic behavior.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` — all existing tests pass
2. Code review: BbjLinker.throwCyclicReferenceError includes file+line info
3. Code review: BBjDocumentValidator differentiates cyclic errors from regular linking errors
4. Code review: Cyclic reference diagnostics have populated `relatedInformation` array
5. Code review: `processLinkingErrors` override correctly replicates Langium's base logic for non-cyclic errors
6. Code review: No changes to existing linking error behavior for non-cyclic references
</verification>

<success_criteria>
- Cyclic reference errors include source filename and line number in their message
- Cyclic reference errors appear with Error severity (red) in Problems panel
- Cyclic reference diagnostics populate `relatedInformation` with clickable LSP DiagnosticRelatedInformation entries
- Regular linking errors (unresolved references) still appear as Warnings (existing behavior preserved)
- All existing tests pass without regression
</success_criteria>

<output>
After completion, create `.planning/phases/30-java-reflection-error-reporting/30-02-SUMMARY.md`
</output>
