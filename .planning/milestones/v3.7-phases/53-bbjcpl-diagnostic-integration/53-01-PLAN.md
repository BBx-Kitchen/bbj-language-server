---
phase: 53-bbjcpl-diagnostic-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/language/bbj-cpl-parser.ts
  - bbj-vscode/src/language/bbj-document-validator.ts
  - bbj-vscode/package.json
  - bbj-vscode/src/language/main.ts
  - bbj-vscode/src/language/bbj-ws-manager.ts
  - bbj-vscode/test/cpl-parser.test.ts
autonomous: true
requirements:
  - CPL-05
  - CPL-06
  - CPL-07

must_haves:
  truths:
    - "BBjCPL diagnostics carry source label 'BBjCPL' (not 'BBj Compiler')"
    - "getDiagnosticTier() classifies BBjCPL diagnostics as tier 3 (highest)"
    - "applyDiagnosticHierarchy() suppresses Langium parse errors when BBjCPL errors present"
    - "bbj.compiler.trigger setting exists with enum ['debounced', 'on-save', 'off'] defaulting to 'debounced'"
    - "Trigger mode propagates from VS Code settings to server via initializationOptions and onDidChangeConfiguration"
  artifacts:
    - path: "bbj-vscode/src/language/bbj-cpl-parser.ts"
      provides: "Source label 'BBjCPL' on all diagnostics"
      contains: "source: 'BBjCPL'"
    - path: "bbj-vscode/src/language/bbj-document-validator.ts"
      provides: "DiagnosticTier.BBjCPL = 3, getDiagnosticTier() BBjCPL branch, hierarchy Rule 0, mergeDiagnostics()"
      exports: ["mergeDiagnostics"]
    - path: "bbj-vscode/package.json"
      provides: "bbj.compiler.trigger setting definition"
      contains: "bbj.compiler.trigger"
    - path: "bbj-vscode/src/language/main.ts"
      provides: "getCompilerTrigger() and setCompilerTrigger() module-level state"
      exports: ["getCompilerTrigger", "setCompilerTrigger"]
    - path: "bbj-vscode/src/language/bbj-ws-manager.ts"
      provides: "compilerTrigger read from initializationOptions"
      contains: "setCompilerTrigger"
  key_links:
    - from: "bbj-vscode/src/language/bbj-document-validator.ts"
      to: "bbj-vscode/src/language/bbj-cpl-parser.ts"
      via: "source label string match"
      pattern: "d\\.source === 'BBjCPL'"
    - from: "bbj-vscode/src/language/main.ts"
      to: "bbj-vscode/src/language/bbj-document-validator.ts"
      via: "setCompilerTrigger import"
      pattern: "setCompilerTrigger"
    - from: "bbj-vscode/src/language/bbj-ws-manager.ts"
      to: "bbj-vscode/src/language/main.ts"
      via: "setCompilerTrigger call from initializationOptions"
      pattern: "setCompilerTrigger"
---

<objective>
Rename the BBjCPL source label, extend the diagnostic hierarchy for BBjCPL tier, implement the diagnostic merge function, add the trigger mode setting, and wire trigger configuration through the server startup and settings change paths.

Purpose: Establishes the data model (source labels, tiers, merge logic) and configuration plumbing that Plan 02 depends on for the actual buildDocuments() integration.
Output: Updated parser source label, extended hierarchy, merge function, trigger setting in package.json, trigger state in main.ts/ws-manager.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/53-bbjcpl-diagnostic-integration/53-RESEARCH.md
@bbj-vscode/src/language/bbj-cpl-parser.ts
@bbj-vscode/src/language/bbj-document-validator.ts
@bbj-vscode/src/language/main.ts
@bbj-vscode/src/language/bbj-ws-manager.ts
@bbj-vscode/package.json
@bbj-vscode/test/cpl-parser.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename source label and extend diagnostic hierarchy with merge function</name>
  <files>
    bbj-vscode/src/language/bbj-cpl-parser.ts
    bbj-vscode/src/language/bbj-document-validator.ts
    bbj-vscode/test/cpl-parser.test.ts
  </files>
  <action>
**bbj-cpl-parser.ts:** Change `source: 'BBj Compiler'` to `source: 'BBjCPL'` in the `parseBbjcplOutput()` function's `diagnostics.push()` call. This is the ONLY place the source label is set (CPL-05).

**bbj-document-validator.ts:** Three changes:

1. **DiagnosticTier enum:** Uncomment/add `BBjCPL = 3` to the `DiagnosticTier` const enum. Remove the placeholder comment.

2. **getDiagnosticTier():** Add a new first branch: `if (d.source === 'BBjCPL') return DiagnosticTier.BBjCPL;`. Remove the Phase 53 placeholder comment. This MUST be the first check — before the parse error check.

3. **applyDiagnosticHierarchy():** Add Rule 0 (new, before existing Rule 1):
```typescript
const hasBbjcplErrors = diagnostics.some(
    d => getDiagnosticTier(d) === DiagnosticTier.BBjCPL
);
// Rule 0: BBjCPL errors present → suppress Langium parse errors (they're redundant)
if (hasBbjcplErrors) {
    result = result.filter(
        d => getDiagnosticTier(d) !== DiagnosticTier.Parse
    );
}
```
Place this AFTER the `hasParseErrors`/`hasAnyError` computation but BEFORE Rule 1. Note: `hasBbjcplErrors` implies `hasAnyError` is true (BBjCPL diags are Error severity), so Rule 2 (suppress warnings when any error) still fires naturally.

4. **Add exported `mergeDiagnostics()` function** at the bottom of the file (before the class). This is a pure function that Plan 02 will call from `BBjDocumentBuilder.buildDocuments()`:
```typescript
/**
 * Merge BBjCPL diagnostics into Langium diagnostics.
 *
 * Rules (from CONTEXT.md):
 * - Same line: prefer Langium message, set source to 'BBjCPL' (compiler confirmed)
 * - BBjCPL-only errors (no Langium match on same line): add with 'BBjCPL' source
 * - Langium-only diagnostics: kept unchanged
 */
export function mergeDiagnostics(langiumDiags: Diagnostic[], cplDiags: Diagnostic[]): Diagnostic[] {
    const result: Diagnostic[] = [...langiumDiags];

    for (const cplDiag of cplDiags) {
        const cplLine = cplDiag.range.start.line;
        const matchIdx = result.findIndex(
            d => d.range.start.line === cplLine && d.source !== 'BBjCPL'
        );

        if (matchIdx >= 0) {
            // Same line: keep Langium message, change source to 'BBjCPL'
            result[matchIdx] = { ...result[matchIdx], source: 'BBjCPL' };
        } else {
            // BBjCPL-only error: add directly
            result.push(cplDiag);
        }
    }

    return result;
}
```

**cpl-parser.test.ts:** Update ALL `expect(d.source).toBe('BBj Compiler')` assertions to `expect(d.source).toBe('BBjCPL')`. There are 4 such assertions:
- Line 30: `expect(first.source).toBe('BBj Compiler')` → `'BBjCPL'`
- Line 37: `expect(second.source).toBe('BBj Compiler')` → `'BBjCPL'`
- Line 51: `expect(diagnostics[0].source).toBe('BBj Compiler')` → `'BBjCPL'`
- Line 122: `expect(d.source).toBe('BBj Compiler')` → `'BBjCPL'`
  </action>
  <verify>
Run `cd bbj-vscode && npx vitest run test/cpl-parser.test.ts` — all 9 tests pass with updated source label assertions.
Run `cd bbj-vscode && npx tsc --noEmit` — no TypeScript errors.
  </verify>
  <done>
Source label is 'BBjCPL' everywhere. DiagnosticTier has BBjCPL=3. getDiagnosticTier() returns BBjCPL tier for source==='BBjCPL'. applyDiagnosticHierarchy() suppresses Langium parse errors when BBjCPL errors present. mergeDiagnostics() exported and ready for Plan 02. All parser tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add trigger setting to package.json and wire through server configuration</name>
  <files>
    bbj-vscode/package.json
    bbj-vscode/src/language/main.ts
    bbj-vscode/src/language/bbj-ws-manager.ts
  </files>
  <action>
**package.json:** Add new setting `bbj.compiler.trigger` in the `properties` section of `configuration.properties`, placed after the existing `bbj.diagnostics.maxErrors` entry (and before `bbj.configPath`):
```json
"bbj.compiler.trigger": {
    "type": "string",
    "enum": ["debounced", "on-save", "off"],
    "default": "debounced",
    "description": "Controls when the BBjCPL compiler checks for errors. 'debounced' runs after a pause in typing (2s), 'on-save' runs on file save only, 'off' disables BBjCPL checking entirely.",
    "scope": "window"
}
```

**main.ts:** Add module-level trigger state following the exact pattern of `setSuppressCascading`/`setMaxErrors`:
```typescript
// BBjCPL trigger mode configuration
let compilerTrigger: 'debounced' | 'on-save' | 'off' = 'debounced';

export function getCompilerTrigger(): 'debounced' | 'on-save' | 'off' {
    return compilerTrigger;
}
export function setCompilerTrigger(trigger: 'debounced' | 'on-save' | 'off'): void {
    compilerTrigger = trigger;
}
```
Add this block right after the existing `import { setSuppressCascading, setMaxErrors }` line and before `const connection = ...`.

Also import `setCompilerTrigger` usage into the `onDidChangeConfiguration` handler — add before the `!workspaceInitialized` guard (same placement as `setSuppressCascading`):
```typescript
// Apply compiler trigger setting (no startup gate — apply immediately)
if (config.compiler?.trigger !== undefined) {
    const trigger = config.compiler.trigger;
    if (trigger === 'debounced' || trigger === 'on-save' || trigger === 'off') {
        setCompilerTrigger(trigger);
    }
}
```

Also add the custom LSP notification for BBjCPL availability. Add after the `startLanguageServer(shared)` call:
```typescript
// BBjCPL availability notification — sent to client when availability changes
let bbjcplAvailableState: boolean | undefined = undefined;

export function notifyBbjcplAvailability(available: boolean): void {
    if (bbjcplAvailableState !== available) {
        bbjcplAvailableState = available;
        connection.sendNotification('bbj/bbjcplAvailability', { available });
    }
}
```

**bbj-ws-manager.ts:** Import `setCompilerTrigger` from `./main.js` (add to existing import line that has `setSuppressCascading, setMaxErrors`). Wait — `bbj-ws-manager.ts` imports from `./bbj-document-validator.js`, not `./main.js`. Since `setCompilerTrigger` is defined in `main.ts`, we need to import from there. BUT: `main.ts` creates the services that `bbj-ws-manager.ts` is part of — this would be a circular import.

**SOLUTION:** Define `setCompilerTrigger`/`getCompilerTrigger` in `bbj-document-validator.ts` instead (same file as `setSuppressCascading`/`setMaxErrors`). This avoids circular imports and keeps all module-level config setters in one place. Move the trigger state definition from `main.ts` to `bbj-document-validator.ts`.

So revised approach:
- **bbj-document-validator.ts:** Add the trigger state (`compilerTrigger`, `getCompilerTrigger()`, `setCompilerTrigger()`) alongside existing `setSuppressCascading`/`setMaxErrors`.
- **main.ts:** Import `setCompilerTrigger` from `'./bbj-document-validator.js'` (add to existing import). Add `config.compiler?.trigger` handling in `onDidChangeConfiguration`. Add `notifyBbjcplAvailability()` function and export it.
- **bbj-ws-manager.ts:** Import `setCompilerTrigger` from `'./bbj-document-validator.js'` (add to existing import that has `setSuppressCascading, setMaxErrors`). In the `onInitialize` handler, after the `maxErrors` block, add:
```typescript
// Set compiler trigger mode
const compilerTrigger = params.initializationOptions.compilerTrigger;
if (compilerTrigger === 'debounced' || compilerTrigger === 'on-save' || compilerTrigger === 'off') {
    setCompilerTrigger(compilerTrigger);
    logger.info(`Compiler trigger mode: ${compilerTrigger}`);
} else {
    setCompilerTrigger('debounced');
}
```
  </action>
  <verify>
Run `cd bbj-vscode && npx tsc --noEmit` — no TypeScript errors (validates imports, type correctness).
Grep for `getCompilerTrigger` and `setCompilerTrigger` to confirm they exist in `bbj-document-validator.ts`.
Grep for `bbj.compiler.trigger` in `package.json` to confirm setting definition.
Grep for `bbj/bbjcplAvailability` in `main.ts` to confirm notification function.
  </verify>
  <done>
`bbj.compiler.trigger` setting exists in package.json with enum [debounced, on-save, off]. `getCompilerTrigger()`/`setCompilerTrigger()` exported from bbj-document-validator.ts. Server reads trigger from initializationOptions on startup and from onDidChangeConfiguration on runtime changes. `notifyBbjcplAvailability()` ready for Plan 02 to call.
  </done>
</task>

</tasks>

<verification>
1. `cd bbj-vscode && npx vitest run test/cpl-parser.test.ts` — all 9 tests pass (source label updated)
2. `cd bbj-vscode && npx tsc --noEmit` — zero TypeScript errors
3. `grep -r "BBj Compiler" bbj-vscode/src/` — zero matches (old label fully removed)
4. `grep "BBjCPL" bbj-vscode/src/language/bbj-document-validator.ts` — shows tier enum, getDiagnosticTier branch, mergeDiagnostics function
5. `grep "compiler.trigger" bbj-vscode/package.json` — shows setting definition
</verification>

<success_criteria>
- Source label 'BBjCPL' on all parser output diagnostics (CPL-05)
- DiagnosticTier.BBjCPL = 3 in hierarchy enum
- getDiagnosticTier() returns BBjCPL tier for BBjCPL-sourced diagnostics
- applyDiagnosticHierarchy() suppresses Langium parse errors when BBjCPL errors present (CPL-06)
- mergeDiagnostics() function exported, ready for buildDocuments() integration
- bbj.compiler.trigger setting in package.json with debounced/on-save/off (CPL-07)
- Trigger mode propagated through initializationOptions and onDidChangeConfiguration
- notifyBbjcplAvailability() function ready for availability tracking (CPL-08 prep)
- All existing tests pass, no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/53-bbjcpl-diagnostic-integration/53-01-SUMMARY.md`
</output>
