---
phase: 34-diagnostic-polish
plan: 03
type: execute
wave: 3
depends_on: ["34-02"]
files_modified:
  - bbj-vscode/src/language/bbj-document-builder.ts
  - bbj-vscode/src/language/bbj-validator.ts
  - bbj-vscode/src/language/bbj-scope.ts
  - bbj-vscode/test/imports.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "USE statements referencing files that resolve via PREFIX directories show no false error after language server finishes loading"
    - "USE statements referencing genuinely missing files show error with list of searched PREFIX directories"
    - "PREFIX file loading failures are logged, not silently swallowed"
  artifacts:
    - path: "bbj-vscode/src/language/bbj-document-builder.ts"
      provides: "Fixed fsPath comparison in reconciliation, debug logging in addImportedBBjDocuments"
      contains: "adjustedFileUri.fsPath.toLowerCase()"
    - path: "bbj-vscode/src/language/bbj-validator.ts"
      provides: "Fixed fsPath comparison in validation, error message with searched paths"
      contains: "Searched:"
    - path: "bbj-vscode/src/language/bbj-scope.ts"
      provides: "Fixed fsPath comparison in scope resolution"
      contains: "adjustedFileUri.fsPath.toLowerCase()"
    - path: "bbj-vscode/test/imports.test.ts"
      provides: "Enabled PREFIX test covering reconciliation"
  key_links:
    - from: "bbj-validator.ts checkUsedClassExists"
      to: "bbj-document-builder.ts revalidateUseFilePathDiagnostics"
      via: "identical URI comparison logic and shared USE_FILE_NOT_RESOLVED_PREFIX"
      pattern: "documentUri\\.fsPath.*adjustedFileUri\\.fsPath"
    - from: "bbj-scope.ts getBBjClassesFromFile"
      to: "bbj-validator.ts checkUsedClassExists"
      via: "same URI comparison pattern for consistency"
      pattern: "documentUri\\.fsPath.*adjustedFileUri\\.fsPath"
---

<objective>
Fix PREFIX diagnostic reconciliation: replace URI-to-fsPath cross-format endsWith comparisons with proper fsPath-to-fsPath equality in 3 locations, add debug logging for PREFIX file loading failures, include searched directories in error messages, and enable the skipped PREFIX test.

Purpose: UAT showed "File 'BBjGridExWidget/BBjGridExWidget.bbj' could not be resolved" persists even after PREFIX docs load. Root cause is endsWith comparing URI string format against fsPath format, which fails on path normalization differences. User also requested searched PREFIX directories in the error message.

Output: Working PREFIX diagnostic reconciliation, actionable error messages, and test coverage.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-diagnostic-polish/34-02-SUMMARY.md
@.planning/phases/34-diagnostic-polish/34-re-DEBUG-PREFIX.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix URI comparison and add logging in all 3 locations</name>
  <files>
    bbj-vscode/src/language/bbj-document-builder.ts
    bbj-vscode/src/language/bbj-validator.ts
    bbj-vscode/src/language/bbj-scope.ts
  </files>
  <action>
Fix the URI-to-fsPath cross-format comparison bug in all 3 locations and add observability to PREFIX file loading.

**Root cause:** `bbjClass.documentUri.toString().toLowerCase().endsWith(adjustedFileUri.fsPath.toLowerCase())` compares a URI string (`file:///path/to/file.bbj`) against a filesystem path (`/path/to/file.bbj`). The `endsWith` works by coincidence on some systems but fails when path normalization differs (percent-encoding, symlinks, double slashes, Windows backslashes). Also, `endsWith` risks false positives where one path is a suffix of another.

**Fix 1 - bbj-document-builder.ts line 199 (revalidateUseFilePathDiagnostics):**
Replace:
```typescript
bbjClass.documentUri.toString().toLowerCase().endsWith(adjustedFileUri.fsPath.toLowerCase())
```
With:
```typescript
bbjClass.documentUri.fsPath.toLowerCase() === adjustedFileUri.fsPath.toLowerCase()
```
Note: `bbjClass.documentUri` is a Langium `URI` object which has a `.fsPath` property (it wraps vscode-uri). Using exact `===` equality instead of `endsWith` is correct because `adjustedFileUri` is already an absolute path (resolved via `resolve()` or `UriUtils.resolvePath`).

**Fix 2 - bbj-validator.ts line 310 (checkUsedClassExists):**
Same replacement as Fix 1. The `bbjClass.documentUri` here comes from `this.indexManager.allElements(BbjClass.$type)`, which returns `AstNodeDescription` objects. The `documentUri` property is a Langium `URI` with `.fsPath`.

Additionally, change the error message (line 314) to include searched paths. Replace:
```typescript
accept('error', `File '${cleanPath}' could not be resolved. Check the file path and PREFIX configuration.`, {
```
With:
```typescript
const searchedPaths = adjustedFileUris.map(u => u.fsPath);
accept('error', `File '${cleanPath}' could not be resolved. Searched: ${searchedPaths.join(', ')}`, {
```

IMPORTANT: The reconciliation regex in bbj-document-builder.ts (`/^File '([^']+)'/`) extracts the path from the first pair of single quotes. The new message format `File 'path' could not be resolved. Searched: ...` still has the path in the first quotes, so the regex remains correct. Do NOT change the message prefix format -- it MUST still start with `File '` to match `USE_FILE_NOT_RESOLVED_PREFIX`.

**Fix 3 - bbj-scope.ts line 230 (getBBjClassesFromFile):**
Same replacement as Fix 1. Change:
```typescript
return adjustedFileUris.some(adjustedFileUri => bbjClass.documentUri.toString().toLowerCase().endsWith(adjustedFileUri.fsPath.toLowerCase()));
```
To:
```typescript
return adjustedFileUris.some(adjustedFileUri => bbjClass.documentUri.fsPath.toLowerCase() === adjustedFileUri.fsPath.toLowerCase());
```

**Fix 4 - bbj-document-builder.ts addImportedBBjDocuments (lines 128-147):**
Add debug logging to the catch block and after the prefix loop. Replace the silent catch:
```typescript
catch (e) {
    // Continue to the next prefixPath if readFile fails
}
```
With:
```typescript
catch (e) {
    console.debug(`[PREFIX] File not found at ${prefixedPath.fsPath}`);
}
```

After the for-of prefixes loop (after line 139, before the `if (docFileData)` check), add:
```typescript
if (!docFileData) {
    console.warn(`[PREFIX] Could not load '${importPath}' from any PREFIX directory. Searched: ${prefixes.join(', ')}`);
}
```
  </action>
  <verify>
1. Run `cd /Users/beff/_workspace/bbj-language-server && npm run langium:generate && npm run build` -- must compile without errors.
2. Run `cd /Users/beff/_workspace/bbj-language-server && npm test` -- must pass with same baseline (432 passing, 10 failing pre-existing, skipped count may change from task 2).
3. Grep all 3 files to confirm no remaining `documentUri.toString().toLowerCase().endsWith` patterns:
   - `grep -n "documentUri.toString" bbj-vscode/src/language/bbj-document-builder.ts bbj-vscode/src/language/bbj-validator.ts bbj-vscode/src/language/bbj-scope.ts` should return NO matches in the URI comparison lines.
4. Grep to confirm new pattern exists: `grep -n "documentUri.fsPath" bbj-vscode/src/language/bbj-document-builder.ts bbj-vscode/src/language/bbj-validator.ts bbj-vscode/src/language/bbj-scope.ts` should show the fix in all 3 files.
5. Grep to confirm error message includes searched paths: `grep -n "Searched:" bbj-vscode/src/language/bbj-validator.ts` should show the updated message.
  </verify>
  <done>
All 3 endsWith comparisons replaced with exact fsPath equality. Error message includes searched directories. Silent catch blocks have debug logging. TypeScript compiles cleanly. All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enable PREFIX test in imports.test.ts</name>
  <files>
    bbj-vscode/test/imports.test.ts
  </files>
  <action>
The PREFIX test at line 208 is skipped with `describe.skip('Prefix tests', ...)` and uses `NodeFileSystem` which requires real file I/O. This test cannot work with `NodeFileSystem` in a unit test environment because it expects files at PREFIX paths that don't exist on disk.

**Strategy:** Convert the test to use `EmptyFileSystem` (like the working import tests above it) and pre-parse the PREFIX document before the test document, simulating what `addImportedBBjDocuments` would do in a real workspace.

**Changes:**

1. Change `describe.skip('Prefix tests', () => {` to `describe('Prefix tests', () => {`

2. Change `const services = createBBjServices(NodeFileSystem);` to `const services = createBBjServices(EmptyFileSystem);`

3. In the `beforeAll`, after creating `parse`, pre-parse the BBjWidget file that the test document references. This is the same pattern used by the existing "Import tests" describe block (lines 18-42) which pre-parses `ImportMe` class before testing `use ::importMe.bbj::ImportMe`. The document URI must match what the scope resolver would look for.

Replace the existing test body with:
```typescript
describe('Prefix tests', () => {
    const services = createBBjServices(EmptyFileSystem);
    let parse: ReturnType<typeof parseHelper>;

    beforeAll(async () => {
        parse = parseHelper(services.BBj);
        // Pre-parse the BBjWidget file so it's in the index when the test document references it.
        // The URI must match what PREFIX resolution would produce.
        await parse(`
            class public BBjWidget
            classend
        `, { documentUri: 'file:///prefix/BBjWidget/BBjWidget.bbj' });
    });

    test('USE with PREFIX-resolved file path resolves classes', async () => {
        const document = await parse(`
            use ::BBjWidget/BBjWidget.bbj::BBjWidget
            declare auto ::BBjWidget/BBjWidget.bbj::BBjWidget xxx
            let yyy = new ::BBjWidget/BBjWidget.bbj::BBjWidget()
            CLASS PUBLIC ZZZ
                METHOD ::BBjWidget/BBjWidget.bbj::BBjWidget doIt()
                    METHODRET new ::BBjWidget/BBjWidget.bbj::BBjWidget()
                METHODEND
            CLASSEND
        `, { validation: true });
        expectNoParserLexerErrors(document);
        // The BBjWidget class should resolve via the pre-parsed document
        // No file-path errors expected since BBjWidget.bbj is in the index
        const filePathErrors = document.diagnostics?.filter(d =>
            d.severity === 1 && d.message.startsWith("File '")
        ) ?? [];
        expect(filePathErrors).toHaveLength(0);
    });
});
```

**Why this works:** The `parseHelper` adds parsed documents to `LangiumDocuments` and runs them through the document builder (parse, index, scope, link, validate). When the test document references `::BBjWidget/BBjWidget.bbj::BBjWidget`, the scope resolver calls `getBBjClassesFromFile` which checks the index for BbjClass entries whose `documentUri.fsPath` matches the resolved path. Since we pre-parsed with a URI whose path ends in `BBjWidget/BBjWidget.bbj`, the fsPath comparison will match.

**Note on the scope resolver:** The scope resolver builds candidate URIs from: (1) relative to current doc, and (2) each PREFIX directory. In test mode with EmptyFileSystem, there are no PREFIX directories configured (no settings). The pre-parsed document at `file:///prefix/BBjWidget/BBjWidget.bbj` won't match the relative resolution from the test document URI.

So we need a different approach -- check if the `parseHelper` supports setting the test document URI. If we set the test document URI to `file:///prefix/test.bbj`, then the relative resolution `UriUtils.resolvePath(UriUtils.dirname(testDocUri), 'BBjWidget/BBjWidget.bbj')` would produce `file:///prefix/BBjWidget/BBjWidget.bbj`, which matches the pre-parsed document.

Set the test document's URI so relative resolution works:
```typescript
const document = await parse(`...`, {
    documentUri: 'file:///prefix/test.bbj',
    validation: true
});
```

This way `UriUtils.dirname('file:///prefix/test.bbj')` = `file:///prefix/` and `UriUtils.resolvePath('file:///prefix/', 'BBjWidget/BBjWidget.bbj')` = `file:///prefix/BBjWidget/BBjWidget.bbj` -- which exactly matches the pre-parsed document URI.
  </action>
  <verify>
1. Run `cd /Users/beff/_workspace/bbj-language-server && npm test -- --reporter=verbose 2>&1 | grep -A2 "Prefix tests"` -- the PREFIX test should show as PASSED (not skipped).
2. Run `cd /Users/beff/_workspace/bbj-language-server && npm test` -- full suite passes with 433 passing (1 previously skipped test now passing), 10 failing (pre-existing), 3 skipped (one fewer skip).
  </verify>
  <done>
PREFIX test enabled and passing. Test verifies that USE statements with BBj file paths resolve classes from pre-indexed documents using fsPath comparison. Skipped test count decreases by 1.
  </done>
</task>

</tasks>

<verification>
1. **Build:** `npm run langium:generate && npm run build` completes without TypeScript errors
2. **Tests:** `npm test` shows 433+ passing (1 previously skipped PREFIX test now passing), 10 failing (pre-existing), 3 skipped
3. **No old pattern:** `grep -rn "documentUri.toString().*endsWith" bbj-vscode/src/language/` returns zero matches
4. **New pattern:** `grep -rn "documentUri.fsPath.*===.*adjustedFileUri.fsPath" bbj-vscode/src/language/` returns matches in all 3 files
5. **Error message:** `grep -n "Searched:" bbj-vscode/src/language/bbj-validator.ts` confirms searched paths in message
6. **Logging:** `grep -n "\\[PREFIX\\]" bbj-vscode/src/language/bbj-document-builder.ts` confirms debug/warn logging exists
</verification>

<success_criteria>
- All 3 `endsWith` URI comparisons replaced with exact `fsPath` equality
- Error message for unresolved USE file paths includes the list of directories that were searched
- Silent catch blocks replaced with debug logging
- PREFIX test enabled and passing
- No regressions: all previously passing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/34-diagnostic-polish/34-03-SUMMARY.md`
</output>
