---
phase: 34-diagnostic-polish
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - bbj-vscode/src/language/bbj-document-builder.ts
  - bbj-vscode/src/language/bbj-validator.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "USE statements referencing files resolvable via PREFIX produce no error diagnostic after workspace build completes"
    - "USE statements referencing genuinely non-existent files still produce an error diagnostic"
    - "Existing import tests continue to pass without regression"
  artifacts:
    - path: "bbj-vscode/src/language/bbj-document-builder.ts"
      provides: "Post-import diagnostic reconciliation for PREFIX-resolved USE paths"
      contains: "revalidateUseFilePathDiagnostics"
    - path: "bbj-vscode/src/language/bbj-validator.ts"
      provides: "Exported constant for file-path diagnostic message prefix"
      contains: "USE_FILE_NOT_RESOLVED"
  key_links:
    - from: "bbj-vscode/src/language/bbj-document-builder.ts"
      to: "IndexManager.allElements(BbjClass.$type)"
      via: "revalidateUseFilePathDiagnostics re-checks after external docs indexed"
      pattern: "indexManager\\.allElements"
    - from: "bbj-vscode/src/language/bbj-document-builder.ts"
      to: "notifyDocumentPhase(document, DocumentState.Validated)"
      via: "pushes updated diagnostics to editor after removing false positives"
      pattern: "notifyDocumentPhase"
---

<objective>
Fix false error diagnostics on USE statements whose file paths resolve via PREFIX directories but not via workspace-local paths.

Purpose: The validator's `checkUsedClassExists` runs during the initial build phase BEFORE `addImportedBBjDocuments` loads external PREFIX-resolved files into the index. This produces false "could not be resolved" errors for valid files. After external docs are loaded and indexed, these diagnostics must be reconciled: remove the ones that are now resolvable, keep the ones that are genuinely broken.

Output: Modified document builder that re-checks USE file path diagnostics after PREFIX documents are indexed, and pushes corrected diagnostics to the editor. No visible change for workspace-local USE statements or genuinely broken paths.

**Accepted limitation (Gap 1 - not addressed):** VS Code setting group headers display "Bbj:" because VS Code auto-derives headers from property key prefixes (`bbj.*` -> `Bbj:`). This is a VS Code platform limitation (GitHub issues #86000, #191807). Changing keys would break all existing user configurations. The description text fix from 34-01 ("Auto Save upon run of BBj program") is the maximum possible improvement.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-diagnostic-polish/34-01-SUMMARY.md
@.planning/phases/34-diagnostic-polish/34-DEBUG-PREFIX.md

@bbj-vscode/src/language/bbj-document-builder.ts (full file — build sequencing, addImportedBBjDocuments)
@bbj-vscode/src/language/bbj-validator.ts (lines 280-318 — checkUsedClassExists with bbjFilePath block)
@bbj-vscode/src/language/bbj-scope.ts (BBjPathPattern export)
@bbj-vscode/src/language/bbj-ws-manager.ts (PREFIX settings, isExternalDocument)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reconcile USE file-path diagnostics after PREFIX documents are indexed</name>
  <files>
    bbj-vscode/src/language/bbj-validator.ts
    bbj-vscode/src/language/bbj-document-builder.ts
  </files>
  <action>
**Step 1: Export a diagnostic message sentinel from bbj-validator.ts**

Add an exported constant near the top of bbj-validator.ts (after the imports, before the class):

```typescript
/** Prefix of the diagnostic message emitted for unresolvable USE file paths. Used by document builder to identify and reconcile these diagnostics after PREFIX docs are loaded. */
export const USE_FILE_NOT_RESOLVED_PREFIX = "File '";
```

Also verify the existing error message in `checkUsedClassExists` (around line 311) starts with this prefix. It currently reads:
```typescript
accept('error', `File '${cleanPath}' could not be resolved. Check the file path and PREFIX configuration.`, { ... });
```
This already starts with `"File '"` — no change needed to the message itself.

**Step 2: Add revalidateUseFilePathDiagnostics method to BBjDocumentBuilder**

Add a new private method to BBjDocumentBuilder that:
1. Iterates workspace documents (not external documents) from the `documents` array
2. For each document that has diagnostics containing the USE_FILE_NOT_RESOLVED_PREFIX message:
   a. Re-runs the same resolution logic as `checkUsedClassExists` — extract cleanPath from the message, build candidate URIs (relative + PREFIX), check `indexManager.allElements(BbjClass.$type)`
   b. If the path NOW resolves (because addImportedBBjDocuments just indexed it), remove that diagnostic from `document.diagnostics`
3. For any document whose diagnostics were modified, call `this.notifyDocumentPhase(document, DocumentState.Validated, cancelToken)` to push updated diagnostics to the editor

The implementation:

```typescript
import { BbjClass } from './generated/ast.js';
import { USE_FILE_NOT_RESOLVED_PREFIX } from './bbj-validator.js';
```
(Add BbjClass to the existing import from `./generated/ast.js` if not already there. Add USE_FILE_NOT_RESOLVED_PREFIX as new import.)

```typescript
/**
 * After addImportedBBjDocuments loads and indexes external PREFIX-resolved files,
 * re-check USE file-path diagnostics that were emitted during the initial build.
 * Diagnostics for paths that are NOW resolvable via the index are removed, and
 * updated diagnostics are pushed to the editor.
 */
private async revalidateUseFilePathDiagnostics(
    documents: LangiumDocument<AstNode>[],
    cancelToken: CancellationToken
): Promise<void> {
    const bbjWsManager = this.wsManager() as BBjWorkspaceManager;
    const prefixes = bbjWsManager.getSettings()?.prefixes ?? [];

    for (const document of documents) {
        if (bbjWsManager.isExternalDocument(document.uri)) continue;
        if (!document.diagnostics?.length) continue;

        const originalLength = document.diagnostics.length;
        document.diagnostics = document.diagnostics.filter(diag => {
            // Only re-check our specific USE file-path diagnostics
            if (!diag.message.startsWith(USE_FILE_NOT_RESOLVED_PREFIX)) {
                return true; // keep all other diagnostics
            }

            // Extract the clean path from the diagnostic message
            // Message format: "File 'some/path.bbj' could not be resolved..."
            const pathMatch = diag.message.match(/^File '([^']+)'/);
            if (!pathMatch) {
                return true; // keep if we can't parse
            }
            const cleanPath = pathMatch[1];

            // Build candidate URIs (same logic as checkUsedClassExists)
            const adjustedFileUris = [
                UriUtils.resolvePath(UriUtils.dirname(document.uri), cleanPath)
            ].concat(
                prefixes.map(prefixPath => URI.file(resolve(prefixPath, cleanPath)))
            );

            // Check if any BbjClass now exists at these URIs
            const nowResolved = this.indexManager.allElements(BbjClass.$type).some(bbjClass => {
                return adjustedFileUris.some(adjustedFileUri =>
                    bbjClass.documentUri.toString().toLowerCase().endsWith(adjustedFileUri.fsPath.toLowerCase())
                );
            });

            // If now resolved, remove the diagnostic (return false to filter out)
            return !nowResolved;
        });

        // If diagnostics changed, notify the editor
        if (document.diagnostics.length !== originalLength) {
            await this.notifyDocumentPhase(document, DocumentState.Validated, cancelToken);
        }
    }
}
```

Add required imports to bbj-document-builder.ts — check existing imports and only add what's missing:
- `UriUtils` from `'langium'` (add to existing langium import)
- `BbjClass` needs to be added to the existing import from `'./generated/ast.js'`
- `USE_FILE_NOT_RESOLVED_PREFIX` from `'./bbj-validator.js'`

**Step 3: Call revalidateUseFilePathDiagnostics in buildDocuments**

Modify the `buildDocuments` method to call the reconciliation after external documents are loaded. Change:

```typescript
protected override async buildDocuments(documents: LangiumDocument<AstNode>[], options: BuildOptions, cancelToken: CancellationToken): Promise<void> {
    await super.buildDocuments(documents, options, cancelToken);
    if (!this.isImportingBBjDocuments) {
        await this.addImportedBBjDocuments(documents, options, cancelToken);
    }
}
```

To:

```typescript
protected override async buildDocuments(documents: LangiumDocument<AstNode>[], options: BuildOptions, cancelToken: CancellationToken): Promise<void> {
    await super.buildDocuments(documents, options, cancelToken);
    if (!this.isImportingBBjDocuments) {
        await this.addImportedBBjDocuments(documents, options, cancelToken);
        // After external PREFIX-resolved documents are loaded and indexed,
        // remove false-positive "could not be resolved" diagnostics for paths
        // that are now in the index. This fixes the timing issue where validation
        // runs before addImportedBBjDocuments loads external files.
        await this.revalidateUseFilePathDiagnostics(documents, cancelToken);
    }
}
```

**Why this approach works:**
- `addImportedBBjDocuments` calls `this.update(addedDocuments, [], cancelToken)` which fully indexes external docs (Parse → IndexContent → Scopes → Link → IndexRefs → Validate(skipped))
- After `update` returns, `indexManager.allElements(BbjClass.$type)` now includes classes from PREFIX-resolved files
- The revalidation filters out diagnostics for paths that are now resolvable
- `notifyDocumentPhase(doc, Validated)` triggers the `onDocumentPhase` listener in `addDiagnosticsHandler` (Langium's built-in LSP wiring) which calls `connection.sendDiagnostics()` with the updated (filtered) diagnostics array
- The editor replaces the old diagnostics with the new set, removing the false errors

**Why NOT full re-validation:**
- Full re-validation (resetting doc state + running all validators) is expensive and risks double-counting other diagnostics that `push` onto the array
- Filtering existing diagnostics is O(n) over the diagnostics array and only touches the specific USE file-path diagnostics
- No other validator results are affected
  </action>
  <verify>
Run `cd /Users/beff/_workspace/bbj-language-server/bbj-vscode && npx vitest run` — all existing tests pass including the 2 USE file path tests from 34-01. The non-existent file test still shows 1 error (genuinely broken path). The valid file test still shows 0 errors (workspace-local path). Compile check: `npx tsc --noEmit` passes with no type errors in bbj-document-builder.ts or bbj-validator.ts.
  </verify>
  <done>
The `buildDocuments` method calls `revalidateUseFilePathDiagnostics` after `addImportedBBjDocuments`. The method filters out USE file-path error diagnostics that are now resolvable via the index (because PREFIX docs were just loaded), and pushes updated diagnostics to the editor. Genuinely broken paths still show errors. Workspace-local valid paths still show no errors. All existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/beff/_workspace/bbj-language-server/bbj-vscode && npx vitest run` — full test suite passes, no regressions
2. `npx tsc --noEmit` — no type errors in modified files
3. `grep -n "revalidateUseFilePathDiagnostics" bbj-vscode/src/language/bbj-document-builder.ts` — method exists and is called from buildDocuments
4. `grep -n "USE_FILE_NOT_RESOLVED_PREFIX" bbj-vscode/src/language/bbj-validator.ts` — sentinel constant exported
5. `grep -n "notifyDocumentPhase" bbj-vscode/src/language/bbj-document-builder.ts` — diagnostics pushed to editor after reconciliation
</verification>

<success_criteria>
- USE statements referencing files in PREFIX directories no longer show false "could not be resolved" errors after the workspace finishes building
- USE statements referencing genuinely non-existent files still show the error diagnostic
- USE statements referencing workspace-local files continue to work correctly (no regression)
- All existing tests pass without modification
- The fix is contained to the document builder's post-import reconciliation — no changes to the validation logic itself
</success_criteria>

<output>
After completion, create `.planning/phases/34-diagnostic-polish/34-02-SUMMARY.md`
</output>
