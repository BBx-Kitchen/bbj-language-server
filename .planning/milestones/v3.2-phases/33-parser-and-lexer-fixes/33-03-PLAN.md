---
phase: 33-parser-and-lexer-fixes
plan: 03
type: execute
wave: 1
depends_on: [33-01, 33-02]
files_modified:
  - bbj-vscode/src/language/bbj.langium
  - bbj-vscode/src/language/bbj-type-inferer.ts
  - bbj-vscode/src/language/bbj-validator.ts
  - bbj-vscode/test/parser.test.ts
  - bbj-vscode/test/linking.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "`cast(BBjString[], someVar!)` with array type notation `[]` parses correctly"
    - "`cast(BBjString[][], someVar!)` with multi-dimensional array notation parses correctly"
    - "`cast(TargetClass, obj!)` without array brackets still works (type inference and diagnostics)"
    - "Existing parser and linking tests continue to pass (no regressions)"
  artifacts:
    - path: "bbj-vscode/src/language/bbj.langium"
      provides: "CastExpression grammar rule as PrimaryExpression alternative"
      contains: "CastExpression"
    - path: "bbj-vscode/src/language/bbj-type-inferer.ts"
      provides: "Type inference for CastExpression nodes"
      contains: "isCastExpression"
    - path: "bbj-vscode/src/language/bbj-validator.ts"
      provides: "Type resolution warning for CastExpression with unresolvable types"
      contains: "CastExpression"
    - path: "bbj-vscode/test/parser.test.ts"
      provides: "Un-skipped PARSE-04 tests passing"
  key_links:
    - from: "bbj.langium (CastExpression)"
      to: "PrimaryExpression alternatives"
      via: "Grammar rule reference"
      pattern: "CastExpression"
    - from: "bbj-type-inferer.ts"
      to: "CastExpression.castType"
      via: "isCastExpression check"
      pattern: "isCastExpression"
    - from: "bbj-validator.ts"
      to: "CastExpression.castType"
      via: "validation check registration"
      pattern: "CastExpression"
---

<objective>
Fix PARSE-04: Make `cast(BBjString[], someVar!)` with array type notation parse correctly by introducing a dedicated CastExpression grammar rule.

Purpose: Close the one remaining verification gap from Phase 33. The `cast(Type[], expr)` syntax fails because the MemberCall loop's ArrayElement rule requires indices in brackets. By making CAST a first-class grammar construct (like ConstructorCall for `new`), the type argument is parsed as QualifiedClass with optional array brackets, bypassing the ArrayElement ambiguity entirely.

Output: Updated grammar, type inferer, validator, and passing tests for array cast notation.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-parser-and-lexer-fixes/33-01-SUMMARY.md
@.planning/phases/33-parser-and-lexer-fixes/33-02-SUMMARY.md

@bbj-vscode/src/language/bbj.langium
@bbj-vscode/src/language/bbj-type-inferer.ts
@bbj-vscode/src/language/bbj-validator.ts
@bbj-vscode/test/parser.test.ts
@bbj-vscode/test/linking.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CastExpression grammar rule and update type inferer + validator</name>
  <files>
    bbj-vscode/src/language/bbj.langium
    bbj-vscode/src/language/bbj-type-inferer.ts
    bbj-vscode/src/language/bbj-validator.ts
    bbj-vscode/test/parser.test.ts
    bbj-vscode/test/linking.test.ts
  </files>
  <action>
**Strategy:** Add `CastExpression` as a dedicated PrimaryExpression alternative, following the same pattern as ConstructorCall (`new Type(args)`). This makes CAST a keyword parsed at the grammar level, so its first argument is parsed as a QualifiedClass (type reference) with optional `[]` brackets — completely avoiding the MemberCall/ArrayElement ambiguity.

**Step 1: Grammar (bbj.langium)**

Add CastExpression rule after ConstructorCall (around line 841):

```langium
CastExpression:
    'CAST' '(' castType=QualifiedClass (arrayDims+='[' ']')* ',' value=Expression Err? RPAREN
;
```

Add CastExpression as a PrimaryExpression alternative. In the PrimaryExpression rule (line 796-806), add `| CastExpression` between ConstructorCall and SymbolicLabelName:

```langium
PrimaryExpression infers Expression:
    '(' Expression RPAREN
    | SymbolRef
    | Literal
    | Mnemonic
    | PositionalMnemonic
    | ConstructorCall
    | CastExpression
    | SymbolicLabelName
    | BBjTypeRef
    | JavaSymbol
    ;
```

**Important:** `'CAST'` as a keyword with `caseInsensitive: true` in langium-config.json will match `cast`, `CAST`, `Cast` etc. automatically. This means `cast` will no longer be tokenized as an ID (it becomes a keyword), so the LibFunction definition in functions.bbl won't match anymore. This is fine — CastExpression replaces the MethodCall-based handling entirely.

**Step 2: Regenerate parser**

Run `npm run langium:generate` in bbj-vscode/ to regenerate the parser and AST types. This will create the `CastExpression` interface in generated/ast.ts with properties: `castType: QualifiedClass`, `arrayDims: string[]`, `value: Expression`, `err?: Expression`.

**Step 3: Type Inferer (bbj-type-inferer.ts)**

Add a new branch for CastExpression in the `getType` method (around line 79, BEFORE the existing MethodCall branch). Import `isCastExpression` and `CastExpression` from generated/ast.js.

```typescript
} else if (isCastExpression(expression)) {
    // CastExpression has castType as a QualifiedClass directly
    if (isBBjTypeRef(expression.castType)) {
        return expression.castType.klass.ref;
    } else if (isSimpleTypeRef(expression.castType)) {
        return expression.castType.simpleClass.ref;
    }
    // For array casts or unresolvable types, return undefined (treat as untyped)
    // Per user decision: no type resolution for array casts in this phase
    return undefined;
```

Also update the existing MethodCall branch: The cast-specific check inside the `isMethodCall` branch (lines 80-98) should remain for backward compatibility during the transition, but in practice `cast(...)` will now always be parsed as CastExpression, so the MethodCall branch's cast check will never trigger. Leave it in place for safety — it does no harm and will be dead code.

**Step 4: Validator (bbj-validator.ts)**

Register a new validation check for CastExpression. Add to the checks object (around line 43):

```typescript
CastExpression: validator.checkCastExpressionTypeResolvable,
```

Add the new validation method to BbjValidator:

```typescript
checkCastExpressionTypeResolvable(castExpr: CastExpression, accept: ValidationAcceptor): void {
    if (!typeResolutionWarningsEnabled) return;

    // Array casts: just stop the false error, no type resolution
    // Per user decision: deferred to future phase
    if (castExpr.arrayDims && castExpr.arrayDims.length > 0) {
        return;
    }

    let typeResolved = false;
    if (isBBjTypeRef(castExpr.castType)) {
        typeResolved = castExpr.castType.klass.ref !== undefined;
    } else if (isSimpleTypeRef(castExpr.castType)) {
        typeResolved = isClass(castExpr.castType.simpleClass.ref);
    }
    if (!typeResolved) {
        accept('warning', 'CAST references an unresolvable type', {
            node: castExpr
        });
    }
}
```

Import `CastExpression`, `isCastExpression`, `isSimpleTypeRef` from generated/ast.js as needed. Also import `isClass` if not already imported.

The existing `checkCastTypeResolvable` method on MethodCall can remain — it will simply never trigger for cast() calls anymore since they parse as CastExpression. It serves as dead code safety net.

**Step 5: Remove validator ArrayElement empty-indices check**

In `checkCastTypeResolvable` (lines 92-97), the ArrayElement empty-indices check was added as preparation for when the grammar fix landed. Since CastExpression now handles this at the grammar level, this check is dead code. Leave it for now — it's harmless and serves as documentation of the previous approach attempt.

**Step 6: Un-skip PARSE-04 tests (parser.test.ts)**

Change `test.skip` to `test` for both PARSE-04 tests at lines 2481 and 2489. Also remove the comment "PARSE-04 tests disabled" at line 2479.

**Step 7: Verify linking tests still pass (linking.test.ts)**

The two linking tests at lines 168-217 (`CAST() conveys type for method completion` and `CAST with unresolvable type shows warning`) use `CAST(TargetClass, obj!)` and `CAST(NonExistentClass, obj!)`. With CastExpression:
- `TargetClass` will be parsed as `castType=QualifiedClass` (specifically SimpleTypeRef with simpleClass=[Class:ID])
- The type inferer's new CastExpression branch resolves `SimpleTypeRef.simpleClass.ref` to the class
- The validator's new method checks the same pattern
- These tests MUST pass without modification. If they don't, debug the QualifiedClass resolution for class names defined in the same file.

**Step 8: Build and test**

```bash
cd bbj-vscode && npm run langium:generate && npm run build && npm test
```

All 195+ previously passing tests must still pass. The 2 PARSE-04 tests must now pass (no longer skipped). The 3 linking tests for CAST must pass. The 5 pre-existing failures are acceptable.
  </action>
  <verify>
```bash
cd bbj-vscode && npm run langium:generate && npm run build && npm test
```

1. `npm run langium:generate` succeeds without errors
2. `npm run build` succeeds without TypeScript errors
3. `npm test` passes — specifically:
   - PARSE-04 test "cast with array type notation" passes (no longer skipped)
   - PARSE-04 test "cast with multi-dimensional array type" passes (no longer skipped)
   - Linking test "CAST() conveys type for method completion" passes
   - Linking test "CAST with unresolvable type shows warning" passes
   - No new test failures beyond the 5 pre-existing ones
4. Total test count: 197+ passing (195 previously + 2 un-skipped), 5 failing (pre-existing), 1 skipped (pre-existing TABLE test)
  </verify>
  <done>
`cast(BBjString[], x!)` and `cast(BBjString[][], x!)` parse without errors. Regular `cast(TargetClass, obj!)` still infers the correct type and `cast(NonExistentClass, obj!)` still shows the unresolvable type warning. No regressions in existing tests.
  </done>
</task>

</tasks>

<verification>
1. Run full test suite: `cd bbj-vscode && npm test` — all previously passing tests still pass
2. PARSE-04 tests are un-skipped and passing
3. Linking tests for CAST type inference and warnings pass
4. Grammar generates cleanly with `npm run langium:generate`
5. Build succeeds with `npm run build`
6. No new parser ambiguity warnings in test output
</verification>

<success_criteria>
- `cast(BBjString[], x!)` parses without parser/lexer errors
- `cast(BBjString[][], x!)` parses without parser/lexer errors
- `cast(TargetClass, obj!)` still resolves type correctly (type inferer)
- `cast(NonExistentClass, obj!)` still shows warning (validator)
- All existing tests pass (no regressions)
- PARSE-04 requirement from phase success criteria is satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/33-parser-and-lexer-fixes/33-03-SUMMARY.md`
</output>
