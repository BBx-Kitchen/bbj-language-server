---
phase: 48-fix-scheduled-for-removal-apis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDownloader.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjEMLoginAction.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
autonomous: true

must_haves:
  truths:
    - "BbjNodeDownloader detects ARM64 and 64-bit architectures using CpuArch API instead of SystemInfo.is64Bit/isAarch64"
    - "BbjEMLoginAction looks up plugin ID using PluginId.getId() instead of PluginId.findId()"
    - "BbjSettingsComponent uses the non-deprecated addBrowseFolderListener(Project, FileChooserDescriptor) overload"
    - "BbjSettingsComponent uses createSingleFileDescriptor() instead of createSingleLocalFileDescriptor()"
    - "Project compiles successfully with zero scheduled-for-removal API warnings in these 3 files"
  artifacts:
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDownloader.java"
      provides: "Platform detection using CpuArch"
      contains: "CpuArch.isArm64()"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjEMLoginAction.java"
      provides: "Plugin lookup using PluginId.getId()"
      contains: "PluginId.getId"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java"
      provides: "Browse folder listener using current API"
      contains: "addBrowseFolderListener(null,"
  key_links:
    - from: "BbjNodeDownloader.getArchitecture()"
      to: "CpuArch API"
      via: "import com.intellij.util.system.CpuArch"
      pattern: "CpuArch\\.isArm64\\(\\)|CpuArch\\.CURRENT\\.width"
    - from: "BbjEMLoginAction.getEMLoginBbjPath()"
      to: "PluginId API"
      via: "PluginId.getId instead of findId"
      pattern: "PluginId\\.getId\\("
---

<objective>
Replace all 4 scheduled-for-removal IntelliJ Platform APIs with their current equivalents across 3 Java files, satisfying COMPAT-01 through COMPAT-04.

Purpose: Eliminate critical compatibility errors that will break the plugin in future IntelliJ IDE versions (2026.1+). These are mechanical API replacements with drop-in alternatives documented by JetBrains.

Output: 3 modified Java files with zero scheduled-for-removal API usages.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDownloader.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjEMLoginAction.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace SystemInfo.is64Bit/isAarch64 with CpuArch API (COMPAT-01)</name>
  <files>bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDownloader.java</files>
  <action>
In `BbjNodeDownloader.java`, replace the deprecated `SystemInfo.is64Bit` and `SystemInfo.isAarch64` fields with the current `CpuArch` API.

1. Add import: `import com.intellij.util.system.CpuArch;`

2. In `getArchitecture()` method (line ~230-239), replace:
   - `SystemInfo.isAarch64` with `CpuArch.isArm64()`
   - `SystemInfo.is64Bit` with `CpuArch.CURRENT.width == 64`

   The method should become:
   ```java
   private static @NotNull String getArchitecture() {
       if (CpuArch.isArm64()) {
           return "arm64";
       }
       if (CpuArch.CURRENT.width != 64) {
           throw new UnsupportedOperationException("32-bit systems are not supported");
       }
       return "x64";
   }
   ```

Do NOT change any other `SystemInfo` usages (e.g., `SystemInfo.isWindows`, `SystemInfo.isMac`, `SystemInfo.isLinux`) -- those are NOT deprecated.
  </action>
  <verify>Run `cd /Users/beff/_workspace/bbj-language-server/bbj-intellij && ./gradlew compileJava` to confirm compilation succeeds. Grep the file for `SystemInfo.is64Bit` and `SystemInfo.isAarch64` to confirm they are gone. Grep for `CpuArch` to confirm new API is used.</verify>
  <done>BbjNodeDownloader.getArchitecture() uses CpuArch.isArm64() and CpuArch.CURRENT.width instead of SystemInfo.isAarch64 and SystemInfo.is64Bit. All other SystemInfo usages (isWindows, isMac, isLinux) remain unchanged. File compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Replace PluginId.findId with PluginId.getId (COMPAT-02) and replace deprecated browse/file-chooser APIs (COMPAT-03, COMPAT-04)</name>
  <files>bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjEMLoginAction.java, bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java</files>
  <action>
**A) In `BbjEMLoginAction.java` (COMPAT-02):**

In `getEMLoginBbjPath()` method (line ~156), replace `PluginId.findId("com.basis.bbj")` with `PluginId.getId("com.basis.bbj")`.

The `findId` is scheduled for removal; `getId` is the current API. Note: `getId()` always returns non-null (creates PluginId if not found), so the null check on line 157 (`if (pluginId == null) return null;`) should be removed since `getId` never returns null. However, keep the null check on the `plugin` variable from `PluginManagerCore.getPlugin()`.

Also update the import: change `com.intellij.openapi.extensions.PluginId` to a proper import statement instead of inline fully-qualified reference. Add:
- `import com.intellij.openapi.extensions.PluginId;`
- `import com.intellij.ide.plugins.PluginManagerCore;`

The method should become:
```java
private static String getEMLoginBbjPath() {
    try {
        var pluginId = PluginId.getId("com.basis.bbj");
        var plugin = PluginManagerCore.getPlugin(pluginId);
        if (plugin == null) return null;
        Path emLogin = plugin.getPluginPath().resolve("lib/tools/em-login.bbj");
        return Files.exists(emLogin) ? emLogin.toString() : null;
    } catch (Exception e) {
        return null;
    }
}
```

**B) In `BbjSettingsComponent.java` (COMPAT-03 and COMPAT-04):**

1. **COMPAT-03 - Replace addBrowseFolderListener overload:**
   The deprecated overload is `addBrowseFolderListener(String title, String description, Project project, FileChooserDescriptor descriptor)`.
   Replace with `addBrowseFolderListener(Project project, FileChooserDescriptor descriptor)`, moving the title and description onto the descriptor using `.withTitle()` and `.withDescription()`.

   For `bbjHomeField` (lines 44-49), change from:
   ```java
   bbjHomeField.addBrowseFolderListener(
       "Select BBj Home Directory",
       "Choose the root directory of your BBj installation",
       null,
       FileChooserDescriptorFactory.createSingleFolderDescriptor()
   );
   ```
   To:
   ```java
   bbjHomeField.addBrowseFolderListener(
       null,
       FileChooserDescriptorFactory.createSingleFolderDescriptor()
           .withTitle("Select BBj Home Directory")
           .withDescription("Choose the root directory of your BBj installation")
   );
   ```

   For `nodeJsField` (lines 69-74), change from:
   ```java
   nodeJsField.addBrowseFolderListener(
       "Select Node.js Executable",
       "Choose the Node.js binary",
       null,
       FileChooserDescriptorFactory.createSingleLocalFileDescriptor()
   );
   ```
   To:
   ```java
   nodeJsField.addBrowseFolderListener(
       null,
       FileChooserDescriptorFactory.createSingleFileDescriptor()
           .withTitle("Select Node.js Executable")
           .withDescription("Choose the Node.js binary")
   );
   ```

2. **COMPAT-04 - Replace createSingleLocalFileDescriptor:**
   In the same nodeJsField change above, `createSingleLocalFileDescriptor()` is replaced with `createSingleFileDescriptor()`. This is already handled in the replacement above.
  </action>
  <verify>Run `cd /Users/beff/_workspace/bbj-language-server/bbj-intellij && ./gradlew compileJava` to confirm compilation succeeds. Grep BbjEMLoginAction.java for `findId` to confirm it is gone. Grep BbjSettingsComponent.java for `createSingleLocalFileDescriptor` to confirm it is gone. Grep BbjSettingsComponent.java for the 4-parameter addBrowseFolderListener signature pattern to confirm it is replaced.</verify>
  <done>BbjEMLoginAction uses PluginId.getId() instead of findId(). BbjSettingsComponent uses 2-parameter addBrowseFolderListener with descriptor.withTitle().withDescription() for both browse fields. createSingleLocalFileDescriptor() replaced with createSingleFileDescriptor(). All 3 files compile successfully.</done>
</task>

</tasks>

<verification>
1. `cd /Users/beff/_workspace/bbj-language-server/bbj-intellij && ./gradlew compileJava` succeeds
2. `grep -r "SystemInfo.is64Bit\|SystemInfo.isAarch64" bbj-intellij/src/` returns no matches
3. `grep -r "PluginId.findId" bbj-intellij/src/` returns no matches
4. `grep -r "createSingleLocalFileDescriptor" bbj-intellij/src/` returns no matches
5. `grep -r "CpuArch" bbj-intellij/src/` shows usage in BbjNodeDownloader
6. `grep -r "PluginId.getId" bbj-intellij/src/` shows usage in BbjEMLoginAction (and existing usages in BbjRunActionBase, BbjLanguageServer)
</verification>

<success_criteria>
- All 4 COMPAT requirements (01-04) are satisfied
- Zero scheduled-for-removal API usages remain in the 3 modified files
- Project compiles without errors
- Functional behavior is unchanged (same architecture detection, same plugin lookup, same file browsing)
</success_criteria>

<output>
After completion, create `.planning/phases/48-fix-scheduled-for-removal-apis/48-01-SUMMARY.md`
</output>
