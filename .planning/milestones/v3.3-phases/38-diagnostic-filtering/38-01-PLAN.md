---
phase: 38-diagnostic-filtering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/language/bbj-document-builder.ts
  - bbj-vscode/src/language/java-javadoc.ts
  - bbj-vscode/test/javadoc.test.ts
autonomous: true

must_haves:
  truths:
    - "Parse errors from bbjlib:/ synthetic files (functions.bbl, variables.bbl, labels.bbl, events.bbl, bbj-api.bbl) are never validated"
    - "Parse errors from classpath:/bbj.bbl synthetic file continue to be suppressed (no regression)"
    - "Javadoc loading shows no per-path error spam when multiple directories fail"
    - "Javadoc loading shows a single summary warning only when ALL sources fail"
    - "Javadoc loading shows no warning when at least one source succeeds (silent partial success)"
    - "Remaining console.error() calls in java-javadoc.ts migrated to logger.error()"
  artifacts:
    - path: "bbj-vscode/src/language/bbj-document-builder.ts"
      provides: "bbjlib:/ scheme check in shouldValidate()"
      contains: "document.uri.scheme === 'bbjlib'"
    - path: "bbj-vscode/src/language/java-javadoc.ts"
      provides: "Javadoc error aggregation and logger migration"
      contains: "logger.error"
    - path: "bbj-vscode/test/javadoc.test.ts"
      provides: "Updated tests for logger.error and aggregation behavior"
      contains: "logger.error"
  key_links:
    - from: "bbj-vscode/src/language/bbj-document-builder.ts"
      to: "DocumentState.Validated"
      via: "shouldValidate sets state before returning false"
      pattern: "_document.state = DocumentState.Validated"
    - from: "bbj-vscode/src/language/java-javadoc.ts"
      to: "bbj-vscode/src/language/logger.ts"
      via: "logger.error replaces console.error"
      pattern: "logger\\.error"
---

<objective>
Fix two diagnostic filtering gaps: add bbjlib:/ URI scheme to shouldValidate() suppression, and aggregate javadoc loading errors into a single summary warning instead of per-path spam. Also migrate the last 2 console.error() calls in java-javadoc.ts to logger.error().

Purpose: Users see only actionable diagnostics. Synthetic file errors and javadoc noise are eliminated.
Output: Updated bbj-document-builder.ts, java-javadoc.ts, and javadoc.test.ts with full test coverage.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-diagnostic-filtering/38-RESEARCH.md
@bbj-vscode/src/language/bbj-document-builder.ts
@bbj-vscode/src/language/java-javadoc.ts
@bbj-vscode/src/language/bbj-index-manager.ts
@bbj-vscode/test/javadoc.test.ts
@bbj-vscode/src/language/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bbjlib:/ scheme check to shouldValidate() (DIAG-01)</name>
  <files>bbj-vscode/src/language/bbj-document-builder.ts</files>
  <action>
In `bbj-document-builder.ts`, add a URI scheme check for `bbjlib` in the `shouldValidate()` method, AFTER the existing `JavaSyntheticDocUri` exact-match check and BEFORE the `BBjWorkspaceManager` instanceof check. This follows the exact same pattern as the existing `JavaSyntheticDocUri` block:

```typescript
if (_document.uri.scheme === 'bbjlib') {
    // never validate synthetic bbjlib files (functions.bbl, variables.bbl, etc.)
    _document.state = DocumentState.Validated;
    return false;
}
```

Insert this at line 31 (after the closing brace of the JavaSyntheticDocUri block, before the `if (this.wsManager()...` block).

This mirrors the pattern already used in `bbj-index-manager.ts:15` which checks `document.uri.scheme === 'bbjlib'` — ensuring consistency between the two gatekeepers.

Do NOT modify any other part of shouldValidate(). The existing JavaSyntheticDocUri check and isExternalDocument check remain as-is.
  </action>
  <verify>
Run `cd /Users/beff/_workspace/bbj-language-server/bbj-vscode && npx vitest run` — all existing tests pass (same pass/fail ratio as before; pre-existing failures in validation.test.ts are unrelated).

Verify the new code compiles: `cd /Users/beff/_workspace/bbj-language-server/bbj-vscode && npx tsc --noEmit`
  </verify>
  <done>
shouldValidate() returns false and sets DocumentState.Validated for any document with URI scheme 'bbjlib', preventing validation of functions.bbl, variables.bbl, labels.bbl, events.bbl, and bbj-api.bbl synthetic files. Existing classpath:/ and external document filtering unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Aggregate javadoc errors and migrate console.error to logger.error (DIAG-02)</name>
  <files>bbj-vscode/src/language/java-javadoc.ts, bbj-vscode/test/javadoc.test.ts</files>
  <action>
**Part A: Javadoc error aggregation in java-javadoc.ts**

In the `initialize()` method (line 44-76), add success/failure tracking around the root-scanning loop:

1. Before the `for (const root of roots...)` loop (line 49), declare:
   ```typescript
   const failedRoots: string[] = [];
   let successCount = 0;
   ```

2. Inside the try block, after `nodes = await this.fsAccess.readDirectory(root)` succeeds (line 56-57), increment `successCount++` after the inner for-loop that processes nodes (after line 72, before the outer loop continues to next root).

3. In the catch block (line 57-59), add the root to failedRoots:
   ```typescript
   failedRoots.push(root.toString());
   ```
   Keep the existing `logger.debug(...)` line as-is.

4. After the root-scanning loop ends (after line 73, before `this.initialized = true`), add the aggregated warning:
   ```typescript
   if (successCount === 0 && failedRoots.length > 0) {
       logger.warn(`Javadoc: no sources accessible (tried ${failedRoots.length} path(s)). Javadoc tooltips will be unavailable.`);
   }
   ```

5. Update the existing logger.info line (line 75) to include source count:
   ```typescript
   logger.info(`JavadocProvider initialized with ${this.packages.size} packages from ${successCount} source(s).`);
   ```

**Part B: Migrate console.error to logger.error in loadJavadocFile()**

In `loadJavadocFile()` method (lines 150-163), replace the two `console.error()` calls:

- Line 154: `console.error(...)` -> `logger.error(...)`  (package name mismatch)
- Line 160: `console.error(...)` -> `logger.error(...)`  (failed to load file)

The `logger` import already exists at line 11. No new imports needed.

**Part C: Update javadoc.test.ts**

1. Update the two existing "Check package name matches file name" tests (lines 26-59) to assert `logger.error()` instead of `console.error()`:
   - Import `logger` from `../src/language/logger.js` and `LogLevel`
   - In beforeEach or at test start, set `logger.setLevel(LogLevel.DEBUG)` so logger.error() calls go through
   - Replace `vi.spyOn(console, 'error')` with `vi.spyOn(console, 'error')` (still spy on console.error since logger.error() delegates to console.error)
   - The assertion `expect(console.error).toHaveBeenCalledWith(...)` should still work since `logger.error()` calls `console.error()` internally

   Actually, the existing tests spy on `console.error` and logger.error delegates to `console.error`, so the test assertions remain correct. The only change needed is removing the comment "// Mock console.error before each test" and updating to note it's testing logger.error output.

2. Add a new test for javadoc initialization aggregation behavior. Create a test subclass that overrides `readDirectory` to simulate failures:

   ```typescript
   test('initialize shows no per-path errors, only summary warning when all fail', async () => {
       // ... test that when all roots fail readDirectory, logger.warn is called once with summary
   })

   test('initialize shows no warning when at least one source succeeds', async () => {
       // ... test that when one root succeeds, no warn is emitted
   })
   ```

   These tests require creating a JavadocProvider subclass that can be initialized (the current `JavadocProviderUnderTest` only exposes `loadJavadocFile`). Add a new test subclass or extend the existing one to allow testing `initialize()` with mock filesystem. Use `EmptyFileSystemProvider` from langium as base, override `readDirectory` to throw for failure simulation.

   Note: The existing `JavadocProvider.getInstance()` returns a singleton that may already be initialized. For aggregation tests, create new instances via the test subclass constructor pattern already established in the file.
  </action>
  <verify>
Run `cd /Users/beff/_workspace/bbj-language-server/bbj-vscode && npx vitest run test/javadoc.test.ts` — all javadoc tests pass including new aggregation tests.

Run `cd /Users/beff/_workspace/bbj-language-server/bbj-vscode && npx vitest run` — full suite passes with same pass/fail ratio.

Run `cd /Users/beff/_workspace/bbj-language-server/bbj-vscode && npx tsc --noEmit` — no type errors.

Manually verify: grep for `console.error` in java-javadoc.ts returns zero results (all migrated to logger.error).
  </verify>
  <done>
1. Javadoc initialize() tracks success/failure per root, emits single logger.warn() only when ALL sources fail, stays silent on partial success.
2. Both console.error() calls in loadJavadocFile() replaced with logger.error().
3. Existing javadoc tests still pass (console.error spy still works since logger.error delegates to it).
4. New tests verify aggregation behavior: no warning on partial success, summary warning on total failure.
5. Zero console.error() calls remain in java-javadoc.ts.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **DIAG-01 verification**: `grep -n "bbjlib" bbj-vscode/src/language/bbj-document-builder.ts` shows scheme check in shouldValidate()
2. **DIAG-02 verification**: `grep -n "console.error" bbj-vscode/src/language/java-javadoc.ts` returns no results
3. **Test verification**: `cd bbj-vscode && npx vitest run` — all javadoc tests pass, no regressions
4. **Type verification**: `cd bbj-vscode && npx tsc --noEmit` — clean compile
5. **Pattern consistency**: `grep -n "scheme === 'bbjlib'" bbj-vscode/src/language/bbj-document-builder.ts bbj-vscode/src/language/bbj-index-manager.ts` — both files use same pattern
</verification>

<success_criteria>
- shouldValidate() returns false for bbjlib:/ scheme documents, setting DocumentState.Validated
- Javadoc initialize() emits zero warnings when any source succeeds
- Javadoc initialize() emits single summary warning when all sources fail
- loadJavadocFile() uses logger.error() not console.error()
- All tests pass (existing + new)
- No regressions in full test suite
</success_criteria>

<output>
After completion, create `.planning/phases/38-diagnostic-filtering/38-01-SUMMARY.md`
</output>
