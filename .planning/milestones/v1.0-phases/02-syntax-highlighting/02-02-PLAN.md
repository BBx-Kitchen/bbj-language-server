---
phase: 02-syntax-highlighting
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjColorSettingsPage.java
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
autonomous: false

must_haves:
  truths:
    - "BBj section appears under Settings > Editor > Color Scheme"
    - "Users can customize colors for BBj keywords, strings, comments, numbers, and other token types"
    - "Color preview in settings page shows representative BBj code with live color updates"
  artifacts:
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjColorSettingsPage.java"
      provides: "Color Scheme settings page for BBj token customization"
      exports: ["BbjColorSettingsPage"]
    - path: "bbj-intellij/src/main/resources/META-INF/plugin.xml"
      provides: "colorSettingsPage extension registration"
      contains: "colorSettingsPage"
  key_links:
    - from: "BbjColorSettingsPage.java"
      to: "DefaultLanguageHighlighterColors"
      via: "TextAttributesKey.createTextAttributesKey with fallback keys"
      pattern: "createTextAttributesKey"
    - from: "plugin.xml"
      to: "BbjColorSettingsPage"
      via: "colorSettingsPage extension registration"
      pattern: "colorSettingsPage"
---

<objective>
Add a BBj-specific section in Settings > Editor > Color Scheme that lets users customize syntax highlighting colors for BBj token types (keywords, strings, comments, numbers, etc.) with a live preview showing representative BBj code.

Purpose: While TextMate highlighting uses sensible theme defaults, power users expect per-language color customization. This puts BBj on par with built-in languages that have their own Color Scheme entries.

Output: A ColorSettingsPage registered in plugin.xml that exposes the key BBj token types for customization, with demo BBj code and IntelliJ theme integration.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-syntax-highlighting/02-RESEARCH.md
@.planning/phases/02-syntax-highlighting/02-01-SUMMARY.md
@bbj-intellij/src/main/resources/META-INF/plugin.xml
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement BbjColorSettingsPage with BBj token customization</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjColorSettingsPage.java
    bbj-intellij/src/main/resources/META-INF/plugin.xml
  </files>
  <action>
  1. Create `BbjColorSettingsPage.java` in `src/main/java/com/basis/bbj/intellij/` implementing `com.intellij.openapi.options.colors.ColorDescriptor` and `com.intellij.openapi.options.colors.ColorSettingsPage`.

  The class should:

  a. Define `TextAttributesKey` constants for BBj-specific token types that fall back to `DefaultLanguageHighlighterColors` keys. This creates BBj-specific customization entries while inheriting theme defaults. Define at minimum these token types:
  - KEYWORD (fallback: DefaultLanguageHighlighterColors.KEYWORD) - for IF, WHILE, FOR, CLASS, etc.
  - STRING (fallback: DefaultLanguageHighlighterColors.STRING) - for quoted strings
  - LINE_COMMENT (fallback: DefaultLanguageHighlighterColors.LINE_COMMENT) - for REM comments
  - BLOCK_COMMENT (fallback: DefaultLanguageHighlighterColors.BLOCK_COMMENT) - for block comments
  - NUMBER (fallback: DefaultLanguageHighlighterColors.NUMBER) - for numeric literals
  - FUNCTION_CALL (fallback: DefaultLanguageHighlighterColors.FUNCTION_CALL) - for built-in functions
  - OPERATION_SIGN (fallback: DefaultLanguageHighlighterColors.OPERATION_SIGN) - for operators
  - IDENTIFIER (fallback: DefaultLanguageHighlighterColors.IDENTIFIER) - for variables/identifiers
  - STRING_ESCAPE (fallback: DefaultLanguageHighlighterColors.VALID_STRING_ESCAPE) - for escape sequences

  Use the naming convention: `TextAttributesKey.createTextAttributesKey("BBJ_KEYWORD", DefaultLanguageHighlighterColors.KEYWORD)` etc.

  b. Return the BBj file icon from `getIcon()` (use `BbjIcons.FILE`).

  c. Return a `SyntaxHighlighter` from `getHighlighter()`. Since BBj uses TextMate-based highlighting (not a custom lexer), return a minimal no-op `SyntaxHighlighter` that does not tokenize. The ColorSettingsPage demo text will use `getAdditionalHighlightingTagToDescriptorMap()` to annotate the demo text with XML-like tags that map to the `TextAttributesKey` constants. This is the standard approach for ColorSettingsPage when the real highlighter is not a custom implementation.

  d. Implement `getDemoText()` returning a representative BBj code snippet with annotation tags. Example:
  ```
  <kw>REM</kw> <lc>BBj Example Program</lc>
  <kw>CLASS</kw> <id>PUBLIC</id> <id>MyClass</id>

      <kw>FIELD</kw> <kw>PRIVATE</kw> <id>BBjString</id> <id>name$</id>
      <kw>FIELD</kw> <kw>PRIVATE</kw> <id>BBjNumber</id> <id>count</id>

      <kw>METHOD</kw> <kw>PUBLIC</kw> <id>void</id> <fn>process</fn>(<id>BBjString</id> <id>input$</id>)
          <kw>LET</kw> <id>count</id> <op>=</op> <num>42</num>
          <kw>LET</kw> <id>name$</id> <op>=</op> <str>"Hello, World!"</str>
          <kw>IF</kw> <id>count</id> <op>></op> <num>0</num> <kw>THEN</kw>
              <fn>PRINT</fn>(<id>name$</id>)
          <kw>FI</kw>
          <kw>FOR</kw> <id>i</id> <op>=</op> <num>1</num> <kw>TO</kw> <num>10</num>
              <fn>PRINT</fn>(<str>"Value: "</str> <op>+</op> <fn>STR$</fn>(<id>i</id>))
          <kw>NEXT</kw> <id>i</id>
      <kw>METHODEND</kw>

  <kw>CLASSEND</kw>

  <bc>/@
   * Block comment example
   * Describes the program
  @/</bc>
  ```

  e. Implement `getAdditionalHighlightingTagToDescriptorMap()` mapping the short tags to TextAttributesKey constants:
  - "kw" -> BBJ_KEYWORD
  - "str" -> BBJ_STRING
  - "lc" -> BBJ_LINE_COMMENT
  - "bc" -> BBJ_BLOCK_COMMENT
  - "num" -> BBJ_NUMBER
  - "fn" -> BBJ_FUNCTION_CALL
  - "op" -> BBJ_OPERATION_SIGN
  - "id" -> BBJ_IDENTIFIER
  - "esc" -> BBJ_STRING_ESCAPE

  f. Return `getDisplayName()` as "BBj".

  g. Return `getAttributeDescriptors()` as an `AttributesDescriptor[]` array mapping display names to TextAttributesKey:
  - "Keyword" -> BBJ_KEYWORD
  - "String" -> BBJ_STRING
  - "Line comment" -> BBJ_LINE_COMMENT
  - "Block comment" -> BBJ_BLOCK_COMMENT
  - "Number" -> BBJ_NUMBER
  - "Function call" -> BBJ_FUNCTION_CALL
  - "Operator" -> BBJ_OPERATION_SIGN
  - "Identifier" -> BBJ_IDENTIFIER
  - "String escape" -> BBJ_STRING_ESCAPE

  h. Return empty `ColorDescriptor[]` from `getColorDescriptors()`.

  2. Register the ColorSettingsPage in `plugin.xml` by adding inside the `<extensions>` block:
  ```xml
  <colorSettingsPage implementation="com.basis.bbj.intellij.BbjColorSettingsPage"/>
  ```

  NOTE: The ColorSettingsPage uses `TextAttributesKey` instances with fallbacks to `DefaultLanguageHighlighterColors`, which means it will show the theme's default colors initially. Users can override them per-language. However, since the actual TextMate highlighting maps to the global `DefaultLanguageHighlighterColors` keys (not the BBj-specific ones), user overrides in this page will NOT automatically affect the TextMate-driven editor highlighting. This is a known limitation of combining TextMate highlighting with ColorSettingsPage. The settings page still provides value as a reference and will become fully functional when the language server provides semantic tokens in Phase 4. For now, it serves as a preview and establishes the infrastructure.

  NOTE: Do NOT attempt to create a custom SyntaxHighlighter with a JFlex Lexer. The demo text uses tag-based highlighting via `getAdditionalHighlightingTagToDescriptorMap()` which is the correct pattern for ColorSettingsPage when the language uses TextMate for real highlighting.
  </action>
  <verify>
  Run `cd bbj-intellij && ./gradlew buildPlugin --no-daemon` and verify:
  1. Build succeeds (BbjColorSettingsPage compiles)
  2. Plugin JAR contains `com/basis/bbj/intellij/BbjColorSettingsPage.class`
  3. plugin.xml contains `colorSettingsPage` extension registration
  </verify>
  <done>
  BbjColorSettingsPage is registered in plugin.xml and compiles successfully. It defines 9 BBj token type customization entries (keyword, string, line comment, block comment, number, function call, operator, identifier, string escape) with demo BBj code for preview. The settings page falls back to IntelliJ theme defaults via DefaultLanguageHighlighterColors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify syntax highlighting and color settings in IntelliJ</name>
  <what-built>
  Complete syntax highlighting for BBj files via TextMate grammar integration (Plan 01) and a BBj Color Scheme settings page (Plan 02). Keywords, strings, comments, numbers, and other tokens should appear in distinct colors. The Color Scheme page should appear under Settings > Editor > Color Scheme > BBj.
  </what-built>
  <how-to-verify>
  1. Run `cd bbj-intellij && ./gradlew runIde` to launch IntelliJ sandbox
  2. Create or open a `.bbj` file with representative code:
     ```
     REM This is a comment
     CLASS PUBLIC MyClass
         METHOD PUBLIC void greet(BBjString name$)
             LET x = 42
             PRINT("Hello, " + name$)
             IF x > 0 THEN
                 PRINT("Positive")
             FI
         METHODEND
     CLASSEND
     ```
  3. Verify syntax highlighting:
     - Keywords (REM, CLASS, PUBLIC, METHOD, etc.) appear in a distinct color (typically blue/orange depending on theme)
     - String "Hello, " appears in string color (typically green)
     - Comment text after REM appears in comment color (typically gray/green)
     - Number 42 appears in number color
     - PRINT and other functions may appear in function color
  4. Navigate to Settings > Editor > Color Scheme > BBj
  5. Verify the BBj section exists with customizable token types
  6. Verify the demo code preview is visible and colored
  7. Try changing a color (e.g., Keyword) and verify the preview updates
  </how-to-verify>
  <resume-signal>Type "approved" if highlighting works and color settings page is visible, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `cd bbj-intellij && ./gradlew buildPlugin --no-daemon` completes with BUILD SUCCESSFUL
2. BbjColorSettingsPage compiles and is registered in plugin.xml
3. Plugin JAR contains all required classes and resources
4. IntelliJ sandbox shows BBj Color Scheme settings page with 9 customizable token types
5. Demo BBj code in settings page preview is syntax highlighted
</verification>

<success_criteria>
- BBj section appears under Settings > Editor > Color Scheme in IntelliJ
- 9 BBj token types are available for customization (keyword, string, line comment, block comment, number, function call, operator, identifier, string escape)
- Demo text in settings page shows representative BBj code with colored tokens
- Color changes in settings update the preview in real-time
- User confirms syntax highlighting works correctly in a real BBj file
</success_criteria>

<output>
After completion, create `.planning/phases/02-syntax-highlighting/02-02-SUMMARY.md`
</output>
