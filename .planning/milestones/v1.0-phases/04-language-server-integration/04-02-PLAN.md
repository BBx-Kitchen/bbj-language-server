---
phase: 04-language-server-integration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjStatusBarWidgetFactory.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjStatusBarWidget.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjRestartServerAction.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerService.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageClient.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
  - bbj-intellij/src/main/resources/icons/bbj-status-ready.svg
  - bbj-intellij/src/main/resources/icons/bbj-status-starting.svg
  - bbj-intellij/src/main/resources/icons/bbj-status-error.svg
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
autonomous: true

must_haves:
  truths:
    - "Status bar shows BBj server state (Ready/Starting/Error) with colored icon"
    - "Status bar widget only visible when BBj file is open"
    - "Clicking status bar opens popup with Restart Server, Open Settings, Show Server Log"
    - "Tools menu includes Restart BBj Language Server action"
    - "Changing settings triggers debounced language server restart"
    - "Status bar reflects server state changes in real time"
  artifacts:
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjStatusBarWidget.java"
      provides: "Custom status bar widget with icon + text + popup menu"
      exports: ["BbjStatusBarWidget"]
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjStatusBarWidgetFactory.java"
      provides: "StatusBarWidgetFactory for registration"
      exports: ["BbjStatusBarWidgetFactory"]
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjRestartServerAction.java"
      provides: "Tools menu action to restart language server"
      exports: ["BbjRestartServerAction"]
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerService.java"
      provides: "Project-level service managing server lifecycle, restart, debounce"
      exports: ["BbjServerService"]
  key_links:
    - from: "BbjLanguageClient.java"
      to: "BbjStatusBarWidget"
      via: "handleServerStatusChanged dispatches to widget via BbjServerService"
      pattern: "BbjServerService.*updateStatus"
    - from: "BbjRestartServerAction"
      to: "LanguageServerManager"
      via: "stop() then start() via BbjServerService"
      pattern: "BbjServerService.*restart"
    - from: "BbjServerService"
      to: "Alarm"
      via: "Debounced restart on settings change"
      pattern: "Alarm.*restartAlarm"
---

<objective>
Add the status bar widget showing language server state, the Tools menu restart action, and debounced settings-change restart -- the user-facing controls for the server lifecycle.

Purpose: Users need visibility into server state and the ability to restart it. This plan provides the core UX controls that make the language server integration feel polished and professional rather than invisible.
Output: Status bar widget (icon + label + popup), Tools menu restart action, and automatic debounced restart when settings change.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-language-server-integration/04-RESEARCH.md
@.planning/phases/04-language-server-integration/04-CONTEXT.md
@.planning/phases/04-language-server-integration/04-01-SUMMARY.md
@bbj-intellij/src/main/resources/META-INF/plugin.xml
@bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageClient.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BbjServerService and status bar widget</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerService.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjStatusBarWidgetFactory.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjStatusBarWidget.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageClient.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
    bbj-intellij/src/main/resources/icons/bbj-status-ready.svg
    bbj-intellij/src/main/resources/icons/bbj-status-starting.svg
    bbj-intellij/src/main/resources/icons/bbj-status-error.svg
    bbj-intellij/src/main/resources/META-INF/plugin.xml
  </files>
  <action>
    Create the `ui/` package under `com.basis.bbj.intellij` and implement three classes:

    **1. BbjServerService.java** -- Project-level service that centralizes server lifecycle management:
    - Implements `Disposable`
    - Register as a project service in plugin.xml: `<projectService serviceImplementation="com.basis.bbj.intellij.ui.BbjServerService"/>`
    - Fields:
      - `private final Project project`
      - `private ServerStatus currentStatus = ServerStatus.stopped` (use `com.redhat.devtools.lsp4ij.ServerStatus` -- if not directly accessible, use a custom enum with values: STOPPED, STARTING, STARTED, ERROR)
      - `private final Alarm restartAlarm` (from `com.intellij.util.Alarm`, `Alarm.ThreadToUse.POOLED_THREAD`, disposable parent = `this`)
      - `private static final int RESTART_DEBOUNCE_MS = 500`
      - `private long lastCrashTime = 0` (for crash recovery in Plan 03)
      - `private int crashCount = 0` (for crash recovery in Plan 03)
    - Methods:
      - `static BbjServerService getInstance(Project project)` -- returns `project.getService(BbjServerService.class)`
      - `void updateStatus(ServerStatus status)` -- stores status, dispatches UI update via `invokeLater` to all status bar widgets in all windows: `project.getMessageBus().syncPublisher(BbjServerStatusListener.TOPIC).statusChanged(status)`
      - `void restart()` -- calls `LanguageServerManager.getInstance(project).stop("bbjLanguageServer", stopOptions)` then `.start("bbjLanguageServer")`. The `StopOptions` should have `setWillDisable(false)`.
      - `void scheduleRestart()` -- debounced: `restartAlarm.cancelAllRequests()`, `restartAlarm.addRequest(this::restart, RESTART_DEBOUNCE_MS)`
      - `ServerStatus getCurrentStatus()` -- returns `currentStatus`
      - `dispose()` -- alarm is auto-disposed via parent chain

    - Create a `BbjServerStatusListener` interface with a single method `void statusChanged(ServerStatus status)` and a `Topic<BbjServerStatusListener> TOPIC` field using `Topic.create("BBj Server Status", BbjServerStatusListener.class)`. This can be a nested interface or separate file -- nested is fine.

    **2. BbjStatusBarWidgetFactory.java** -- Implements `StatusBarWidgetFactory`:
    - `getId()` returns `"BbjLanguageServerStatus"`
    - `getDisplayName()` returns `"BBj Language Server"`
    - `isAvailable(@NotNull Project project)` returns `true`
    - `createWidget(@NotNull Project project)` returns `new BbjStatusBarWidget(project)`

    **3. BbjStatusBarWidget.java** -- Extends `EditorBasedWidget`, implements `CustomStatusBarWidget`:
    - Widget ID: `"BbjLanguageServerStatus"`
    - `getComponent()` returns a `JPanel` (using `new JPanel(new FlowLayout(FlowLayout.LEFT, 4, 0))`) containing:
      - A `JLabel` for the icon (status-dependent icon)
      - A `JLabel` for text ("BBj: Ready", "BBj: Starting", "BBj: Error", "BBj: Stopped")
    - The panel should have no border, be non-opaque, and have a mouse listener that opens a popup menu on click
    - Popup menu (JBPopupMenu) with three items:
      - "Restart Server" -- calls `BbjServerService.getInstance(project).restart()`
      - "Open Settings" -- calls `ShowSettingsUtil.getInstance().showSettingsDialog(project, "BBj")`
      - "Show Server Log" -- opens the tool window: `ToolWindowManager.getInstance(project).getToolWindow("BBj Language Server")?.show()` (tool window created in Plan 03; for now just attempt to find it, silently ignore if null)
    - Tooltip shows: "BBj Language Server\nStatus: {status}\nPID: {pid if available}" (PID can be added later; for now just status)
    - Subscribe to `BbjServerStatusListener.TOPIC` on the project message bus in constructor. When `statusChanged` is called, update icon and text label via `invokeLater`.
    - Visibility: The widget is always registered but only shows content when BBj file is active. Override `getPresentation()` or check `getEditor()` in component to show/hide. Simplest approach: always show the widget but display "BBj: Idle" when no BBj file is focused, by checking `FileEditorManager.getInstance(project).getSelectedFiles()` for BBj file types in the `selectionChanged` callback (from `EditorBasedWidget`).

    **Status icons** -- Create three 13x13 SVG icons in `src/main/resources/icons/`:
    - `bbj-status-ready.svg`: Green filled circle
    - `bbj-status-starting.svg`: Yellow/amber filled circle
    - `bbj-status-error.svg`: Red filled circle
    Use simple SVGs: `<svg><circle cx="6.5" cy="6.5" r="5" fill="#..."/></svg>` with viewBox="0 0 13 13".

    **BbjIcons.java** -- Add status icon constants:
    ```java
    Icon STATUS_READY = IconLoader.getIcon("/icons/bbj-status-ready.svg", BbjIcons.class);
    Icon STATUS_STARTING = IconLoader.getIcon("/icons/bbj-status-starting.svg", BbjIcons.class);
    Icon STATUS_ERROR = IconLoader.getIcon("/icons/bbj-status-error.svg", BbjIcons.class);
    ```

    **BbjLanguageClient.java** -- Update `handleServerStatusChanged` (from Plan 01) to notify BbjServerService:
    ```java
    @Override
    public void handleServerStatusChanged(ServerStatus serverStatus) {
        super.handleServerStatusChanged(serverStatus);
        ApplicationManager.getApplication().invokeLater(() -> {
            BbjServerService service = BbjServerService.getInstance(getProject());
            service.updateStatus(serverStatus);
        });
    }
    ```
    Note: `getProject()` is available from the `LanguageClientImpl` parent class.

    **plugin.xml** -- Add inside the `<extensions defaultExtensionNs="com.intellij">` block:
    ```xml
    <!-- Project-level server lifecycle service -->
    <projectService serviceImplementation="com.basis.bbj.intellij.ui.BbjServerService"/>

    <!-- Status bar widget -->
    <statusBarWidgetFactory
        id="BbjLanguageServerStatus"
        implementation="com.basis.bbj.intellij.ui.BbjStatusBarWidgetFactory"/>
    ```
  </action>
  <verify>
    Run `./gradlew buildPlugin` -- must compile without errors.
    Verify BbjServerService, BbjStatusBarWidgetFactory, BbjStatusBarWidget classes exist in ui/ package.
    Verify plugin.xml has projectService and statusBarWidgetFactory entries.
    Verify 3 status SVG icons exist.
  </verify>
  <done>
    Status bar widget registered and compiles.
    BbjServerService centralizes server lifecycle with debounced restart.
    BbjLanguageClient dispatches status changes to BbjServerService.
    Status bar shows icon + text reflecting server state.
    Click on widget opens popup menu with 3 actions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create restart action and settings-change restart trigger</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjRestartServerAction.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
    bbj-intellij/src/main/resources/META-INF/plugin.xml
  </files>
  <action>
    **1. BbjRestartServerAction.java** -- Extends `AnAction`:
    - Constructor: `super("Restart BBj Language Server", "Restart the BBj language server", BbjIcons.FILE)`
    - `actionPerformed(AnActionEvent e)`:
      - Get project from `e.getProject()`. If null, return.
      - Call `BbjServerService.getInstance(project).restart()`
    - `update(AnActionEvent e)`:
      - Enable/visible only when a BBj file is focused in the editor.
      - Get the current editor file: `CommonDataKeys.VIRTUAL_FILE.getData(e.getDataContext())`
      - Check if file extension is one of: `bbj`, `bbl`, `bbjt`, `src`
      - Set `e.getPresentation().setEnabledAndVisible(isBbjFile)` where `isBbjFile` is true if file matches
      - If no file or no project, set disabled and invisible

    **2. BbjSettingsConfigurable.java** -- Modify the existing `apply()` method to trigger debounced restart:
    - After the existing code that saves settings and refreshes editor notifications, add:
      ```java
      // Trigger debounced language server restart
      for (var project : ProjectManager.getInstance().getOpenProjects()) {
          BbjServerService.getInstance(project).scheduleRestart();
      }
      ```
    - This uses the debounced `scheduleRestart()` method from BbjServerService, so if the user clicks Apply multiple times quickly, only one restart occurs.
    - Add the import for `BbjServerService`: `import com.basis.bbj.intellij.ui.BbjServerService;`

    **3. plugin.xml** -- Add the Tools menu action. Place this as a new `<actions>` block at the top level (sibling to `<extensions>`):
    ```xml
    <actions>
        <action id="bbj.restartLanguageServer"
                class="com.basis.bbj.intellij.ui.BbjRestartServerAction"
                text="Restart BBj Language Server"
                description="Restart the BBj language server">
            <add-to-group group-id="ToolsMenu" anchor="last"/>
        </action>
    </actions>
    ```
  </action>
  <verify>
    Run `./gradlew buildPlugin` -- must compile without errors.
    Verify BbjRestartServerAction.java exists and extends AnAction.
    Verify BbjSettingsConfigurable.apply() calls BbjServerService.scheduleRestart().
    Verify plugin.xml has the `<actions>` block with the restart action.
  </verify>
  <done>
    Tools menu shows "Restart BBj Language Server" (visible only when BBj file is focused).
    Clicking the action triggers server restart via BbjServerService.
    Changing settings and clicking Apply triggers debounced server restart.
    `./gradlew buildPlugin` passes.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew buildPlugin` succeeds
2. plugin.xml has: projectService, statusBarWidgetFactory, actions block
3. BbjServerService has restart(), scheduleRestart(), updateStatus() methods
4. BbjStatusBarWidget has icon + text labels and popup menu
5. BbjRestartServerAction visibility controlled by BBj file focus
6. BbjSettingsConfigurable.apply() triggers scheduleRestart()
7. BbjLanguageClient.handleServerStatusChanged() notifies BbjServerService
</verification>

<success_criteria>
- Status bar widget appears showing server state when BBj file is open
- Clicking widget opens popup with Restart/Settings/Log actions
- Tools > Restart BBj Language Server action visible and functional
- Settings Apply triggers debounced server restart (not immediate, batched)
- Status bar updates in real time as server starts/stops
</success_criteria>

<output>
After completion, create `.planning/phases/04-language-server-integration/04-02-SUMMARY.md`
</output>
