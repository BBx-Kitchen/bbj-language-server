---
phase: 04-language-server-integration
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerLogToolWindowFactory.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerCrashNotificationProvider.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerService.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageClient.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
  - bbj-intellij/src/main/resources/icons/bbj-toolwindow.svg
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
autonomous: true

must_haves:
  truths:
    - "BBj Language Server tool window shows real-time server log output"
    - "Server crash triggers balloon notification with Show Log action"
    - "Server crash triggers editor banner on BBj files until resolved"
    - "Auto-restart occurs once after crash; second crash stops and notifies user"
    - "Closing project cleanly stops language server (no zombie processes)"
    - "Log level configurable in settings and passed to language server"
  artifacts:
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerLogToolWindowFactory.java"
      provides: "Tool window with ConsoleView for server stdout/stderr"
      exports: ["BbjServerLogToolWindowFactory"]
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerCrashNotificationProvider.java"
      provides: "Editor banner shown when server is in crashed state"
      exports: ["BbjServerCrashNotificationProvider"]
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerService.java"
      provides: "Crash recovery logic (auto-restart once, stop on second)"
      contains: "crashCount"
  key_links:
    - from: "BbjLanguageClient.java"
      to: "BbjServerService"
      via: "handleServerStatusChanged detects crash (stopped unexpectedly)"
      pattern: "ServerStatus\\.stopped.*crash"
    - from: "BbjServerService"
      to: "NotificationGroupManager"
      via: "Balloon notification on crash"
      pattern: "NotificationGroupManager.*BBj Language Server"
    - from: "BbjServerService"
      to: "EditorNotifications"
      via: "updateAllNotifications triggers crash banner"
      pattern: "EditorNotifications.*updateAllNotifications"
    - from: "BbjServerLogToolWindowFactory"
      to: "ConsoleView"
      via: "TextConsoleBuilderFactory creates console for log output"
      pattern: "TextConsoleBuilderFactory.*createBuilder"
---

<objective>
Add the server log tool window, crash recovery with notifications (balloon + editor banner), clean project shutdown, and log level configuration -- the error handling and observability layer for the language server.

Purpose: When things go wrong (server crashes, errors), users need clear feedback and automatic recovery. When debugging, they need to see server logs. This plan completes the production-quality error handling story.
Output: Tool window with live log output, crash recovery with auto-restart limit, balloon and banner notifications, clean shutdown, log level setting.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-language-server-integration/04-RESEARCH.md
@.planning/phases/04-language-server-integration/04-CONTEXT.md
@.planning/phases/04-language-server-integration/04-01-SUMMARY.md
@.planning/phases/04-language-server-integration/04-02-SUMMARY.md
@bbj-intellij/src/main/resources/META-INF/plugin.xml
@bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerService.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageClient.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tool window and crash recovery system</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerLogToolWindowFactory.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerCrashNotificationProvider.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerService.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageClient.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
    bbj-intellij/src/main/resources/icons/bbj-toolwindow.svg
    bbj-intellij/src/main/resources/META-INF/plugin.xml
  </files>
  <action>
    **1. BbjServerLogToolWindowFactory.java** -- Implements `ToolWindowFactory, DumbAware`:
    - `createToolWindowContent(Project project, ToolWindow toolWindow)`:
      - Create `ConsoleView` via `TextConsoleBuilderFactory.getInstance().createBuilder(project).getConsole()`
      - Create `Content` via `toolWindow.getContentManager().getFactory().createContent(console.getComponent(), "Log", false)`
      - Add content: `toolWindow.getContentManager().addContent(content)`
      - Store the console reference in `BbjServerService.getInstance(project)` so other code can write to it: add a `setConsoleView(ConsoleView console)` method to BbjServerService
      - Register console as disposable: `Disposer.register(toolWindow.getDisposable(), console)`
    - `shouldBeAvailable(Project project)` returns `true`

    **2. BbjServerService.java** -- Add crash recovery logic and log output methods:

    Add fields:
    - `private ConsoleView consoleView` (set by tool window factory)
    - `private boolean serverCrashed = false` (tracks crash state for editor banner)
    - `private static final long CRASH_WINDOW_MS = 30_000` (30 seconds)

    Add/modify methods:
    - `void setConsoleView(ConsoleView console)` -- stores reference
    - `void logToConsole(String message, ConsoleViewContentType type)` -- writes to tool window console if available: `if (consoleView != null) { consoleView.print(message + "\n", type); }`
    - `boolean isServerCrashed()` -- returns `serverCrashed`
    - `void clearCrashState()` -- sets `serverCrashed = false`, `crashCount = 0`, updates editor notifications

    Modify `updateStatus(ServerStatus status)`:
    - If status is `stopped` and previous status was `started` or `starting` (unexpected stop = crash):
      - Set `serverCrashed = true`
      - Increment `crashCount`
      - Log to console: "Language server stopped unexpectedly"
      - If `crashCount == 1`: Auto-restart after brief delay (1 second). Log: "Auto-restarting language server (attempt 1)..."
      - If `crashCount >= 2` AND within `CRASH_WINDOW_MS` of first crash: Stop. Log: "Language server crashed twice. Stopping auto-restart." Fire balloon notification. Update editor notifications (triggers crash banner).
      - Reset `crashCount` if more than `CRASH_WINDOW_MS` has passed since last crash.
    - If status is `started`: Clear crash state (`serverCrashed = false`, `crashCount = 0`). Update editor notifications.
    - Store `currentStatus = status`
    - Fire message bus topic as before

    Add balloon notification method:
    - `private void notifyCrash()`:
      ```java
      NotificationGroupManager.getInstance()
          .getNotificationGroup("BBj Language Server")
          .createNotification(
              "BBj Language Server crashed unexpectedly",
              "The server crashed twice and has been stopped. Check the log for details.",
              NotificationType.ERROR)
          .addAction(new NotificationAction("Show Log") {
              @Override
              public void actionPerformed(@NotNull AnActionEvent e, @NotNull Notification n) {
                  ToolWindow tw = ToolWindowManager.getInstance(project)
                      .getToolWindow("BBj Language Server");
                  if (tw != null) tw.show();
                  n.expire();
              }
          })
          .addAction(new NotificationAction("Restart") {
              @Override
              public void actionPerformed(@NotNull AnActionEvent e, @NotNull Notification n) {
                  clearCrashState();
                  restart();
                  n.expire();
              }
          })
          .notify(project);
      ```

    Add project disposal hook (in constructor or init block):
    - Register with project disposal to force-kill server:
      ```java
      Disposer.register(project, this);
      ```
      In `dispose()`: Call `LanguageServerManager.getInstance(project).stop("bbjLanguageServer")` to ensure clean shutdown on project close. Log: "Project closing, stopping language server".

    **3. BbjServerCrashNotificationProvider.java** -- Extends `EditorNotificationProvider`:
    - `collectNotificationData(Project project, VirtualFile file)`:
      - Return null if file is not a BBj file (check extension against bbj, bbl, bbjt, src)
      - Return null if `BbjServerService.getInstance(project).isServerCrashed()` is false
      - Create `EditorNotificationPanel` with `EditorNotificationPanel.Status.Error`
      - Set text: "BBj Language Server has crashed. Language features are unavailable."
      - Add action link "Restart Server" that calls `BbjServerService.getInstance(project).clearCrashState()` then `restart()`
      - Add action link "Show Log" that opens the tool window
      - Return the panel

    **4. BbjLanguageClient.java** -- Enhance `handleServerStatusChanged`:
    - The existing code from Plan 02 dispatches to BbjServerService. The crash detection logic is now in BbjServerService.updateStatus(), so no changes needed to the client itself.
    - However, add log output to the tool window. In `handleServerStatusChanged`:
      ```java
      BbjServerService service = BbjServerService.getInstance(getProject());
      service.logToConsole("Server status: " + serverStatus, ConsoleViewContentType.SYSTEM_OUTPUT);
      service.updateStatus(serverStatus);
      ```

    **5. BbjIcons.java** -- Add tool window icon:
    ```java
    Icon TOOL_WINDOW = IconLoader.getIcon("/icons/bbj-toolwindow.svg", BbjIcons.class);
    ```

    **6. bbj-toolwindow.svg** -- Create a 13x13 SVG icon. Use the same BBj blue from the file icon but as a simple terminal/console shape (rectangle with "> " prompt). Keep it minimal.

    **7. plugin.xml** -- Add inside `<extensions defaultExtensionNs="com.intellij">`:
    ```xml
    <!-- Server log tool window -->
    <toolWindow id="BBj Language Server"
                factoryClass="com.basis.bbj.intellij.ui.BbjServerLogToolWindowFactory"
                anchor="bottom"
                icon="com.basis.bbj.intellij.BbjIcons.TOOL_WINDOW"
                canCloseContents="false"/>

    <!-- Notification group for crash/error balloons -->
    <notificationGroup id="BBj Language Server"
                        displayType="STICKY_BALLOON"/>

    <!-- Editor banner for server crash state -->
    <editorNotificationProvider
        implementation="com.basis.bbj.intellij.ui.BbjServerCrashNotificationProvider"/>
    ```
  </action>
  <verify>
    Run `./gradlew buildPlugin` -- must compile without errors.
    Verify BbjServerLogToolWindowFactory.java exists and implements ToolWindowFactory.
    Verify BbjServerCrashNotificationProvider.java exists and extends EditorNotificationProvider.
    Verify BbjServerService.java has crashCount, CRASH_WINDOW_MS, notifyCrash(), logToConsole() methods.
    Verify plugin.xml has toolWindow, notificationGroup, and editorNotificationProvider entries.
  </verify>
  <done>
    Tool window "BBj Language Server" registered in bottom panel with ConsoleView.
    Crash recovery: auto-restart once, stop and notify on second crash within 30s.
    Balloon notification on double-crash with "Show Log" and "Restart" actions.
    Editor banner on BBj files when server is in crashed state.
    Project disposal triggers server force-stop.
    `./gradlew buildPlugin` passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add log level setting and pass to language server</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageClient.java
  </files>
  <action>
    **1. BbjSettings.java** -- Add log level field to State:
    ```java
    public String logLevel = "Info";  // Default: Info. Options: Error, Warn, Info, Debug
    ```

    **2. BbjSettingsComponent.java** -- Add log level dropdown to settings UI:
    - Read the existing BbjSettingsComponent.java first to understand the current layout pattern.
    - Add a `JComboBox<String>` with options: "Error", "Warn", "Info", "Debug"
    - Place it in the settings form below the existing fields, with label "Log Level"
    - Add getter `getLogLevel()` and setter `setLogLevel(String level)`
    - Follow the same FormBuilder pattern used for existing fields

    **3. BbjSettingsConfigurable.java** -- Wire log level to settings:
    - In `isModified()`: Add check for `!Objects.equals(myComponent.getLogLevel(), state.logLevel)`
    - In `apply()`: Add `state.logLevel = myComponent.getLogLevel()` before the restart trigger
    - In `reset()`: Add `myComponent.setLogLevel(state.logLevel)`. If empty, default to "Info".

    **4. BbjLanguageClient.java** -- Pass log level in both initializationOptions and createSettings:
    - In `createSettings()` (or wherever settings are built): Add `settings.addProperty("logLevel", state.logLevel)` alongside home and classpath
    - Ensure `initializationOptions` (if set via LSPClientFeatures) also includes `logLevel`
    - Read BbjLanguageClient.java as created in Plan 01 to see the exact structure, then add logLevel to both the initializationOptions and the didChangeConfiguration settings object
  </action>
  <verify>
    Run `./gradlew buildPlugin` -- must compile without errors.
    Verify BbjSettings.State has `logLevel` field with "Info" default.
    Verify BbjSettingsComponent has log level dropdown (JComboBox).
    Verify BbjSettingsConfigurable wires logLevel in isModified/apply/reset.
    Verify BbjLanguageClient includes logLevel in settings sent to server.
  </verify>
  <done>
    Settings UI shows Log Level dropdown with Error/Warn/Info/Debug options.
    Log level persists across IDE restarts.
    Log level passed to language server via initializationOptions and didChangeConfiguration.
    Changing log level triggers debounced restart (from existing apply() logic).
    `./gradlew buildPlugin` passes.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew buildPlugin` succeeds
2. Tool window "BBj Language Server" appears in bottom panel
3. plugin.xml has toolWindow, notificationGroup, editorNotificationProvider entries
4. BbjServerService has crash recovery (auto-restart once, stop on second)
5. Balloon notification fires on double-crash with Show Log and Restart actions
6. Editor banner appears on BBj files when server is crashed
7. Project disposal stops language server
8. Log level dropdown in settings with 4 options
9. Log level included in initializationOptions sent to server
</verification>

<success_criteria>
- Tool window shows server log output (status changes at minimum)
- Crash recovery automatically restarts server once, then stops with notification
- Balloon notification has actionable links (Show Log, Restart)
- Editor banner persists until server is restarted or crash state cleared
- Project close kills server process cleanly
- Log level setting works end-to-end (UI -> persist -> send to server)
</success_criteria>

<output>
After completion, create `.planning/phases/04-language-server-integration/04-03-SUMMARY.md`
</output>
