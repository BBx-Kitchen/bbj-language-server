---
phase: 04-language-server-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-intellij/build.gradle.kts
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServerFactory.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServer.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageClient.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjCompletionFeature.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
  - bbj-intellij/src/main/resources/icons/bbj-function.svg
  - bbj-intellij/src/main/resources/icons/bbj-variable.svg
  - bbj-intellij/src/main/resources/icons/bbj-keyword.svg
autonomous: true

must_haves:
  truths:
    - "Language server process starts when first BBj file is opened"
    - "Syntax errors appear as red underlines in editor"
    - "Code completion popup shows BBj keywords, functions, variables"
    - "Ctrl+Click navigates to variable declaration"
    - "Hover shows documentation and signature"
    - "Parameter hints show on function call"
  artifacts:
    - path: "bbj-intellij/build.gradle.kts"
      provides: "LSP4IJ dependency and language server bundle copy task"
      contains: "com.redhat.devtools.lsp4ij"
    - path: "bbj-intellij/src/main/resources/META-INF/plugin.xml"
      provides: "LSP4IJ dependency declaration and server registration"
      contains: "com.redhat.devtools.lsp4ij"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServerFactory.java"
      provides: "LanguageServerFactory connecting all LSP pieces"
      exports: ["BbjLanguageServerFactory"]
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServer.java"
      provides: "OSProcessStreamConnectionProvider launching node main.cjs --stdio"
      exports: ["BbjLanguageServer"]
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageClient.java"
      provides: "LanguageClientImpl with initializationOptions and createSettings"
      exports: ["BbjLanguageClient"]
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjCompletionFeature.java"
      provides: "Custom BBj icons for completion item kinds"
      exports: ["BbjCompletionFeature"]
  key_links:
    - from: "bbj-intellij/build.gradle.kts"
      to: "LSP4IJ marketplace plugin"
      via: "plugin() dependency declaration"
      pattern: "plugin\\(\"com\\.redhat\\.devtools\\.lsp4ij"
    - from: "plugin.xml"
      to: "BbjLanguageServerFactory"
      via: "LSP4IJ server extension point"
      pattern: "factoryClass.*BbjLanguageServerFactory"
    - from: "BbjLanguageServer.java"
      to: "node main.cjs --stdio"
      via: "GeneralCommandLine in constructor"
      pattern: "GeneralCommandLine.*--stdio"
    - from: "BbjLanguageClient.java"
      to: "BbjSettings"
      via: "initializationOptions with home and classpath"
      pattern: "initializationOptions.*home.*classpath"
---

<objective>
Wire the BBj language server to the IntelliJ plugin via LSP4IJ, enabling all core LSP features (diagnostics, completion, navigation, hover, signature help) end-to-end.

Purpose: This is the foundational plan for Phase 4. Without the language server connection, none of the LSP features work. Everything else in this phase (status bar, tool window, crash recovery) builds on top of this.
Output: Working LSP integration -- opening a BBj file launches the language server and all LSP features (diagnostics, completion, go-to-definition, hover, parameter hints) function via LSP4IJ defaults.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-language-server-integration/04-RESEARCH.md
@.planning/phases/04-language-server-integration/04-CONTEXT.md
@bbj-intellij/build.gradle.kts
@bbj-intellij/src/main/resources/META-INF/plugin.xml
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add LSP4IJ dependency and language server bundle copy</name>
  <files>
    bbj-intellij/build.gradle.kts
    bbj-intellij/src/main/resources/META-INF/plugin.xml
  </files>
  <action>
    **build.gradle.kts changes:**

    1. Add LSP4IJ as a marketplace plugin dependency in the `intellijPlatform` block:
       ```kotlin
       plugin("com.redhat.devtools.lsp4ij:0.19.0")
       ```
       Place it after the existing `bundledPlugin("org.jetbrains.plugins.textmate")` line.

    2. Add a `copyLanguageServer` task that copies the bundled language server from bbj-vscode:
       ```kotlin
       val copyLanguageServer by tasks.registering(Copy::class) {
           from("${projectDir}/../bbj-vscode/out/language/") {
               include("main.cjs")
           }
           into(layout.buildDirectory.dir("resources/main/language-server"))
       }
       ```

    3. Update the existing `processResources` task to also depend on `copyLanguageServer`:
       ```kotlin
       tasks.named("processResources") {
           dependsOn(copyTextMateBundle)
           dependsOn(copyLanguageServer)
       }
       ```

    **plugin.xml changes:**

    Add the LSP4IJ dependency after the existing `<depends>` entries:
    ```xml
    <depends>com.redhat.devtools.lsp4ij</depends>
    ```

    **CRITICAL: Do NOT add org.eclipse.lsp4j as a dependency anywhere.** LSP4IJ bundles its own LSP4J. Adding it separately causes ClassCastException at runtime.

    After making changes, run `./gradlew processResources` from bbj-intellij/ to verify the language server bundle copies correctly and the build resolves the LSP4IJ dependency.
  </action>
  <verify>
    Run `./gradlew processResources` from bbj-intellij/ directory -- must succeed without errors.
    Verify file exists: `bbj-intellij/build/resources/main/language-server/main.cjs`
  </verify>
  <done>
    build.gradle.kts has LSP4IJ plugin dependency and copyLanguageServer task.
    plugin.xml declares `<depends>com.redhat.devtools.lsp4ij</depends>`.
    `./gradlew processResources` succeeds and main.cjs is copied to build/resources/main/language-server/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create LSP core classes and register language server</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServerFactory.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServer.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageClient.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjCompletionFeature.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
    bbj-intellij/src/main/resources/icons/bbj-function.svg
    bbj-intellij/src/main/resources/icons/bbj-variable.svg
    bbj-intellij/src/main/resources/icons/bbj-keyword.svg
    bbj-intellij/src/main/resources/META-INF/plugin.xml
  </files>
  <action>
    Create the `lsp/` package under `com.basis.bbj.intellij` and implement four classes:

    **1. BbjLanguageServerFactory.java** -- Implements `LanguageServerFactory` (from `com.redhat.devtools.lsp4ij`):
    - `createConnectionProvider(Project project)` returns `new BbjLanguageServer(project)`
    - `createLanguageClient(Project project)` returns `new BbjLanguageClient(project)`
    - `createClientFeatures()` returns `new LSPClientFeatures().setCompletionFeature(new BbjCompletionFeature())`
    - Package: `com.basis.bbj.intellij.lsp`

    **2. BbjLanguageServer.java** -- Extends `OSProcessStreamConnectionProvider`:
    - Constructor takes `@NotNull Project project`
    - Resolves Node.js path: Use `BbjSettings.getInstance().getState().nodeJsPath`. If empty, fall back to `BbjNodeDetector.detectNodePath()`. If still null, fall back to `"node"` (system PATH).
    - Resolves server path: The language server bundle `main.cjs` is in the plugin's resources. Use this approach to find it at runtime:
      ```java
      // Resolve from plugin installation path
      PluginId pluginId = PluginId.getId("com.basis.bbj.intellij");
      IdeaPluginDescriptor plugin = PluginManagerCore.getPlugin(pluginId);
      Path serverPath = plugin.getPluginPath().resolve("lib").resolve("language-server").resolve("main.cjs");
      ```
      Note: In development (runIde), the path structure may differ. The resource is at `build/resources/main/language-server/main.cjs`. Try the plugin path first; if main.cjs doesn't exist there, fall back to searching the classloader:
      ```java
      URL resource = getClass().getClassLoader().getResource("language-server/main.cjs");
      ```
      If using classloader, extract to a temp file since Node.js needs a real filesystem path.
    - Create `GeneralCommandLine` with `[nodePath, serverPathString, "--stdio"]`
    - Set charset to UTF-8: `cmd.setCharset(StandardCharsets.UTF_8)`
    - Set working directory to `project.getBasePath()`
    - Call `super.setCommandLine(cmd)`

    **3. BbjLanguageClient.java** -- Extends `LanguageClientImpl`:
    - Constructor takes `@NotNull Project project`, calls `super(project)`
    - Override `createSettings()`: Return a `com.google.gson.JsonObject` with `home` (from `BbjSettings.getInstance().getState().bbjHomePath`) and `classpath` (from `state.classpathEntry`). This is sent via `workspace/didChangeConfiguration`.
    - Override `handleServerStatusChanged(ServerStatus serverStatus)`: For now, just call `super.handleServerStatusChanged(serverStatus)`. Plan 02 will hook the status bar widget here. Log the status change: `System.out.println("BBj LS status: " + serverStatus)` (temporary, Plan 03 replaces with tool window logging).

    **4. BbjCompletionFeature.java** -- Extends `LSPCompletionFeature`:
    - Override `getIcon(CompletionItem item)`:
      - `CompletionItemKind.Function` -> `BbjIcons.FUNCTION`
      - `CompletionItemKind.Variable` -> `BbjIcons.VARIABLE`
      - `CompletionItemKind.Keyword` -> `BbjIcons.KEYWORD`
      - All other kinds -> `super.getIcon(item)` (LSP4IJ default)

    **BbjIcons.java** -- Add new icon constants:
    ```java
    Icon FUNCTION = IconLoader.getIcon("/icons/bbj-function.svg", BbjIcons.class);
    Icon VARIABLE = IconLoader.getIcon("/icons/bbj-variable.svg", BbjIcons.class);
    Icon KEYWORD = IconLoader.getIcon("/icons/bbj-keyword.svg", BbjIcons.class);
    ```

    **Icon SVG files** -- Create three simple 16x16 SVG icons in `src/main/resources/icons/`:
    - `bbj-function.svg`: Purple circle with "f" letter (similar to IntelliJ function icons)
    - `bbj-variable.svg`: Blue circle with "v" letter
    - `bbj-keyword.svg`: Orange circle with "k" letter
    Use simple SVG with solid fill colors that work on both light and dark themes. Keep SVGs minimal (just a circle + text element).

    **plugin.xml** -- Add LSP4IJ server registration after the existing `<extensions defaultExtensionNs="com.intellij">` block:
    ```xml
    <extensions defaultExtensionNs="com.redhat.devtools.lsp4ij">
        <server id="bbjLanguageServer"
                name="BBj Language Server"
                factoryClass="com.basis.bbj.intellij.lsp.BbjLanguageServerFactory">
            <description><![CDATA[
                BBj Language Server powered by Langium. Provides diagnostics,
                code completion, go-to-definition, hover, and signature help
                for BBj source files.
            ]]></description>
        </server>

        <languageMapping language="BBj"
                         serverId="bbjLanguageServer"
                         languageId="bbj"/>
    </extensions>
    ```

    **IMPORTANT:** The `languageId="bbj"` must be lowercase to match what the Langium language server expects as the LSP language identifier.

    After creating all files, run `./gradlew buildPlugin` to verify compilation succeeds.
  </action>
  <verify>
    Run `./gradlew buildPlugin` from bbj-intellij/ directory -- must compile without errors.
    Verify the lsp/ package has 4 Java files.
    Verify plugin.xml has the LSP4IJ extensions block with server and languageMapping.
    Verify BbjIcons.java has FUNCTION, VARIABLE, KEYWORD constants.
    Verify 3 SVG icon files exist in src/main/resources/icons/.
  </verify>
  <done>
    All four LSP classes compile successfully.
    plugin.xml registers the language server with LSP4IJ extension points.
    Language mapping connects BBj language to bbjLanguageServer with languageId "bbj".
    BbjCompletionFeature maps Function/Variable/Keyword kinds to BBj-specific icons.
    `./gradlew buildPlugin` passes.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew buildPlugin` succeeds without errors
2. `build/resources/main/language-server/main.cjs` exists after processResources
3. plugin.xml has `<depends>com.redhat.devtools.lsp4ij</depends>`
4. plugin.xml has `<server id="bbjLanguageServer" ...>` and `<languageMapping ...>` entries
5. All 4 classes in lsp/ package compile: BbjLanguageServerFactory, BbjLanguageServer, BbjLanguageClient, BbjCompletionFeature
6. BbjIcons has FILE, FUNCTION, VARIABLE, KEYWORD constants
</verification>

<success_criteria>
- Plugin builds successfully with LSP4IJ dependency resolved from marketplace
- Language server bundle (main.cjs) is copied into plugin resources at build time
- LSP4IJ extension points registered correctly in plugin.xml
- All LSP core classes implement the correct LSP4IJ interfaces/base classes
- When run via `./gradlew runIde`, opening a BBj file should trigger language server startup (visible in LSP4IJ console if available)
</success_criteria>

<output>
After completion, create `.planning/phases/04-language-server-integration/04-01-SUMMARY.md`
</output>
