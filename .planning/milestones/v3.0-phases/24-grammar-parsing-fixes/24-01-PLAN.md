---
phase: 24-grammar-parsing-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/language/bbj-token-builder.ts
  - bbj-vscode/test/parser.test.ts
autonomous: true

must_haves:
  truths:
    - "Camel-case identifiers containing BBj keywords (getResult, isNew, forEach) tokenize as single ID tokens, not keyword+identifier pairs"
    - "Standalone keywords (GET, IF, FOR, NEW) still tokenize correctly as keyword tokens"
    - "Labels with keyword-prefixed names (getResult:) parse without error"
    - "GOTO/GOSUB targets with keyword-prefixed names (GOTO getResult) parse without error"
  artifacts:
    - path: "bbj-vscode/src/language/bbj-token-builder.ts"
      provides: "longer_alt configuration on all keyword tokens"
      contains: "longer_alt"
    - path: "bbj-vscode/test/parser.test.ts"
      provides: "Tests for keyword-prefixed identifiers"
      contains: "getResult"
  key_links:
    - from: "bbj-token-builder.ts"
      to: "Chevrotain lexer"
      via: "longer_alt property on keyword tokens"
      pattern: "longer_alt.*=.*id"
---

<objective>
Fix GRAM-02: Camel-case method names containing embedded BBj keywords are parsed correctly as single identifiers.

Purpose: The Chevrotain lexer currently splits `getResult` into `GET` + `Result` because keyword tokens take priority over identifier matching. This causes false errors on labels, GOTO targets, and field names that start with BBj keywords. The fix uses Chevrotain's `longer_alt` property on all keyword tokens to prefer the longer ID match during tokenization.

Output: Updated `bbj-token-builder.ts` with `longer_alt` on keyword tokens, tests proving keyword-prefixed identifiers tokenize correctly.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-grammar-parsing-fixes/24-CONTEXT.md
@.planning/phases/24-grammar-parsing-fixes/24-RESEARCH.md
@bbj-vscode/src/language/bbj-token-builder.ts
@bbj-vscode/src/language/bbj-module.ts
@bbj-vscode/src/language/bbj.langium
@bbj-vscode/test/parser.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add longer_alt to keyword tokens in BBjTokenBuilder</name>
  <files>bbj-vscode/src/language/bbj-token-builder.ts</files>
  <action>
In the `buildTokens()` method of `BBjTokenBuilder`, after the existing loop that adds keywords to the ID category (lines 38-46), add `longer_alt` configuration to each keyword token that points to the ID terminal token.

Specifically, in the same loop (or an adjacent one), for each keyword token that matches the existing criteria (`/[A-Z]+(?!_)/.test(keywordToken.name)`, not a terminal, not in EXCLUDED set, no LINE_BREAKS):
- Set `keywordToken.LONGER_ALT = id;` (note: Chevrotain uses `LONGER_ALT` as the property name on the token type object)

This tells Chevrotain: "When you match keyword X, also check if a longer ID match exists. If so, use the ID token instead." This resolves `getResult` -> `[ID:getResult]` instead of `[GET][ID:Result]`.

IMPORTANT: The property name on the `TokenType` interface is `LONGER_ALT` (all caps with underscore). Per user decision, apply to ALL keyword tokens (future-proof), not just known conflicts like get/is/new.

Also apply `LONGER_ALT = id` to the `RELEASE_NL` and `RELEASE_NO_NL` tokens (which also get `CATEGORIES = [id]`).

Keep the existing `CATEGORIES = [id]` assignment -- it serves a different purpose (allowing keywords to be used as identifiers in certain grammar positions like method names after dot).
  </action>
  <verify>
Run the existing test suite: `cd /Users/beff/_workspace/bbj-language-server/bbj-vscode && npm test`

All existing tests must pass. The `longer_alt` change should not break any current functionality since existing code that uses standalone keywords (like `IF`, `THEN`, `FOR`) will still match as keywords (they're not followed by more identifier characters).
  </verify>
  <done>
All keyword tokens in the BBjTokenBuilder have `LONGER_ALT` set to the ID token. Existing test suite passes with zero regressions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for keyword-prefixed identifiers (GRAM-02)</name>
  <files>bbj-vscode/test/parser.test.ts</files>
  <action>
Add test cases to `parser.test.ts` that verify camel-case identifiers with keyword prefixes parse correctly. Add tests in the existing describe block, near the existing "Issue #223 Fix identifiers starting with NEXT" test:

1. **Test: Labels with keyword-prefixed names parse correctly (GRAM-02)**
```
getResult:
    PRINT "at getResult"
isNew:
    PRINT "at isNew"
forEach:
    PRINT "at forEach"
```
Expect: no parser or lexer errors.

2. **Test: GOTO/GOSUB with keyword-prefixed labels (GRAM-02)**
```
GOTO getResult
GOTO isNew
GOSUB forEach
STOP
getResult: PRINT "get"
isNew: PRINT "is"
forEach: PRINT "for"; RETURN
```
Expect: no parser or lexer errors, no validation errors (with `{ validation: true }`).

3. **Test: Field names with keyword-prefixed identifiers in classes (GRAM-02)**
```
class public TestClass
    field private BBjString getString$
    field private BBjNumber isReady%
    method public void getResult()
    methodend
    method public BBjNumber isNew()
        methodret 0
    methodend
classend
```
Expect: no parser or lexer errors.

4. **Test: Variable names with keyword-prefixed identifiers (GRAM-02)**
```
let getResult$ = "test"
let isNew% = 1
let forEach! = null()
PRINT getResult$, isNew%, forEach!
```
Expect: no parser or lexer errors.

Use the existing `expectNoParserLexerErrors()` and `expectNoValidationErrors()` helper functions.
  </action>
  <verify>
Run: `cd /Users/beff/_workspace/bbj-language-server/bbj-vscode && npm test`

All new tests pass. All existing tests still pass.
  </verify>
  <done>
4 new test cases prove GRAM-02 is fixed: keyword-prefixed identifiers (getResult, isNew, forEach) parse as single tokens in labels, GOTO targets, field names, and variable names.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/beff/_workspace/bbj-language-server/bbj-vscode && npm test` -- all tests pass
2. New tests specifically verify `getResult`, `isNew`, `forEach` as labels, GOTO targets, field names, and variable names
3. Existing tests verify standalone keywords (`IF`, `FOR`, `GET`, `NEW`) still work
4. The `longer_alt` property is set on all keyword tokens in `bbj-token-builder.ts`
</verification>

<success_criteria>
- GRAM-02 requirement satisfied: Camel-case method names containing BBj keywords parsed correctly as single identifiers
- Zero test regressions
- `longer_alt` applied to ALL keywords per user decision (future-proof)
</success_criteria>

<output>
After completion, create `.planning/phases/24-grammar-parsing-fixes/24-01-SUMMARY.md`
</output>
