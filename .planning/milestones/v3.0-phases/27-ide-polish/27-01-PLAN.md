---
phase: 27-ide-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/language/bbj-node-kind.ts
  - bbj-vscode/package.json
autonomous: true

must_haves:
  truths:
    - "Labels show a distinct icon (Key) in Structure View and completion, not the generic Field icon"
    - "Variables and fields show Variable icon in Structure View and completion"
    - "Methods show Method icon, DEF FN functions show Function icon -- visually distinguishable"
    - "Run icons (GUI/BUI/DWC) appear on .bbj, .bbl, .bbx, .src files only -- not on .txt, .md, or other files"
    - "Run icons do NOT appear on .bbjt files (test files) or .arc files (not runnable)"
  artifacts:
    - path: "bbj-vscode/src/language/bbj-node-kind.ts"
      provides: "Differentiated SymbolKind and CompletionItemKind mappings"
      contains: "LabelDecl"
    - path: "bbj-vscode/package.json"
      provides: "Corrected when clauses and language registration for run icons"
      contains: ".bbx"
  key_links:
    - from: "bbj-vscode/src/language/bbj-node-kind.ts"
      to: "Structure View + completion popups"
      via: "NodeKindProvider consumed by Langium LSP"
      pattern: "getSymbolKind|getCompletionItemKind"
    - from: "bbj-vscode/package.json"
      to: "VS Code menu visibility"
      via: "when clause evaluation"
      pattern: "resourceLangId"
---

<objective>
Differentiate symbol kinds in Structure View and completion popups, and scope VS Code run icons to BBj file types only.

Purpose: Labels, variables, fields, methods, and DEF FN functions currently all show as generic Field icons, making Structure View and completion popups hard to scan. Run icons appearing on non-BBj files confuse users.
Output: Updated `bbj-node-kind.ts` with distinct SymbolKind/CompletionItemKind mappings, and fixed `package.json` with corrected language registration and run icon scoping.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-ide-polish/27-RESEARCH.md
@bbj-vscode/src/language/bbj-node-kind.ts
@bbj-vscode/src/language/bbj-module.ts
@bbj-vscode/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Differentiate SymbolKind and CompletionItemKind mappings</name>
  <files>bbj-vscode/src/language/bbj-node-kind.ts</files>
  <action>
Update `BBjNodeKindProvider` to return distinct kinds for each AST node type.

In `getSymbolKind()`, add cases BEFORE the default:
- `LabelDecl.$type` -> `SymbolKind.Key` (per Claude's discretion: Key is semantically closest to labels/line references)
- `VariableDecl.$type` -> `SymbolKind.Variable`
- `FieldDecl.$type` -> `SymbolKind.Variable` (per user decision: variables and fields share the same kind)
- `MethodDecl.$type` -> `SymbolKind.Method` (per user decision: distinct from DEF FN)
- `DefFunction.$type` -> `SymbolKind.Function` (keep existing -- already maps Function)
- `LibFunction.$type` -> keep as `SymbolKind.Function` (existing)

Note: `MethodDecl` currently returns `SymbolKind.Function`. Change it to `SymbolKind.Method` per user decision that methods and DEF FN functions should be visually distinguished.

In `getCompletionItemKind()`, mirror the SymbolKind mapping for consistency:
- `LabelDecl.$type` -> `CompletionItemKind.Keyword` (closest available -- CompletionItemKind has no Key equivalent; Keyword gives a distinct icon)
- `VariableDecl.$type` -> `CompletionItemKind.Variable`
- `FieldDecl.$type` -> `CompletionItemKind.Variable` (same as VariableDecl per user decision)
- `MethodDecl.$type` -> `CompletionItemKind.Method` (separate from Function)
- Keep existing `DefFunction`, `LibFunction` -> `CompletionItemKind.Function`
- Keep existing `JavaMethod` -> `CompletionItemKind.Function`

Add imports for `LabelDecl`, `VariableDecl`, `FieldDecl`, `DefFunction` from `./generated/ast.js`.

IMPORTANT: The switch cases must use `$type` static property for type-safe matching (existing pattern).
  </action>
  <verify>Run `npm run build` in bbj-vscode directory. Verify no TypeScript compilation errors. Verify the imports resolve correctly.</verify>
  <done>
- LabelDecl returns SymbolKind.Key / CompletionItemKind.Keyword
- VariableDecl and FieldDecl return SymbolKind.Variable / CompletionItemKind.Variable
- MethodDecl returns SymbolKind.Method / CompletionItemKind.Method
- DefFunction returns SymbolKind.Function / CompletionItemKind.Function
- Default fallback still returns SymbolKind.Field / CompletionItemKind.Field
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix run icon scoping to BBj file types only</name>
  <files>bbj-vscode/package.json</files>
  <action>
Fix two issues in `package.json`:

**Issue 1: Missing dot prefix on `.bbx` extension**
In `contributes.languages`, the `bbx` language entry has `"extensions": ["bbx"]` (line 48) -- missing the dot prefix. Change to `"extensions": [".bbx"]`. This may be why VS Code fails to associate `.bbx` files with the `bbx` language ID, causing `resourceLangId == bbx` to fail.

**Issue 2: Exclude .bbjt from run icon scoping**
Per user decision, run icons should appear on `.bbj`, `.bbl`, `.bbx`, `.src` files ONLY. The `.bbjt` extension is currently registered under the `bbj` language ID, which means `resourceLangId == bbj` matches `.bbjt` files too.

To fix: Keep `.bbjt` in the language registration (it still needs syntax highlighting and language intelligence), but update the `when` clauses for the three run commands (bbj.run, bbj.runBUI, bbj.runDWC) in ALL three menu locations (editor/context, editor/title, explorer/context) to explicitly exclude `.bbjt`:

Change from:
```
"when": "resourceLangId == bbj || resourceLangId == bbx"
```

To:
```
"when": "(resourceLangId == bbj && resourceExtname != .bbjt) || resourceLangId == bbx"
```

This preserves language intelligence for `.bbjt` files while hiding run icons (since test files need a test panel, which is deferred).

Per user decision: `.arc` files are NOT in any language registration, so they won't match `resourceLangId == bbj` anyway -- no change needed for `.arc`.

**Do NOT modify** the `when` clauses for `bbj.compile`, `bbj.decompile`, or `bbj.denumber` -- those are separate commands with their own scoping rules.
  </action>
  <verify>
Verify the JSON is valid by running: `node -e "JSON.parse(require('fs').readFileSync('bbj-vscode/package.json', 'utf8'))"`.
Verify the `.bbx` extension has a dot prefix.
Verify all 9 run command `when` clauses (3 commands x 3 menu locations) include the `.bbjt` exclusion.
  </verify>
  <done>
- `.bbx` extension in language registration has dot prefix: `".bbx"`
- All run icon `when` clauses exclude `.bbjt` files
- Run icons will appear on `.bbj`, `.bbl`, `.src` (via bbj langId) and `.bbx` (via bbx langId)
- Run icons will NOT appear on `.bbjt`, `.arc`, or non-BBj files
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds in bbj-vscode directory
2. `package.json` is valid JSON
3. bbj-node-kind.ts has distinct SymbolKind cases for Label, Variable, Field, Method, DefFunction
4. bbj-node-kind.ts has matching CompletionItemKind cases
5. Run command when clauses exclude .bbjt
</verification>

<success_criteria>
- Structure View and completion popups show distinct icons for labels (Key), variables/fields (Variable), methods (Method), and DEF FN functions (Function)
- Run icons are scoped to .bbj, .bbl, .bbx, .src files -- not appearing on .bbjt, .arc, or non-BBj files
- Build succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/27-ide-polish/27-01-SUMMARY.md`
</output>
