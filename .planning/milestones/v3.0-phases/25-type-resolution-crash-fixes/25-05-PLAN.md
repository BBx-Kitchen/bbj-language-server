---
phase: 25-type-resolution-crash-fixes
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/language/bbj-scope-local.ts
  - bbj-vscode/src/language/bbj-nodedescription-provider.ts
  - bbj-vscode/src/language/bbj-hover.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Implicit getter/setter completion shows return type and parentheses like a regular method"
    - "USE statement with unresolvable class shows warning without crashing the server"
    - "Hovering over Java classes with complex JavaDoc does not produce noisy console warnings"
  artifacts:
    - path: "bbj-vscode/src/language/bbj-scope-local.ts"
      provides: "createAccessorDescription returns FunctionNodeDescription with parameters and returnType"
      contains: "parameters"
    - path: "bbj-vscode/src/language/bbj-scope-local.ts"
      provides: "processNode guards node.name before createDescription for VariableDecl"
      contains: "node.name"
    - path: "bbj-vscode/src/language/bbj-nodedescription-provider.ts"
      provides: "createDescription guards against undefined name"
      contains: "!name"
    - path: "bbj-vscode/src/language/bbj-hover.ts"
      provides: "tryParseJavaDoc silently catches errors"
  key_links:
    - from: "bbj-vscode/src/language/bbj-scope-local.ts"
      to: "bbj-vscode/src/language/bbj-completion-provider.ts"
      via: "FunctionNodeDescription with parameters/returnType passes isFunctionNodeDescription check"
      pattern: "parameters.*returnType"
    - from: "bbj-vscode/src/language/bbj-nodedescription-provider.ts"
      to: "bbj-vscode/src/language/bbj-scope-local.ts"
      via: "createDescription safely handles undefined name from processNode"
      pattern: "name.*undefined"
---

<objective>
Close two UAT gaps from phase 25: (1) implicit getter/setter completion missing return type and parentheses, and (2) server crash on USE with unresolvable class.

Purpose: Fix completion display for implicit accessors so they match regular method presentation, and prevent server crashes when encountering unnamed VariableDecl nodes or malformed JSDoc.
Output: Updated bbj-scope-local.ts, bbj-nodedescription-provider.ts, and bbj-hover.ts with defensive fixes.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bbj-vscode/src/language/bbj-scope-local.ts
@bbj-vscode/src/language/bbj-nodedescription-provider.ts
@bbj-vscode/src/language/bbj-completion-provider.ts
@bbj-vscode/src/language/bbj-hover.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix implicit accessor completion to show return type and parentheses</name>
  <files>bbj-vscode/src/language/bbj-scope-local.ts</files>
  <action>
Modify the `createAccessorDescription` function (line 310-318) to return a `FunctionNodeDescription` instead of a plain `AstNodeDescription`. This is the root cause of accessor completion showing just the name without parentheses or return type.

Current code returns:
```ts
function createAccessorDescription(...): AstNodeDescription {
    return {
        name: toAccessorName(member.name, setter),
        nameSegment,
        type: MethodDecl.$type,
        documentUri: AstUtils.getDocument(member).uri,
        path: astNodeLocator.getAstNodePath(member)
    }
}
```

Change to return `FunctionNodeDescription` (which is `AstNodeDescription & MethodData`):

1. Import `FunctionNodeDescription` and `ParameterData` from `./bbj-nodedescription-provider.js` (add to existing import that already imports `getClassRefNode` and `getFQNFullname`).

2. Change the function signature return type from `AstNodeDescription` to `FunctionNodeDescription`.

3. Add `parameters` and `returnType` fields to the returned object:
   - For a GETTER (setter=false): `parameters: []` (no params), `returnType: getFQNFullname(member.type)` (the backing field's type, e.g., "BBjString")
   - For a SETTER (setter=true): `parameters: [{ name: 'value', type: getFQNFullname(member.type) }]` (one param with the field's type), `returnType: ''` (void/empty -- same convention used by methods with no return type)

The key insight: `isFunctionNodeDescription()` in bbj-nodedescription-provider.ts checks for `'parameters' in obj && 'returnType' in obj`. Once the accessor description has these fields, the completion provider's `createReferenceCompletionItem` will format it with parentheses and return type display, matching regular method completion.

Note: `member.type` is `QualifiedClass | undefined` (from VariableDecl interface). `getFQNFullname` already handles undefined by returning `''`. So if the field has no explicit type, the return type will be empty string, which is fine.
  </action>
  <verify>
Run `npm run build` from `bbj-vscode/` to confirm TypeScript compilation succeeds with no type errors. Then run `npm test` from the project root to confirm no regressions. Specifically verify that the `createAccessorDescription` function now returns an object that would pass `isFunctionNodeDescription()` (has both `parameters` array and `returnType` string).
  </verify>
  <done>
Implicit getter descriptions have `parameters: []` and `returnType` set to the backing field's type. Implicit setter descriptions have `parameters: [{ name: 'value', type: fieldType }]` and `returnType: ''`. The completion provider formats these with parentheses and return type display, matching regular method completion items.
  </done>
</task>

<task type="auto">
  <name>Task 2: Guard against undefined name in scope computation and reduce JSDoc noise</name>
  <files>bbj-vscode/src/language/bbj-scope-local.ts, bbj-vscode/src/language/bbj-nodedescription-provider.ts, bbj-vscode/src/language/bbj-hover.ts</files>
  <action>
Three small defensive fixes to prevent the "Node at path /statements@12 has no name" crash and reduce console noise:

**Fix A: Guard node.name in processNode (bbj-scope-local.ts, line 117-125)**

In the `isVariableDecl(node)` branch, add a guard before calling `createDescription`. Currently line 123 is:
```ts
const description = this.descriptions.createDescription(node, node.name);
```

The `NamedElement` interface types `name` as `string`, but at runtime a parse-error VariableDecl can have `name` as `undefined`. When `undefined` is passed to `DefaultAstNodeDescriptionProvider.createDescription`, it throws "Node at path ... has no name".

Change the block to guard:
```ts
} else if (isVariableDecl(node) && node.$containerProperty !== 'params') {
    const methodScope = AstUtils.getContainerOfType(node, isMethodDecl);
    const scopeHolder = methodScope ?? node.$container;
    if (scopeHolder && node.name) {
        const description = this.descriptions.createDescription(node, node.name);
        this.addToScope(scopes, scopeHolder, description);
    }
}
```

The only change is replacing `if (scopeHolder)` with `if (scopeHolder && node.name)`. If `node.name` is undefined (parse error), silently skip -- the node has no useful scope contribution anyway.

**Fix B: Guard createDescription in BBjAstNodeDescriptionProvider (bbj-nodedescription-provider.ts, line 7-16)**

Add an early return in the `createDescription` override to guard against `undefined` name before calling `super.createDescription`. This is a belt-and-suspenders defense -- even if callers forget to check, the provider won't crash.

Change:
```ts
override createDescription(node: AstNode, name: string | undefined, document: LangiumDocument = AstUtils.getDocument(node)): AstNodeDescription {
    const descr = super.createDescription(node, name, document);
    switch (node.$type) {
```

To:
```ts
override createDescription(node: AstNode, name: string | undefined, document: LangiumDocument = AstUtils.getDocument(node)): AstNodeDescription {
    if (!name) {
        return {
            name: '',
            nameSegment: undefined,
            type: node.$type,
            documentUri: document.uri,
            path: this.astNodeLocator.getAstNodePath(node)
        };
    }
    const descr = super.createDescription(node, name, document);
    switch (node.$type) {
```

This returns a safe empty-name description instead of throwing. The `astNodeLocator` is already available as `this.astNodeLocator` from the parent class `DefaultAstNodeDescriptionProvider`.

**Fix C: Silence JSDoc parse warnings in tryParseJavaDoc (bbj-hover.ts, line 129-139)**

Change `console.warn(error)` to `// silently ignore` in the `tryParseJavaDoc` catch block. The JSDoc parse failures for complex Java documentation (e.g., HashMap) are expected and non-actionable -- they just produce noise in the output.

Change:
```ts
protected tryParseJavaDoc(comment: string) {
    if (isJSDoc(comment)) {
        try {
            const doc = parseJSDoc(comment)
            return doc.toMarkdown()
        } catch (error) {
            console.warn(error)
        }
    }
    return comment;
}
```

To:
```ts
protected tryParseJavaDoc(comment: string) {
    if (isJSDoc(comment)) {
        try {
            const doc = parseJSDoc(comment)
            return doc.toMarkdown()
        } catch {
            // JSDoc parsing can fail on complex Java documentation (e.g., HashMap).
            // Fall through to return raw comment text.
        }
    }
    return comment;
}
```
  </action>
  <verify>
Run `npm run build` from `bbj-vscode/` to confirm TypeScript compilation. Run `npm test` from project root to confirm no regressions. Verify that `BBjAstNodeDescriptionProvider.createDescription` handles `undefined` name gracefully by returning an empty-name description object rather than throwing.
  </verify>
  <done>
The server no longer crashes when encountering a USE statement with an unresolvable class that produces unnamed VariableDecl nodes. The processNode VariableDecl branch skips nodes with no name. The BBjAstNodeDescriptionProvider returns a safe fallback for undefined names. JSDoc parse failures are silently handled without console noise.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` in bbj-vscode/ completes with zero errors
2. `npm test` from project root -- no new failures beyond the 18 pre-existing ones
3. The `createAccessorDescription` function returns an object with `parameters` and `returnType` fields
4. The `isFunctionNodeDescription()` type guard would return true for accessor descriptions
5. `BBjAstNodeDescriptionProvider.createDescription(node, undefined)` does not throw
6. `processNode` with a VariableDecl whose name is undefined does not throw
7. `tryParseJavaDoc` with malformed JSDoc does not produce console.warn output
</verification>

<success_criteria>
- Implicit getter completion shows `getName(): FieldType` format (with parentheses and return type) matching regular method completion
- Implicit setter completion shows `setName(value): void` format
- USE statements with unresolvable classes produce warnings (from plan 25-03) without crashing the server
- No console.warn noise from JSDoc parse failures on Java class hover
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/25-type-resolution-crash-fixes/25-05-SUMMARY.md`
</output>
