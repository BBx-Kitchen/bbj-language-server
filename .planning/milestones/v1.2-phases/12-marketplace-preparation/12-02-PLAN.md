---
phase: 12-marketplace-preparation
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - bbj-intellij/build.gradle.kts
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
autonomous: false

must_haves:
  truths:
    - "Plugin verifier produces zero errors against recommended IDE versions"
    - "Plugin distribution ZIP contains LICENSE and NOTICES files"
    - "Plugin icon displays correctly in 40x40 format (SVG, vector paths, under 3KB)"
    - "Built plugin ZIP is ready for JetBrains Marketplace upload"
  artifacts:
    - path: "bbj-intellij/build/distributions/*.zip"
      provides: "Plugin distribution ZIP ready for Marketplace upload"
    - path: "bbj-intellij/build/reports/pluginVerifier/"
      provides: "Verification reports showing zero errors"
  key_links:
    - from: "bbj-intellij/build.gradle.kts"
      to: "verifyPlugin task"
      via: "pluginVerification.ides.recommended()"
      pattern: "recommended"
    - from: "bbj-intellij/src/main/resources/META-INF/pluginIcon.svg"
      to: "plugin distribution"
      via: "Gradle resource processing"
      pattern: "pluginIcon"
---

<objective>
Run the JetBrains Plugin Verifier to ensure zero errors, fix any issues found, verify the distribution ZIP is complete, and confirm the plugin is ready for Marketplace submission.

Purpose: The JetBrains Marketplace requires plugins to pass the Plugin Verifier with zero errors before approval. This plan runs the verifier, fixes any compatibility issues, and produces a final verified distribution ZIP. A human checkpoint confirms the icon and listing look correct.

Output: Clean verifier report with zero errors, verified distribution ZIP with all required files (plugin.xml, icon SVGs, LICENSE, NOTICES, description), and human confirmation of visual appearance.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-marketplace-preparation/12-CONTEXT.md
@.planning/phases/12-marketplace-preparation/12-RESEARCH.md
@.planning/phases/12-marketplace-preparation/12-01-SUMMARY.md
@bbj-intellij/build.gradle.kts
@bbj-intellij/src/main/resources/META-INF/plugin.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run plugin verifier and fix any errors</name>
  <files>
    bbj-intellij/build.gradle.kts
    bbj-intellij/src/main/resources/META-INF/plugin.xml
  </files>
  <action>
    1. Run `cd bbj-intellij && ./gradlew verifyPlugin` to execute the Plugin Verifier against recommended IDE versions. This will download IDE binaries (may take several minutes on first run) and check binary compatibility.

    2. Examine the verification output and reports at `bbj-intellij/build/reports/pluginVerifier/`. Look for:
       - **ERRORS**: Must be fixed. These are binary incompatibilities (missing classes, changed method signatures, internal API usage that no longer exists).
       - **WARNINGS**: Review each one. Fix "Internal API usage" if a stable alternative exists. Fix "Deprecated API usage" if replacement is straightforward. Document acceptable warnings (e.g., experimental API usage for features that have no stable alternative).
       - Common issues to watch for: LSP4IJ API calls that may not exist in all IDE versions, @ApiStatus.Internal usage, platform API calls deprecated between 2024.2 and newer versions.

    3. For each error found:
       - If it's a missing class/method from LSP4IJ: Check if the API changed between versions, update import or method call.
       - If it's internal API usage: Find the public API alternative in IntelliJ Platform SDK docs.
       - If it's a sinceBuild/untilBuild mismatch: Adjust the Gradle configuration.
       - If it's a plugin.xml structural issue: Fix the XML structure.

    4. After fixing errors, re-run `./gradlew verifyPlugin` to confirm zero errors.

    5. Run `./gradlew buildPlugin` to produce the final distribution ZIP.

    6. Verify the distribution ZIP contents include all required files by listing the ZIP contents:
       - `plugin.xml` with description, vendor, change-notes
       - `pluginIcon.svg` and `pluginIcon_dark.svg`
       - `LICENSE` and `NOTICES`
       - `lib/language-server/main.cjs`
       - `lib/textmate/bbj-bundle/` with .tmLanguage.json files

    Note: The `files_modified` above lists files that MAY need changes if verifier finds issues. If verifier passes clean on first run, these files remain unchanged from Plan 01.
  </action>
  <verify>
    - `cd bbj-intellij && ./gradlew verifyPlugin` exits with code 0
    - Verification report shows zero COMPATIBILITY_PROBLEMS errors
    - `./gradlew buildPlugin` succeeds
    - Distribution ZIP at `bbj-intellij/build/distributions/` exists
    - ZIP contents include: plugin.xml, pluginIcon.svg, pluginIcon_dark.svg, LICENSE, NOTICES
  </verify>
  <done>
    Plugin verifier reports zero errors. Distribution ZIP is built and contains all required Marketplace assets (plugin.xml, icons, license, notices, language server, TextMate grammars).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Marketplace-ready plugin package:
    - Updated description with full feature list and shared language server mention
    - MIT License and NOTICES (third-party attributions) in distribution
    - Plugin version 0.1.0 with initial release change notes
    - Plugin verifier passing with zero errors
    - Distribution ZIP ready for upload

    The plugin icon (pluginIcon.svg) already existed as a proper SVG vector (994 bytes, well under 3KB limit) with both light and dark theme variants.
  </what-built>
  <how-to-verify>
    1. Run the plugin in sandbox to check icon and metadata:
       `cd bbj-intellij && ./gradlew runIde`
    2. In the launched IDE, go to Settings > Plugins > Installed
    3. Find "BBj Language Support" and verify:
       - Plugin icon displays correctly (BBj logo)
       - Version shows "0.1.0"
       - Description shows full feature list
       - Vendor shows "BASIS International Ltd."
    4. Close the sandbox IDE

    5. Check the distribution ZIP contents:
       `unzip -l bbj-intellij/build/distributions/BBj-Language-Support-0.1.0.zip`
    6. Verify LICENSE and NOTICES are included in the ZIP

    7. Review the verifier report for any warnings you want addressed:
       `cat bbj-intellij/build/reports/pluginVerifier/*/verification-result.txt 2>/dev/null || echo "Check build/reports/pluginVerifier/ directory"`
  </how-to-verify>
  <resume-signal>Type "approved" if everything looks good, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `cd bbj-intellij && ./gradlew verifyPlugin` exits cleanly with zero errors
2. `cd bbj-intellij && ./gradlew buildPlugin` produces ZIP in build/distributions/
3. ZIP contains all required files: plugin.xml, pluginIcon.svg, pluginIcon_dark.svg, LICENSE, NOTICES
4. Human verified: icon displays, description is accurate, version is correct
</verification>

<success_criteria>
- Plugin verifier reports zero errors (MKT-04)
- Plugin icon displays correctly in 40x40 format (MKT-01)
- plugin.xml contains complete description, vendor info, and change notes (MKT-02)
- Distribution includes MIT License text (MKT-03)
- Human has confirmed visual appearance and distribution contents
</success_criteria>

<output>
After completion, create `.planning/phases/12-marketplace-preparation/12-02-SUMMARY.md`
</output>
