---
phase: 08-run-commands
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunBuiAction.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunDwcAction.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
  - bbj-intellij/build.gradle.kts
autonomous: true

must_haves:
  truths:
    - "Right-clicking a .bbj file shows 'Run As BUI Program' and 'Run As DWC Program' in the editor context menu"
    - "BUI action spawns bbj with web.bbj and 'BUI' client type parameter matching VSCode behavior"
    - "DWC action spawns bbj with web.bbj and 'DWC' client type parameter matching VSCode behavior"
    - "All three run actions (GUI/BUI/DWC) appear as toolbar buttons in the main toolbar"
    - "Alt+G triggers GUI run, Alt+B triggers BUI run, Alt+D triggers DWC run"
    - "web.bbj is bundled in the plugin distribution under lib/tools/"
    - "EM username and password settings appear on the settings page with defaults admin/admin123"
    - "Auto-save checkbox appears on the settings page, defaulting to checked"
  artifacts:
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunBuiAction.java"
      provides: "BUI run action extending BbjRunActionBase, using web.bbj with BUI client type"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunDwcAction.java"
      provides: "DWC run action extending BbjRunActionBase, using web.bbj with DWC client type"
    - path: "bbj-intellij/build.gradle.kts"
      provides: "Copy task for web.bbj bundling into plugin distribution"
    - path: "bbj-intellij/src/main/resources/META-INF/plugin.xml"
      provides: "All three run actions registered with shortcuts, toolbar, and context menu"
  key_links:
    - from: "BbjRunBuiAction.java"
      to: "web.bbj"
      via: "locates bundled web.bbj via plugin path resolution"
      pattern: "web\\.bbj"
    - from: "BbjRunBuiAction.java"
      to: "BbjSettings"
      via: "reads emUsername and emPassword for web.bbj authentication"
      pattern: "emUsername|emPassword"
    - from: "build.gradle.kts"
      to: "bbj-vscode/tools/web.bbj"
      via: "Copy task bundles web.bbj into plugin lib/tools/"
      pattern: "tools/web\\.bbj"
    - from: "plugin.xml"
      to: "BbjRunBuiAction, BbjRunDwcAction"
      via: "action registration with keyboard-shortcut elements"
      pattern: "bbj\\.runBui|bbj\\.runDwc"
---

<objective>
Implement BUI and DWC run actions, bundle web.bbj, add EM settings, wire all three run actions with toolbar buttons and keyboard shortcuts. After this plan, users can run BBj programs as GUI/BUI/DWC from toolbar buttons (Alt+G/B/D) or context menu.

Purpose: Completes the full run command feature set, bringing IntelliJ to parity with VSCode for launching BBj programs.
Output: BbjRunBuiAction.java, BbjRunDwcAction.java, updated build.gradle.kts with web.bbj bundling, updated plugin.xml with all actions/shortcuts/toolbar, updated settings page with EM credentials and auto-save toggle.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-run-commands/08-01-SUMMARY.md
@bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunGuiAction.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
@bbj-intellij/src/main/resources/META-INF/plugin.xml
@bbj-intellij/build.gradle.kts
@bbj-vscode/src/Commands/Commands.cjs
@bbj-vscode/tools/web.bbj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BUI/DWC run actions, bundle web.bbj, add EM settings</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunBuiAction.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunDwcAction.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
    bbj-intellij/build.gradle.kts
  </files>
  <action>
**BbjRunActionBase.java** — Add a protected helper method for locating the bundled web.bbj:

- `protected String getWebBbjPath()`: Locates web.bbj in the plugin's bundled tools directory. The file is bundled at `lib/tools/web.bbj` relative to the plugin installation. Use `PathManager.getPluginsPath()` + `/BBj Language Support/lib/tools/web.bbj` to locate it. Alternatively, use the classloader resource approach: resolve the plugin's installation directory via `PluginManagerCore.getPlugin(PluginId.getId("com.basis.bbj.intellij"))` -> `getPluginPath()` -> append `lib/tools/web.bbj`. If the file doesn't exist, return null.

  Better approach for robustness: Use `PluginManagerCore.getPlugin(PluginId.getId("com.basis.bbj.intellij")).getPluginPath().resolve("lib/tools/web.bbj")`. Store as `Path`, check `Files.exists()`, return `path.toString()` or null.

**BbjRunBuiAction.java** — Extends BbjRunActionBase:
- Constructor: `super("Run As BUI Program", "Run current BBj file as BUI program in browser", BbjIcons.RUN_BUI)`.
- Override `buildCommandLine()`:
  1. Get bbj executable via `getBbjExecutablePath()`. If null, show error and return null.
  2. Get web.bbj path via `getWebBbjPath()`. If null, show error "web.bbj runner not found in plugin bundle" and return null.
  3. Get settings state for username, password, classpath.
  4. Derive `name` from filename: strip extension. E.g., `MyProgram.bbj` -> `MyProgram` (matches VSCode: `programme.split(".").slice(0, -1).join(".")`).
  5. Derive `programme` = filename only (basename, no directory).
  6. Derive `workingDir` = `file.getParent().getPath()` (the directory containing the file — matches VSCode's `path.dirname(fileName)` for web runner).
  7. Read EM username/password from `BbjSettings.getInstance().getState().emUsername` / `.emPassword`.
  8. Read classpath from settings.
  9. Build command matching VSCode's `runWeb`:
     ```
     "bbj" -q -WD"<web_runner_dir>" "<web_runner_dir>/web.bbj" - "BUI" "<name>" "<programme>" "<workingDir>" "<username>" "<password>" "<classpath>"
     ```
     Where `web_runner_dir` is the directory containing web.bbj (its parent).

     In GeneralCommandLine terms:
     - Executable: bbj path
     - Parameters: `-q`, `-WD` + webRunnerDir, webBbjPath, `-`, `BUI`, name, programme, workingDir, username, password, classpath

     Note the `-` (dash) parameter between web.bbj path and the arguments — this is the BBj convention for separating program arguments from interpreter arguments.
  10. Set cmd working directory to webRunnerDir.
  11. Return cmd.

  Override `getRunMode()` or just hardcode "BUI" for the success notification.

**BbjRunDwcAction.java** — Nearly identical to BbjRunBuiAction:
- Constructor: `super("Run As DWC Program", "Run current BBj file as DWC program in browser", BbjIcons.RUN_DWC)`.
- Same `buildCommandLine()` as BUI but passes `"DWC"` instead of `"BUI"` as the client type parameter.

  To avoid code duplication, consider having both BUI and DWC extend a shared `BbjRunWebAction` intermediate class, OR add a constructor parameter to a single web runner action class. The simplest clean approach:

  Create a `protected String getClientType()` method that BbjRunBuiAction returns `"BUI"` and BbjRunDwcAction returns `"DWC"`, and put the shared `buildCommandLine()` logic in BbjRunActionBase (or a new intermediate `BbjRunWebActionBase`). Use your judgment for cleanest code — do NOT create excessive abstraction. Two small classes with minor duplication is fine.

**BbjSettings.java** — Add these fields to the State inner class:
- `public String emUsername = "admin";` — EM username for web.bbj, defaults to "admin" matching VSCode
- `public String emPassword = "admin123";` — EM password for web.bbj, defaults to "admin123" matching VSCode

**BbjSettingsComponent.java** — Add three new UI fields:
1. **EM Username** text field — under a new "Run Commands" TitledSeparator section at the bottom (before the fill-vertically spacer)
2. **EM Password** text field — same section
3. **Auto-save before run** checkbox — same section, defaults to checked

Add corresponding getter/setter methods:
- `getEmUsername()` / `setEmUsername(String)`
- `getEmPassword()` / `setEmPassword(String)`
- `isAutoSaveBeforeRun()` / `setAutoSaveBeforeRun(boolean)`

Follow the existing pattern: add fields to the form builder, wire document listeners if validation needed (no validation needed for these per phase context).

**BbjSettingsConfigurable.java** — Read this file first, then wire the new settings fields into `isModified()`, `apply()`, and `reset()` following the existing pattern for bbjHomePath/nodeJsPath/classpathEntry/logLevel/javaInteropPort.

**build.gradle.kts** — Add web.bbj bundling:
1. Add a new `copyWebRunner` task (Copy type) that copies `bbj-vscode/tools/web.bbj` into `layout.buildDirectory.dir("resources/main/tools")`.
2. Make `processResources` depend on `copyWebRunner`.
3. Add web.bbj to `prepareSandbox` task: copy from `bbj-vscode/tools/` with `include("web.bbj")` into `"${pluginName.get()}/lib/tools"`.

Follow the exact same pattern as the existing `copyLanguageServer` and `prepareSandbox` tasks.
  </action>
  <verify>
Run `cd /Users/beff/_workspace/bbj-language-server/bbj-intellij && ./gradlew compileJava` — must compile without errors. Verify:
- BbjRunBuiAction and BbjRunDwcAction exist and extend BbjRunActionBase
- BbjSettings.State has emUsername, emPassword fields with correct defaults
- BbjSettingsComponent has the three new form fields
- BbjSettingsConfigurable wires the new fields
- build.gradle.kts has copyWebRunner task and prepareSandbox includes web.bbj
- Run `./gradlew processResources` and verify `build/resources/main/tools/web.bbj` exists
  </verify>
  <done>BUI and DWC run actions build commands matching VSCode's runWeb pattern. web.bbj is bundled via Gradle. Settings page has EM username/password and auto-save toggle. Everything compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Register all three run actions with toolbar buttons and keyboard shortcuts</name>
  <files>
    bbj-intellij/src/main/resources/META-INF/plugin.xml
  </files>
  <action>
Update plugin.xml to complete all run action registrations. Replace the single `bbj.runGui` action (from Plan 01) with a complete action group containing all three run actions with shortcuts and toolbar placement.

**Replace the existing bbj.runGui action** with a full BBj Run action group:

```xml
<!-- BBj Run Commands group -->
<group id="bbj.runGroup"
       text="BBj Run"
       description="Run BBj programs"
       popup="true"
       icon="com.basis.bbj.intellij.BbjIcons.RUN_GUI">
    <action id="bbj.runGui"
            class="com.basis.bbj.intellij.actions.BbjRunGuiAction"
            text="Run As BBj Program"
            description="Run current BBj file as GUI program"
            icon="com.basis.bbj.intellij.BbjIcons.RUN_GUI">
        <keyboard-shortcut keymap="$default" first-keystroke="alt G"/>
    </action>
    <action id="bbj.runBui"
            class="com.basis.bbj.intellij.actions.BbjRunBuiAction"
            text="Run As BUI Program"
            description="Run current BBj file as BUI program in browser"
            icon="com.basis.bbj.intellij.BbjIcons.RUN_BUI">
        <keyboard-shortcut keymap="$default" first-keystroke="alt B"/>
    </action>
    <action id="bbj.runDwc"
            class="com.basis.bbj.intellij.actions.BbjRunDwcAction"
            text="Run As DWC Program"
            description="Run current BBj file as DWC program in browser"
            icon="com.basis.bbj.intellij.BbjIcons.RUN_DWC">
        <keyboard-shortcut keymap="$default" first-keystroke="alt D"/>
    </action>
    <add-to-group group-id="EditorPopupMenu" anchor="first"/>
    <add-to-group group-id="MainToolBar" anchor="last"/>
</group>
```

**Key design points:**
- The group is a popup group so the context menu shows "BBj Run >" with three sub-items instead of cluttering the menu with three separate items.
- `MainToolBar` placement puts the group in the main toolbar. Each action within the group has its own icon, so all three buttons appear.
- Keyboard shortcuts are on individual actions, not the group.
- The `add-to-group` for EditorPopupMenu replaces the individual action's previous placement.

**Alternative if popup group doesn't show individual toolbar buttons:** If IntelliJ renders popup groups as a single dropdown in the toolbar (which is likely), that's actually better UX — one toolbar button with a dropdown for GUI/BUI/DWC. But if the user wants three separate visible buttons, use individual `add-to-group` on each action instead of on the group. Test with `./gradlew runIde` to verify appearance.

Actually, for SEPARATE toolbar buttons (per RUN-04: "Run GUI/BUI/DWC actions appear as toolbar buttons"), register each action individually in the toolbar rather than as a group:

```xml
<action id="bbj.runGui" ...>
    <add-to-group group-id="EditorPopupMenu" anchor="first"/>
    <add-to-group group-id="MainToolBar" anchor="last"/>
    <keyboard-shortcut keymap="$default" first-keystroke="alt G"/>
</action>
<action id="bbj.runBui" ...>
    <add-to-group group-id="EditorPopupMenu" anchor="after" relative-to-action="bbj.runGui"/>
    <add-to-group group-id="MainToolBar" anchor="after" relative-to-action="bbj.runGui"/>
    <keyboard-shortcut keymap="$default" first-keystroke="alt B"/>
</action>
<action id="bbj.runDwc" ...>
    <add-to-group group-id="EditorPopupMenu" anchor="after" relative-to-action="bbj.runBui"/>
    <add-to-group group-id="MainToolBar" anchor="after" relative-to-action="bbj.runBui"/>
    <keyboard-shortcut keymap="$default" first-keystroke="alt D"/>
</action>
```

Use your judgment between the group approach and individual approach based on which actually produces visible toolbar buttons. The requirement is that each run mode has its own distinct visible button in the toolbar.

Keep the existing `bbj.restartLanguageServer` action unchanged.
  </action>
  <verify>
Run `cd /Users/beff/_workspace/bbj-language-server/bbj-intellij && ./gradlew buildPlugin` — must build without errors. Verify plugin.xml contains:
- `bbj.runGui` with `keyboard-shortcut` alt G and toolbar/menu placement
- `bbj.runBui` with `keyboard-shortcut` alt B and toolbar/menu placement
- `bbj.runDwc` with `keyboard-shortcut` alt D and toolbar/menu placement
- All three reference their respective BbjIcons constants
- The existing `bbj.restartLanguageServer` action is unchanged
  </verify>
  <done>All three run actions registered in plugin.xml with keyboard shortcuts (Alt+G/B/D), editor context menu placement, and main toolbar placement. Full plugin builds cleanly.</done>
</task>

</tasks>

<verification>
1. `./gradlew buildPlugin` succeeds without errors
2. BUI action command matches VSCode pattern: `bbj -q -WD<toolsDir> <toolsDir>/web.bbj - "BUI" "<name>" "<programme>" "<workingDir>" "<username>" "<password>" "<classpath>"`
3. DWC action command is identical but with "DWC" client type
4. web.bbj is copied into plugin distribution at lib/tools/web.bbj
5. Settings page shows EM Username (default: admin), EM Password (default: admin123), Auto-save checkbox (default: checked)
6. plugin.xml has all three actions with Alt+G, Alt+B, Alt+D shortcuts
7. plugin.xml has all three actions in EditorPopupMenu and MainToolBar
8. Keyboard shortcuts do not conflict with existing IntelliJ bindings
</verification>

<success_criteria>
- BUI run action spawns: `bbj -q -WD<toolsDir> <toolsDir>/web.bbj - "BUI" <name> <programme> <workingDir> <username> <password> <classpath>`
- DWC run action spawns same command with "DWC" instead of "BUI"
- web.bbj is bundled in plugin ZIP under lib/tools/web.bbj
- Settings page has EM username (admin), password (admin123), auto-save toggle
- Alt+G / Alt+B / Alt+D shortcuts registered for all three run modes
- All three actions appear in editor context menu and main toolbar
- `./gradlew buildPlugin` passes
</success_criteria>

<output>
After completion, create `.planning/phases/08-run-commands/08-02-SUMMARY.md`
</output>
