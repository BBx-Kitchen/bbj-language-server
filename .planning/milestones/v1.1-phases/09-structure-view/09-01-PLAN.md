---
phase: 09-structure-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
autonomous: false

must_haves:
  truths:
    - "Opening the Structure tool window (Alt+7 / Cmd+7) for a BBj file shows a tree of symbols (variables, classes, labels, methods)"
    - "Editing the BBj file updates the Structure view to reflect new/removed/renamed symbols"
    - "Clicking any symbol in the Structure view moves the cursor to that symbol's location in the editor"
  artifacts:
    - path: "bbj-intellij/src/main/resources/META-INF/plugin.xml"
      provides: "LSP4IJ DocumentSymbol -> Structure View binding"
      contains: "lang.psiStructureViewFactory"
  key_links:
    - from: "bbj-intellij/src/main/resources/META-INF/plugin.xml"
      to: "com.redhat.devtools.lsp4ij.features.documentSymbol.LSPDocumentSymbolStructureViewFactory"
      via: "lang.psiStructureViewFactory extension point"
      pattern: "psiStructureViewFactory.*language=\"BBj\".*LSPDocumentSymbolStructureViewFactory"
    - from: "Language server (main.cjs)"
      to: "LSP4IJ DocumentSymbol handler"
      via: "textDocument/documentSymbol LSP method"
      pattern: "documentSymbolProvider"
---

<objective>
Register the LSP4IJ `psiStructureViewFactory` extension point for the BBj language so the Structure tool window displays the document symbol tree from the language server.

Purpose: The language server already provides DocumentSymbol responses (Langium default + BBjNodeKindProvider mapping AST nodes to SymbolKind). LSP4IJ provides `LSPDocumentSymbolStructureViewFactory` which maps these to IntelliJ's Structure View. The only thing missing is the extension point binding in plugin.xml -- LSP4IJ auto-registers this for TEXT and TextMate languages but requires explicit registration for custom languages like BBj.

Output: Updated plugin.xml with Structure View working for all BBj/BBx files.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-structure-view/09-RESEARCH.md

@bbj-intellij/src/main/resources/META-INF/plugin.xml
@bbj-vscode/test/document-symbol.test.ts
@bbj-vscode/src/language/bbj-node-kind.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add psiStructureViewFactory extension point to plugin.xml</name>
  <files>bbj-intellij/src/main/resources/META-INF/plugin.xml</files>
  <action>
Add the following extension point inside the existing `<extensions defaultExtensionNs="com.intellij">` block, immediately after the `<lang.commenter>` registration (line 89) and before the `<colorSettingsPage>` registration:

```xml
        <!-- LSP textDocument/documentSymbol -> Structure View -->
        <lang.psiStructureViewFactory
            language="BBj"
            implementationClass="com.redhat.devtools.lsp4ij.features.documentSymbol.LSPDocumentSymbolStructureViewFactory"/>
```

This is the ONLY change needed. Do NOT:
- Create a custom PsiStructureViewFactory class (LSP4IJ provides one)
- Modify any language server code (the server already works -- test proves it)
- Register via LSPClientFeatures (extension points must be in plugin.xml)
- Touch any other files

After editing plugin.xml, run the existing document-symbol test to confirm the language server side is still working:

```bash
cd bbj-vscode && npx vitest run test/document-symbol.test.ts
```

Then build the plugin to verify the XML is valid:

```bash
cd bbj-intellij && ./gradlew buildPlugin
```
  </action>
  <verify>
1. `grep -c "psiStructureViewFactory" bbj-intellij/src/main/resources/META-INF/plugin.xml` returns 1
2. `npx vitest run test/document-symbol.test.ts` passes (confirms server-side DocumentSymbol still works)
3. `./gradlew buildPlugin` succeeds (confirms plugin.xml is valid and LSP4IJ class resolves)
  </verify>
  <done>plugin.xml contains the psiStructureViewFactory extension point for BBj language referencing LSPDocumentSymbolStructureViewFactory; both document-symbol test and Gradle build pass</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Structure View integration via single plugin.xml extension point addition</what-built>
  <how-to-verify>
1. Build and run the plugin: `cd bbj-intellij && ./gradlew runIde`
2. In the sandbox IDE, open any BBj file with classes, methods, variables, and labels
3. Open the Structure tool window: View > Tool Windows > Structure (or Alt+7 / Cmd+7)
4. Verify STRUC-01: The Structure pane shows a tree of symbols -- variables as Field icons, classes with Class icons, methods/functions nested under classes, labels as Field icons
5. Verify STRUC-02: Edit the file (add a new variable declaration like `newVar$ = "hello"`), confirm the Structure view updates to show the new symbol
6. Verify STRUC-03: Click any symbol in the Structure view, confirm the editor cursor jumps to that symbol's location
7. Also check with a .bbx file to confirm Structure View works for config files too
  </how-to-verify>
  <resume-signal>Type "approved" if all three criteria pass, or describe what is not working</resume-signal>
</task>

</tasks>

<verification>
- plugin.xml contains exactly one `lang.psiStructureViewFactory` entry for language="BBj"
- The implementation class is `com.redhat.devtools.lsp4ij.features.documentSymbol.LSPDocumentSymbolStructureViewFactory`
- Gradle build succeeds (buildPlugin task)
- Existing document-symbol test passes (server still works)
- Structure View renders symbols, updates on edit, and navigates on click (human-verified)
</verification>

<success_criteria>
- STRUC-01: Structure tool window shows symbol tree from language server (classes, methods, variables, labels)
- STRUC-02: Editing the file updates the Structure view
- STRUC-03: Clicking a symbol navigates to its location in the editor
</success_criteria>

<output>
After completion, create `.planning/phases/09-structure-view/09-01-SUMMARY.md`
</output>
