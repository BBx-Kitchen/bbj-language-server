---
phase: 19-test-plan
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - bbj-vscode/package.json
  - bbj-vscode/vitest.config.ts
autonomous: true

must_haves:
  truths:
    - "Coverage report can be generated with npm run test:coverage"
    - "Coverage excludes generated files (src/language/generated/**)"
    - "Coverage report shows meaningful percentages for source files"
    - "Coverage thresholds are configured (prevents regressions)"
  artifacts:
    - path: "bbj-vscode/package.json"
      provides: "test:coverage script"
      contains: "vitest run --coverage"
    - path: "bbj-vscode/vitest.config.ts"
      provides: "Coverage configuration"
      contains: "coverage"
  key_links:
    - from: "bbj-vscode/vitest.config.ts"
      to: "@vitest/coverage-v8"
      via: "provider: 'v8'"
      pattern: "provider.*v8"
---

<objective>
Add coverage reporting infrastructure to the test suite using @vitest/coverage-v8.

Purpose: Enable measurement of test coverage to identify gaps and establish quality gates for future development. V8 coverage is the fastest option for Node.js projects.

Output: Coverage tooling installed, configured, and runnable via npm script.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-test-plan/19-RESEARCH.md

@bbj-vscode/package.json
@bbj-vscode/vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @vitest/coverage-v8</name>
  <files>bbj-vscode/package.json</files>
  <action>
Install the V8 coverage provider for vitest:

```bash
cd bbj-vscode && npm install --save-dev @vitest/coverage-v8
```

This will add `@vitest/coverage-v8` to devDependencies in package.json.

**Why V8 over Istanbul:**
- V8 coverage uses native Node.js profiler (no transpilation)
- Faster execution than Istanbul
- Better source map handling for TypeScript
- Recommended for Node.js language server projects
  </action>
  <verify>
```bash
cd bbj-vscode && grep "@vitest/coverage-v8" package.json
```
Expected: Shows @vitest/coverage-v8 in devDependencies
  </verify>
  <done>@vitest/coverage-v8 installed in package.json devDependencies</done>
</task>

<task type="auto">
  <name>Task 2: Configure vitest coverage settings</name>
  <files>bbj-vscode/vitest.config.ts</files>
  <action>
Update vitest.config.ts with comprehensive coverage configuration:

```typescript
import { defineConfig } from 'vitest/config'

export default defineConfig({
  test: {
    coverage: {
      enabled: false, // Enable via --coverage flag, not by default
      provider: 'v8',
      reporter: ['text', 'html', 'json-summary'],
      reportsDirectory: './coverage',
      include: ['src/**/*.ts'],
      exclude: [
        'src/language/generated/**', // Langium-generated files
        'src/extension.ts',           // VS Code extension entry point (hard to unit test)
        '**/*.d.ts',                  // Type definitions
      ],
      // Conservative thresholds - start low, increase over time
      // Based on research: 70% lines, 65% functions, 60% branches recommended
      thresholds: {
        lines: 50,      // Start conservative, current coverage unknown
        functions: 45,
        branches: 40,
        statements: 50,
        // Fail build if coverage drops below thresholds
        // This prevents regressions, not ensures completeness
      }
    }
  },
})
```

**Configuration choices:**
- `enabled: false` - Don't run coverage on every test; use --coverage flag when needed
- `provider: 'v8'` - Native Node.js coverage, fastest option
- `reporter: ['text', 'html', 'json-summary']` - Console output + HTML report + JSON for CI
- `exclude generated/**` - Langium-generated code shouldn't count toward coverage
- `exclude extension.ts` - VS Code extension activation is hard to unit test
- `thresholds` - Conservative starting values (will adjust after baseline measurement)
  </action>
  <verify>
```bash
cd bbj-vscode && cat vitest.config.ts | grep -A 20 "coverage"
```
Expected: Shows coverage configuration with provider, include, exclude, thresholds
  </verify>
  <done>vitest.config.ts has complete coverage configuration</done>
</task>

<task type="auto">
  <name>Task 3: Add test:coverage npm script</name>
  <files>bbj-vscode/package.json</files>
  <action>
Add a `test:coverage` script to package.json scripts section:

```json
"scripts": {
  ...existing scripts...
  "test:coverage": "vitest run --coverage"
}
```

This provides a convenient way to run tests with coverage without modifying the default `test` script behavior.

**Why separate script:**
- Default `npm test` stays fast (no coverage overhead)
- Coverage can be run explicitly when needed
- CI can call `npm run test:coverage` for coverage gates
  </action>
  <verify>
```bash
cd bbj-vscode && npm run test:coverage 2>&1 | head -50
```
Expected: Tests run with coverage output showing percentages for files
  </verify>
  <done>npm run test:coverage runs tests and generates coverage report</done>
</task>

</tasks>

<verification>
1. `npm run test:coverage` completes successfully
2. Coverage report generated in ./coverage directory
3. Text coverage summary shows percentages for src files
4. Generated files (src/language/generated/**) are excluded from report
5. Thresholds are configured (build fails if coverage drops too low)
</verification>

<success_criteria>
- @vitest/coverage-v8 in package.json devDependencies
- vitest.config.ts has coverage configuration
- `npm run test:coverage` script works
- Coverage report excludes generated files
- HTML report viewable at coverage/index.html
</success_criteria>

<output>
After completion, create `.planning/phases/19-test-plan/19-02-SUMMARY.md`
</output>
