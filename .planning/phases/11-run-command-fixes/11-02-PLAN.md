---
phase: 11-run-command-fixes
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java
autonomous: false

must_haves:
  truths:
    - "Right-clicking a .bbj file in the project tree shows Run as GUI/BUI/DWC options"
    - "Right-clicking in the editor on a .bbj file shows Run as GUI/BUI/DWC options"
    - "Run actions are no longer registered to MainToolBar (removed for new UI compatibility)"
    - "Keyboard shortcuts Alt+G, Alt+B, Alt+D still work for GUI/BUI/DWC respectively"
    - "Run actions are only enabled when a BBj file is selected (editor or project tree)"
  artifacts:
    - path: "bbj-intellij/src/main/resources/META-INF/plugin.xml"
      provides: "ProjectViewPopupMenu group registration, MainToolBar removed, context menu submenu"
      contains: "ProjectViewPopupMenu"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java"
      provides: "Updated update() method supporting both editor and project view contexts"
      contains: "CommonDataKeys.VIRTUAL_FILE"
  key_links:
    - from: "plugin.xml (ProjectViewPopupMenu)"
      to: "BbjRunGuiAction, BbjRunBuiAction, BbjRunDwcAction"
      via: "action group registration in plugin.xml"
      pattern: "ProjectViewPopupMenu"
    - from: "BbjRunActionBase.update()"
      to: "CommonDataKeys.VIRTUAL_FILE"
      via: "action context for both editor and project tree file selection"
      pattern: "CommonDataKeys\\.VIRTUAL_FILE"
---

<objective>
Fix run action visibility in IntelliJ's new UI and add right-click context menu in project tree.

Purpose: Run toolbar buttons (GUI/BUI/DWC) are hidden in IntelliJ's new UI (default since 2024.2) because MainToolBar actions are not shown by default. Users also cannot right-click a .bbj file in the project tree to run it. This plan removes the unreliable MainToolBar registrations and adds ProjectViewPopupMenu context menu access.

Output: Updated plugin.xml with ProjectViewPopupMenu registrations (as a submenu group), removed MainToolBar registrations. Updated BbjRunActionBase.update() to properly handle both editor and project tree contexts. Verified via manual testing.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-run-command-fixes/11-CONTEXT.md
@.planning/phases/11-run-command-fixes/11-RESEARCH.md
@.planning/phases/11-run-command-fixes/11-01-SUMMARY.md
@bbj-intellij/src/main/resources/META-INF/plugin.xml
@bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunGuiAction.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update plugin.xml action registrations</name>
  <files>bbj-intellij/src/main/resources/META-INF/plugin.xml</files>
  <action>
Modify plugin.xml to fix toolbar visibility and add project tree context menu:

1. **Remove all `MainToolBar` group registrations** from the three run actions (bbj.runGui, bbj.runBui, bbj.runDwc). Delete these lines:
   - `<add-to-group group-id="MainToolBar" anchor="last"/>` from bbj.runGui
   - `<add-to-group group-id="MainToolBar" anchor="after" relative-to-action="bbj.runGui"/>` from bbj.runBui
   - `<add-to-group group-id="MainToolBar" anchor="after" relative-to-action="bbj.runBui"/>` from bbj.runDwc

2. **Add a BBj Run action group** that appears as a submenu in the project view context menu. Create a `<group>` element:
   ```xml
   <!-- BBj Run submenu for Project View context menu -->
   <group id="bbj.runGroup"
          text="BBj Run"
          description="Run BBj program"
          icon="com.basis.bbj.intellij.BbjIcons.RUN_GUI"
          popup="true">
       <reference ref="bbj.runGui"/>
       <reference ref="bbj.runBui"/>
       <reference ref="bbj.runDwc"/>
       <add-to-group group-id="ProjectViewPopupMenu" anchor="before" relative-to-action="$Cut"/>
   </group>
   ```

3. **Keep existing EditorPopupMenu registrations** on the individual actions — these already work correctly for right-click in editor.

4. **Keep existing keyboard shortcuts** (Alt+G, Alt+B, Alt+D) — these are independent of toolbar/menu registration.

The result: run actions are accessible via:
  - Editor right-click context menu (existing, unchanged)
  - Project tree right-click context menu (new submenu "BBj Run > Run As GUI/BUI/DWC")
  - Keyboard shortcuts Alt+G/B/D (existing, unchanged)
  - NOT via MainToolBar (removed — unreliable in new UI)
  </action>
  <verify>
Run `./gradlew build` in `bbj-intellij/` to verify build succeeds. Grep plugin.xml for `MainToolBar` — should find zero matches. Grep plugin.xml for `ProjectViewPopupMenu` — should find one match. Grep plugin.xml for `bbj.runGroup` — should find one match. Verify all three action IDs (bbj.runGui, bbj.runBui, bbj.runDwc) still exist. Verify keyboard shortcuts still registered.
  </verify>
  <done>
plugin.xml has no MainToolBar registrations. BBj Run submenu group registered in ProjectViewPopupMenu. All three run actions referenced in the submenu group. EditorPopupMenu registrations and keyboard shortcuts preserved. Build compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update action update() for project tree context</name>
  <files>bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java</files>
  <action>
The existing `update()` method in BbjRunActionBase already uses `CommonDataKeys.VIRTUAL_FILE` which works for both editor and project tree contexts. However, verify and ensure:

1. **Confirm `update()` handles project tree selection correctly.** The `e.getData(CommonDataKeys.VIRTUAL_FILE)` call should return the selected file when right-clicking in the project tree. This is the standard IntelliJ pattern and should work without changes.

2. **Also handle directory selection gracefully.** When a user right-clicks a directory (not a file) in the project tree, `VIRTUAL_FILE` returns the directory. The current `file.getExtension()` check returns null for directories, which correctly disables the action. No change needed here.

3. **Ensure `actionPerformed()` also handles project tree context.** The current code uses `e.getData(CommonDataKeys.VIRTUAL_FILE)` which works from both editor and project tree. Verify that `e.getProject()` returns correctly from project tree context as well.

4. **Add `.bbx` to the BBj file extension check in `update()`** if not already present. The current check already includes `.bbx`, so verify it's there. Looking at the existing code, the extensions checked are: bbj, bbl, bbjt, src, bbx. This is correct — no change needed.

If the existing `update()` and `actionPerformed()` methods already work correctly for project tree context (which they should since they use standard `CommonDataKeys`), no code changes are needed in this task. The main fix is the plugin.xml registration from Task 1.

However, if during testing you discover that the project tree context does not provide `VIRTUAL_FILE` for the selected file, the fallback is to also check `CommonDataKeys.PSI_FILE` and extract the VirtualFile from it.
  </action>
  <verify>
Run `./gradlew build` in `bbj-intellij/` to verify compilation succeeds. Review BbjRunActionBase.update() to confirm it uses CommonDataKeys.VIRTUAL_FILE (works for both editor and project tree). If code changes were made, verify they compile.
  </verify>
  <done>
BbjRunActionBase.update() correctly handles both editor and project tree contexts via CommonDataKeys.VIRTUAL_FILE. Run actions are enabled only when a BBj file is selected regardless of context (editor or project tree).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Fixed run command visibility and context menu access:
- Removed MainToolBar registrations (were hidden in new UI)
- Added ProjectViewPopupMenu submenu "BBj Run" with GUI/BUI/DWC options
- Preserved editor context menu and keyboard shortcuts
- Fixed executable resolution (from Plan 01) and stderr capture

Combined with Plan 01 fixes:
- Executable resolution now uses java.nio.file.Files API
- Process stderr captured and routed to LS log window
- Pre-launch validation with clear error messages
  </what-built>
  <how-to-verify>
**A. UI & menu verification (any platform):**
1. Open IntelliJ with a project containing .bbj files
2. **Project tree context menu:** Right-click a .bbj file in the project tree. Verify "BBj Run" submenu appears with "Run As BBj Program", "Run As BUI Program", "Run As DWC Program" options
3. **Editor context menu:** Open a .bbj file, right-click in editor. Verify the three run options appear at the top of the context menu
4. **Keyboard shortcuts:** With a .bbj file focused, press Alt+G, Alt+B, Alt+D — verify each triggers the corresponding run action
5. **New UI toolbar:** Verify the main toolbar does NOT show BBj run buttons (this is intentional — they were unreliable in new UI)
6. **Non-BBj files:** Right-click a .java or .txt file — verify BBj Run submenu is NOT shown or is grayed out

**B. macOS end-to-end (RUN-04):**
7. **GUI mode:** Run a .bbj file as GUI on macOS. Verify the bbj executable resolves correctly (no "not found" errors) and the program launches
8. **BUI mode:** Run a .bbj file as BUI on macOS. Verify it launches without errors
9. **DWC mode:** Run a .bbj file as DWC on macOS. Verify it launches without errors
10. **Stderr capture (macOS):** Trigger a BBj process error (e.g., run a .bbj file with invalid syntax). Verify stderr output appears in the BBj Language Server log window (bottom panel), NOT as a notification balloon
11. **Log window auto-open (macOS):** Verify the LS log window auto-opens when stderr/error occurs, but does NOT auto-open on a successful launch

**C. Windows end-to-end (RUN-05) — if Windows environment available:**
12. **GUI mode:** Run a .bbj file as GUI on Windows. Verify the bbj.exe executable resolves correctly and the program launches
13. **BUI mode:** Run a .bbj file as BUI on Windows. Verify it launches without errors
14. **DWC mode:** Run a .bbj file as DWC on Windows. Verify it launches without errors
15. **Stderr capture (Windows):** Trigger a BBj process error on Windows. Verify stderr output appears in the BBj Language Server log window, NOT as a notification balloon
16. **Log window auto-open (Windows):** Verify the LS log window auto-opens on error but not on successful launch

**D. Error handling verification (both platforms):**
17. **BBj Home not set:** Clear the BBj Home setting, attempt to run. Verify a clear error message appears in the LS log window: "BBj Home is not configured..."
18. **Invalid BBj Home path:** Set BBj Home to a nonexistent directory, attempt to run. Verify error in LS log window: "BBj Home directory does not exist..."
19. **Missing executable:** Set BBj Home to a valid directory that does NOT contain bin/bbj. Verify error in LS log window: "BBj executable not found..."
20. **No notification balloons:** Confirm that NO notification balloons appear for any of the above errors — all errors route exclusively to the LS log window
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `./gradlew build` compiles without errors
2. plugin.xml contains NO `MainToolBar` references for run actions
3. plugin.xml contains `ProjectViewPopupMenu` group with `bbj.runGroup`
4. All three run action IDs still registered with keyboard shortcuts
5. Manual verification: right-click .bbj file in project tree shows run submenu
6. Manual verification: right-click in editor shows run options
7. Manual verification: keyboard shortcuts work
</verification>

<success_criteria>
- Run actions accessible from project tree right-click context menu
- Run actions accessible from editor right-click context menu
- Keyboard shortcuts Alt+G/B/D work
- No MainToolBar registrations in plugin.xml
- Non-BBj files do not show run options
- Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/11-run-command-fixes/11-02-SUMMARY.md`
</output>
