---
phase: 11-run-command-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java
autonomous: true

must_haves:
  truths:
    - "User configures BBj Home in settings and run command correctly resolves the bbj executable (no false 'not found' errors)"
    - "Process stderr output from a failed BBj launch appears in the BBj Language Server log window"
    - "Log window auto-opens only when an error occurs during run command execution"
    - "If BBj Home is not set or executable does not exist, a clear error message appears in the log window before any process is spawned"
  artifacts:
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java"
      provides: "Fixed executable resolution, pre-launch validation, stderr capture via ProcessAdapter, error routing to LS log window"
      contains: "java.nio.file.Files"
  key_links:
    - from: "BbjRunActionBase.java"
      to: "BbjServerService.logToConsole()"
      via: "error messages and stderr output routed to LS log tool window"
      pattern: "BbjServerService\\.getInstance.*logToConsole"
    - from: "BbjRunActionBase.actionPerformed()"
      to: "ProcessAdapter.onTextAvailable()"
      via: "stderr capture attached before startNotify()"
      pattern: "addProcessListener.*ProcessAdapter"
---

<objective>
Fix the BBj executable resolution bug and add process stderr capture to run commands.

Purpose: Run commands currently fail with "not found" errors despite a valid BBj Home configuration (likely due to java.io.File symbolic link issues). Additionally, process stderr is silently lost, making it impossible to diagnose failed launches. This plan fixes both problems.

Output: Updated BbjRunActionBase.java with reliable executable resolution using java.nio.file.Files API, comprehensive pre-launch validation with clear error messages routed to the LS log window, and ProcessAdapter-based stderr capture that auto-opens the log window on errors.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-run-command-fixes/11-CONTEXT.md
@.planning/phases/11-run-command-fixes/11-RESEARCH.md
@bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunGuiAction.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunBuiAction.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunDwcAction.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerService.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerLogToolWindowFactory.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
@bbj-intellij/src/main/resources/META-INF/plugin.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix executable resolution and add pre-launch validation</name>
  <files>bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java</files>
  <action>
Modify BbjRunActionBase.java to fix the executable resolution bug and add pre-launch validation:

1. **Replace `getBbjExecutablePath()` implementation** to use `java.nio.file.Files` API instead of `java.io.File`:
   - Use `java.nio.file.Path` and `java.nio.file.Paths` for path construction
   - Use `Files.exists(path)` instead of `file.exists()` (handles symbolic links correctly per JDK-4956115)
   - Use `Files.isRegularFile(path)` instead of `file.isFile()`
   - Use `Files.isExecutable(path)` to verify the file is actually executable
   - Try both `bin/bbj` (unix) and `bin/bbj.exe` (windows) using `SystemInfo.isWindows`
   - Also try the path directly without `bin/` prefix as a fallback (some installations differ)
   - Return the resolved `Path.toAbsolutePath().toString()`

2. **Add a `validateBeforeRun()` method** that performs comprehensive pre-launch checks BEFORE spawning any process:
   - Check `bbjHomePath` is set (not null, not empty). If not: log error to LS log window with message "BBj Home is not configured. Set it in Settings > Languages & Frameworks > BBj."
   - Check `bbjHomePath` directory exists using `Files.isDirectory()`. If not: log error "BBj Home directory does not exist: <path>"
   - Check bbj executable is found (call `getBbjExecutablePath()`). If null: log error "BBj executable not found in <bbjHomePath>/bin/. Verify your BBj installation."
   - Return true only if all checks pass, false otherwise
   - All error logging goes through `BbjServerService.getInstance(project).logToConsole(message, ConsoleViewContentType.ERROR_OUTPUT)`

3. **Update `actionPerformed()`** to call `validateBeforeRun()` before `buildCommandLine()`:
   - Call `validateBeforeRun(project)` first
   - If validation fails, auto-show the LS log tool window using `ToolWindowManager.getInstance(project).getToolWindow("BBj Language Server").show()` (on EDT via `invokeLater`)
   - Return early without calling `buildCommandLine()`
   - Remove the notification balloon calls from `showError()` — per CONTEXT.md decisions, errors go to LS log window only (no balloons, no auto-open settings)

4. **Update imports:**
   - Add: `java.nio.file.Files`, `java.nio.file.Path`, `java.nio.file.Paths`
   - Add: `com.basis.bbj.intellij.ui.BbjServerService`
   - Add: `com.intellij.execution.ui.ConsoleViewContentType`
   - Add: `com.intellij.openapi.wm.ToolWindow`, `com.intellij.openapi.wm.ToolWindowManager`
   - Remove: `com.intellij.notification.NotificationGroupManager`, `com.intellij.notification.NotificationType` (no longer using balloons for run errors)

5. **Remove `showError()` and `showSuccess()` methods** — replace with `logError()` and `logInfo()` helper methods that route to `BbjServerService.logToConsole()`. The `logError()` method should also auto-show the log tool window.

IMPORTANT: Do NOT use notification balloons for validation errors (per CONTEXT.md decision). All errors go to the LS log window only. The log window auto-opens only when there is an error.
  </action>
  <verify>
Run `./gradlew build` in `bbj-intellij/` to verify compilation succeeds. Grep for `java.io.File` in BbjRunActionBase.java to confirm no old File API usage remains for executable resolution. Grep for `NotificationGroupManager` in BbjRunActionBase.java to confirm balloon notifications are removed. Grep for `Files.exists` to confirm new API is used. Grep for `logToConsole` to confirm error routing to LS log window.
  </verify>
  <done>
BbjRunActionBase uses java.nio.file.Files for executable resolution. Pre-launch validation checks BBj Home, directory existence, and executable existence before any process spawn. All errors route to LS log window via BbjServerService.logToConsole(). No notification balloons used for run command errors. Log window auto-shows on error.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ProcessAdapter for stderr capture</name>
  <files>bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java</files>
  <action>
Modify BbjRunActionBase.java to capture process stderr and route it to the LS log window:

1. **Update `actionPerformed()`** process execution block to attach a ProcessAdapter BEFORE calling `startNotify()`:
   ```
   OSProcessHandler handler = new OSProcessHandler(cmd);
   handler.addProcessListener(new ProcessAdapter() {
       @Override
       public void onTextAvailable(@NotNull ProcessEvent event, @NotNull Key outputType) {
           if (outputType == ProcessOutputTypes.STDERR) {
               String text = event.getText();
               if (text != null && !text.isBlank()) {
                   BbjServerService service = BbjServerService.getInstance(project);
                   service.logToConsole("[" + getRunMode() + "] " + text.stripTrailing(), ConsoleViewContentType.ERROR_OUTPUT);
                   // Auto-show log window on stderr
                   ApplicationManager.getApplication().invokeLater(() -> {
                       ToolWindow tw = ToolWindowManager.getInstance(project).getToolWindow("BBj Language Server");
                       if (tw != null && !tw.isVisible()) {
                           tw.show();
                       }
                   });
               }
           }
       }

       @Override
       public void processTerminated(@NotNull ProcessEvent event) {
           int exitCode = event.getExitCode();
           if (exitCode != 0) {
               BbjServerService service = BbjServerService.getInstance(project);
               service.logToConsole("[" + getRunMode() + "] Process exited with code " + exitCode, ConsoleViewContentType.ERROR_OUTPUT);
           }
       }
   });
   handler.startNotify();
   ```

2. **Add required imports:**
   - `com.intellij.execution.process.ProcessAdapter`
   - `com.intellij.execution.process.ProcessEvent`
   - `com.intellij.execution.process.ProcessOutputTypes`
   - `com.intellij.openapi.util.Key`
   - `com.intellij.openapi.application.ApplicationManager`

3. **Log launch info** to LS log window when a program is successfully launched:
   - After `handler.startNotify()`, log: `"[GUI] Launched <filename>"` using `ConsoleViewContentType.SYSTEM_OUTPUT`
   - Remove the `showSuccess()` notification balloon call

4. **Update the ExecutionException catch block** to log the error to the LS log window instead of showing a notification balloon, and auto-show the log window.

IMPORTANT: Attach ProcessAdapter BEFORE startNotify() — this is critical to not miss early output (per RESEARCH.md pitfall #3).
  </action>
  <verify>
Run `./gradlew build` in `bbj-intellij/` to verify compilation succeeds. Grep for `ProcessAdapter` in BbjRunActionBase.java to confirm stderr capture is attached. Grep for `startNotify` to confirm ProcessAdapter is added before startNotify(). Grep for `STDERR` to confirm stderr filtering. Verify no `showSuccess` or `showError` notification balloon methods remain.
  </verify>
  <done>
ProcessAdapter is attached to OSProcessHandler before startNotify(). Stderr output from BBj process is captured and routed to LS log window with run mode prefix. Non-zero exit codes are logged. Log window auto-shows when stderr or errors occur. No notification balloons used. Launch info logged to LS log window.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew build` in `bbj-intellij/` compiles without errors
2. `BbjRunActionBase.java` uses `java.nio.file.Files` for executable resolution (no `java.io.File` for existence checks)
3. `BbjRunActionBase.java` has `ProcessAdapter` attached before `startNotify()`
4. `BbjRunActionBase.java` routes all errors to `BbjServerService.logToConsole()` (no `NotificationGroupManager` usage)
5. `BbjRunActionBase.java` has `validateBeforeRun()` method that checks BBj Home, directory, and executable before process spawn
6. Log window auto-shows on error via `ToolWindowManager`
</verification>

<success_criteria>
- Executable resolution uses java.nio.file.Files API (handles symbolic links correctly)
- Pre-launch validation catches missing/invalid BBj Home before process spawn
- All error messages route to LS log window, not notification balloons
- Process stderr captured via ProcessAdapter and displayed in LS log window
- Log window auto-opens only when errors occur
- Build compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/11-run-command-fixes/11-01-SUMMARY.md`
</output>
