---
phase: 33-parser-and-lexer-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/language/bbj.langium
  - bbj-vscode/src/language/bbj-validator.ts
  - bbj-vscode/test/parser.test.ts
autonomous: true

must_haves:
  truths:
    - "`method public void doSomething()` parses without flagging `void` as an unresolvable class"
    - "`cast(BBjString[], someVar!)` with array type notation `[]` parses without errors"
    - "`cast(MyClass[][], someVar!)` multi-dimensional array notation parses without errors"
    - "Existing parser tests continue to pass (177 passing, 6 known failures unchanged)"
  artifacts:
    - path: "bbj-vscode/src/language/bbj.langium"
      provides: "Grammar rules for void return type and cast array notation"
      contains: "voidReturn"
    - path: "bbj-vscode/test/parser.test.ts"
      provides: "Test coverage for void and cast array fixes"
  key_links:
    - from: "bbj-vscode/src/language/bbj.langium"
      to: "MethodDecl interface"
      via: "voidReturn property in MethodDeclStart fragment"
      pattern: "voidReturn.*void"
---

<objective>
Fix two grammar-level bugs that produce false errors on valid BBj syntax: the `void` return type being flagged as an unresolvable class in method signatures (PARSE-01), and `cast(Type[], expr)` with array bracket notation failing to parse (PARSE-04).

Purpose: Eliminate false diagnostics that erode developer trust in the language server.
Output: Updated grammar, validator, and tests; `langium generate` + build passing.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-parser-and-lexer-fixes/33-RESEARCH.md
@bbj-vscode/src/language/bbj.langium
@bbj-vscode/src/language/bbj-validator.ts
@bbj-vscode/test/parser.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix void return type and cast array notation in grammar</name>
  <files>
    bbj-vscode/src/language/bbj.langium
    bbj-vscode/src/language/bbj-validator.ts
    bbj-vscode/test/parser.test.ts
  </files>
  <action>
**PARSE-01: void return type (Grammar fix)**

In `bbj.langium`, modify the `MethodDeclStart` fragment (line 352-353) to recognize `void` as an optional keyword in the return type position, separate from `QualifiedClass` resolution:

Current:
```
fragment MethodDeclStart returns MethodDecl:
    'METHOD' Visibility Static (returnType=QualifiedClass (array?='[' ']')? )? name=ValidName '(' ...
```

Change to:
```
fragment MethodDeclStart returns MethodDecl:
    'METHOD' Visibility Static (voidReturn?='void' | (returnType=QualifiedClass (array?='[' ']')?) )? name=ValidName '(' ...
```

Add `voidReturn` to the `MethodDecl` interface (around line 952):
```
interface MethodDecl extends NamedElement {
    visibility?: string
    static?: boolean
    voidReturn?: boolean
    returnType?: QualifiedClass
    ...
}
```

IMPORTANT: `void` must be case-insensitive in BBj. Check if Langium keywords default to case-insensitive. If not, use a terminal pattern instead: `VOID returns string: /void/i;` and reference it as `voidReturn?=VOID`. However, first test with the simple keyword approach since the grammar already handles case-insensitive keywords like `'METHOD'`, `'CLASS'`, etc. through Langium's default behavior (Langium 4.x defaults to case-insensitive keywords).

**PARSE-04: cast array notation (Grammar + Validator fix)**

The issue is that `cast(BBjString[], someVar!)` fails because `BBjString[]` is parsed as an expression and `[]` is not valid in that context. The cast's first argument is parsed via `ParameterCall` -> `Expression`, which doesn't support array bracket notation on type references.

The best approach: Make the `checkCastTypeResolvable` validator in `bbj-validator.ts` more tolerant. Since the brackets after a type name in `cast()` are parsed as an `ArrayElement` access (the parser already handles `Type[...]` as array indexing), the issue is that the validator doesn't recognize this pattern.

Actually, examine the exact parse result for `cast(BBjString[], x!)`. The parser sees:
1. `BBjString` as a BBjTypeRef or SymbolRef
2. `[]` as array indexing with no index -- which may cause a parse error

If the parser itself fails (not just validation), we need a grammar fix. Check by adding a test first and examining the error.

Two-pronged approach:
1. First, add test cases for `cast(BBjString[], x!)` and `cast(MyClass[][], x!)` to determine if the error is parser-level or validator-level.
2. If parser-level: Consider adding array notation to the expression grammar so `BBjString[]` is a valid expression. A clean approach is to enhance the `MemberCall` rule to allow `[]` (empty brackets) as array-type notation when no index is provided -- but this may conflict with existing array access.

   Alternative: Create a special-case in ParameterCall to recognize type-with-array syntax:
   ```
   ParameterCall:
       expression=Expression (arrayDims+='[' ']')*
   ```
   Then update `checkCastTypeResolvable` to check `arrayDims` on the parameter call.

3. If validator-level only: Update `checkCastTypeResolvable` in `bbj-validator.ts` to handle the case where the type argument is followed by array brackets.

Per user decision: "Just stop the false error -- no type resolution for array casts in this phase." So the fix should be minimal -- stop the error, don't add type resolution.

**Tests to add in `parser.test.ts`:**

```typescript
test('PARSE-01: void return type in method signature (#356)', async () => {
    const result = await parse(`
        class public MyService
            method public void doSomething()
                PRINT "hello"
            methodend
        classend
    `, { validation: true });
    expectNoParserLexerErrors(result);
    expectNoValidationErrors(result);
});

test('PARSE-01: void return type case insensitive (#356)', async () => {
    const result = await parse(`
        class public MyService
            method public VOID doNothing()
            methodend
            method public Void doAlsoNothing()
            methodend
        classend
    `, { validation: true });
    expectNoParserLexerErrors(result);
    expectNoValidationErrors(result);
});

test('PARSE-04: cast with array type notation (#296)', async () => {
    const result = await parse(`
        declare auto x!
        x! = cast(BBjString[], x!)
    `);
    expectNoParserLexerErrors(result);
});

test('PARSE-04: cast with multi-dimensional array type (#296)', async () => {
    const result = await parse(`
        declare auto x!
        x! = cast(BBjString[][], x!)
    `);
    expectNoParserLexerErrors(result);
});
```

After making changes, run:
```bash
cd bbj-vscode && npm run langium:generate && npm run build && npx vitest run test/parser.test.ts
```

Verify that all 177 previously-passing tests still pass, plus the new tests pass. The 6 known failures should remain unchanged.
  </action>
  <verify>
    Run `cd bbj-vscode && npm run langium:generate && npm run build && npx vitest run test/parser.test.ts` -- all previously passing tests still pass, plus new PARSE-01 and PARSE-04 tests pass. The 6 known pre-existing failures remain unchanged.
  </verify>
  <done>
    1. `method public void doSomething()` parses without errors and `void` is NOT flagged as an unresolvable class
    2. `cast(BBjString[], someVar!)` parses without errors
    3. `cast(Type[][], someVar!)` multi-dimensional arrays parse without errors
    4. Case-insensitive `VOID`/`Void`/`void` all work in method signatures
    5. 177+ previously passing parser tests still pass
  </done>
</task>

</tasks>

<verification>
1. `npm run langium:generate` completes without errors
2. `npm run build` compiles successfully
3. `npx vitest run test/parser.test.ts` shows 177+ passing (new tests added), 6 known failures unchanged
4. New test for `method public void doSomething()` passes with validation enabled
5. New test for `cast(BBjString[], x!)` passes
</verification>

<success_criteria>
- void in method return type position is recognized as a keyword, not a class reference
- Array bracket notation in cast expressions does not produce parse errors
- No regressions in existing parser tests
</success_criteria>

<output>
After completion, create `.planning/phases/33-parser-and-lexer-fixes/33-01-SUMMARY.md`
</output>
