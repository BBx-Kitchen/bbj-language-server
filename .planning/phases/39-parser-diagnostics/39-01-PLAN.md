---
phase: 39-parser-diagnostics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/language/bbj-module.ts
  - documentation/docs/user-guide/configuration.md
  - .planning/phases/39-parser-diagnostics/39-INVESTIGATION.md
autonomous: true

must_haves:
  truths:
    - "Root cause of Chevrotain ambiguity warnings is documented with specific grammar rule names"
    - "Each ambiguity is classified as 'real issue' or 'safe to suppress' with rationale"
    - "Parser ambiguity details are visible when bbj.debug=true"
    - "Parser ambiguity warnings are silent when bbj.debug=false (default)"
    - "Full Chevrotain ambiguity message (with rule names) is passed through in debug mode"
    - "Non-debug mode shows at most one summary line via logger.debug"
    - "bbj.debug setting is documented in Docusaurus with enable/disable instructions"
  artifacts:
    - path: ".planning/phases/39-parser-diagnostics/39-INVESTIGATION.md"
      provides: "Root cause analysis documenting which grammar rules trigger ambiguities and whether they are safe"
      contains: "## Ambiguous Rules"
    - path: "bbj-vscode/src/language/bbj-module.ts"
      provides: "Enhanced ambiguity logging hook with debug-gated verbosity"
      contains: "logger.isDebug"
    - path: "documentation/docs/user-guide/configuration.md"
      provides: "bbj.debug documentation section"
      contains: "bbj.debug"
  key_links:
    - from: "bbj-vscode/src/language/bbj-module.ts"
      to: "bbj-vscode/src/language/logger.ts"
      via: "logger.isDebug() and logger.debug()"
      pattern: "logger\\.isDebug\\(\\)|logger\\.debug\\("
    - from: ".planning/phases/39-parser-diagnostics/39-INVESTIGATION.md"
      to: "bbj-vscode/src/language/bbj.langium"
      via: "documents which grammar rules cause ambiguities"
      pattern: "## Ambiguous Rules"
---

<objective>
Investigate Chevrotain ambiguity warnings to identify root cause grammar rules, enhance ambiguity logging to show full details behind debug flag, and document the bbj.debug setting.

Purpose: Complete the v3.3 milestone by (1) investigating and documenting which BBj grammar rules cause Chevrotain ambiguity warnings (PARSE-01), (2) handling parser ambiguity warnings appropriately -- quiet by default, verbose on-demand (PARSE-02), and (3) documenting the debug setting so users know how to enable verbose output (DOCS-01).

Output: Investigation document with root cause analysis, enhanced ambiguity hook in bbj-module.ts, updated configuration.md with debug logging section.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-parser-diagnostics/39-RESEARCH.md
@bbj-vscode/src/language/bbj-module.ts
@bbj-vscode/src/language/bbj.langium
@bbj-vscode/src/language/logger.ts
@documentation/docs/user-guide/configuration.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Investigate ambiguity root cause and document findings</name>
  <files>
    bbj-vscode/src/language/bbj-module.ts
    .planning/phases/39-parser-diagnostics/39-INVESTIGATION.md
  </files>
  <action>
**Step 1: Capture ambiguity messages.**

Temporarily modify the `createBBjParser` function in bbj-module.ts to collect ALL ambiguity messages. Change the lookaheadStrategy.logging callback to unconditionally collect messages into an array and log each one:

```typescript
const ambiguityMessages: string[] = [];
lookaheadStrategy.logging = (message: string) => {
    ambiguityMessages.push(message);
    console.log(`[AMBIGUITY] ${message}`);
}
```

Then run the test suite (`npm test` in bbj-vscode/) or write a small standalone script that creates the services and triggers parser finalization. The ambiguity messages are emitted during `parser.finalize()` which runs when createBBjServices() is called. The test suite already calls `createBBjServices(EmptyFileSystem)` in parser.test.ts, so running tests will trigger the messages.

Capture the full console output. The Chevrotain ambiguity messages will contain specific grammar rule names like "Ambiguous Alternatives Detected: [rule_name] in [context]".

**Step 2: Analyze grammar rules.**

From the captured messages, identify:
- Which grammar rules (from bbj.langium) are flagged
- What the alternation conflict is (which alternatives overlap)
- Whether the ambiguity is a real parsing issue or safe (first-alternative-wins semantics are correct)

To determine if an ambiguity is "real": check if any valid BBj input could parse incorrectly due to the ambiguity. If the first alternative is always the correct choice when both match, the ambiguity is safe.

**Step 3: Determine fix vs suppress for each ambiguity.**

For each identified ambiguity:
- If the grammar can be easily refactored to eliminate it (common prefix extraction), note the refactoring approach
- If the ambiguity is safe and refactoring would make the grammar harder to read, note it as safe-to-suppress with rationale
- If grammar changes would be needed, verify they won't break any of the 460+ existing tests

**Step 4: Document findings.**

Create `.planning/phases/39-parser-diagnostics/39-INVESTIGATION.md` with:

```markdown
# Phase 39: Ambiguity Investigation

**Investigated:** [date]
**Parser:** Chevrotain 11.0.3 via Langium 4.1.3

## Summary

[1-2 sentence summary of findings]

## Ambiguous Rules

### [Rule Name 1]
- **Message:** [Full Chevrotain message]
- **Grammar location:** [Line in bbj.langium]
- **Conflict:** [Which alternatives overlap and why]
- **Real issue?** [Yes/No with explanation]
- **Resolution:** [Fix (describe refactoring) | Suppress (describe rationale)]

### [Rule Name 2]
... (repeat for each ambiguity)

## Conclusion

[Summary: how many ambiguities found, how many real vs safe, overall approach]
```

**Step 5: Revert temporary logging changes.**

After capturing messages and documenting findings, revert bbj-module.ts back to its original state (the `ambiguitiesReported` flag pattern). Task 2 will apply the permanent debug-gated enhancement.

IMPORTANT: Do NOT leave the temporary console.log in the final state of bbj-module.ts. The file must be back to its original state after this task completes.
  </action>
  <verify>
1. `.planning/phases/39-parser-diagnostics/39-INVESTIGATION.md` exists and contains specific grammar rule names from Chevrotain output
2. Each ambiguity is classified as real issue or safe-to-suppress with rationale
3. bbj-module.ts is reverted to its original state (no temporary logging changes remain)
4. `npm test` in bbj-vscode/ passes all 460+ tests (confirming revert is clean)
  </verify>
  <done>
Root cause of Chevrotain ambiguity warnings is documented in 39-INVESTIGATION.md with specific grammar rules identified from bbj.langium, each classified as real issue or safe to suppress, and bbj-module.ts is back to its original state ready for Task 2's permanent changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance ambiguity logging hook with debug-gated verbosity</name>
  <files>bbj-vscode/src/language/bbj-module.ts</files>
  <action>
Modify the `createBBjParser` function (lines 106-120) to enhance the `lookaheadStrategy.logging` callback, informed by the investigation findings from Task 1:

1. When `logger.isDebug()` is true: pass through EVERY ambiguity message with full details via `logger.debug()`. Prefix each with "Parser: " for consistency. Do NOT use the `ambiguitiesReported` flag to suppress when debug is on -- all messages should be visible for investigation.

2. When `logger.isDebug()` is false: keep existing behavior -- use the `ambiguitiesReported` flag to show one summary via `logger.debug()` (which will be suppressed anyway since debug is off, but the flag prevents any future log spam if the level changes mid-session).

3. Update the summary message to say: `'Parser: Ambiguous Alternatives Detected. Enable bbj.debug to see details.'` (replace "ambiguity logging" with "bbj.debug" for clarity).

The updated callback should be approximately:
```typescript
lookaheadStrategy.logging = (message: string) => {
    if (logger.isDebug()) {
        logger.debug(`Parser: ${message}`);
    } else if (!ambiguitiesReported) {
        ambiguitiesReported = true;
        logger.debug('Parser: Ambiguous Alternatives Detected. Enable bbj.debug to see details.');
    }
}
```

Do NOT change any other part of bbj-module.ts. Do NOT modify the `ambiguitiesReported` module-scope variable declaration. Do NOT change the parser.finalize() call or any service registrations.
  </action>
  <verify>
Run `npm test` from bbj-vscode/ directory. All 460+ tests must pass with zero regressions. The 11 pre-existing test failures must remain unchanged.

Run `npx tsc --noEmit` from bbj-vscode/ to verify TypeScript compilation succeeds.
  </verify>
  <done>
The ambiguity logging hook in bbj-module.ts passes through full Chevrotain messages when logger.isDebug() returns true, and shows a one-time summary when debug is off. All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Document bbj.debug setting in Docusaurus configuration page</name>
  <files>documentation/docs/user-guide/configuration.md</files>
  <action>
Add a new "Debug Logging" section to configuration.md. Insert it AFTER the "Core Settings" section (after the `bbj.classpath` entry, around line 41) and BEFORE the "Web/BUI Settings" section. This is a core setting, so it belongs with the other core settings.

Add the following section:

```markdown
#### `bbj.debug`

Enable verbose debug logging in the language server. When enabled, the Output panel shows detailed information about:
- Java class loading and resolution
- Classpath scanning details
- Parser ambiguity analysis
- Document validation timing

```json
{
  "bbj.debug": true
}
```

**Default**: `false`

To view debug output:
1. Set `bbj.debug` to `true` in VS Code settings
2. Open the Output panel (`View` > `Output`)
3. Select "BBj Language Server" from the dropdown
4. Debug messages appear with ISO 8601 timestamps

This setting takes effect immediately without restarting the language server.
```

Also update the "Complete Settings Example" section (around line 142) to include `bbj.debug`:

```json
{
  "bbj.debug": false,
  "bbj.home": "/opt/bbj",
  ...
}
```

Add `"bbj.debug": false` as the FIRST entry in the complete example (it's a core setting).

Also update the "Troubleshooting Configuration" section at the bottom. Replace the existing "Language Server Logs" subsection (lines 243-248) with a more specific version that references bbj.debug:

```markdown
### Language Server Logs

To diagnose issues with the language server:

1. Set `bbj.debug` to `true` in VS Code settings
2. Open the Output panel (`View` > `Output`)
3. Select "BBj Language Server" from the dropdown
4. Look for timestamped debug messages showing detailed diagnostics

Common debug output includes Java class resolution, parser warnings, and validation details. Set `bbj.debug` back to `false` when done to reduce output noise.
```

Do NOT change any other sections. Preserve all existing content, formatting, and frontmatter.
  </action>
  <verify>
Read the file and verify:
1. The `bbj.debug` section exists under Core Settings
2. The complete example includes `bbj.debug`
3. The troubleshooting section references `bbj.debug`
4. No existing content was removed or corrupted
  </verify>
  <done>
The configuration.md page documents the bbj.debug setting with usage instructions, the complete example includes it, and the troubleshooting section references it for diagnosing issues.
  </done>
</task>

</tasks>

<verification>
1. `39-INVESTIGATION.md` exists with specific grammar rule names and classifications (real vs safe-to-suppress)
2. `npm test` in bbj-vscode/ passes all 460+ tests with zero regressions
3. `npx tsc --noEmit` in bbj-vscode/ compiles without errors
4. bbj-module.ts contains `logger.isDebug()` check in the lookaheadStrategy.logging callback
5. bbj-module.ts contains `logger.debug(\`Parser: ${message}\`)` for verbose output
6. configuration.md contains a `bbj.debug` section with enable/disable instructions
7. configuration.md troubleshooting section references `bbj.debug` setting
</verification>

<success_criteria>
- Root cause of Chevrotain ambiguity warnings documented with specific grammar rules identified in 39-INVESTIGATION.md
- Each ambiguity classified as real issue or safe to suppress with rationale
- Parser ambiguity details available on-demand via bbj.debug flag (not shown by default)
- With bbj.debug=true, full Chevrotain messages identify specific grammar rules
- Debug logging setting documented in Docusaurus with clear instructions for enabling verbose output
- All existing tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/39-parser-diagnostics/39-01-SUMMARY.md`
</output>
