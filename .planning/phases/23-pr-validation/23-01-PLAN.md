---
phase: 23-pr-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/pr-validation.yml
  - .github/workflows/manual-release.yml
autonomous: true

must_haves:
  truths:
    - "PRs touching bbj-intellij/ trigger IntelliJ build validation"
    - "PRs touching shared dependencies (language server, tools, syntaxes) trigger IntelliJ validation"
    - "Plugin verifier runs on release builds to catch compatibility issues"
  artifacts:
    - path: ".github/workflows/pr-validation.yml"
      provides: "PR validation workflow for IntelliJ plugin"
      contains: "pull_request"
    - path: ".github/workflows/manual-release.yml"
      provides: "Release workflow with plugin verification"
      contains: "verifyPlugin"
  key_links:
    - from: ".github/workflows/pr-validation.yml"
      to: "bbj-intellij/"
      via: "paths filter triggers on changes"
      pattern: "paths:.*bbj-intellij"
    - from: ".github/workflows/pr-validation.yml"
      to: "bbj-vscode/out/language/"
      via: "artifact download from vscode build job"
      pattern: "download-artifact.*language-server"
    - from: ".github/workflows/manual-release.yml"
      to: "pluginVerifier()"
      via: "Gradle verifyPlugin task"
      pattern: "gradlew.*verifyPlugin"
---

<objective>
Add PR validation for IntelliJ plugin and plugin verification for release builds.

Purpose: Ensure IntelliJ plugin compatibility is validated before merging PRs and before releasing to users. Path-filtered PR validation catches build issues early; plugin verifier catches binary compatibility issues with target IDE versions.

Output: New pr-validation.yml workflow, updated manual-release.yml with verifyPlugin step
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-pr-validation/23-RESEARCH.md

# Prior patterns - relevant for workflow structure
@.github/workflows/preview.yml
@.github/workflows/manual-release.yml

# IntelliJ build configuration - has pluginVerifier() dependency
@bbj-intellij/build.gradle.kts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PR validation workflow with path filtering</name>
  <files>.github/workflows/pr-validation.yml</files>
  <action>
Create new workflow file `.github/workflows/pr-validation.yml` with:

1. **Trigger configuration:**
   - `on: pull_request` targeting `main` branch
   - `paths` filter including:
     - `bbj-intellij/**`
     - `bbj-vscode/out/language/**` (language server dependency)
     - `bbj-vscode/tools/**` (web.bbj runner)
     - `bbj-vscode/syntaxes/**` (TextMate bundles)
     - `.github/workflows/pr-validation.yml` (self)

2. **Job 1: build-vscode**
   - Same pattern as preview.yml publish-preview job, but WITHOUT:
     - Version bumping (PRs don't bump versions)
     - Committing changes
     - Publishing to marketplace
   - Steps: checkout, setup-node@v4 (node 20), npm ci, npm run build
   - Upload artifact: language-server (main.cjs)
   - Retention: 1 day (short-lived PR artifacts)

3. **Job 2: validate-intellij**
   - `needs: build-vscode`
   - Same pattern as preview.yml build-intellij job
   - Steps:
     - checkout
     - download-artifact (language-server to bbj-vscode/out/language/)
     - setup-java@v4 (temurin 17)
     - Build: `./gradlew buildPlugin` (no version flag needed - uses default 0.1.0)
   - NO artifact upload (validation only, not publishing)

**IMPORTANT:** Use actions/checkout@v4, setup-node@v4, setup-java@v4 (not v3).
**IMPORTANT:** Do NOT include verifyPlugin in PR validation - too slow for every PR. Keep it for release builds only.
  </action>
  <verify>
File exists and YAML is valid:
```bash
cat .github/workflows/pr-validation.yml
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/pr-validation.yml'))"
```
Verify contains expected elements:
- `pull_request:` trigger
- `paths:` with bbj-intellij/**
- Two jobs: build-vscode, validate-intellij
- `needs: build-vscode` on validate-intellij job
  </verify>
  <done>
PR validation workflow exists with path filtering for bbj-intellij/ and shared dependencies, two-job pattern matching existing workflows.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add plugin verification to release workflow</name>
  <files>.github/workflows/manual-release.yml</files>
  <action>
Modify `.github/workflows/manual-release.yml` to add verifyPlugin step in the build-intellij job:

1. **In build-intellij job**, after "Build IntelliJ plugin" step, add new step:
   ```yaml
   - name: Verify plugin compatibility
     working-directory: bbj-intellij
     env:
       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
     run: ./gradlew verifyPlugin
   ```

**CRITICAL:** Must set `GITHUB_TOKEN` env var to avoid API rate limiting when verifier resolves latest version.

**Positioning:** After buildPlugin, before "Rename plugin with version" step. This ensures we verify the built plugin before uploading.

The existing `pluginVerification { ides { recommended() } }` configuration in build.gradle.kts handles IDE version selection.

**Why release builds only (not PR validation):**
- verifyPlugin downloads multiple IDE versions (~1GB+ each)
- Takes 5-10+ minutes per run
- PR validation should be fast for developer iteration
- Release builds are infrequent and worth the verification time
  </action>
  <verify>
File contains verifyPlugin step with GITHUB_TOKEN:
```bash
grep -A3 "Verify plugin" .github/workflows/manual-release.yml
grep "GITHUB_TOKEN" .github/workflows/manual-release.yml
```
YAML remains valid:
```bash
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/manual-release.yml'))"
```
  </verify>
  <done>
Release workflow runs verifyPlugin after buildPlugin with GITHUB_TOKEN set, catches IDE compatibility issues before creating release.
  </done>
</task>

</tasks>

<verification>
1. Both workflow files are valid YAML
2. pr-validation.yml triggers on pull_request to main with correct path filters
3. pr-validation.yml has two jobs with artifact passing pattern
4. manual-release.yml has verifyPlugin step with GITHUB_TOKEN
5. Git status shows only expected files modified
</verification>

<success_criteria>
- [ ] `.github/workflows/pr-validation.yml` exists and is valid YAML
- [ ] PR workflow triggers on changes to bbj-intellij/, bbj-vscode/out/language/, bbj-vscode/tools/, bbj-vscode/syntaxes/
- [ ] PR workflow has two jobs (build-vscode, validate-intellij) with artifact passing
- [ ] Release workflow has verifyPlugin step after buildPlugin
- [ ] GITHUB_TOKEN env var set for verifyPlugin to avoid rate limiting
- [ ] All changes committed with atomic commits per task
</success_criteria>

<output>
After completion, create `.planning/phases/23-pr-validation/23-01-SUMMARY.md`
</output>
