---
phase: 57-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/Commands/Commands.cjs
  - bbj-vscode/package.json
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunDwcAction.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunBuiAction.java
  - bbj-intellij/src/main/resources/textmate/bbj-bundle/package.json
autonomous: true
requirements:
  - BUG-01
  - BUG-02

must_haves:
  truths:
    - "Setting bbj.classpath to '--' and running a DWC/BUI program launches successfully (classpath treated as empty)"
    - "Setting bbj.classpath to '--' and running a GUI program launches successfully (no -CP-- argument)"
    - "Opening a file named config.bbx shows plain text, not BBj syntax highlighting"
    - "Opening a file named config.min shows plain text, not BBj syntax highlighting"
    - "Opening a regular .bbx file (not named config.bbx) still shows BBj syntax highlighting"
  artifacts:
    - path: "bbj-vscode/src/Commands/Commands.cjs"
      provides: "'--' sentinel stripping in run and runWeb functions"
      contains: "stripSentinel"
    - path: "bbj-vscode/package.json"
      provides: "config.bbx excluded from bbj language association"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java"
      provides: "'--' sentinel stripping in getClasspathArg"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunDwcAction.java"
      provides: "'--' sentinel stripping in DWC classpath reading"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunBuiAction.java"
      provides: "'--' sentinel stripping in BUI classpath reading"
    - path: "bbj-intellij/src/main/resources/textmate/bbj-bundle/package.json"
      provides: "config.bbx excluded from BBj language in IntelliJ"
  key_links:
    - from: "bbj-vscode/src/Commands/Commands.cjs"
      to: "bbj.classpath setting"
      via: "vscode.workspace.getConfiguration read"
      pattern: "classpath.*--"
    - from: "bbj-intellij actions"
      to: "BbjSettings.classpathEntry"
      via: "getClasspathArg and direct state read"
      pattern: "classpathEntry.*--"
---

<objective>
Fix two configuration-layer bugs: (1) the EM Config "--" sentinel value causing DWC/BUI/GUI startup failures when passed as a classpath argument, and (2) config.bbx files incorrectly receiving BBj syntax highlighting instead of opening as plain text.

Purpose: Users with EM Config "--" sentinel in their classpath settings can run programs without failure, and config.bbx configuration files no longer get parsed as BBj source.
Output: Patched Commands.cjs, IntelliJ run actions, and updated file association manifests in both VS Code and IntelliJ.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bbj-vscode/src/Commands/Commands.cjs
@bbj-vscode/package.json
@bbj-vscode/tools/web.bbj
@bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunDwcAction.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunBuiAction.java
@bbj-intellij/src/main/resources/textmate/bbj-bundle/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Strip "--" sentinel from classpath in all run commands</name>
  <files>
    bbj-vscode/src/Commands/Commands.cjs
    bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunDwcAction.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunBuiAction.java
  </files>
  <action>
    BUG-01: The EM Config value "--" is a BBj convention meaning "not configured." When this appears as the `bbj.classpath` setting, it must be treated as empty (no classpath argument).

    **Commands.cjs (VS Code):**
    1. In the `runWeb()` function (around line 82): after reading `const sscp = vscode.workspace.getConfiguration("bbj").classpath;`, add a check: if `sscp` is `"--"`, treat it as empty string. The simplest approach: add a module-level helper `const stripSentinel = (v) => v === '--' ? '' : (v || '');` and use it wherever classpath is read.
    2. In the `run()` function (around line 215): after reading `var sscp = vscode.workspace.getConfiguration('bbj').classpath;`, apply the same strip. Currently `sscp` gets prefixed with `-CP` (line 222-226), and passing `-CP--` to bbj is invalid.
    3. Note: `web.bbj` line 69 already has `sscp! <> "--"` check, but the VS Code `run()` function does NOT use web.bbj — it directly builds the bbj command line. So both paths need the fix.

    **BbjRunActionBase.java (IntelliJ):**
    4. In `getClasspathArg()` (around line 209-214): after reading `String entry = state.classpathEntry;`, add a check: if `entry` equals `"--"`, treat it as null (return null). Add the check right after the null/empty check: `if ("--".equals(entry)) return null;`.

    **BbjRunDwcAction.java and BbjRunBuiAction.java (IntelliJ):**
    5. Both files read classpath at line 108: `String classpath = state.classpathEntry != null ? state.classpathEntry : "";`. Add "--" stripping: `String classpath = (state.classpathEntry != null && !"--".equals(state.classpathEntry)) ? state.classpathEntry : "";`.

    When "--" is stripped, the program launches as if no classpath was configured — silently, no warning, no failure. This matches the user decision: "When '--' is stripped, silently omit the entry and proceed with launch."
  </action>
  <verify>
    - Read Commands.cjs and confirm both `runWeb()` and `run()` strip "--" before use.
    - Read BbjRunActionBase.java and confirm `getClasspathArg()` returns null for "--".
    - Read BbjRunDwcAction.java and BbjRunBuiAction.java and confirm "--" is treated as empty.
    - Run `npm run build` in bbj-vscode/ to confirm no TypeScript/build errors.
  </verify>
  <done>
    The "--" sentinel value in bbj.classpath is silently treated as "not configured" across all run commands in both VS Code (Commands.cjs runWeb and run) and IntelliJ (BbjRunActionBase, BbjRunDwcAction, BbjRunBuiAction). No classpath argument is emitted when the value is "--".
  </done>
</task>

<task type="auto">
  <name>Task 2: Exclude config.bbx and config.min from BBj language association</name>
  <files>
    bbj-vscode/package.json
    bbj-intellij/src/main/resources/textmate/bbj-bundle/package.json
  </files>
  <action>
    BUG-02: config.bbx is a BBj Home configuration file (key=value format), NOT a BBj program. Files named exactly `config.bbx` or `config.min` must open as plain text without BBj syntax highlighting.

    Per user decision: "Exclude by filename only: any file named config.bbx or config.min is excluded from BBj language association regardless of directory."
    Per user decision: ".bbx extension otherwise remains a valid BBj program extension — only these specific filenames are excluded."

    **VS Code (bbj-vscode/package.json):**
    1. The `.bbx` extension is currently listed in `contributes.languages[0].extensions` array at line 34. Keep `.bbx` in the extensions list.
    2. Add a `configurationDefaults` section (if not present) or update the existing one in `contributes` to add file association exclusions. Use VS Code's `files.associations` to override for specific filenames:
       ```json
       "configurationDefaults": {
         "[bbj]": {},
         "files.associations": {
           "config.bbx": "plaintext",
           "config.min": "plaintext"
         }
       }
       ```
       This tells VS Code: files named exactly `config.bbx` or `config.min` should be associated with plaintext, overriding the `.bbx` extension match.
    3. If a `configurationDefaults` section already exists, merge into it.

    **IntelliJ (bbj-intellij/src/main/resources/textmate/bbj-bundle/package.json):**
    4. The `.bbx` extension is in the extensions array at line 7. Keep `.bbx` in the extensions list (same rationale: other .bbx files are valid BBj programs).
    5. IntelliJ's TextMate bundle format does not support filename-level exclusions the same way VS Code does. The IntelliJ TextMate bundle `package.json` is limited to extensions, so the exclusion may need to be handled differently. Check if the `languages` array supports `filenames` or `filenamePatterns` for exclusion. If not, add a comment noting the limitation and skip IntelliJ-specific exclusion for now — IntelliJ users can manually override file type associations in Settings > Editor > File Types.

    IMPORTANT: Do NOT remove `.bbx` from the extensions lists. Only config.bbx and config.min are excluded.
  </action>
  <verify>
    - Read bbj-vscode/package.json and confirm `configurationDefaults` contains `files.associations` mapping `config.bbx` and `config.min` to `plaintext`.
    - Confirm `.bbx` remains in `contributes.languages[0].extensions`.
    - Run `npm run build` in bbj-vscode/ to verify no errors.
  </verify>
  <done>
    Files named config.bbx and config.min open as plain text in VS Code (via configurationDefaults file associations). The .bbx extension otherwise remains associated with BBj language. IntelliJ handles config.bbx exclusion if the bundle format supports it, or documents the limitation.
  </done>
</task>

</tasks>

<verification>
1. In Commands.cjs, the `runWeb()` and `run()` functions handle `"--"` classpath by treating it as empty — no `-CP--` or `"--"` passed to bbj executable.
2. In IntelliJ run actions, `"--"` classpath is treated as null/empty — no classpath argument emitted.
3. In VS Code package.json, config.bbx and config.min are mapped to plaintext via configurationDefaults.
4. The .bbx extension remains a valid BBj extension for non-config files.
5. `npm run build` in bbj-vscode/ succeeds without errors.
</verification>

<success_criteria>
- The "--" sentinel is silently stripped in all six classpath-reading code paths (2 VS Code + 4 IntelliJ)
- config.bbx files open as plain text in VS Code
- Non-config .bbx files still get BBj highlighting
- Build passes in both VS Code and IntelliJ projects
</success_criteria>

<output>
After completion, create `.planning/phases/57-bug-fixes/57-01-SUMMARY.md`
</output>
