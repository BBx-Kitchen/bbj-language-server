---
phase: 57-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/language/bbj-token-builder.ts
  - bbj-vscode/src/language/bbj.langium
  - bbj-vscode/src/language/generated/ast.ts
  - bbj-vscode/src/language/generated/grammar.ts
  - bbj-vscode/src/language/generated/module.ts
  - bbj-vscode/src/language/bbj-validator.ts
  - bbj-vscode/test/parser.test.ts
autonomous: true
requirements:
  - BUG-03
  - BUG-04

must_haves:
  truths:
    - "releaseVersion! parses as a single identifier token without error"
    - "releaseDate (unsuffixed, keyword-prefixed) parses as a single identifier without error"
    - "release! parses as a single identifier token without error"
    - "stepMode! and other keyword-prefixed suffixed identifiers parse without error"
    - "DECLARE in a class body (outside methods) produces a diagnostic error, not a parser crash"
    - "The parser recovers after misplaced DECLARE and continues parsing subsequent class members"
  artifacts:
    - path: "bbj-vscode/src/language/bbj-token-builder.ts"
      provides: "RELEASE_NL and RELEASE_NO_NL LONGER_ALT includes idWithSuffix"
      contains: "idWithSuffix"
    - path: "bbj-vscode/src/language/bbj.langium"
      provides: "ClassMember accepts VariableDecl as recoverable alternative"
      contains: "VariableDecl"
    - path: "bbj-vscode/src/language/bbj-validator.ts"
      provides: "Validation check for DECLARE at class member level"
      contains: "checkDeclareNotInClassBody"
    - path: "bbj-vscode/test/parser.test.ts"
      provides: "Test cases for suffixed identifiers and DECLARE in class body"
      contains: "releaseVersion"
  key_links:
    - from: "bbj-vscode/src/language/bbj-token-builder.ts"
      to: "Chevrotain LONGER_ALT"
      via: "RELEASE_NL/RELEASE_NO_NL LONGER_ALT = [idWithSuffix, id]"
      pattern: "releaseNl.*LONGER_ALT.*idWithSuffix"
    - from: "bbj-vscode/src/language/bbj.langium ClassMember"
      to: "bbj-vscode/src/language/bbj-validator.ts"
      via: "Grammar accepts VariableDecl, validator rejects it with diagnostic"
      pattern: "checkDeclareNotInClassBody"
---

<objective>
Fix two parser-level bugs: (1) RELEASE-prefixed suffixed identifiers (like `releaseVersion!`) incorrectly parsed as RELEASE keyword + orphaned tokens, and (2) DECLARE statement in class body crashing the parser instead of producing a recoverable diagnostic.

Purpose: Valid BBj programs using keyword-prefixed identifiers parse cleanly, and misplaced DECLARE statements produce a helpful error instead of breaking the parse tree.
Output: Patched token builder, grammar, validator, and regression tests.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bbj-vscode/src/language/bbj-token-builder.ts
@bbj-vscode/src/language/bbj.langium
@bbj-vscode/src/language/bbj-validator.ts
@bbj-vscode/test/parser.test.ts
@bbj-vscode/test/lexer.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix RELEASE token LONGER_ALT and add DECLARE recovery in grammar</name>
  <files>
    bbj-vscode/src/language/bbj-token-builder.ts
    bbj-vscode/src/language/bbj.langium
    bbj-vscode/src/language/generated/ast.ts
    bbj-vscode/src/language/generated/grammar.ts
    bbj-vscode/src/language/generated/module.ts
    bbj-vscode/src/language/bbj-validator.ts
  </files>
  <action>
    **BUG-03: Fix RELEASE_NL and RELEASE_NO_NL LONGER_ALT**

    Root cause: In `bbj-token-builder.ts` lines 52-57, the RELEASE_NL and RELEASE_NO_NL tokens have `LONGER_ALT = id` but are missing `idWithSuffix`. The general keyword loop (lines 39-49) correctly sets `LONGER_ALT = [idWithSuffix, id]` for all standard keywords, but RELEASE tokens are handled separately (lines 52-57) and only set `LONGER_ALT = id`.

    When the lexer encounters `releaseVersion!`, the RELEASE_NL/RELEASE_NO_NL pattern matches the "RELEASE" prefix. Chevrotain checks LONGER_ALT: since only `id` is listed (not `idWithSuffix`), it falls through to ID which matches `releaseVersion` but NOT the `!` suffix. The `!` becomes an orphaned token causing a parse error.

    Fix in `bbj-token-builder.ts`:
    1. Change line 56 from `releaseNl.LONGER_ALT = id;` to `releaseNl.LONGER_ALT = [idWithSuffix, id];`
    2. Change line 57 from `releaseNoNl.LONGER_ALT = id;` to `releaseNoNl.LONGER_ALT = [idWithSuffix, id];`

    This ensures `releaseVersion!` matches ID_WITH_SUFFIX (longest match), `releaseVersion` matches ID, and bare `RELEASE` still matches the RELEASE tokens.

    **BUG-04: Add DECLARE recovery in class body grammar + validation**

    Root cause: The `ClassMember` grammar rule at line 346-348 only accepts `FieldDecl | MethodDecl`. When DECLARE appears at the class member level, the parser has no matching alternative and crashes/fails to recover.

    Grammar fix in `bbj.langium`:
    1. Extend the `ClassMember` rule to include `VariableDecl` as an alternative:
       ```
       ClassMember returns ClassMember:
           FieldDecl | MethodDecl | VariableDecl
       ;
       ```
    2. Update the `type BBjClassMember` union at line 1026 to include `VariableDecl`:
       ```
       type BBjClassMember = FieldDecl | MethodDecl | VariableDecl
       ```
    3. After editing grammar, run `npm run langium:generate` in bbj-vscode/ to regenerate `generated/ast.ts`, `generated/grammar.ts`, and `generated/module.ts`.

    Validation fix in `bbj-validator.ts`:
    4. Add a new validation check method to `BBjValidator` class:
       ```typescript
       checkDeclareNotInClassBody(node: VariableDecl, accept: ValidationAcceptor): void {
           if (node.$container?.$type === 'BbjClass' && node.$containerProperty === 'members') {
               accept('error', 'DECLARE is not valid at class member level. Use FIELD for class-level declarations, or move DECLARE inside a method body.', {
                   node
               });
           }
       }
       ```
    5. Register the check in `registerValidationChecks()`: add `VariableDecl: validator.checkDeclareNotInClassBody` to the checks object. Import `VariableDecl` and `isVariableDecl` if not already imported from generated/ast.
    6. The parser now gracefully accepts DECLARE in class body (no crash), but the validator emits a clear error diagnostic telling the user DECLARE is not valid there.

    IMPORTANT: After editing `bbj.langium`, you MUST run `npm run langium:generate` before building. Then run `npm run build` to verify no compile errors.
  </action>
  <verify>
    - Run `cd /Users/beff/_workspace/bbj-language-server/bbj-vscode && npm run langium:generate` and confirm it succeeds.
    - Run `cd /Users/beff/_workspace/bbj-language-server/bbj-vscode && npm run build` and confirm it succeeds.
    - Read bbj-token-builder.ts and confirm both RELEASE_NL and RELEASE_NO_NL have `LONGER_ALT = [idWithSuffix, id]`.
    - Read bbj.langium and confirm ClassMember includes VariableDecl.
    - Read bbj-validator.ts and confirm checkDeclareNotInClassBody is registered and implemented.
  </verify>
  <done>
    RELEASE_NL and RELEASE_NO_NL tokens include idWithSuffix in LONGER_ALT array. ClassMember grammar rule accepts VariableDecl. Validation check emits "DECLARE is not valid at class member level" error when DECLARE appears between methods in a class body. Grammar regenerated and build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add regression tests for suffixed identifiers and DECLARE in class body</name>
  <files>
    bbj-vscode/test/parser.test.ts
  </files>
  <action>
    Add tests to parser.test.ts to cover both BUG-03 and BUG-04. Use the existing test patterns: `parse()` helper, `expectNoParserLexerErrors()`, and direct diagnostic checks.

    **BUG-03 regression tests — suffixed identifiers with keyword prefixes:**

    1. Add test: "Keyword-prefixed suffixed identifiers parse without error"
       ```typescript
       test('Keyword-prefixed suffixed identifiers parse without error', async () => {
           const document = await parse(`
               releaseVersion! = "1.0"
               stepMode! = 0
               release! = null()
               releaseDate = "2024-01-01"
           `, { validation: false });
           expectNoParserLexerErrors(document);
       });
       ```
       This tests: `releaseVersion!` (RELEASE prefix + suffix), `stepMode!` (STEP prefix + suffix), `release!` (exact keyword + suffix), `releaseDate` (keyword prefix, no suffix). All should parse cleanly as identifiers.

    2. Add test: "Bare RELEASE keyword still works as statement"
       ```typescript
       test('Bare RELEASE keyword still works as statement', async () => {
           const document = await parse(`
               RELEASE
           `, { validation: false });
           expectNoParserLexerErrors(document);
       });
       ```
       Ensures the RELEASE keyword still functions when used as a standalone statement (non-regression).

    **BUG-04 regression tests — DECLARE in class body:**

    3. Add test: "DECLARE in class body produces validation error, not parser crash"
       ```typescript
       test('DECLARE in class body produces validation error, not parser crash', async () => {
           const document = await parse(`
               CLASS PUBLIC MyClass
                   DECLARE AUTO BBjString name!
                   METHOD PUBLIC void doSomething()
                   METHODEND
               CLASSEND
           `, { validation: true });
           // Parser should NOT crash — no lexer/parser errors
           expectNoParserLexerErrors(document);
           // Validator should report an error about DECLARE at class member level
           expect(document.diagnostics?.length).toBeGreaterThan(0);
           expect(document.diagnostics?.some(d => d.message.toLowerCase().includes('declare'))).toBeTruthy();
       });
       ```

    4. Add test: "DECLARE inside method body is valid"
       ```typescript
       test('DECLARE inside method body is valid', async () => {
           const document = await parse(`
               CLASS PUBLIC MyClass
                   METHOD PUBLIC void doSomething()
                       DECLARE AUTO BBjString name!
                   METHODEND
               CLASSEND
           `, { validation: false });
           expectNoParserLexerErrors(document);
       });
       ```
       Non-regression: DECLARE inside a method body should still be perfectly valid.

    Place all new tests in the existing `describe('Parser Tests', ...)` block.
  </action>
  <verify>
    - Run `cd /Users/beff/_workspace/bbj-language-server/bbj-vscode && npx vitest run test/parser.test.ts` and confirm ALL tests pass including the new ones.
    - Run `cd /Users/beff/_workspace/bbj-language-server/bbj-vscode && npx vitest run` to confirm no regressions across the full test suite.
  </verify>
  <done>
    Four new tests added to parser.test.ts: (1) keyword-prefixed suffixed identifiers parse without error, (2) bare RELEASE still works, (3) DECLARE in class body produces validation error not crash, (4) DECLARE inside method body remains valid. All tests pass, no regressions.
  </done>
</task>

</tasks>

<verification>
1. `releaseVersion!`, `release!`, `releaseDate`, `stepMode!` all parse without lexer/parser errors.
2. Bare `RELEASE` statement still works as a keyword.
3. DECLARE in class body at member level produces a validation diagnostic error (red squiggly with message), not a parser crash.
4. DECLARE inside method body remains valid (no error).
5. Parser recovers after misplaced DECLARE and continues parsing subsequent class members (MethodDecl after DECLARE still parsed).
6. `npm run langium:generate` succeeds.
7. `npm run build` succeeds.
8. Full test suite passes with no regressions.
</verification>

<success_criteria>
- RELEASE_NL and RELEASE_NO_NL tokens have LONGER_ALT = [idWithSuffix, id]
- ClassMember grammar rule includes VariableDecl alternative
- Validation check emits error for DECLARE at class member level
- All four regression tests pass
- Full test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/57-bug-fixes/57-02-SUMMARY.md`
</output>
