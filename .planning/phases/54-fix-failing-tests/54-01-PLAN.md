---
phase: 54-fix-failing-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/test/classes.test.ts
  - bbj-vscode/test/validation.test.ts
autonomous: true
requirements:
  - TEST-01
  - TEST-02
  - TEST-05
  - TEST-06

must_haves:
  truths:
    - "classes.test.ts private class error assertion passes with the (declared in ...) format"
    - "classes.test.ts protected class error assertion passes with the (declared in ...) format"
    - "validation.test.ts instance member access level test passes with (in ...) error format"
    - "validation.test.ts static member access level test passes with (in ...) error format"
  artifacts:
    - path: "bbj-vscode/test/classes.test.ts"
      provides: "Updated assertions using toContain() for class access-level error messages"
    - path: "bbj-vscode/test/validation.test.ts"
      provides: "Updated expectError calls using RegExp for member access-level error messages"
  key_links:
    - from: "bbj-vscode/test/classes.test.ts"
      to: "bbj-vscode/src/language/validations/check-classes.ts"
      via: "Error message format must match between source and test assertion"
      pattern: "declared in.*is not visible"
    - from: "bbj-vscode/test/validation.test.ts"
      to: "bbj-vscode/src/language/bbj-validator.ts"
      via: "Error message format must match between source and test assertion"
      pattern: "from the type.*is not visible"
---

<objective>
Update stale test assertions in classes.test.ts and validation.test.ts to match the current error message format that includes source location info (e.g., `(declared in filename:line)`).

Purpose: Four tests fail because error messages were enhanced with source location info but test assertions still use the old exact-match format. No source code changes needed — only test expectations.

Output: 4 previously failing tests (TEST-01, TEST-02, TEST-05, TEST-06) pass green.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-fix-failing-tests/54-CONTEXT.md
@bbj-vscode/test/classes.test.ts
@bbj-vscode/test/validation.test.ts
@bbj-vscode/src/language/validations/check-classes.ts
@bbj-vscode/src/language/bbj-validator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix class access-level error message assertions (TEST-01, TEST-02)</name>
  <files>bbj-vscode/test/classes.test.ts</files>
  <action>
In `classes.test.ts`, two tests fail because the validator now emits messages like:
- `Private class 'A' (declared in 2.bbj:2) is not visible from this file.`
- `Protected class 'A' (declared in test1.bbj:2) is not visible from this directory.`

But the assertions use `.toBe()` exact match against the old format without `(declared in ...)`.

Per user decision: use **substring matching** (contains) so tests survive future message enhancements.

Update the "Cannot access private class from different file" test (lines 53-54):
- Change `expect(diagnostics[0].message).toBe("Private class 'A' is not visible from this file.")` to `expect(diagnostics[0].message).toContain("Private class 'A'")`
- Change `expect(diagnostics[1].message).toBe("Private class 'A' is not visible from this file.")` to `expect(diagnostics[1].message).toContain("is not visible from this file")`

This pattern: first assertion checks the class name is mentioned, second checks the visibility message fragment. Both assertions together ensure the right error without being fragile to format changes.

Update the "Cannot access protected class from different non-related folder file" test (lines 81-82):
- Change `expect(diagnostics[0].message).toBe("Protected class 'A' is not visible from this directory.")` to `expect(diagnostics[0].message).toContain("Protected class 'A'")`
- Change `expect(diagnostics[1].message).toBe("Protected class 'A' is not visible from this directory.")` to `expect(diagnostics[1].message).toContain("is not visible from this directory")`
  </action>
  <verify>Run `cd bbj-vscode && npx vitest run test/classes.test.ts` — both "Cannot access private class from different file" and "Cannot access protected class from different non-related folder file" pass.</verify>
  <done>TEST-01 and TEST-02 pass. The 2 class access-level tests in classes.test.ts are green using substring matching.</done>
</task>

<task type="auto">
  <name>Task 2: Fix member access-level error message assertions (TEST-05, TEST-06)</name>
  <files>bbj-vscode/test/validation.test.ts</files>
  <action>
In `validation.test.ts`, two tests fail:
- "Call instance members with different access levels" (lines 263-324)
- "Call static members with different access levels" (lines 326-386)

Both tests use `expectError(validationResult, "The member 'X' from the type 'Y' is not visible", ...)`. Langium's `expectError` does **exact string match** (`d.message === options.message`). The validator now emits messages like `"The member 'doPrivately' from the type 'Test' (in 17.bbj:11) is not visible"` — the `(in ...)` suffix causes the exact match to fail, and `expectError` reports "Found no issues" because no diagnostic matches the filter.

Fix: Change all 12 `expectError` calls (6 per test) from string to **RegExp** matching. Langium's `expectError` supports RegExp — when a RegExp is passed, it uses `regexp.test(d.message)` instead of exact match.

For the "Call instance members" test, update each `expectError` call:
```typescript
// Before:
expectError(validationResult, "The member 'doPrivately' from the type 'Test' is not visible", { ... });
// After:
expectError(validationResult, /The member 'doPrivately' from the type 'Test'.*is not visible/, { ... });
```

Apply the same pattern to all 6 `expectError` calls in "Call instance members" test (lines 300-323):
1. `"The member 'doPrivately' from the type 'Test' is not visible"` → `/The member 'doPrivately' from the type 'Test'.*is not visible/`
2. `"The member 'fieldPrivate' from the type 'Test' is not visible"` → `/The member 'fieldPrivate' from the type 'Test'.*is not visible/`
3. `"The member 'doPrivately' from the type 'Test' is not visible"` → `/The member 'doPrivately' from the type 'Test'.*is not visible/`
4. `"The member 'doProtected' from the type 'Test' is not visible"` → `/The member 'doProtected' from the type 'Test'.*is not visible/`
5. `"The member 'fieldPrivate' from the type 'Test' is not visible"` → `/The member 'fieldPrivate' from the type 'Test'.*is not visible/`
6. `"The member 'fieldProtected' from the type 'Test' is not visible"` → `/The member 'fieldProtected' from the type 'Test'.*is not visible/`

Apply the same 6 RegExp changes to the "Call static members" test (lines 362-385).

Total: 12 `expectError` calls changed from string to RegExp.
  </action>
  <verify>Run `cd bbj-vscode && npx vitest run test/validation.test.ts` — both "Call instance members with different access levels" and "Call static members with different access levels" pass.</verify>
  <done>TEST-05 and TEST-06 pass. All 12 member access-level assertions in validation.test.ts use RegExp matching and are green.</done>
</task>

</tasks>

<verification>
Run the full test suite: `cd bbj-vscode && npm test`

Confirm:
1. classes.test.ts: "Cannot access private class from different file" passes
2. classes.test.ts: "Cannot access protected class from different non-related folder file" passes
3. validation.test.ts: "Call instance members with different access levels" passes
4. validation.test.ts: "Call static members with different access levels" passes
5. No regressions in other tests
</verification>

<success_criteria>
- TEST-01, TEST-02, TEST-05, TEST-06 all pass
- No other tests regressed
- Assertions use substring/RegExp matching per user decision (resilient to future message format changes)
</success_criteria>

<output>
After completion, create `.planning/phases/54-fix-failing-tests/54-01-SUMMARY.md`
</output>
