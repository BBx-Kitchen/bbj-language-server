---
phase: 06-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-intellij/build.gradle.kts
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
  - bbj-intellij/src/main/resources/META-INF/description.html
  - bbj-intellij/src/main/resources/META-INF/pluginIcon.svg
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjWelcomeNotification.java
autonomous: true

must_haves:
  truths:
    - "buildPlugin produces a ZIP in build/distributions/ containing language server and TextMate grammars"
    - "Plugin ZIP has correct directory structure: lib/*.jar + lib/language-server/main.cjs + lib/textmate/"
    - "plugin.xml vendor is 'BASIS International Ltd.' with correct email and url"
    - "First launch shows welcome notification with link to settings"
  artifacts:
    - path: "bbj-intellij/build.gradle.kts"
      provides: "Marketplace-ready build config with pluginConfiguration, prepareSandbox copy tasks"
    - path: "bbj-intellij/src/main/resources/META-INF/description.html"
      provides: "Plugin marketplace description"
    - path: "bbj-intellij/src/main/resources/META-INF/pluginIcon.svg"
      provides: "Plugin icon for marketplace and Plugins dialog"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjWelcomeNotification.java"
      provides: "First-launch welcome balloon"
  key_links:
    - from: "build.gradle.kts prepareSandbox"
      to: "bbj-vscode/out/language/main.cjs"
      via: "Copy task into lib/language-server/"
      pattern: "prepareSandbox.*language-server.*main\\.cjs"
    - from: "BbjWelcomeNotification"
      to: "BbjSettingsConfigurable"
      via: "NotificationAction opens settings"
      pattern: "ShowSettingsUtil.*BbjSettingsConfigurable"
---

<objective>
Configure the Gradle build for marketplace-ready plugin packaging, ensure the plugin ZIP has correct directory structure with bundled language server, add marketplace metadata (vendor, description, icon), and implement a welcome notification on first launch.

Purpose: Transform the development-mode build into a distributable plugin ZIP that can be installed from disk on any IntelliJ instance and is structured for future JetBrains Marketplace publishing.
Output: A buildPlugin task that produces a correctly structured ZIP, marketplace metadata files, and a welcome notification class.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bbj-intellij/build.gradle.kts
@bbj-intellij/settings.gradle.kts
@bbj-intellij/src/main/resources/META-INF/plugin.xml
@bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServer.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update build.gradle.kts for marketplace-ready packaging</name>
  <files>bbj-intellij/build.gradle.kts</files>
  <action>
Update build.gradle.kts to produce a correctly structured plugin ZIP:

1. Add `pluginConfiguration` block inside `intellijPlatform {}` with:
   - `name = "BBj Language Support"`
   - `version = project.version.toString()`
   - `vendor { name = "BASIS International Ltd."; email = "support@basis.cloud"; url = "https://basis.cloud" }`
   - `description = file("src/main/resources/META-INF/description.html").readText()`
   - `ideaVersion { sinceBuild = "242"; untilBuild = "243.*" }`

2. Add a `prepareSandbox` task extension to copy language server and TextMate bundles into the correct plugin directory structure. The standard `processResources`-based copy tasks put files into the JAR. For the installed plugin, language server must be at `lib/language-server/main.cjs` relative to the plugin root (since BbjLanguageServer.resolveServerPath() looks at `plugin.getPluginPath().resolve("lib").resolve("language-server").resolve("main.cjs")`). Add:

```kotlin
tasks.named<PrepareSandboxTask>("prepareSandbox") {
    from("${projectDir}/../bbj-vscode/out/language/") {
        include("main.cjs")
        into("${pluginName.get()}/lib/language-server")
    }
    from(layout.buildDirectory.dir("resources/main/textmate")) {
        into("${pluginName.get()}/lib/textmate")
    }
}
```

Import `org.jetbrains.intellij.platform.gradle.tasks.PrepareSandboxTask` at the top.

3. Remove the existing `patchPluginXml {}` block (now redundant — sinceBuild/untilBuild are in pluginConfiguration.ideaVersion).

4. Keep the existing `copyTextMateBundle` and `copyLanguageServer` tasks (they still populate build/resources/main/ for the JAR, which is needed for the classloader fallback in development mode).

5. Do NOT add changelog plugin — keep it simple. Change notes can be hardcoded in pluginConfiguration for now or left empty.

NOTE: The `buildSearchableOptions` task should remain enabled because this plugin HAS settings (Settings > Languages & Frameworks > BBj).
  </action>
  <verify>
Run `cd bbj-intellij && ./gradlew buildPlugin` and verify:
- ZIP created at `build/distributions/bbj-intellij-0.1.0-alpha.zip`
- Unzip and verify structure contains `bbj-intellij/lib/language-server/main.cjs`
- Unzip and verify structure contains `bbj-intellij/lib/textmate/bbj-bundle/`
  </verify>
  <done>
buildPlugin produces ZIP with language server at lib/language-server/main.cjs and TextMate grammars at lib/textmate/bbj-bundle/. Plugin metadata includes vendor "BASIS International Ltd." and description from description.html.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add marketplace metadata files and update plugin.xml</name>
  <files>
    bbj-intellij/src/main/resources/META-INF/description.html
    bbj-intellij/src/main/resources/META-INF/pluginIcon.svg
    bbj-intellij/src/main/resources/META-INF/plugin.xml
  </files>
  <action>
1. Create `description.html` with a brief HTML description for the marketplace:
   - What the plugin does (BBj language support for IntelliJ)
   - Key features: syntax highlighting, diagnostics, code completion, go-to-definition, hover docs, signature help, Java interop
   - Requirements: Node.js 18+, BBj installation (for full features)
   - Keep it concise — 10-15 lines of HTML, no complex formatting
   - Use `<p>`, `<ul>`, `<li>` tags only (marketplace renderer is limited)

2. Create `pluginIcon.svg` — this is the plugin icon shown in the JetBrains Plugins dialog (NOT the file type icon). Must be 40x40 px. Create a simple SVG with the text "BBj" in a rounded square, using the same blue (#4A90D9) as the existing file icon. This is a NEW file, separate from the existing /icons/bbj.svg (which is the 16x16 file type icon).

3. Update `plugin.xml`:
   - Change vendor from `BASIS International` to `BASIS International Ltd.`
   - Remove the `<version>0.1.0</version>` element (version is now managed by Gradle's pluginConfiguration)
   - Remove `<idea-version since-build="242"/>` (now managed by Gradle's pluginConfiguration)
   - Remove the inline `<description>` block (now loaded from description.html by Gradle)
   - Keep all extension registrations unchanged

4. Register a `postStartupActivity` in plugin.xml for the welcome notification (implemented in Task 3):
   ```xml
   <postStartupActivity implementation="com.basis.bbj.intellij.BbjWelcomeNotification"/>
   ```
  </action>
  <verify>
Confirm files exist:
- `src/main/resources/META-INF/description.html` (non-empty HTML)
- `src/main/resources/META-INF/pluginIcon.svg` (valid SVG, 40x40)
- `plugin.xml` has vendor "BASIS International Ltd." and no inline version/description/idea-version
- `plugin.xml` has postStartupActivity registration
  </verify>
  <done>
Marketplace metadata files created. plugin.xml cleaned up to let Gradle manage version, description, and build range. Welcome notification registered as startup activity.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement first-launch welcome notification</name>
  <files>bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjWelcomeNotification.java</files>
  <action>
Create `BbjWelcomeNotification.java` implementing `StartupActivity` and `DumbAware`:

1. In `runActivity(Project project)`:
   - Use `PropertiesComponent.getInstance()` to check key `"com.basis.bbj.intellij.welcomeShown"`
   - If already shown (boolean true), return immediately
   - Create a `Notification` using group ID `"BBj Language Server"` (already registered in plugin.xml):
     - Title: "BBj Language Support Installed"
     - Content: "Configure your BBj Home path and Node.js to enable all language features."
     - Type: `NotificationType.INFORMATION`
   - Add action: "Open Settings" — opens BbjSettingsConfigurable via `ShowSettingsUtil.getInstance().showSettingsDialog(project, BbjSettingsConfigurable.class)`
   - Add action: "Dismiss" — expires the notification
   - Call `Notifications.Bus.notify(notification, project)`
   - Mark `"com.basis.bbj.intellij.welcomeShown"` as true via `PropertiesComponent.getInstance().setValue()`

This ensures the balloon shows exactly once per IDE installation and provides a direct path to configuration.

Required imports:
- `com.intellij.ide.util.PropertiesComponent`
- `com.intellij.notification.*`
- `com.intellij.openapi.actionSystem.AnActionEvent`
- `com.intellij.openapi.options.ShowSettingsUtil`
- `com.intellij.openapi.project.DumbAware`
- `com.intellij.openapi.startup.StartupActivity`
  </action>
  <verify>
Run `./gradlew buildPlugin` — compiles without errors. Verify the class file is included in the output JAR.
  </verify>
  <done>
Welcome notification appears on first launch with "Open Settings" action. Subsequent launches skip the notification.
  </done>
</task>

</tasks>

<verification>
1. `cd bbj-intellij && ./gradlew clean buildPlugin` succeeds
2. ZIP at `build/distributions/bbj-intellij-0.1.0-alpha.zip` exists
3. Unzipped structure contains:
   - `bbj-intellij/lib/bbj-intellij-0.1.0-alpha.jar`
   - `bbj-intellij/lib/language-server/main.cjs`
   - `bbj-intellij/lib/textmate/bbj-bundle/` (with grammar files)
4. JAR contains `META-INF/plugin.xml` with vendor "BASIS International Ltd."
5. JAR contains `META-INF/description.html`
6. JAR contains `META-INF/pluginIcon.svg`
</verification>

<success_criteria>
- buildPlugin produces distributable ZIP with correct directory structure
- Language server (main.cjs) is at lib/language-server/ inside plugin ZIP
- TextMate grammars are at lib/textmate/bbj-bundle/ inside plugin ZIP
- Plugin metadata is marketplace-ready (vendor, description, icon)
- Welcome notification class compiles and is registered
</success_criteria>

<output>
After completion, create `.planning/phases/06-distribution/06-01-SUMMARY.md`
</output>
