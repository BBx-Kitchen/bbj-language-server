---
phase: 06-distribution
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDownloader.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServer.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjMissingNodeNotificationProvider.java
autonomous: true

must_haves:
  truths:
    - "If system Node.js is missing or too old, plugin downloads Node.js automatically in background"
    - "Downloaded Node.js is stored in plugin data directory and reused across IDE restarts"
    - "User can browse code while Node.js downloads (non-blocking)"
    - "Language server starts using downloaded Node.js when system Node.js is unavailable"
    - "Platform detection works for macOS (x64/ARM), Windows (x64), Linux (x64)"
  artifacts:
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDownloader.java"
      provides: "Platform detection, Node.js download, extraction, caching"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServer.java"
      provides: "Updated resolveNodePath() with download fallback"
  key_links:
    - from: "BbjLanguageServer.resolveNodePath()"
      to: "BbjNodeDownloader"
      via: "Calls getOrDownloadNode() when settings and auto-detect both fail"
      pattern: "BbjNodeDownloader\\.getOrDownloadNode"
    - from: "BbjNodeDownloader"
      to: "https://nodejs.org/dist/"
      via: "HTTP download of platform-specific Node.js archive"
      pattern: "nodejs\\.org/dist"
---

<objective>
Implement on-demand Node.js download so the plugin works even when Node.js is not installed on the user's system. Downloads the correct platform-specific Node.js binary in the background, stores it in the plugin's data directory, and integrates it into the language server startup chain.

Purpose: Remove the hard dependency on pre-installed Node.js — the plugin should work out-of-the-box on any system by downloading Node.js if needed.
Output: BbjNodeDownloader class and updated BbjLanguageServer with download fallback.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDetector.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServer.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjMissingNodeNotificationProvider.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BbjNodeDownloader with platform detection and download</name>
  <files>bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDownloader.java</files>
  <action>
Create `BbjNodeDownloader.java` — a utility class that detects the runtime platform, downloads the appropriate Node.js binary, extracts it, and caches it in the plugin data directory.

**Constants:**
- `NODE_VERSION = "v20.18.1"` (latest LTS at time of development)
- `DOWNLOAD_BASE_URL = "https://nodejs.org/dist/"`

**Public methods:**

1. `public static @Nullable Path getOrDownloadNode(@NotNull Project project)`:
   - Check cached node binary first (`getCachedNodePath()`). If exists and executable, return it.
   - If not cached, trigger background download via `ProgressManager.getInstance().run(new Task.Backgroundable(project, "Downloading Node.js...", true) {...})`
   - Inside the background task:
     a. Determine platform and architecture using `com.intellij.openapi.util.SystemInfo`
     b. Construct download URL (see below)
     c. Download archive to temp file using `HttpRequests.request(url).saveToFile(tempFile, indicator)`
     d. Extract the `node` (or `node.exe`) binary from the archive
     e. Store in plugin data directory
     f. Show balloon notification: "Node.js downloaded successfully"
   - Return null immediately if download not yet complete (caller should handle this gracefully). The LS will fail to start initially but will succeed on next file open after download completes.

   ALTERNATIVE (simpler, synchronous-with-progress approach): Since BbjLanguageServer constructor needs the path synchronously, use `ProgressManager.getInstance().runProcessWithProgressSynchronously()` with a cancelable progress dialog. This blocks the LS startup but keeps the IDE responsive. The user sees "Downloading Node.js..." with a progress bar. This is acceptable because it only happens once (first use), and the LS can't start without Node.js anyway.

   Actually, the BEST approach: make `getOrDownloadNode()` return null if not cached. In `BbjLanguageServer.resolveNodePath()`, if all methods fail (settings, detect, download cache), throw RuntimeException. Separately, provide a method `downloadNodeAsync(Project project)` that downloads in background and when done, triggers a notification. The `BbjMissingNodeNotificationProvider` banner can add a "Download Node.js" action button. This keeps the architecture clean — no blocking, no synchronous download in the LS constructor.

   GO WITH: The async approach. Two methods:
   - `@Nullable Path getCachedNodePath()` — returns cached node binary path or null (synchronous, fast)
   - `void downloadNodeAsync(@NotNull Project project, @Nullable Runnable onComplete)` — background download with progress, calls onComplete on EDT when done

2. `@Nullable Path getCachedNodePath()`:
   - Compute plugin data directory: `PathManager.getPluginsPath() + "/bbj-intellij-data/nodejs/"`
   - Look for `node` (unix) or `node.exe` (windows) in that directory
   - Verify it's executable (Files.isExecutable)
   - Return path if found and executable, null otherwise

3. `void downloadNodeAsync(@NotNull Project project, @Nullable Runnable onComplete)`:
   - Run as `Task.Backgroundable(project, "Downloading Node.js " + NODE_VERSION + "...")`
   - Determine platform/arch from SystemInfo
   - Build URL:
     - macOS: `node-{VERSION}-darwin-{arm64|x64}.tar.gz`
     - Linux: `node-{VERSION}-linux-x64.tar.gz`
     - Windows: `node-{VERSION}-win-x64.zip`
   - Download using `com.intellij.util.io.HttpRequests`:
     ```java
     HttpRequests.request(url)
         .productNameAsUserAgent()
         .connect(request -> {
             request.saveToFile(tempFile, indicator);
             return tempFile;
         });
     ```
   - Extract just the `node` binary:
     - For `.tar.gz`: Use `org.apache.commons.compress` if available, or use `ProcessBuilder("tar", "xzf", ...)` (tar is available on macOS/Linux; on Windows use zip format)
     - For `.zip` (Windows): Use `java.util.zip.ZipInputStream`
     - The node binary is at `node-{VERSION}-{platform}-{arch}/bin/node` (unix) or `node-{VERSION}-win-x64/node.exe` (windows)
   - Copy extracted binary to `{pluginDataDir}/nodejs/node` (or `node.exe`)
   - Set executable permission: `file.toFile().setExecutable(true)`
   - Clean up temp files
   - On success: show balloon "Node.js {VERSION} downloaded successfully. Restart BBj Language Server to activate."
   - On failure: show balloon with error "Failed to download Node.js: {message}"
   - Call onComplete on EDT if provided

**Private methods:**

4. `private static String getPlatformName()`:
   - `SystemInfo.isMac` → "darwin"
   - `SystemInfo.isLinux` → "linux"
   - `SystemInfo.isWindows` → "win"

5. `private static String getArchitecture()`:
   - macOS: `SystemInfo.isAarch64` → "arm64", else "x64"
   - Others: `SystemInfo.is64Bit` → "x64" (don't support 32-bit, it's 2026)

6. `private static Path getNodeDataDirectory()`:
   - Return `Paths.get(PathManager.getPluginsPath(), "bbj-intellij-data", "nodejs")`
   - Create directories if not exist

**Archive extraction:**
For tar.gz (macOS/Linux), use `Runtime.getRuntime().exec(new String[]{"tar", "xzf", archivePath, "-C", extractDir, "--strip-components=1"})` — simple and reliable.
For zip (Windows), use `java.util.zip.ZipInputStream` to extract just the node.exe.
After extraction, copy the `bin/node` (unix) or `node.exe` (windows) to the data directory.

**Important notes:**
- Use `com.intellij.openapi.util.SystemInfo` (NOT System.getProperty) for platform detection — it handles edge cases
- Node.js 20.18.1 LTS archive sizes: ~25MB (will download fast on modern connections)
- Minimum version check already exists in BbjNodeDetector.meetsMinimumVersion() (>= 18)
  </action>
  <verify>
`./gradlew compileJava` succeeds. Review generated class has correct SystemInfo usage and URL construction for all 3 platforms.
  </verify>
  <done>
BbjNodeDownloader can detect platform, download Node.js archive asynchronously, extract the binary, and cache it in plugin data directory. getCachedNodePath() returns cached path for synchronous access.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Node.js download into language server startup and notification banner</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServer.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjMissingNodeNotificationProvider.java
  </files>
  <action>
**Update BbjLanguageServer.resolveNodePath():**

Add a new step between auto-detection and "node" fallback:

```
1. Check settings (existing)
2. Try auto-detection via BbjNodeDetector.detectNodePath() (existing)
3. NEW: Check BbjNodeDownloader.getCachedNodePath() — if non-null, return its toString()
4. Fallback to "node" (existing — this will fail if Node.js is truly not installed, but the missing-node banner will guide the user)
```

This is a minimal change — just insert step 3 into the existing resolveNodePath() chain.

**Update BbjMissingNodeNotificationProvider:**

Add a "Download Node.js" action button to the existing editor banner when Node.js is missing:

1. Read the existing banner implementation
2. Add an action link labeled "Download Node.js" that calls `BbjNodeDownloader.downloadNodeAsync(project, () -> { /* refresh banners */ })`
3. The onComplete callback should call `EditorNotifications.getInstance(project).updateAllNotifications()` to dismiss the banner after download completes
4. Keep the existing "Open Settings" action as well

This gives users two paths: configure an existing Node.js in settings, or let the plugin download one automatically.
  </action>
  <verify>
`./gradlew compileJava` succeeds. Review BbjLanguageServer.resolveNodePath() includes the download cache check. Review BbjMissingNodeNotificationProvider has "Download Node.js" action.
  </verify>
  <done>
Language server startup chain checks downloaded Node.js cache. Missing-Node banner offers one-click download. After download completes, banner refreshes and LS can start using downloaded Node.js.
  </done>
</task>

</tasks>

<verification>
1. `cd bbj-intellij && ./gradlew compileJava` succeeds with no errors
2. BbjNodeDownloader.getCachedNodePath() returns null when no cached node exists (expected for clean install)
3. BbjNodeDownloader constructs correct URLs:
   - macOS ARM: `https://nodejs.org/dist/v20.18.1/node-v20.18.1-darwin-arm64.tar.gz`
   - macOS x64: `https://nodejs.org/dist/v20.18.1/node-v20.18.1-darwin-x64.tar.gz`
   - Windows x64: `https://nodejs.org/dist/v20.18.1/node-v20.18.1-win-x64.zip`
   - Linux x64: `https://nodejs.org/dist/v20.18.1/node-v20.18.1-linux-x64.tar.gz`
4. BbjLanguageServer.resolveNodePath() has 4-step resolution chain: settings → detect → cached download → fallback
5. BbjMissingNodeNotificationProvider includes "Download Node.js" action
</verification>

<success_criteria>
- BbjNodeDownloader compiles and handles all 3 target platforms (macOS, Windows, Linux)
- Language server startup uses cached downloaded Node.js when system Node.js is unavailable
- Missing-Node editor banner offers one-click Node.js download
- Download runs in background without blocking the IDE
- Downloaded Node.js persists across IDE restarts in plugin data directory
</success_criteria>

<output>
After completion, create `.planning/phases/06-distribution/06-02-SUMMARY.md`
</output>
