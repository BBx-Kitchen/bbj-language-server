---
phase: 03-settings-runtime
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjMissingHomeNotificationProvider.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjMissingNodeNotificationProvider.java
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
autonomous: false

must_haves:
  truths:
    - "Opening a BBj file with no BBj home configured shows a warning banner"
    - "Opening a BBj file with no Node.js configured shows a warning banner"
    - "Banner for missing BBj home has 'Configure BBj Home' action that opens settings"
    - "Banner for missing Node.js has 'Configure Node.js path' and 'Install Node.js' actions"
    - "Banners disappear after user configures valid paths and applies settings"
    - "Banners only appear on BBj files, not other file types"
  artifacts:
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjMissingHomeNotificationProvider.java"
      provides: "Editor banner for missing/invalid BBj home"
      contains: "EditorNotificationProvider"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjMissingNodeNotificationProvider.java"
      provides: "Editor banner for missing/invalid Node.js"
      contains: "EditorNotificationProvider"
    - path: "bbj-intellij/src/main/resources/META-INF/plugin.xml"
      provides: "editorNotificationProvider registrations"
      contains: "editorNotificationProvider"
  key_links:
    - from: "BbjMissingHomeNotificationProvider.java"
      to: "BbjSettings.java"
      via: "reads bbjHomePath from settings state"
      pattern: "BbjSettings\\.getInstance\\(\\)"
    - from: "BbjMissingHomeNotificationProvider.java"
      to: "BbjHomeDetector.java"
      via: "validates path with isValidBbjHome"
      pattern: "isValidBbjHome"
    - from: "BbjMissingNodeNotificationProvider.java"
      to: "BbjSettings.java"
      via: "reads nodeJsPath from settings state"
      pattern: "BbjSettings\\.getInstance\\(\\)"
    - from: "BbjMissingNodeNotificationProvider.java"
      to: "BbjSettingsConfigurable.java"
      via: "ShowSettingsUtil opens settings dialog"
      pattern: "BbjSettingsConfigurable\\.class"
    - from: "BbjMissingNodeNotificationProvider.java"
      to: "nodejs.org"
      via: "BrowserUtil.browse for install action"
      pattern: "BrowserUtil\\.browse"
---

<objective>
Add editor notification banners that appear on BBj files when BBj home or Node.js is not configured.

Purpose: Users need clear guidance when opening BBj files in an unconfigured environment. Two separate banners -- one for missing BBj home, one for missing Node.js -- provide actionable links to configure or install the missing dependency. This is a hard requirement from the phase context (both are editor banner requirements).

Output: Two EditorNotificationProvider implementations registered in plugin.xml, plus a human verification checkpoint to confirm the full settings + banner flow works visually.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-settings-runtime/03-RESEARCH.md
@.planning/phases/03-settings-runtime/03-CONTEXT.md
@.planning/phases/03-settings-runtime/03-01-SUMMARY.md
@.planning/phases/03-settings-runtime/03-02-SUMMARY.md
@bbj-intellij/src/main/resources/META-INF/plugin.xml
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjHomeDetector.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDetector.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create editor notification providers and register in plugin.xml</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjMissingHomeNotificationProvider.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjMissingNodeNotificationProvider.java
    bbj-intellij/src/main/resources/META-INF/plugin.xml
  </files>
  <action>
**BbjMissingHomeNotificationProvider.java:**

Implement `EditorNotificationProvider` and `DumbAware`.

`collectNotificationData(@NotNull Project project, @NotNull VirtualFile file)`:
1. If `file.getFileType() != BbjFileType.INSTANCE` -> return null (only BBj files)
2. Read `BbjSettings.getInstance().getState().bbjHomePath`
3. If path is non-empty AND `BbjHomeDetector.isValidBbjHome(path)` -> return null (configured and valid)
4. Otherwise return a lambda that creates an `EditorNotificationPanel`:
   - Use `EditorNotificationPanel(fileEditor, EditorNotificationPanel.Status.Warning)`
   - Set text: `"BBj home directory is not configured"`
   - Add action label `"Configure BBj Home"` that calls `ShowSettingsUtil.getInstance().showSettingsDialog(project, BbjSettingsConfigurable.class)`
   - Return the panel

**BbjMissingNodeNotificationProvider.java:**

Same structure as above, but for Node.js.

`collectNotificationData(@NotNull Project project, @NotNull VirtualFile file)`:
1. If `file.getFileType() != BbjFileType.INSTANCE` -> return null
2. Read `BbjSettings.getInstance().getState().nodeJsPath`
3. If path is non-empty, check that the file exists AND `BbjNodeDetector.meetsMinimumVersion(BbjNodeDetector.getNodeVersion(path))`:
   - If valid -> return null (configured and valid)
4. If path is empty, try auto-detection: `BbjNodeDetector.detectNodePath()`
   - If auto-detected AND version is valid -> return null (auto-detected successfully, no banner needed)
5. Otherwise return a lambda creating `EditorNotificationPanel`:
   - Use `EditorNotificationPanel.Status.Warning`
   - Set text: `"Node.js 18+ is required to run the BBj language server"`
   - Add action label `"Configure Node.js Path"` -> `ShowSettingsUtil.getInstance().showSettingsDialog(project, BbjSettingsConfigurable.class)`
   - Add action label `"Install Node.js"` -> `BrowserUtil.browse("https://nodejs.org/")`
   - Return the panel

**IMPORTANT for BbjMissingNodeNotificationProvider:** The `getNodeVersion()` call runs an external process. Keep the provider lightweight. Since `collectNotificationData` is called by the platform (not on EDT necessarily), this is acceptable for now. If performance becomes an issue, caching can be added later.

**plugin.xml update:**

Add these entries inside `<extensions defaultExtensionNs="com.intellij">`, after the applicationConfigurable entry (added by Plan 02):

```xml
<!-- Editor banners for missing configuration -->
<editorNotificationProvider
    implementation="com.basis.bbj.intellij.BbjMissingHomeNotificationProvider"/>
<editorNotificationProvider
    implementation="com.basis.bbj.intellij.BbjMissingNodeNotificationProvider"/>
```

Do NOT modify existing entries. Only ADD these two new entries.
  </action>
  <verify>
1. Compile: `cd /Users/beff/_workspace/bbj-language-server/bbj-intellij && ./gradlew compileJava 2>&1 | tail -5`
2. Count notification providers: `grep -c "editorNotificationProvider" bbj-intellij/src/main/resources/META-INF/plugin.xml` should return 2
3. Build plugin: `cd /Users/beff/_workspace/bbj-language-server/bbj-intellij && ./gradlew buildPlugin 2>&1 | tail -5`
  </verify>
  <done>Both EditorNotificationProviders compile. plugin.xml has two editorNotificationProvider entries. buildPlugin succeeds.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 3 settings and runtime detection:
- Settings page at Preferences > Languages & Frameworks > BBj with BBj home, Node.js, and classpath sections
- Auto-detection of BBj home from ~/BASIS/Install.properties
- Auto-detection of Node.js from system PATH with version display
- Dynamic classpath dropdown from BBj.properties
- Inline validation on all fields
- Editor banners on BBj files when BBj home or Node.js is missing/invalid
- Settings persistence across IDE restarts
  </what-built>
  <how-to-verify>
1. Run the plugin sandbox: `cd /Users/beff/_workspace/bbj-language-server/bbj-intellij && ./gradlew runIde`
2. Open Preferences (Cmd+,) > Languages & Frameworks > BBj
3. Verify three sections visible: BBj Environment, Node.js Runtime, Classpath
4. Check BBj home is pre-filled (auto-detected from ~/BASIS/Install.properties)
5. Check Node.js path is pre-filled (auto-detected from PATH)
6. Verify Node.js version label shows detected version (e.g., "Detected: v22.x.x")
7. Verify classpath dropdown is populated with entries (bbj_default, addon, etc.)
8. Clear BBj home field and verify classpath dropdown becomes disabled
9. Enter invalid path in BBj home and verify red validation error appears
10. Click Apply, close settings, reopen -- verify values persisted
11. Open or create a .bbj file
12. Clear BBj home in settings, apply, return to editor -- verify yellow banner appears
13. Verify banner has "Configure BBj Home" link that opens settings
14. Clear Node.js path in settings (and temporarily rename node binary or set invalid path), apply
15. Verify Node.js banner appears with "Configure Node.js Path" and "Install Node.js" links
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `./gradlew buildPlugin` passes
- plugin.xml has all Phase 3 registrations: applicationService, applicationConfigurable, 2x editorNotificationProvider
- Opening BBj file with no config shows warning banners
- Settings page has all three sections with functional fields
- Human verification confirms full visual flow
</verification>

<success_criteria>
Editor notification banners appear on BBj files when BBj home or Node.js is missing/invalid. Banners have actionable links (open settings, install Node.js). Banners disappear after valid configuration is applied. Full Phase 3 verified by human in sandbox IDE.
</success_criteria>

<output>
After completion, create `.planning/phases/03-settings-runtime/03-03-SUMMARY.md`
</output>
