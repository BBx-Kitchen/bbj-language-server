---
phase: 03-settings-runtime
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjHomeDetector.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDetector.java
autonomous: true

must_haves:
  truths:
    - "BbjSettings stores bbjHomePath, nodeJsPath, and classpathEntry as application-level state"
    - "BbjHomeDetector finds BBj installation from ~/BASIS/Install.properties and common locations"
    - "BbjNodeDetector finds Node.js on system PATH and validates version >= 18"
    - "Settings persist across IDE restarts via PersistentStateComponent XML serialization"
  artifacts:
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java"
      provides: "Application-level persistent settings state"
      exports: ["BbjSettings", "BbjSettings.State"]
      contains: "@State"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjHomeDetector.java"
      provides: "BBj home auto-detection and validation"
      exports: ["BbjHomeDetector"]
      contains: "detectBbjHome"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDetector.java"
      provides: "Node.js detection and version validation"
      exports: ["BbjNodeDetector"]
      contains: "detectNodePath"
  key_links:
    - from: "BbjSettings.java"
      to: "ApplicationManager.getApplication().getService()"
      via: "PersistentStateComponent registration"
      pattern: "ApplicationManager\\.getApplication\\(\\)\\.getService"
    - from: "BbjHomeDetector.java"
      to: "~/BASIS/Install.properties"
      via: "java.util.Properties file read"
      pattern: "Install\\.properties"
    - from: "BbjNodeDetector.java"
      to: "PathEnvironmentVariableUtil.findInPath"
      via: "system PATH search"
      pattern: "findInPath.*node"
---

<objective>
Create the settings state model and runtime detection utilities for the BBj IntelliJ plugin.

Purpose: These three foundation classes provide the data layer that the settings UI (Plan 02) and editor banners (Plan 03) will consume. BbjSettings persists user configuration. BbjHomeDetector and BbjNodeDetector auto-detect BBj and Node.js installations so the settings page can pre-populate fields.

Output: Three Java classes ready for consumption by the settings UI and editor notification providers.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-settings-runtime/03-RESEARCH.md
@.planning/phases/03-settings-runtime/03-CONTEXT.md
@bbj-intellij/src/main/resources/META-INF/plugin.xml
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjFileType.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BbjSettings persistent state service</name>
  <files>bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java</files>
  <action>
Create `BbjSettings.java` implementing `PersistentStateComponent<BbjSettings.State>`.

Requirements:
- Annotate with `@State(name = "com.basis.bbj.intellij.BbjSettings", storages = @Storage("BbjSettings.xml"))`
- Inner `State` class with three public String fields defaulting to "":
  - `bbjHomePath` (absolute path to BBj installation)
  - `nodeJsPath` (absolute path to Node.js binary)
  - `classpathEntry` (name of selected classpath, e.g., "bbj_default")
- Static `getInstance()` method using `ApplicationManager.getApplication().getService(BbjSettings.class)`
- Implement `getState()` returning `myState`
- Implement `loadState(@NotNull State state)` assigning `myState = state`
- Also add a static helper: `getBBjClasspathEntries(String bbjHomePath)` that reads `cfg/BBj.properties` from the given BBj home path, parses lines starting with `basis.classpath.`, extracts the key name between `basis.classpath.` and `=`, and returns a sorted `List<String>`. This mirrors the VS Code extension's `getBBjClasspathEntries()` function. Do NOT filter underscore-prefixed entries (show all entries for parity with VS Code).

Note: Do NOT add `@Service` annotation -- the service will be registered via plugin.xml `applicationService` in Plan 02. The `@State` annotation alone is sufficient for `PersistentStateComponent`.

Package: `com.basis.bbj.intellij`

Imports needed:
- `com.intellij.openapi.application.ApplicationManager`
- `com.intellij.openapi.components.PersistentStateComponent`
- `com.intellij.openapi.components.State`
- `com.intellij.openapi.components.Storage`
- `org.jetbrains.annotations.NotNull`
- Standard java.io, java.nio, java.util as needed
  </action>
  <verify>File compiles: `cd /Users/beff/_workspace/bbj-language-server/bbj-intellij && ./gradlew compileJava 2>&1 | tail -5` shows BUILD SUCCESSFUL</verify>
  <done>BbjSettings class exists with State inner class (bbjHomePath, nodeJsPath, classpathEntry), getInstance(), getState(), loadState(), and getBBjClasspathEntries() static helper</done>
</task>

<task type="auto">
  <name>Task 2: Create BbjHomeDetector and BbjNodeDetector utility classes</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjHomeDetector.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDetector.java
  </files>
  <action>
Create two utility classes with private constructors (static methods only).

**BbjHomeDetector.java:**
- `public static @Nullable String detectBbjHome()` -- auto-detect BBj installation:
  1. First: Read `~/BASIS/Install.properties` using `java.util.Properties`. Check `BBjDirectory` key first, fall back to `BASISInstallDirectory`. Validate the found path with `isValidBbjHome()`.
  2. Second: Check common locations. On Windows (`SystemInfo.isWindows`): `C:\bbx`, `C:\basis\bbj`. On Unix/macOS: `/usr/local/bbx`, `/opt/bbx`, `/opt/basis/bbj`. Return first valid path.
  3. Return null if nothing found.
- `public static boolean isValidBbjHome(@NotNull String path)` -- validates by checking `new File(path, "cfg/BBj.properties").exists()`
- Use `com.intellij.openapi.util.SystemInfo` for OS detection.
- Use `System.getProperty("user.home")` for home directory.

**BbjNodeDetector.java:**
- `public static @Nullable String detectNodePath()` -- find node binary:
  1. Use `PathEnvironmentVariableUtil.findInPath("node")` from `com.intellij.execution.configurations`
  2. If found and `canExecute()`, return absolute path
  3. Return null otherwise
- `public static @Nullable String getNodeVersion(@NotNull String nodePath)` -- get version string:
  1. Create `GeneralCommandLine(nodePath, "--version")` with `ParentEnvironmentType.CONSOLE`
  2. Set charset to UTF-8
  3. Use `ExecUtil.execAndReadLine(cmd)` to get output (e.g., "v22.22.0")
  4. Return trimmed output, or null on any exception
- `public static boolean meetsMinimumVersion(@Nullable String version)` -- check version >= 18:
  1. Return false if null or doesn't start with "v"
  2. Parse major version from `version.substring(1).split("\\.")[0]`
  3. Return `major >= 18`
  4. Return false on NumberFormatException

Both classes: package `com.basis.bbj.intellij`, private constructor, all static methods.
  </action>
  <verify>File compiles: `cd /Users/beff/_workspace/bbj-language-server/bbj-intellij && ./gradlew compileJava 2>&1 | tail -5` shows BUILD SUCCESSFUL</verify>
  <done>BbjHomeDetector detects from Install.properties and common paths, validates via cfg/BBj.properties. BbjNodeDetector detects from PATH, reads version via GeneralCommandLine, enforces >= 18.</done>
</task>

</tasks>

<verification>
- `./gradlew compileJava` passes with all three new files
- BbjSettings has State with three String fields and getInstance()
- BbjHomeDetector has detectBbjHome() and isValidBbjHome()
- BbjNodeDetector has detectNodePath(), getNodeVersion(), meetsMinimumVersion()
- No plugin.xml changes yet (Plan 02 handles registration)
</verification>

<success_criteria>
Three Java files compile successfully. BbjSettings provides persistent state storage. BbjHomeDetector can find BBj from installer trace and common locations. BbjNodeDetector can find and validate Node.js from system PATH. All classes follow IntelliJ Platform API patterns from the research document.
</success_criteria>

<output>
After completion, create `.planning/phases/03-settings-runtime/03-01-SUMMARY.md`
</output>
