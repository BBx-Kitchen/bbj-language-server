---
phase: 03-settings-runtime
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
autonomous: true

must_haves:
  truths:
    - "Settings page appears at Preferences > Languages & Frameworks > BBj"
    - "BBj home field has browse button and pre-fills with auto-detected path"
    - "Node.js field has browse button and shows detected version"
    - "Classpath dropdown populates dynamically when BBj home is valid"
    - "Classpath dropdown is disabled when BBj home is empty or invalid"
    - "Inline validation shows errors for invalid BBj home and Node.js paths"
    - "Settings persist when user clicks Apply/OK and survive IDE restart"
  artifacts:
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java"
      provides: "Swing settings panel with three sections"
      contains: "TextFieldWithBrowseButton"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java"
      provides: "Settings controller connecting UI to BbjSettings state"
      contains: "implements Configurable"
    - path: "bbj-intellij/src/main/resources/META-INF/plugin.xml"
      provides: "applicationService and applicationConfigurable registrations"
      contains: "applicationConfigurable"
  key_links:
    - from: "BbjSettingsConfigurable.java"
      to: "BbjSettings.java"
      via: "getInstance().getState() in isModified/apply/reset"
      pattern: "BbjSettings\\.getInstance\\(\\)"
    - from: "BbjSettingsComponent.java"
      to: "BbjHomeDetector.java"
      via: "auto-detection on panel creation"
      pattern: "BbjHomeDetector\\.detectBbjHome"
    - from: "BbjSettingsComponent.java"
      to: "BbjSettings.java"
      via: "classpath dropdown population"
      pattern: "getBBjClasspathEntries"
    - from: "BbjSettingsConfigurable.java"
      to: "EditorNotifications"
      via: "updateAllNotifications() in apply()"
      pattern: "updateAllNotifications"
    - from: "plugin.xml"
      to: "BbjSettings.java"
      via: "applicationService registration"
      pattern: "applicationService.*BbjSettings"
---

<objective>
Build the settings UI page for the BBj IntelliJ plugin.

Purpose: Users need a settings page to configure BBj home, Node.js path, and classpath selection. This page is the primary configuration surface and must wire to the BbjSettings state from Plan 01. The classpath dropdown dynamically populates based on BBj home validity, and inline validation provides immediate feedback.

Output: A working settings page at Preferences > Languages & Frameworks > BBj with three sections, browse buttons, validation, and persistence.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-settings-runtime/03-RESEARCH.md
@.planning/phases/03-settings-runtime/03-CONTEXT.md
@.planning/phases/03-settings-runtime/03-01-SUMMARY.md
@bbj-intellij/src/main/resources/META-INF/plugin.xml
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjHomeDetector.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDetector.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BbjSettingsComponent Swing panel</name>
  <files>bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java</files>
  <action>
Create `BbjSettingsComponent.java` -- the Swing UI panel for the settings page.

**Constructor takes a `Disposable parentDisposable` parameter** (for ComponentValidator lifecycle).

**Layout:** Single scrollable panel using `FormBuilder` with three sections separated by `TitledSeparator`:

**Section 1: "BBj Environment"**
- `TextFieldWithBrowseButton` for BBj home path
  - Browse button uses `FileChooserDescriptorFactory.createSingleFolderDescriptor()`
  - Title: "Select BBj Home Directory", Description: "Choose the root directory of your BBj installation"
- Inline validation via `ComponentValidator` on the text field:
  - Empty: no validation (return null -- don't validate empty fields per research anti-pattern)
  - Non-empty but invalid (`!BbjHomeDetector.isValidBbjHome(path)`): return `ValidationInfo("BBj.properties not found in " + path + "/cfg/", bbjHomeField)`
  - Valid: return null
- Attach `DocumentAdapter` to text field to trigger revalidation on change AND update the classpath dropdown

**Section 2: "Node.js Runtime"**
- `TextFieldWithBrowseButton` for Node.js path
  - Browse button uses `FileChooserDescriptorFactory.createSingleLocalFileDescriptor()`
  - Title: "Select Node.js Executable", Description: "Choose the Node.js binary"
- `JBLabel` below the field showing detected version (e.g., "Detected: v22.22.0") or error ("Version too old (minimum: 18)")
- Inline validation via `ComponentValidator`:
  - Empty: no validation
  - Non-empty but file doesn't exist: `ValidationInfo("File not found: " + path, nodeJsField)`
  - File exists but version check fails: `ValidationInfo("Node.js version 18 or higher is required", nodeJsField)`
  - Valid: return null
- Attach `DocumentAdapter` to trigger revalidation and update version label on change
- **Important:** Node.js version detection (`BbjNodeDetector.getNodeVersion()`) runs an external process. Call it on document change but be aware it may briefly block. This is acceptable for settings page interactions.

**Section 3: "Classpath"**
- `ComboBox<String>` with `CollectionComboBoxModel<String>`
- Method `updateClasspathDropdown(String bbjHomePath)`:
  - If path is empty or invalid: disable combo, set model to `["(set BBj home first)"]`
  - If valid: enable combo, populate with `BbjSettings.getBBjClasspathEntries(bbjHomePath)`, prepend empty string as default/no-selection option
- Wire: when BBj home text field changes, call `updateClasspathDropdown(bbjHomeField.getText())`

**Public getters/setters:**
- `getPanel()` returns the main JPanel
- `getBbjHomePath()` / `setBbjHomePath(String)` -- get/set text field value
- `getNodeJsPath()` / `setNodeJsPath(String)` -- get/set text field value
- `getClasspathEntry()` / `setClasspathEntry(String)` -- get/set combo selection
- `getPreferredFocusedComponent()` returns the BBj home text field

Package: `com.basis.bbj.intellij`
  </action>
  <verify>File compiles: `cd /Users/beff/_workspace/bbj-language-server/bbj-intellij && ./gradlew compileJava 2>&1 | tail -5`</verify>
  <done>BbjSettingsComponent creates a three-section panel with browse buttons, inline validation, dynamic classpath dropdown, and version display label</done>
</task>

<task type="auto">
  <name>Task 2: Create BbjSettingsConfigurable and register in plugin.xml</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
    bbj-intellij/src/main/resources/META-INF/plugin.xml
  </files>
  <action>
**BbjSettingsConfigurable.java:**

Create the controller class implementing `Configurable` and `Disposable`.

- `getDisplayName()` returns `"BBj"`
- `getPreferredFocusedComponent()` delegates to `myComponent.getPreferredFocusedComponent()`
- `createComponent()`:
  - Instantiate `new BbjSettingsComponent(this)` (pass self as parentDisposable)
  - Call `reset()` to populate fields from stored state
  - If stored BBj home is empty, try auto-detection: call `BbjHomeDetector.detectBbjHome()` and if non-null, set it on the component (so user sees pre-filled value but must explicitly Apply)
  - Similarly for Node.js: if stored path is empty, call `BbjNodeDetector.detectNodePath()` and if non-null, set on component
  - Return `myComponent.getPanel()`
- `isModified()`:
  - Compare each field in `myComponent` against `BbjSettings.getInstance().getState()`
  - Return true if ANY field differs (use `Objects.equals` for null safety)
- `apply()`:
  - Read all three fields from component into `BbjSettings.getInstance().getState()`
  - Refresh editor notifications: iterate `ProjectManager.getInstance().getOpenProjects()` and call `EditorNotifications.getInstance(project).updateAllNotifications()` for each
  - (Phase 4 will add language server restart here)
- `reset()`:
  - Read state from `BbjSettings.getInstance().getState()` into component fields
- `disposeUIResources()`:
  - Set `myComponent = null`
  - Call `Disposer.dispose(this)` to clean up ComponentValidators

**plugin.xml updates:**

Add these entries inside the existing `<extensions defaultExtensionNs="com.intellij">` block, AFTER the existing colorSettingsPage entry:

```xml
<!-- Application-level settings service -->
<applicationService
    serviceImplementation="com.basis.bbj.intellij.BbjSettings"/>

<!-- Settings page under Languages & Frameworks > BBj -->
<applicationConfigurable
    parentId="language"
    instance="com.basis.bbj.intellij.BbjSettingsConfigurable"
    id="com.basis.bbj.intellij.BbjSettingsConfigurable"
    displayName="BBj"/>
```

Do NOT modify any existing entries in plugin.xml. Only ADD the new entries.
  </action>
  <verify>
1. Compile: `cd /Users/beff/_workspace/bbj-language-server/bbj-intellij && ./gradlew compileJava 2>&1 | tail -5`
2. Verify plugin.xml has applicationService and applicationConfigurable: `grep -c "applicationService\|applicationConfigurable" bbj-intellij/src/main/resources/META-INF/plugin.xml` should return 2
  </verify>
  <done>BbjSettingsConfigurable wires BbjSettingsComponent to BbjSettings. Settings page registered at Languages & Frameworks > BBj. Auto-detection pre-fills empty fields. Apply persists state and refreshes editor notifications.</done>
</task>

</tasks>

<verification>
- `./gradlew compileJava` passes
- plugin.xml contains `applicationService` for BbjSettings
- plugin.xml contains `applicationConfigurable` with `parentId="language"` and `displayName="BBj"`
- BbjSettingsConfigurable implements Configurable with all 5 methods (getDisplayName, createComponent, isModified, apply, reset)
- BbjSettingsComponent has three sections with browse buttons, validation, and classpath dropdown
- apply() calls EditorNotifications.updateAllNotifications()
</verification>

<success_criteria>
Settings page compiles and is registered in plugin.xml. Opening Preferences > Languages & Frameworks > BBj shows a panel with BBj home (browse + validate), Node.js (browse + version label + validate), and classpath (dynamic dropdown). Applying settings persists them via BbjSettings and refreshes editor notifications.
</success_criteria>

<output>
After completion, create `.planning/phases/03-settings-runtime/03-02-SUMMARY.md`
</output>
