---
phase: 16-api-signature-deprecated-api-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/language/bbj-completion-provider.ts
  - bbj-vscode/src/language/bbj-linker.ts
autonomous: true

must_haves:
  truths:
    - "Completion provider override matches Langium 4 createReferenceCompletionItem signature (3 params)"
    - "Linker handles Reference | MultiReference union type safely in all $refText accesses"
    - "prepareLangiumParser usage in bbj-module.ts is confirmed valid (no change needed)"
    - "Zero pre-v3 deprecated API usages remain in the codebase"
  artifacts:
    - path: "bbj-vscode/src/language/bbj-completion-provider.ts"
      provides: "Completion provider with Langium 4 signature"
      contains: "createReferenceCompletionItem(nodeDescription: AstNodeDescription | FunctionNodeDescription, _refInfo: ReferenceInfo, _context: CompletionContext)"
    - path: "bbj-vscode/src/language/bbj-linker.ts"
      provides: "Linker with Reference union type handling"
      contains: "isReference"
  key_links:
    - from: "bbj-vscode/src/language/bbj-completion-provider.ts"
      to: "langium/lsp DefaultCompletionProvider"
      via: "override createReferenceCompletionItem with 3-param signature"
      pattern: "super\\.createReferenceCompletionItem\\(nodeDescription,\\s*_refInfo,\\s*_context\\)"
    - from: "bbj-vscode/src/language/bbj-linker.ts"
      to: "langium isReference type guard"
      via: "import and usage for Reference narrowing"
      pattern: "isReference.*refInfo\\.reference"
---

<objective>
Update completion provider and linker to match Langium 4 API signatures. The completion provider's `createReferenceCompletionItem` override must accept the two new required parameters (`ReferenceInfo`, `CompletionContext`), and the linker must handle the `Reference | MultiReference` union type with proper type guards. Also verify `prepareLangiumParser` is unchanged and no deprecated APIs remain.

Purpose: Resolves MIGR-04, MIGR-05, MIGR-06, MIGR-08 -- the four remaining Langium 4 API signature changes that block compilation and future-proof the linker.
Output: Updated bbj-completion-provider.ts and bbj-linker.ts with Langium 4 compatible signatures.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-api-signature-deprecated-api-migration/16-RESEARCH.md

@bbj-vscode/src/language/bbj-completion-provider.ts
@bbj-vscode/src/language/bbj-linker.ts
@bbj-vscode/src/language/bbj-module.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update completion provider signature for Langium 4</name>
  <files>bbj-vscode/src/language/bbj-completion-provider.ts</files>
  <action>
Update the `createReferenceCompletionItem` override to match the Langium 4 signature with 3 parameters.

1. Add `ReferenceInfo` to the import from `langium`:
   Change: `import { AstNodeDescription, GrammarAST, MaybePromise } from "langium";`
   To: `import { AstNodeDescription, GrammarAST, MaybePromise, ReferenceInfo } from "langium";`

2. Add `CompletionContext` to the import from `langium/lsp` (it is already imported, verify it is there):
   Current line already has: `import { CompletionAcceptor, CompletionContext, CompletionValueItem, DefaultCompletionProvider, LangiumServices } from "langium/lsp";`
   CompletionContext is already imported. No change needed.

3. Update the method signature on line 15:
   FROM: `override  createReferenceCompletionItem(nodeDescription: AstNodeDescription | FunctionNodeDescription): CompletionValueItem {`
   TO: `override createReferenceCompletionItem(nodeDescription: AstNodeDescription | FunctionNodeDescription, _refInfo: ReferenceInfo, _context: CompletionContext): CompletionValueItem {`
   (Also fix the double-space before `createReferenceCompletionItem`)

4. Update the super call on line 16:
   FROM: `const superImpl = super.createReferenceCompletionItem(nodeDescription)`
   TO: `const superImpl = super.createReferenceCompletionItem(nodeDescription, _refInfo, _context)`

Do NOT change any other logic in the method body. The `_` prefix on the new params indicates they are forwarded to super but not used directly in this override.
  </action>
  <verify>
Run: `grep -n "createReferenceCompletionItem" bbj-vscode/src/language/bbj-completion-provider.ts`
Expected: Line 15 shows 3-param signature with `_refInfo: ReferenceInfo, _context: CompletionContext`
Expected: Super call passes all 3 params

Run: `grep "ReferenceInfo" bbj-vscode/src/language/bbj-completion-provider.ts`
Expected: ReferenceInfo is imported from langium
  </verify>
  <done>
createReferenceCompletionItem override accepts (nodeDescription, _refInfo, _context) matching the Langium 4 DefaultCompletionProvider signature. Super call forwards all 3 params. ReferenceInfo imported from langium.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Reference union type guards to linker and audit for deprecated APIs</name>
  <files>bbj-vscode/src/language/bbj-linker.ts</files>
  <action>
Add defensive type narrowing for `Reference | MultiReference` union type in the linker's `getCandidate` method, and verify no deprecated APIs exist.

1. Add `isReference` to the import from `langium`:
   Change the import block to include `isReference`:
   ```
   import {
       AstNodeDescription,
       AstUtils,
       DefaultLinker, DocumentState, interruptAndCheck,
       isReference,
       LangiumDocument, LinkingError,
       ReferenceInfo,
       WorkspaceManager
   } from 'langium';
   ```
   (Insert `isReference,` in alphabetical order after `interruptAndCheck,`)

2. In the `getCandidate` method, wrap the `$refText` accesses with `isReference` type guards for safety. The current code accesses `refInfo.reference.$refText` which exists on both `Reference` and `MultiReference`, so the code is functionally correct already. However, add a defensive early-return for `MultiReference` at the top of `getCandidate`:

   At the start of `getCandidate` (line 81, after the method signature), add:
   ```typescript
   // Langium 4: ReferenceInfo.reference can be Reference | MultiReference
   // BBj only uses single references; skip multi-reference cases
   if (!isReference(refInfo.reference)) {
       return super.getCandidate(refInfo);
   }
   ```

   This ensures that if Langium ever passes a MultiReference to getCandidate, we safely delegate to super instead of assuming single-reference behavior.

3. Verify prepareLangiumParser usage: Read bbj-module.ts and confirm `prepareLangiumParser` import and usage at line 12 and line 104 is unchanged. Do NOT modify bbj-module.ts -- it is confirmed valid per RESEARCH.md.

4. Deprecated API audit: Grep across all .ts files in bbj-vscode/src/language/ for any of these known removed APIs:
   - `findDeclaration` (renamed to `findDeclarations` in Langium 4)
   - `getLocalScopes` (removed)
   - `getExportedElements` (removed)
   If found, report and fix. If not found (expected), note the clean audit.

Do NOT modify bbj-scope.ts or bbj-module.ts. Only modify bbj-linker.ts.
  </action>
  <verify>
Run: `grep "isReference" bbj-vscode/src/language/bbj-linker.ts`
Expected: `isReference` imported from langium AND used in getCandidate method

Run: `grep -n "MultiReference" bbj-vscode/src/language/bbj-linker.ts`
Expected: Comment mentioning MultiReference in the type guard block

Run: `grep "prepareLangiumParser" bbj-vscode/src/language/bbj-module.ts`
Expected: Import and usage present (unchanged from before)

Run: `grep -rn "findDeclaration\b\|getLocalScopes\|getExportedElements" bbj-vscode/src/language/*.ts`
Expected: No matches (clean deprecated API audit)
  </verify>
  <done>
Linker imports `isReference` from langium and uses it as a defensive type guard at the top of `getCandidate`. MultiReference cases delegate to super. prepareLangiumParser confirmed valid in bbj-module.ts. No deprecated pre-v3 APIs found in codebase audit.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Completion provider signature**: `grep -c "refInfo.*ReferenceInfo.*context.*CompletionContext" bbj-vscode/src/language/bbj-completion-provider.ts` returns 1
2. **Linker type guard**: `grep -c "isReference" bbj-vscode/src/language/bbj-linker.ts` returns at least 2 (import + usage)
3. **prepareLangiumParser unchanged**: `grep "prepareLangiumParser" bbj-vscode/src/language/bbj-module.ts` shows import and usage
4. **No deprecated APIs**: `grep -rn "findDeclaration[^s]\|getLocalScopes\|getExportedElements" bbj-vscode/src/language/` returns empty
5. **No pre-v3 imports**: No imports from removed langium subpaths
</verification>

<success_criteria>
- createReferenceCompletionItem override has 3-parameter signature matching Langium 4
- Super call in completion provider forwards all 3 parameters
- Linker imports isReference from langium
- Linker's getCandidate has defensive MultiReference handling
- prepareLangiumParser confirmed still valid (no changes to bbj-module.ts)
- Zero deprecated API usages found across all source files
- All four requirements covered: MIGR-04, MIGR-05, MIGR-06, MIGR-08
</success_criteria>

<output>
After completion, create `.planning/phases/16-api-signature-deprecated-api-migration/16-01-SUMMARY.md`
</output>
