---
phase: 31-extension-settings-file-types
plan: 04
type: execute
wave: 2
depends_on: ["31-02", "31-03"]
files_modified:
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjEMLoginAction.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjEMTokenStore.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunBuiAction.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunDwcAction.java
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
autonomous: true

must_haves:
  truths:
    - "Running 'Login to Enterprise Manager' action in IntelliJ prompts for credentials, launches em-login.bbj, and stores the returned JWT securely"
    - "BUI and DWC run actions in IntelliJ use the stored JWT token instead of plaintext username/password"
    - "If no JWT is stored when a BUI/DWC run is triggered, the user is prompted to log in first"
    - "No plaintext EM passwords are stored in IntelliJ settings after migration"
    - "The IntelliJ settings page has an EM URL field and no username/password fields"
  artifacts:
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjEMLoginAction.java"
      provides: "Login to EM action that launches em-login.bbj and stores JWT via CredentialStore"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjEMTokenStore.java"
      provides: "Utility class for JWT storage/retrieval via IntelliJ PasswordSafe"
    - path: "bbj-intellij/src/main/resources/META-INF/plugin.xml"
      provides: "Login to EM action registration"
      contains: "BbjEMLoginAction"
  key_links:
    - from: "BbjEMLoginAction.java"
      to: "bbj-vscode/tools/em-login.bbj"
      via: "GeneralCommandLine launches BBj with em-login.bbj stub"
    - from: "BbjEMTokenStore.java"
      to: "IntelliJ PasswordSafe"
      via: "CredentialAttributes for secure JWT storage"
    - from: "BbjRunBuiAction.java"
      to: "BbjEMTokenStore.java"
      via: "getToken() before building run command"
---

<objective>
Implement JWT-based EM authentication in IntelliJ using CredentialStore/PasswordSafe. Add "Login to EM" action, remove plaintext EM credentials from settings, and update BUI/DWC run actions to use JWT.

Purpose: Delivers CONF-03 (token-based EM auth) for IntelliJ. Eliminates plaintext EM password storage.
Output: Login to EM action, PasswordSafe-backed JWT, updated run actions, EM URL in settings.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-extension-settings-file-types/31-CONTEXT.md
@.planning/phases/31-extension-settings-file-types/31-RESEARCH.md
@.planning/phases/31-extension-settings-file-types/31-01-SUMMARY.md
@.planning/phases/31-extension-settings-file-types/31-02-SUMMARY.md
@.planning/phases/31-extension-settings-file-types/31-03-SUMMARY.md
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunBuiAction.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunDwcAction.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java
@bbj-intellij/src/main/resources/META-INF/plugin.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EM token store utility and login action</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjEMTokenStore.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjEMLoginAction.java
    bbj-intellij/src/main/resources/META-INF/plugin.xml
  </files>
  <action>
**Create BbjEMTokenStore.java:**

A utility class for JWT storage and retrieval using IntelliJ's PasswordSafe:

```java
package com.basis.bbj.intellij.actions;

import com.intellij.credentialStore.CredentialAttributes;
import com.intellij.credentialStore.CredentialAttributesKt;
import com.intellij.credentialStore.Credentials;
import com.intellij.ide.passwordSafe.PasswordSafe;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;

/**
 * Utility for storing and retrieving EM JWT tokens via IntelliJ PasswordSafe.
 * Tokens are keyed by a service name, stored in the OS-native keychain.
 */
public final class BbjEMTokenStore {

    private static final String SERVICE_NAME = "BBj Enterprise Manager";

    private BbjEMTokenStore() {} // Utility class

    private static CredentialAttributes createAttributes() {
        return new CredentialAttributes(
            CredentialAttributesKt.generateServiceName(SERVICE_NAME, "jwt-token")
        );
    }

    public static void storeToken(@NotNull String token) {
        CredentialAttributes attrs = createAttributes();
        Credentials credentials = new Credentials("bbj-em", token);
        PasswordSafe.getInstance().set(attrs, credentials);
    }

    @Nullable
    public static String getToken() {
        CredentialAttributes attrs = createAttributes();
        Credentials credentials = PasswordSafe.getInstance().get(attrs);
        return credentials != null ? credentials.getPasswordAsString() : null;
    }

    public static void deleteToken() {
        CredentialAttributes attrs = createAttributes();
        PasswordSafe.getInstance().set(attrs, null);
    }
}
```

**Create BbjEMLoginAction.java:**

An IntelliJ action that prompts for credentials, launches em-login.bbj, and stores the JWT:

```java
package com.basis.bbj.intellij.actions;

import com.basis.bbj.intellij.BbjSettings;
import com.intellij.execution.configurations.GeneralCommandLine;
import com.intellij.execution.process.CapturingProcessHandler;
import com.intellij.execution.process.ProcessOutput;
import com.intellij.openapi.actionSystem.AnAction;
import com.intellij.openapi.actionSystem.AnActionEvent;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.ui.Messages;
import org.jetbrains.annotations.NotNull;

import java.io.File;
import java.nio.file.Files;
import java.nio.file.Path;

public final class BbjEMLoginAction extends AnAction {

    public BbjEMLoginAction() {
        super("Login to Enterprise Manager",
              "Authenticate with BBj Enterprise Manager and store JWT token",
              null);
    }

    @Override
    public void actionPerformed(@NotNull AnActionEvent e) {
        Project project = e.getProject();

        BbjSettings.State state = BbjSettings.getInstance().getState();
        String bbjHome = state.bbjHomePath;
        if (bbjHome == null || bbjHome.isEmpty()) {
            Messages.showErrorDialog(
                "Please configure BBj Home in Settings > Languages & Frameworks > BBj",
                "BBj Home Not Set"
            );
            return;
        }

        // Prompt for credentials
        String username = Messages.showInputDialog(
            "Enter EM username:",
            "Enterprise Manager Login",
            null,
            "admin",
            null
        );
        if (username == null || username.isEmpty()) return;

        String password = Messages.showPasswordDialog(
            "Enter EM password:",
            "Enterprise Manager Login"
        );
        if (password == null) return;

        // Find em-login.bbj in plugin bundle
        String emLoginPath = getEMLoginBbjPath();
        if (emLoginPath == null) {
            Messages.showErrorDialog(
                "em-login.bbj not found in plugin bundle",
                "Login Failed"
            );
            return;
        }

        // Build BBj executable path
        String os = System.getProperty("os.name", "").toLowerCase();
        String bbjBin = bbjHome + File.separator + "bin" + File.separator +
                        "bbj" + (os.contains("win") ? ".exe" : "");
        Path bbjPath = Path.of(bbjBin);
        try { bbjPath = bbjPath.toRealPath(); } catch (Exception ignored) {}

        if (!Files.isExecutable(bbjPath)) {
            Messages.showErrorDialog("BBj executable not found: " + bbjBin, "Login Failed");
            return;
        }

        // Launch em-login.bbj
        try {
            GeneralCommandLine cmd = new GeneralCommandLine(bbjPath.toString());
            cmd.addParameter("-q");
            cmd.addParameter(emLoginPath);
            cmd.addParameter("-");
            cmd.addParameter(username);
            cmd.addParameter(password);

            CapturingProcessHandler handler = new CapturingProcessHandler(cmd);
            ProcessOutput output = handler.runProcess(15000); // 15s timeout

            String stdout = output.getStdout().trim();
            if (stdout.startsWith("ERROR:")) {
                Messages.showErrorDialog(stdout.substring(6), "EM Login Failed");
                return;
            }

            if (stdout.isEmpty()) {
                Messages.showErrorDialog(
                    "No token received from EM login",
                    "EM Login Failed"
                );
                return;
            }

            // Store JWT securely
            BbjEMTokenStore.storeToken(stdout);
            Messages.showInfoMessage(
                "Successfully logged in to Enterprise Manager",
                "EM Login"
            );
        } catch (Exception ex) {
            Messages.showErrorDialog(
                "Login failed: " + ex.getMessage(),
                "EM Login Failed"
            );
        }
    }

    /**
     * Gets the path to em-login.bbj from the plugin bundle.
     * Uses the same pattern as BbjRunActionBase.getWebBbjPath().
     */
    private String getEMLoginBbjPath() {
        // Use PluginManagerCore to find plugin path (same pattern as run actions)
        try {
            var pluginId = com.intellij.openapi.extensions.PluginId.findId("com.basis.bbj");
            if (pluginId == null) return null;
            var plugin = com.intellij.ide.plugins.PluginManagerCore.getPlugin(pluginId);
            if (plugin == null) return null;
            Path toolsDir = plugin.getPluginPath().resolve("tools");
            Path emLogin = toolsDir.resolve("em-login.bbj");
            return Files.exists(emLogin) ? emLogin.toString() : null;
        } catch (Exception e) {
            return null;
        }
    }
}
```

**plugin.xml changes:**

Add the EM Login action in the `<actions>` section:
```xml
<action id="bbj.loginEM"
        class="com.basis.bbj.intellij.actions.BbjEMLoginAction"
        text="Login to Enterprise Manager"
        description="Authenticate with BBj Enterprise Manager and store JWT token">
    <add-to-group group-id="ToolsMenu" anchor="last"/>
</action>
```
  </action>
  <verify>
1. `ls bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjEMTokenStore.java` exists
2. `ls bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjEMLoginAction.java` exists
3. `grep "BbjEMLoginAction" bbj-intellij/src/main/resources/META-INF/plugin.xml` returns a match
4. `grep "PasswordSafe" bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjEMTokenStore.java` returns a match
  </verify>
  <done>
BbjEMTokenStore provides secure JWT storage via PasswordSafe. BbjEMLoginAction prompts for credentials, launches em-login.bbj, and stores the token. Action registered in plugin.xml under Tools menu.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update IntelliJ settings and run actions for token-based auth</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunBuiAction.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunDwcAction.java
  </files>
  <action>
**BbjSettings.java changes:**
1. Add `public String emUrl = "";` field to State class (EM URL setting).
2. REMOVE `emUsername` and `emPassword` fields from State class. These are replaced by JWT stored in PasswordSafe.
   NOTE: Removing fields from State won't cause errors for users with existing settings â€” IntelliJ's XML deserialization silently ignores unknown fields and uses defaults for missing fields.

**BbjSettingsComponent.java changes:**
1. Add a new field: `private final JBTextField emUrlField;`
2. In the constructor, create the field:
   ```java
   emUrlField = new JBTextField();
   emUrlField.getEmptyText().setText("http://localhost:8888");
   ```
3. REMOVE `emUsernameField` and `emPasswordField` fields and their initialization.
4. In the form builder, replace the "Run Commands" section. Change:
   ```java
   .addComponent(new TitledSeparator("Run Commands"))
   .addLabeledComponent(new JBLabel("EM Username:"), emUsernameField, 1, false)
   .addLabeledComponent(new JBLabel("EM Password:"), emPasswordField, 1, false)
   .addComponent(autoSaveCheckbox)
   ```
   To:
   ```java
   .addComponent(new TitledSeparator("Enterprise Manager"))
   .addLabeledComponent(new JBLabel("EM URL:"), emUrlField, 1, false)

   .addComponent(new TitledSeparator("Run Commands"))
   .addComponent(autoSaveCheckbox)
   ```
5. REMOVE `getEmUsername()`, `setEmUsername()`, `getEmPassword()`, `setEmPassword()` methods.
6. Add new getter/setter:
   ```java
   public @NotNull String getEmUrl() {
       return emUrlField.getText().trim();
   }
   public void setEmUrl(@NotNull String url) {
       emUrlField.setText(url);
   }
   ```

**BbjSettingsConfigurable.java changes:**
1. In `isModified()`:
   - REMOVE the emUsername and emPassword comparisons
   - ADD: `|| !Objects.equals(myComponent.getEmUrl(), state.emUrl)`
2. In `apply()`:
   - REMOVE: `state.emUsername = ...` and `state.emPassword = ...`
   - ADD: `state.emUrl = myComponent.getEmUrl();`
3. In `reset()`:
   - REMOVE the emUsername/emPassword loading lines
   - ADD:
   ```java
   myComponent.setEmUrl(state.emUrl != null ? state.emUrl : "");
   ```

**BbjRunBuiAction.java changes:**
Replace the username/password credential retrieval with JWT token retrieval:
1. Remove:
   ```java
   String username = state.emUsername != null ? state.emUsername : "admin";
   String password = state.emPassword != null ? state.emPassword : "admin123";
   ```
2. Add token retrieval with login prompt:
   ```java
   String token = BbjEMTokenStore.getToken();
   if (token == null || token.isEmpty()) {
       // Prompt user to login
       int result = Messages.showYesNoDialog(
           project,
           "EM login required for BUI. Login now?",
           "Enterprise Manager Login Required",
           Messages.getQuestionIcon()
       );
       if (result == Messages.YES) {
           // Trigger EM login action
           com.intellij.openapi.actionSystem.ActionManager.getInstance()
               .getAction("bbj.loginEM")
               .actionPerformed(/* create AnActionEvent */);
           // Retry token retrieval
           token = BbjEMTokenStore.getToken();
       }
       if (token == null || token.isEmpty()) {
           logError(project, "EM login required for BUI run");
           return null;
       }
   }
   ```
   ACTUALLY, triggering an action programmatically is complex. Simpler approach: just show the error and instruct the user to login first:
   ```java
   String token = BbjEMTokenStore.getToken();
   if (token == null || token.isEmpty()) {
       logError(project, "Please run 'Login to Enterprise Manager' from the Tools menu first");
       return null;
   }
   ```
3. In the command line builder, replace username/password parameters with the token:
   - Keep the same parameter positions for backward compatibility, but:
   - Pass empty strings for username/password positions (params 5, 6)
   - Add token as param 8:
   ```java
   cmd.addParameter("");  // username placeholder
   cmd.addParameter("");  // password placeholder
   cmd.addParameter(classpath);
   cmd.addParameter(token);  // JWT token
   ```

**BbjRunDwcAction.java changes:**
Apply the exact same changes as BbjRunBuiAction (replace username/password with token retrieval, add token to command line).

Add the necessary import to both run action files:
```java
import com.basis.bbj.intellij.actions.BbjEMTokenStore;
```
  </action>
  <verify>
1. `grep -c "emUsername\|emPassword" bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java` returns 0
2. `grep -c "emUsername\|emPassword" bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java` returns 0
3. `grep "emUrl" bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java` returns a match
4. `grep "BbjEMTokenStore" bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunBuiAction.java` returns a match
5. `grep "BbjEMTokenStore" bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunDwcAction.java` returns a match
  </verify>
  <done>
IntelliJ settings have EM URL field, no username/password fields. BUI/DWC run actions retrieve JWT from PasswordSafe and pass to web.bbj as token parameter. Users are prompted to login when no token is stored.
  </done>
</task>

</tasks>

<verification>
1. BbjEMTokenStore.java uses PasswordSafe for JWT storage
2. BbjEMLoginAction.java launches em-login.bbj and stores result
3. plugin.xml registers Login to EM action
4. BbjSettings.State has emUrl, no emUsername/emPassword
5. BbjSettingsComponent has EM URL field, no username/password fields
6. BbjRunBuiAction and BbjRunDwcAction use BbjEMTokenStore.getToken()
7. Run command lines pass token as param 8 to web.bbj
</verification>

<success_criteria>
- "Login to Enterprise Manager" action appears in IntelliJ Tools menu
- Login prompts for credentials, launches em-login.bbj, stores JWT in PasswordSafe
- BUI/DWC run actions retrieve JWT from PasswordSafe
- No plaintext EM passwords in IntelliJ settings
- EM URL field visible in IntelliJ BBj settings page
- Run commands fail gracefully with login prompt when no token stored
</success_criteria>

<output>
After completion, create `.planning/phases/31-extension-settings-file-types/31-04-SUMMARY.md`
</output>
