---
phase: 31-extension-settings-file-types
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
  - bbj-intellij/src/main/resources/textmate/bbj-bundle/package.json
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbxConfigFileType.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServerFactory.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjJavaInteropService.java
autonomous: true

must_haves:
  truths:
    - "Opening a .bbx file in IntelliJ shows the BBj icon and provides BBj language features"
    - "The IntelliJ BBj settings page has an editable host field for java-interop connection"
    - "Setting a non-localhost host in IntelliJ BBj settings changes where health checks probe"
    - "Default interop connection is localhost:5008 when no settings are configured"
    - "The IntelliJ BBj settings page has a config.bbx path field that overrides the default location"
  artifacts:
    - path: "bbj-intellij/src/main/resources/META-INF/plugin.xml"
      provides: ".bbx merged into BBj fileType, BbxConfigFileType removed"
      contains: "extensions=\"bbj;bbl;bbjt;src;bbx\""
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java"
      provides: "javaInteropHost and configPath fields in State"
      contains: "javaInteropHost"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java"
      provides: "Editable host text field and config path field in settings UI"
      contains: "javaInteropHostField"
  key_links:
    - from: "BbjSettings.java"
      to: "BbjLanguageServerFactory.java"
      via: "initializationOptions includes javaInteropHost and configPath from settings"
      pattern: "javaInteropHost|configPath"
    - from: "BbjSettings.java"
      to: "BbjJavaInteropService.java"
      via: "Health check reads host from settings"
      pattern: "javaInteropHost"
---

<objective>
Merge .bbx into the BBj file type in IntelliJ (same icon, language features, run commands), add java-interop host configurability, and add config.bbx path setting to the settings page.

Purpose: Delivers IDE-01 (.bbx treated as BBj), CONF-01 (config.bbx path configurable), and CONF-02 (configurable interop host) for IntelliJ.
Output: .bbx files get full BBj treatment in IntelliJ; java-interop host and config.bbx path are configurable alongside the existing port field.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-extension-settings-file-types/31-CONTEXT.md
@.planning/phases/31-extension-settings-file-types/31-RESEARCH.md
@bbj-intellij/src/main/resources/META-INF/plugin.xml
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjFileType.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbxConfigFileType.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServerFactory.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjJavaInteropService.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Merge .bbx into BBj file type in IntelliJ</name>
  <files>
    bbj-intellij/src/main/resources/META-INF/plugin.xml
    bbj-intellij/src/main/resources/textmate/bbj-bundle/package.json
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbxConfigFileType.java
  </files>
  <action>
**plugin.xml changes:**
1. In the first `<fileType>` element (name="BBj"), change `extensions="bbj;bbl;bbjt;src"` to `extensions="bbj;bbl;bbjt;src;bbx"`.

2. REMOVE the entire second `<fileType>` element:
   ```xml
   <fileType
       name="BBx Config"
       implementationClass="com.basis.bbj.intellij.BbxConfigFileType"
       fieldName="INSTANCE"
       language="BBj"
       extensions="bbx"/>
   ```

3. In the `<extensions defaultExtensionNs="com.redhat.devtools.lsp4ij">` section, REMOVE the second `<languageMapping>` entry:
   ```xml
   <languageMapping language="BBj"
                    serverId="bbjLanguageServer"
                    languageId="bbx"
                    fileType="BBx Config"/>
   ```
   The first languageMapping (languageId="bbj") will handle all BBj files including .bbx. Actually, check if LSP4IJ needs the languageId to match what the language server expects. The LS uses "bbj" as the language ID, so .bbx files (now registered as BBj language) will be sent with languageId "bbj" — which is correct.

**TextMate bundle package.json changes:**
In `bbj-intellij/src/main/resources/textmate/bbj-bundle/package.json`:
1. In `contributes.languages`, add ".bbx" to the BBj language extensions: `[".bbj", ".bbl", ".bbjt", ".src", ".bbx"]`
2. REMOVE the second language entry (id: "BBx", extensions: [".bbx"])
3. In `contributes.grammars`, REMOVE the second grammar entry (language: "BBx", scopeName: "source.bbx")

**BbxConfigFileType.java:**
DELETE this file entirely. It's no longer needed since .bbx is now part of BbjFileType.

NOTE: After deletion, check that no other Java files import or reference `BbxConfigFileType`. Search for `BbxConfigFileType` in all Java files under bbj-intellij/src. If any references exist (unlikely since plugin.xml was the main consumer), update them.
  </action>
  <verify>
1. `grep -r "BbxConfigFileType" bbj-intellij/src/` returns no results
2. `grep "bbx" bbj-intellij/src/main/resources/META-INF/plugin.xml` shows bbx only in the BBj fileType extensions attribute
3. The TextMate bundle package.json has only one language entry with .bbx in extensions
  </verify>
  <done>.bbx files are registered under the BBj file type in IntelliJ — same icon, same language server mapping, no separate BbxConfigFileType.</done>
</task>

<task type="auto">
  <name>Task 2: Add interop host to IntelliJ settings and update connection code</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServerFactory.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjJavaInteropService.java
  </files>
  <action>
**BbjSettings.java changes:**
1. Add `public String javaInteropHost = "localhost";` to the `State` class, right before the existing `javaInteropPort` field. Default is "localhost" which resolves to 127.0.0.1 for TCP connections.
2. Add `public String configPath = "";` to the `State` class. When empty/blank, the language server uses the default `{bbjHome}/cfg/config.bbx`. When set, the language server uses this path instead.

**BbjSettingsComponent.java changes:**
1. Add new fields:
   ```java
   private final JBTextField javaInteropHostField;
   private final JBTextField configPathField;
   ```

2. In the constructor, create and initialize the fields:
   ```java
   javaInteropHostField = new JBTextField();
   javaInteropHostField.setText("localhost");

   configPathField = new JBTextField();
   configPathField.getEmptyText().setText("{BBj Home}/cfg/config.bbx (default)");
   ```

3. In the form builder, add the config path field in the BBj section (before Java Interop) and replace the static `new JBLabel("localhost")` host label with the new editable field:
   ```java
   .addLabeledComponent(new JBLabel("config.bbx Path:"), configPathField, 1, false)
   .addComponent(new TitledSeparator("Java Interop"))
   .addLabeledComponent(new JBLabel("Host:"), javaInteropHostField, 1, false)
   .addLabeledComponent(new JBLabel("Port:"), javaInteropPortField, 1, false)
   ```

4. Add getter/setter methods:
   ```java
   public @NotNull String getJavaInteropHost() {
       return javaInteropHostField.getText().trim();
   }

   public void setJavaInteropHost(@NotNull String host) {
       javaInteropHostField.setText(host);
   }

   public @NotNull String getConfigPath() {
       return configPathField.getText().trim();
   }

   public void setConfigPath(@NotNull String path) {
       configPathField.setText(path);
   }
   ```

**BbjSettingsConfigurable.java changes:**
1. In `isModified()`, add:
   - `|| !Objects.equals(myComponent.getJavaInteropHost(), state.javaInteropHost)`
   - `|| !Objects.equals(myComponent.getConfigPath(), state.configPath)`

2. In `apply()`, add:
   - `state.javaInteropHost = myComponent.getJavaInteropHost();`
   - `state.configPath = myComponent.getConfigPath();`

3. In `reset()`, add after the java-interop port loading section:
   ```java
   String javaInteropHost = state.javaInteropHost;
   if (javaInteropHost == null || javaInteropHost.isEmpty()) {
       javaInteropHost = "localhost";
   }
   myComponent.setJavaInteropHost(javaInteropHost);
   myComponent.setConfigPath(state.configPath != null ? state.configPath : "");
   ```

**BbjLanguageServerFactory.java changes:**
In the `initializeParams` method:
1. Change the hardcoded host:
   ```java
   options.addProperty("javaInteropHost",
       state.javaInteropHost != null && !state.javaInteropHost.isEmpty()
           ? state.javaInteropHost : "localhost");
   ```
   This was previously `options.addProperty("javaInteropHost", "127.0.0.1")` — now it reads from settings.

2. Add the configPath property:
   ```java
   options.addProperty("configPath",
       state.configPath != null ? state.configPath : "");
   ```
   This passes the config.bbx path override to the language server.

**BbjJavaInteropService.java changes:**
In the `checkConnection()` method, update the health check to read host from settings alongside the port:
```java
int port = BbjSettings.getInstance().getState().javaInteropPort;
String host = BbjSettings.getInstance().getState().javaInteropHost;
if (host == null || host.isEmpty()) host = "localhost";
```
Then change the `InetSocketAddress` to use the configurable host:
```java
socket.connect(new InetSocketAddress(host, port), TCP_TIMEOUT_MS);
```
This was previously hardcoded to `"127.0.0.1"`.
  </action>
  <verify>
1. `grep -r "javaInteropHost" bbj-intellij/src/` returns results in BbjSettings, BbjSettingsComponent, BbjSettingsConfigurable, BbjLanguageServerFactory, and BbjJavaInteropService
2. `grep '"127.0.0.1"' bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjJavaInteropService.java` returns no results (no more hardcoded IP)
3. `grep 'new JBLabel("localhost")' bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java` returns no results (replaced with editable field)
  </verify>
  <done>
IntelliJ BBj settings page has an editable host field alongside the port field. BbjLanguageServerFactory passes configurable host in initializationOptions. BbjJavaInteropService health checks use configurable host. Default remains localhost:5008.
  </done>
</task>

</tasks>

<verification>
1. No references to BbxConfigFileType remain in the codebase
2. plugin.xml BBj fileType includes bbx in extensions list
3. TextMate bundle has single language entry with .bbx
4. BbjSettings.State has javaInteropHost field with "localhost" default and configPath field
5. BbjSettingsComponent has editable host field (not static label) and config path field
6. BbjLanguageServerFactory reads host and configPath from settings, not hardcoded
7. BbjJavaInteropService health checks use host from settings
8. No hardcoded "127.0.0.1" in BbjJavaInteropService
9. BbjLanguageServerFactory passes configPath in initializationOptions
</verification>

<success_criteria>
- .bbx files in IntelliJ are recognized as BBj with BBj icon and full language server features
- IntelliJ BBj settings page shows editable Host, Port, and config.bbx Path fields
- Changing host/port in settings affects where the health check probes and what the LS receives
- Setting config.bbx Path sends the override to the language server via initializationOptions
- Default behavior (empty/unset host) uses localhost:5008; empty config path uses bbjdir/cfg/config.bbx
</success_criteria>

<output>
After completion, create `.planning/phases/31-extension-settings-file-types/31-02-SUMMARY.md`
</output>
