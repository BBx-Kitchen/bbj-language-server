---
phase: 31-extension-settings-file-types
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
  - bbj-intellij/src/main/resources/textmate/bbj-bundle/package.json
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbxConfigFileType.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServerFactory.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjJavaInteropService.java
autonomous: true

must_haves:
  truths:
    - "Opening a .bbx file in IntelliJ shows the BBj icon and provides BBj language features"
    - "The IntelliJ BBj settings page has an editable host field for java-interop connection"
    - "Setting a non-localhost host in IntelliJ BBj settings changes where health checks probe"
    - "Default interop connection is localhost:5008 when no settings are configured"
  artifacts:
    - path: "bbj-intellij/src/main/resources/META-INF/plugin.xml"
      provides: ".bbx merged into BBj fileType, BbxConfigFileType removed"
      contains: "extensions=\"bbj;bbl;bbjt;src;bbx\""
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java"
      provides: "javaInteropHost field in State"
      contains: "javaInteropHost"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java"
      provides: "Editable host text field in settings UI"
      contains: "javaInteropHostField"
  key_links:
    - from: "BbjSettings.java"
      to: "BbjLanguageServerFactory.java"
      via: "initializationOptions includes javaInteropHost from settings"
      pattern: "javaInteropHost"
    - from: "BbjSettings.java"
      to: "BbjJavaInteropService.java"
      via: "Health check reads host from settings"
      pattern: "javaInteropHost"
---

<objective>
Merge .bbx into the BBj file type in IntelliJ (same icon, language features, run commands) and add java-interop host configurability to the settings page.

Purpose: Delivers IDE-01 (.bbx treated as BBj) and CONF-02 (configurable interop host) for IntelliJ.
Output: .bbx files get full BBj treatment in IntelliJ; java-interop host is configurable alongside the existing port field.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-extension-settings-file-types/31-CONTEXT.md
@.planning/phases/31-extension-settings-file-types/31-RESEARCH.md
@bbj-intellij/src/main/resources/META-INF/plugin.xml
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjFileType.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbxConfigFileType.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServerFactory.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjJavaInteropService.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Merge .bbx into BBj file type in IntelliJ</name>
  <files>
    bbj-intellij/src/main/resources/META-INF/plugin.xml
    bbj-intellij/src/main/resources/textmate/bbj-bundle/package.json
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbxConfigFileType.java
  </files>
  <action>
**plugin.xml changes:**
1. In the first `<fileType>` element (name="BBj"), change `extensions="bbj;bbl;bbjt;src"` to `extensions="bbj;bbl;bbjt;src;bbx"`.

2. REMOVE the entire second `<fileType>` element:
   ```xml
   <fileType
       name="BBx Config"
       implementationClass="com.basis.bbj.intellij.BbxConfigFileType"
       fieldName="INSTANCE"
       language="BBj"
       extensions="bbx"/>
   ```

3. In the `<extensions defaultExtensionNs="com.redhat.devtools.lsp4ij">` section, REMOVE the second `<languageMapping>` entry:
   ```xml
   <languageMapping language="BBj"
                    serverId="bbjLanguageServer"
                    languageId="bbx"
                    fileType="BBx Config"/>
   ```
   The first languageMapping (languageId="bbj") will handle all BBj files including .bbx. Actually, check if LSP4IJ needs the languageId to match what the language server expects. The LS uses "bbj" as the language ID, so .bbx files (now registered as BBj language) will be sent with languageId "bbj" — which is correct.

**TextMate bundle package.json changes:**
In `bbj-intellij/src/main/resources/textmate/bbj-bundle/package.json`:
1. In `contributes.languages`, add ".bbx" to the BBj language extensions: `[".bbj", ".bbl", ".bbjt", ".src", ".bbx"]`
2. REMOVE the second language entry (id: "BBx", extensions: [".bbx"])
3. In `contributes.grammars`, REMOVE the second grammar entry (language: "BBx", scopeName: "source.bbx")

**BbxConfigFileType.java:**
DELETE this file entirely. It's no longer needed since .bbx is now part of BbjFileType.

NOTE: After deletion, check that no other Java files import or reference `BbxConfigFileType`. Search for `BbxConfigFileType` in all Java files under bbj-intellij/src. If any references exist (unlikely since plugin.xml was the main consumer), update them.
  </action>
  <verify>
1. `grep -r "BbxConfigFileType" bbj-intellij/src/` returns no results
2. `grep "bbx" bbj-intellij/src/main/resources/META-INF/plugin.xml` shows bbx only in the BBj fileType extensions attribute
3. The TextMate bundle package.json has only one language entry with .bbx in extensions
  </verify>
  <done>.bbx files are registered under the BBj file type in IntelliJ — same icon, same language server mapping, no separate BbxConfigFileType.</done>
</task>

<task type="auto">
  <name>Task 2: Add interop host to IntelliJ settings and update connection code</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServerFactory.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjJavaInteropService.java
  </files>
  <action>
**BbjSettings.java changes:**
Add `public String javaInteropHost = "localhost";` to the `State` class, right before the existing `javaInteropPort` field. Default is "localhost" which resolves to 127.0.0.1 for TCP connections.

**BbjSettingsComponent.java changes:**
1. Add a new field: `private final JBTextField javaInteropHostField;`

2. In the constructor, create and initialize the field:
   ```java
   javaInteropHostField = new JBTextField();
   javaInteropHostField.setText("localhost");
   ```

3. In the form builder, change the Java Interop section. Replace the static `new JBLabel("localhost")` host label with the new editable field:
   ```java
   .addComponent(new TitledSeparator("Java Interop"))
   .addLabeledComponent(new JBLabel("Host:"), javaInteropHostField, 1, false)
   .addLabeledComponent(new JBLabel("Port:"), javaInteropPortField, 1, false)
   ```

4. Add getter/setter methods:
   ```java
   public @NotNull String getJavaInteropHost() {
       return javaInteropHostField.getText().trim();
   }

   public void setJavaInteropHost(@NotNull String host) {
       javaInteropHostField.setText(host);
   }
   ```

**BbjSettingsConfigurable.java changes:**
1. In `isModified()`, add: `|| !Objects.equals(myComponent.getJavaInteropHost(), state.javaInteropHost)`

2. In `apply()`, add: `state.javaInteropHost = myComponent.getJavaInteropHost();`

3. In `reset()`, add after the java-interop port loading section:
   ```java
   String javaInteropHost = state.javaInteropHost;
   if (javaInteropHost == null || javaInteropHost.isEmpty()) {
       javaInteropHost = "localhost";
   }
   myComponent.setJavaInteropHost(javaInteropHost);
   ```

**BbjLanguageServerFactory.java changes:**
In the `initializeParams` method, change the hardcoded host:
```java
options.addProperty("javaInteropHost",
    state.javaInteropHost != null && !state.javaInteropHost.isEmpty()
        ? state.javaInteropHost : "localhost");
```
This was previously `options.addProperty("javaInteropHost", "127.0.0.1")` — now it reads from settings.

**BbjJavaInteropService.java changes:**
In the `checkConnection()` method, update the health check to read host from settings alongside the port:
```java
int port = BbjSettings.getInstance().getState().javaInteropPort;
String host = BbjSettings.getInstance().getState().javaInteropHost;
if (host == null || host.isEmpty()) host = "localhost";
```
Then change the `InetSocketAddress` to use the configurable host:
```java
socket.connect(new InetSocketAddress(host, port), TCP_TIMEOUT_MS);
```
This was previously hardcoded to `"127.0.0.1"`.
  </action>
  <verify>
1. `grep -r "javaInteropHost" bbj-intellij/src/` returns results in BbjSettings, BbjSettingsComponent, BbjSettingsConfigurable, BbjLanguageServerFactory, and BbjJavaInteropService
2. `grep '"127.0.0.1"' bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjJavaInteropService.java` returns no results (no more hardcoded IP)
3. `grep 'new JBLabel("localhost")' bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java` returns no results (replaced with editable field)
  </verify>
  <done>
IntelliJ BBj settings page has an editable host field alongside the port field. BbjLanguageServerFactory passes configurable host in initializationOptions. BbjJavaInteropService health checks use configurable host. Default remains localhost:5008.
  </done>
</task>

</tasks>

<verification>
1. No references to BbxConfigFileType remain in the codebase
2. plugin.xml BBj fileType includes bbx in extensions list
3. TextMate bundle has single language entry with .bbx
4. BbjSettings.State has javaInteropHost field with "localhost" default
5. BbjSettingsComponent has editable host field (not static label)
6. BbjLanguageServerFactory reads host from settings, not hardcoded
7. BbjJavaInteropService health checks use host from settings
8. No hardcoded "127.0.0.1" in BbjJavaInteropService
</verification>

<success_criteria>
- .bbx files in IntelliJ are recognized as BBj with BBj icon and full language server features
- IntelliJ BBj settings page shows editable Host and Port fields under Java Interop section
- Changing host/port in settings affects where the health check probes and what the LS receives
- Default behavior (empty/unset host) uses localhost:5008
</success_criteria>

<output>
After completion, create `.planning/phases/31-extension-settings-file-types/31-02-SUMMARY.md`
</output>
