---
phase: 31-extension-settings-file-types
plan: 03
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - bbj-vscode/tools/em-login.bbj
  - bbj-vscode/tools/web.bbj
  - bbj-vscode/package.json
  - bbj-vscode/src/extension.ts
  - bbj-vscode/src/Commands/Commands.cjs
autonomous: true

must_haves:
  truths:
    - "Running 'BBj: Login to EM' command in VS Code prompts for EM URL if not configured, then launches BBj login stub and stores the returned JWT securely"
    - "BUI and DWC run commands in VS Code use the stored JWT token instead of plaintext username/password"
    - "If no JWT is stored when a BUI/DWC run is triggered, the user is prompted to log in first"
    - "No plaintext passwords are stored in VS Code settings after migration"
    - "The bbj.em.url setting is visible in VS Code settings"
  artifacts:
    - path: "bbj-vscode/tools/em-login.bbj"
      provides: "BBj stub program that authenticates via BBjAdminFactory and prints JWT to stdout"
    - path: "bbj-vscode/package.json"
      provides: "bbj.em.url setting and bbj.loginEM command registration"
      contains: "bbj.em.url"
    - path: "bbj-vscode/src/extension.ts"
      provides: "Login to EM command implementation using SecretStorage"
      contains: "loginEM"
  key_links:
    - from: "bbj-vscode/src/extension.ts"
      to: "bbj-vscode/tools/em-login.bbj"
      via: "child_process exec to launch BBj with em-login.bbj stub"
    - from: "bbj-vscode/src/extension.ts"
      to: "VS Code SecretStorage"
      via: "context.secrets.store/get for JWT"
    - from: "bbj-vscode/src/Commands/Commands.cjs"
      to: "bbj-vscode/src/extension.ts"
      via: "getEMToken callback for run commands"
---

<objective>
Create the BBj login stub program and implement JWT-based EM authentication in VS Code using SecretStorage. Remove plaintext EM credentials from settings and update BUI/DWC run commands to use JWT.

Purpose: Delivers CONF-03 (token-based EM auth) for VS Code. Eliminates the security tech debt of plaintext EM passwords in settings.
Output: em-login.bbj stub, VS Code "BBj: Login to EM" command, SecretStorage-backed JWT, updated run commands.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-extension-settings-file-types/31-CONTEXT.md
@.planning/phases/31-extension-settings-file-types/31-RESEARCH.md
@.planning/phases/31-extension-settings-file-types/31-01-SUMMARY.md
@bbj-vscode/tools/web.bbj
@bbj-vscode/src/extension.ts
@bbj-vscode/src/Commands/Commands.cjs
@bbj-vscode/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create em-login.bbj stub and update web.bbj to accept token</name>
  <files>
    bbj-vscode/tools/em-login.bbj
    bbj-vscode/tools/web.bbj
  </files>
  <action>
**Create em-login.bbj:**

Create a new BBj program `bbj-vscode/tools/em-login.bbj` that:
1. Accepts command line parameters: username, password (from a login dialog or passed directly)
2. Calls `BBjAdminFactory.getBBjAdmin(username!, password!)` to authenticate
3. Gets the auth token via `admin!.getAuthToken()` (this is the BBj Admin API method for JWT)
4. Prints the token to stdout using `PRINT` so the calling IDE can capture it
5. Handles errors gracefully (e.g., bad credentials) by printing an error prefix like "ERROR:" followed by the message

Pattern (following web.bbj conventions):
```bbj
rem BBj EM Login Stub - Authenticates and returns JWT token
rem Parameters:
rem   1) username
rem   2) password

? 'HIDE'

username! = ARGV(1,err=*next)
password! = ARGV(2,err=*next)

if (username! = null()) then
    print "ERROR:Username required"
    release
fi
if (password! = null()) then
    print "ERROR:Password required"
    release
fi

rem Authenticate and get token
admin! = BBjAdminFactory.getBBjAdmin(username!, password!, err=authFailed)
token! = admin!.getAuthToken()
print token!
release

authFailed:
print "ERROR:Authentication failed - invalid credentials"
release
```

NOTE: The exact BBj Admin API method for getting a JWT may differ. The research indicates `getAuthToken()` but this may need adjustment. Use the pattern from the existing `getBBjAdmin()` call in web.bbj as a guide. If `getAuthToken()` doesn't exist, try `admin!.getToken()` or similar. The executor should check BBj Admin API javadoc if available in the bbjdir.

**Update web.bbj:**

The existing web.bbj takes username and password as params 5 and 6. Update it to ALSO accept a token as an alternative. The approach:

1. Add a new optional parameter (param 8) for the auth token:
   ```bbj
   token! = ARGV(8,err=*next)
   ```

2. Change the authentication logic to prefer token if provided:
   ```bbj
   if (token! <> null() and token! > "") then
       rem Token-based auth
       admin! = BBjAdminFactory.getBBjAdmin(token!)
   else
       rem Legacy username/password auth (backwards compatible)
       if (username! = null()) username! = "admin"
       if (password! = null()) password! = "admin123"
       admin! = BBjAdminFactory.getBBjAdmin(username!, password!)
   fi
   ```

IMPORTANT: Check if `BBjAdminFactory.getBBjAdmin()` has an overload that accepts a token. If not, there may be a different factory method like `BBjAdminFactory.getBBjAdminFromToken(token!)`. The executor should check the BBj API. If no token-based factory method exists, keep the web.bbj using username/password for now and note this as a limitation — the em-login.bbj stub still provides value by obtaining the token for future EM API calls even if the run command still needs username/password internally.
  </action>
  <verify>
1. File `bbj-vscode/tools/em-login.bbj` exists and contains BBjAdminFactory authentication code
2. File `bbj-vscode/tools/web.bbj` handles token parameter (param 8) with fallback to username/password
  </verify>
  <done>
em-login.bbj stub authenticates and prints JWT to stdout. web.bbj accepts optional token parameter with backward-compatible fallback to username/password.
  </done>
</task>

<task type="auto">
  <name>Task 2: VS Code EM auth -- settings, login command, SecretStorage, run command updates</name>
  <files>
    bbj-vscode/package.json
    bbj-vscode/src/extension.ts
    bbj-vscode/src/Commands/Commands.cjs
  </files>
  <action>
**package.json changes:**

1. Add new setting `bbj.em.url`:
   ```json
   "bbj.em.url": {
       "type": ["string", "null"],
       "default": null,
       "description": "Enterprise Manager URL (e.g., http://localhost:8888). Used for EM login and web-based run commands.",
       "scope": "window"
   }
   ```

2. REMOVE the plaintext credential settings:
   - Remove `bbj.web.username`
   - Remove `bbj.web.password`

   NOTE: Keep `bbj.web.apps` and `bbj.web.AutoSaveUponRun` since those aren't credentials.

3. Add new command in `contributes.commands`:
   ```json
   {
       "category": "BBj",
       "command": "bbj.loginEM",
       "title": "Login to Enterprise Manager"
   }
   ```

4. Add `"onCommand:bbj.loginEM"` to `activationEvents`.

**extension.ts changes:**

1. Register the new login command. Implementation:
   ```typescript
   vscode.commands.registerCommand("bbj.loginEM", async () => {
       const config = vscode.workspace.getConfiguration("bbj");
       const bbjHome = config.get<string>("home");

       if (!bbjHome) {
           vscode.window.showErrorMessage("Please set bbj.home first", "Open Settings").then(sel => {
               if (sel === "Open Settings") {
                   vscode.commands.executeCommand('workbench.action.openSettings', 'bbj.home');
               }
           });
           return;
       }

       // Prompt for credentials
       const username = await vscode.window.showInputBox({
           prompt: "EM Username",
           value: "admin",
           ignoreFocusOut: true
       });
       if (!username) return;

       const password = await vscode.window.showInputBox({
           prompt: "EM Password",
           password: true,
           ignoreFocusOut: true
       });
       if (password === undefined) return;

       // Launch em-login.bbj to get JWT
       const bbj = path.join(bbjHome, 'bin', `bbj${process.platform === 'win32' ? '.exe' : ''}`);
       const emLoginPath = context.asAbsolutePath(path.join('tools', 'em-login.bbj'));

       try {
           const result = await new Promise<string>((resolve, reject) => {
               const { exec } = require('child_process');
               exec(`"${bbj}" -q "${emLoginPath}" - "${username}" "${password}"`,
                   { timeout: 15000 },
                   (err: any, stdout: string, stderr: string) => {
                       if (err) {
                           reject(new Error(stderr || err.message));
                           return;
                       }
                       const output = stdout.trim();
                       if (output.startsWith('ERROR:')) {
                           reject(new Error(output.substring(6)));
                           return;
                       }
                       resolve(output);
                   }
               );
           });

           // Store JWT in SecretStorage
           await context.secrets.store('bbj.em.token', result);
           vscode.window.showInformationMessage('Successfully logged in to Enterprise Manager');
       } catch (error) {
           vscode.window.showErrorMessage(`EM login failed: ${error}`);
       }
   });
   ```

2. Export a function `getEMToken` that Commands.cjs can use:
   Create a module-level variable to hold the secrets reference and a getter:
   ```typescript
   let secretStorage: vscode.SecretStorage;

   export async function getEMToken(): Promise<string | undefined> {
       return secretStorage?.get('bbj.em.token');
   }
   ```
   Set `secretStorage = context.secrets` in activate().

3. Export the `getEMToken` function so Commands.cjs can import it.

**Commands.cjs changes:**

1. In the `runWeb` function, replace the username/password retrieval with token retrieval:
   - Instead of reading `bbj.web.username` and `bbj.web.password` from settings, get the token.
   - Since Commands.cjs is a CommonJS file and can't easily await the async getEMToken, use a different approach:
     - Pass the token as a parameter to runWeb from extension.ts
     - OR: Modify the runWeb function to accept a token parameter

   The simplest approach: Modify the `run`, `runBUI`, and `runDWC` exports in Commands.cjs to accept a `getToken` callback parameter. Then in extension.ts where these commands are registered, pass the token retrieval function.

   In extension.ts, change the command registrations:
   ```typescript
   vscode.commands.registerCommand("bbj.run", Commands.run);  // GUI doesn't use EM - no change needed

   vscode.commands.registerCommand("bbj.runBUI", async (params) => {
       const token = await getEMToken();
       if (!token) {
           // Auto-prompt login
           await vscode.commands.executeCommand('bbj.loginEM');
           const freshToken = await getEMToken();
           if (!freshToken) return; // User cancelled login
       }
       Commands.runBUI(params, token);
   });
   ```

   Wait, looking at the existing code more carefully: Commands.cjs runWeb takes `(params, client)` where client is "BUI" or "DWC". The run/runBUI/runDWC exports call runWeb internally. The simplest fix:

   a. Add a `token` parameter to `runWeb(params, client, token)`.
   b. When token is provided, pass it as ARGV(8) to web.bbj. When not, fall back to reading username/password from config (for backwards compatibility during transition).
   c. In extension.ts, wrap the BUI/DWC command registrations to get the token and auto-prompt login if missing.

   For the `bbj.run` (GUI) command — it doesn't use web.bbj, so no EM auth needed. Only BUI and DWC go through web.bbj.

   In Commands.cjs, update `runWeb`:
   - Accept optional 3rd parameter `token`
   - If token is provided, add it as an extra argument to the command line
   - If token is not provided, use username/password from config (backwards compatible)

   In extension.ts, wrap the BUI and DWC command registrations:
   ```typescript
   vscode.commands.registerCommand("bbj.runBUI", async (params) => {
       let token = await getEMToken();
       if (!token) {
           const login = await vscode.window.showInformationMessage(
               'EM login required for BUI. Login now?', 'Login', 'Cancel'
           );
           if (login === 'Login') {
               await vscode.commands.executeCommand('bbj.loginEM');
               token = await getEMToken();
           }
           if (!token) return;
       }
       Commands.runBUI(params, token);
   });
   ```

   And update Commands.cjs exports to pass token through:
   ```javascript
   module.exports = {
       // ...
       runBUI: (params, token) => runWeb(params, "BUI", token),
       runDWC: (params, token) => runWeb(params, "DWC", token),
       // ...
   };
   ```
  </action>
  <verify>
1. `node -e "const p = require('./bbj-vscode/package.json'); console.log(p.contributes.configuration.properties['bbj.em.url']); console.log(p.contributes.configuration.properties['bbj.web.username'])"` — em.url exists, web.username is undefined
2. `grep -c "loginEM" bbj-vscode/src/extension.ts` returns >= 2 (registration + implementation)
3. `grep -c "SecretStorage\|secrets" bbj-vscode/src/extension.ts` returns >= 1
4. `grep -c "web\.username\|web\.password" bbj-vscode/package.json` returns 0 (removed)
5. `grep "getEMToken\|token" bbj-vscode/src/Commands/Commands.cjs` — token handling present
  </verify>
  <done>
VS Code has bbj.em.url setting, "BBj: Login to EM" command with SecretStorage JWT storage, and BUI/DWC run commands use JWT with auto-prompt login. Plaintext EM credentials removed from settings.
  </done>
</task>

</tasks>

<verification>
1. em-login.bbj exists in tools/ directory with BBjAdminFactory auth
2. web.bbj accepts optional token parameter (backward compatible)
3. package.json has bbj.em.url, bbj.loginEM command, no bbj.web.username/password
4. extension.ts registers loginEM command with SecretStorage
5. Commands.cjs runWeb accepts and passes token to web.bbj
6. BUI/DWC commands auto-prompt login if no token stored
7. TypeScript compiles: `npx tsc --noEmit -p bbj-vscode/tsconfig.json`
</verification>

<success_criteria>
- "BBj: Login to EM" command prompts for credentials, launches em-login.bbj, stores JWT in SecretStorage
- BUI/DWC run commands retrieve JWT from SecretStorage and pass to web.bbj
- If no JWT stored, user is prompted to log in before BUI/DWC run
- No plaintext passwords in VS Code settings
- bbj.em.url setting available in VS Code settings
</success_criteria>

<output>
After completion, create `.planning/phases/31-extension-settings-file-types/31-03-SUMMARY.md`
</output>
