---
phase: 31-extension-settings-file-types
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/package.json
  - bbj-vscode/src/extension.ts
  - bbj-vscode/src/language/java-interop.ts
  - bbj-vscode/src/language/main.ts
  - bbj-vscode/src/language/bbj-ws-manager.ts
autonomous: true

must_haves:
  truths:
    - "Opening a .bbx file in VS Code shows the BBj icon, syntax highlighting, and completion"
    - "Run commands (GUI/BUI/DWC) appear for .bbx files in editor title bar and context menu"
    - "Setting bbj.interop.host and bbj.interop.port in VS Code settings changes where the language server connects for Java interop"
    - "Default interop connection is localhost:5008 when no settings are configured"
    - "Changing interop host/port settings takes effect without restarting the extension"
  artifacts:
    - path: "bbj-vscode/package.json"
      provides: ".bbx in bbj language extensions; bbj.interop.host and bbj.interop.port settings"
      contains: "bbj.interop.host"
    - path: "bbj-vscode/src/language/java-interop.ts"
      provides: "Configurable host/port for socket connection"
      contains: "setConnectionConfig"
    - path: "bbj-vscode/src/language/main.ts"
      provides: "onDidChangeConfiguration updates interop host/port"
  key_links:
    - from: "bbj-vscode/src/extension.ts"
      to: "bbj-vscode/src/language/main.ts"
      via: "initializationOptions.interopHost and interopPort"
      pattern: "interopHost|interopPort"
    - from: "bbj-vscode/src/language/main.ts"
      to: "bbj-vscode/src/language/java-interop.ts"
      via: "setConnectionConfig or clearCache after config change"
---

<objective>
Merge .bbx into the BBj language in VS Code (same icon, diagnostics, completion, run commands) and make java-interop host/port configurable in VS Code settings with hot reload.

Purpose: Delivers IDE-01 (.bbx treated as BBj) and CONF-02 (configurable interop host/port) for VS Code and the shared language server.
Output: .bbx files get full BBj treatment in VS Code; bbj.interop.host and bbj.interop.port settings are available and take effect immediately.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-extension-settings-file-types/31-CONTEXT.md
@.planning/phases/31-extension-settings-file-types/31-RESEARCH.md
@bbj-vscode/package.json
@bbj-vscode/src/extension.ts
@bbj-vscode/src/language/java-interop.ts
@bbj-vscode/src/language/main.ts
@bbj-vscode/src/language/bbj-ws-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Merge .bbx into BBj language and add interop settings in package.json</name>
  <files>bbj-vscode/package.json</files>
  <action>
1. In the `contributes.languages` array, REMOVE the entire second language entry (id: "bbx") — .bbx files should no longer be a separate language.

2. In the first language entry (id: "bbj"), add ".bbx" to the `extensions` array so it becomes:
   `[".bbj", ".bbl", ".bbjt", ".src", ".bbx"]`

3. In `contributes.grammars`, REMOVE the second grammar entry (language: "bbx", scopeName: "source.bbx"). The .bbx files will now use the same BBj grammar.

4. Add new configuration properties in `contributes.configuration.properties`:
   - `bbj.interop.host`: type string, default "localhost", description "Java interop service hostname. Change this to connect to a remote java-interop instance.", scope "window"
   - `bbj.interop.port`: type number, default 5008, description "Java interop service port number.", scope "window"

5. In the `activationEvents` array, add `"onLanguage:bbx"` removal is NOT needed since .bbx is now part of language "bbj" — but remove any bbx-specific activation if present. Actually, since .bbx is now mapped to "bbj" language, the existing `"onLanguage:bbj"` activation event covers it. No activation event changes needed.

6. In the `editor/context` menu `when` clauses, the conditions already include `resourceLangId == bbx` for run commands. Since .bbx is now mapped to language id "bbj", these `|| resourceLangId == bbx` conditions are no longer needed but are harmless. Leave them for now (they'll just never match since bbx language ID no longer exists, but won't cause errors).

IMPORTANT: Do NOT change the `when` clauses — they currently work for the `bbx` language ID. Since .bbx will now be language `bbj`, the `resourceLangId == bbj` part of the conditions will match. The `|| resourceLangId == bbx` part becomes dead code but causes no harm.
  </action>
  <verify>
Run `node -e "const p = require('./bbj-vscode/package.json'); console.log(p.contributes.languages.length); console.log(p.contributes.languages[0].extensions); console.log(Object.keys(p.contributes.configuration.properties).filter(k => k.includes('interop')))"` and confirm:
- Only 1 language entry
- Extensions include .bbx
- interop.host and interop.port properties exist
  </verify>
  <done>.bbx is part of the BBj language in VS Code (same icon, same grammar). bbj.interop.host and bbj.interop.port are configurable settings.</done>
</task>

<task type="auto">
  <name>Task 2: Make java-interop connection use configurable host/port and update LS config handler</name>
  <files>
    bbj-vscode/src/language/java-interop.ts
    bbj-vscode/src/language/bbj-ws-manager.ts
    bbj-vscode/src/language/main.ts
    bbj-vscode/src/extension.ts
  </files>
  <action>
**java-interop.ts changes:**
1. Add private fields `private interopHost: string = '127.0.0.1'` and `private interopPort: number = 5008` to `JavaInteropService`.

2. Add a public method `setConnectionConfig(host: string, port: number): void` that:
   - Sets `this.interopHost = host || '127.0.0.1'`
   - Sets `this.interopPort = port || 5008`
   - Logs the new host/port: `console.log(\`Java interop connection config: ${host}:${port}\`)`
   - Does NOT disconnect/reconnect — that happens separately via clearCache()

3. In `createSocket()`, change the hardcoded `socket.connect(DEFAULT_PORT, '127.0.0.1')` to use `socket.connect(this.interopPort, this.interopHost)`.

4. Remove the `DEFAULT_PORT` constant (no longer needed since defaults are in the class fields).

**bbj-ws-manager.ts changes:**
1. In the `onInitialize` handler where `params.initializationOptions` is read, also extract `interopHost` and `interopPort`:
   ```
   const interopHost = params.initializationOptions.interopHost || 'localhost';
   const interopPort = params.initializationOptions.interopPort || 5008;
   ```
2. Call `this.javaInterop.setConnectionConfig(interopHost, interopPort)` right after extracting these values (before workspace initialization proceeds).

**main.ts changes:**
In the `onDidChangeConfiguration` handler, after clearing cache and before reloading classpath, extract the new interop settings from the change object and update the connection config:
```typescript
// Extract interop settings from configuration change
const config = change.settings?.bbj;
if (config) {
    const interopHost = config.interop?.host || 'localhost';
    const interopPort = config.interop?.port || 5008;
    javaInterop.setConnectionConfig(interopHost, interopPort);
}
```
Add the same logic to the `bbj/refreshJavaClasses` handler (extract settings from wsManager, apply to javaInterop before reconnecting).

**extension.ts changes:**
1. In `startLanguageClient()`, update `initializationOptions` to include the interop settings:
   ```typescript
   initializationOptions: {
       home: vscode.workspace.getConfiguration("bbj").get("home"),
       classpath: vscode.workspace.getConfiguration("bbj").get("classpath"),
       typeResolutionWarnings: vscode.workspace.getConfiguration("bbj").get("typeResolution.warnings", true),
       interopHost: vscode.workspace.getConfiguration("bbj").get("interop.host", "localhost"),
       interopPort: vscode.workspace.getConfiguration("bbj").get("interop.port", 5008)
   }
   ```

2. Update the `documentSelector` to also include `{ scheme: 'file', language: 'bbx' }` — actually, since .bbx is now language "bbj", this is NOT needed. The existing `{ scheme: 'file', language: 'bbj' }` already covers .bbx files. No documentSelector change needed.

3. Remove or keep the `.bbx` language formatter registration — currently only `"bbj"` is registered for formatting. Since .bbx is now "bbj", it already gets formatting. No change needed.
  </action>
  <verify>
1. `npx tsc --noEmit -p bbj-vscode/tsconfig.json` compiles without errors
2. `cd bbj-vscode && npm test` — existing tests pass
3. Grep for `DEFAULT_PORT` in java-interop.ts — should not be found
4. Grep for `interopHost` in java-interop.ts, bbj-ws-manager.ts, main.ts, extension.ts — should appear in all four
  </verify>
  <done>
Language server uses configurable host/port for java-interop connection. initializationOptions passes interop settings from VS Code. onDidChangeConfiguration updates interop connection on settings change. Default remains localhost:5008.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation succeeds: `npx tsc --noEmit -p bbj-vscode/tsconfig.json`
2. Tests pass: `cd bbj-vscode && npm test`
3. package.json has only one language entry with .bbx in extensions
4. package.json has bbj.interop.host and bbj.interop.port settings
5. java-interop.ts uses configurable host/port, no hardcoded DEFAULT_PORT
6. initializationOptions includes interopHost and interopPort
7. onDidChangeConfiguration extracts and applies interop settings
</verification>

<success_criteria>
- .bbx files in VS Code are recognized as BBj language with BBj icon and full language intelligence
- bbj.interop.host and bbj.interop.port are visible in VS Code settings
- Language server reads interop host/port from initialization options
- Changing interop settings triggers cache clear and reconnection with new host/port
- Default behavior (no settings configured) connects to localhost:5008
</success_criteria>

<output>
After completion, create `.planning/phases/31-extension-settings-file-types/31-01-SUMMARY.md`
</output>
