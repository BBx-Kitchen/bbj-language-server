---
phase: 56-production-fixme-todo-resolution
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/language/java-interop.ts
autonomous: true
gap_closure: true
requirements: [TODO-01]

must_haves:
  truths:
    - "Java method completion items include pre-populated Javadoc documentation (signature + javadoc text) from the docu field set at class resolution time"
    - "The existing completion provider code path (isDocumented(node) && node.docu) is reachable for Java classpath methods"
    - "npm test passes with zero regressions after changes"
  artifacts:
    - path: "bbj-vscode/src/language/java-interop.ts"
      provides: "method.docu population during resolveClass()"
      contains: "method.docu"
  key_links:
    - from: "bbj-vscode/src/language/java-interop.ts"
      to: "bbj-vscode/src/language/bbj-completion-provider.ts"
      via: "method.docu field pre-populated at class resolution time, read synchronously at completion time"
      pattern: "method\\.docu\\s*="
---

<objective>
Populate `method.docu` during Java class resolution so completion items show full Javadoc documentation.

Purpose: The completion provider already has correct code to display Javadoc from `node.docu` (lines 146-157 of bbj-completion-provider.ts), but `method.docu` is never populated for Java classpath methods during `resolveClass()` in java-interop.ts. This gap closure populates the `docu` field at class resolution time, making the existing completion code path reachable.

Output: Modified java-interop.ts with method.docu population.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-production-fixme-todo-resolution/56-02-SUMMARY.md
@.planning/phases/56-production-fixme-todo-resolution/56-VERIFICATION.md
@bbj-vscode/src/language/java-interop.ts
@bbj-vscode/src/language/bbj-completion-provider.ts
@bbj-vscode/src/language/bbj-hover.ts
@bbj-vscode/src/language/java-javadoc.ts
@bbj-vscode/src/language/java-types.langium
</context>

<tasks>

<task type="auto">
  <name>Task 1: Populate method.docu in resolveClass() from Javadoc data</name>
  <files>bbj-vscode/src/language/java-interop.ts</files>
  <action>
In `resolveClass()` (around line 391-412), after the method's parameters are processed and `methodDocs` is available, populate `method.docu` with a `DocumentationInfo`-shaped object when Javadoc data exists.

The existing code already fetches `methodDocs` (lines 393-396) which is an array of `MethodDoc` objects (from java-javadoc.ts). Each `MethodDoc` has a `docu?: string` field containing raw javadoc text.

After the parameter processing loop (after line 411, before `AstUtils.linkContentToContainer(method)` on line 412), add:

```typescript
if (methodDocs.length > 0 && methodDocs[0].docu) {
    const doc = methodDocs[0];
    // Build signature: "ReturnType ClassName.methodName(Type paramName, ...)"
    const params = method.parameters.map((p, idx) => {
        const realName = doc.params[idx]?.name ?? p.name;
        return `${javaTypeAdjust(p.type)} ${realName}`;
    }).join(', ');
    const ownerName = javaClass.name.split('.').pop() ?? javaClass.name;
    const signature = `${javaTypeAdjust(method.returnType)} ${ownerName}.${method.name}(${params})`;
    (method as Mutable<JavaMethod>).docu = {
        javadoc: tryParseJavaDoc(doc.docu),
        signature: signature
    };
}
```

This requires two additional imports/functions:

1. Add a `javaTypeAdjust` function (or inline it). The hover provider has a private `javaTypeAdjust` that strips `java.lang.` prefix: `typeFqn.replace(/^java\.lang\./, '')`. Since it's a private function in bbj-hover.ts, define the same simple inline lambda or local function in java-interop.ts.

2. Add a `tryParseJavaDoc` function. The hover provider has this as a class method. It uses Langium's `isJSDoc` and `parseJSDoc` to convert raw javadoc comments to markdown. Add this as a local helper in java-interop.ts:
   - Import `isJSDoc` and `parseJSDoc` from `'langium'` (add to the existing import on line 7)
   - Add local function:
     ```typescript
     function tryParseJavaDoc(comment: string): string {
         if (isJSDoc(comment)) {
             try {
                 return parseJSDoc(comment).toMarkdown();
             } catch {
                 // JSDoc parsing can fail on complex Java documentation
             }
         }
         return comment;
     }
     ```

3. Add local function:
   ```typescript
   function javaTypeAdjust(typeFqn: string): string {
       return typeFqn.replace(/^java\.lang\./, '');
   }
   ```

Place both helper functions as module-level functions near the bottom of the file (before or after `extractPackageName`), NOT inside the class.

IMPORTANT: The `DocumentationInfo` type is generated from the Langium grammar (java-types.langium) and has shape `{ javadoc: string, signature?: string }`. The `Mutable` utility from Langium is already imported. Setting `method.docu` requires casting through `Mutable<JavaMethod>` since `docu` is optional on `Documented`.

IMPORTANT: Do NOT modify bbj-completion-provider.ts â€” its code is already correct and will work once method.docu is populated.
  </action>
  <verify>
Run `npm test` from the project root. All 501+ tests should pass with 0 failures. Then verify the docu assignment exists:
- `grep -n "method.*\.docu" bbj-vscode/src/language/java-interop.ts` should show the new assignment
- `grep -n "tryParseJavaDoc" bbj-vscode/src/language/java-interop.ts` should show the helper function
  </verify>
  <done>
method.docu is populated during resolveClass() when Javadoc data is available, containing both a formatted signature string and parsed javadoc markdown. The existing isDocumented(node) && node.docu check in bbj-completion-provider.ts (line 146) is now reachable for Java classpath methods that have javadoc documentation. npm test passes with zero regressions.
  </done>
</task>

</tasks>

<verification>
1. `npm test` exits 0 with all tests passing
2. `grep -n "method.*\.docu" bbj-vscode/src/language/java-interop.ts` confirms docu population code exists
3. Static analysis: the isDocumented(node) && node.docu path in bbj-completion-provider.ts (line 146) is now reachable for JavaMethod nodes resolved via resolveClass()
</verification>

<success_criteria>
- Java method nodes have their docu field populated during class resolution when Javadoc documentation exists
- The completion provider's Javadoc display path (lines 146-157) is functionally reachable for Java classpath methods
- All existing tests pass without regression
</success_criteria>

<output>
After completion, create `.planning/phases/56-production-fixme-todo-resolution/56-03-SUMMARY.md`
</output>
