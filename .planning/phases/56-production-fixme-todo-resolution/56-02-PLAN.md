---
phase: 56-production-fixme-todo-resolution
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/language/bbj-completion-provider.ts
  - bbj-vscode/src/language/java-interop.ts
  - bbj-vscode/src/language/bbj-notifications.ts
autonomous: true
requirements:
  - TODO-01
  - TODO-02

must_haves:
  truths:
    - "Java method completion items show param names with types from Javadoc when available"
    - "Java method completion items include full Javadoc documentation (description, params, return type) in the documentation panel"
    - "When the Java interop service fails to connect, the IDE shows an error-level notification guiding the user to check the Java service"
    - "npm test passes with zero regressions after all changes"
  artifacts:
    - path: "bbj-vscode/src/language/bbj-completion-provider.ts"
      provides: "Javadoc-enriched completion items for Java methods"
      contains: "no TODO on lines 132 or 144"
    - path: "bbj-vscode/src/language/java-interop.ts"
      provides: "Error notification to client on connection failure"
      contains: "no TODO on line 78"
    - path: "bbj-vscode/src/language/bbj-notifications.ts"
      provides: "notifyJavaConnectionError function for sending window/showMessage"
  key_links:
    - from: "bbj-vscode/src/language/bbj-completion-provider.ts"
      to: "bbj-vscode/src/language/java-javadoc.ts"
      via: "JavadocProvider.getInstance().getDocumentation()"
      pattern: "javadocProvider.*getDocumentation"
    - from: "bbj-vscode/src/language/java-interop.ts"
      to: "bbj-vscode/src/language/bbj-notifications.ts"
      via: "notifyJavaConnectionError()"
      pattern: "notifyJavaConnectionError"
---

<objective>
Implement the 2 actionable TODOs: (1) enrich Java method completion items with Javadoc param names and documentation, and (2) send an error notification to the IDE client when the Java interop service connection fails.

Purpose: Improve developer experience by surfacing Java documentation in code completion and providing clear error feedback when the Java backend is unreachable.
Output: 3 files updated with TODO comments removed and features implemented.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-production-fixme-todo-resolution/56-CONTEXT.md
@bbj-vscode/src/language/bbj-completion-provider.ts
@bbj-vscode/src/language/java-interop.ts
@bbj-vscode/src/language/bbj-notifications.ts
@bbj-vscode/src/language/java-javadoc.ts
@bbj-vscode/src/language/bbj-hover.ts
@bbj-vscode/src/language/bbj-nodedescription-provider.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement TODO-01 — Javadoc integration in completion provider</name>
  <files>bbj-vscode/src/language/bbj-completion-provider.ts</files>
  <action>
The completion provider at `createReferenceCompletionItem()` (lines 122-157) currently builds completion items for Java methods using `FunctionNodeDescription` data (param names, types, return type). Two TODOs exist:

**TODO line 132 ("load param names for java methods from Javadoc"):**

This TODO is actually ALREADY HANDLED — `java-interop.ts` lines 400-409 already loads `realName` from Javadoc into `parameter.realName` during class resolution. The `FunctionNodeDescription` carries `realName` through `enhanceFunctionDescription()`. The completion label builder at line 129 already uses `p.realName ?? p.name`. So param names from Javadoc are already being loaded and displayed.

**Action:** Remove the TODO comment on line 132 entirely. The param names are already loaded by `java-interop.ts` during class resolution — the completion provider already uses `realName` from the `ParameterData`. Per user decision, delete the TODO comment (code speaks for itself).

**TODO line 144 ("Add docu to description?"):**

Currently, when `nodeDescription.node` exists (it's a Java method AST node), the code calls `documentationHeader(node)` which returns just a signature-style header. The user wants FULL Javadoc documentation — complete description, params, and return type — in the documentation panel.

**Action:** Replace the current block (lines 143-148) to fetch Javadoc from `JavadocProvider` and build a rich markdown documentation string. The completion provider's `createReferenceCompletionItem` is synchronous, but `JavadocProvider.getDocumentation()` is async. Since completion items support a `documentation` field that can be set synchronously, and the `FunctionNodeDescription` already carries the node reference, we need to work with what's available synchronously.

The approach: Use the existing `documentationHeader(node)` for the synchronous path (which gives a method signature), and check if the node has a pre-populated `docu` property (which `java-interop.ts` sets when Javadoc is available via `isDocumented(node) && node.docu`). The `JavaMethod` interface from the grammar has a `docu` field that can hold `DocumentationInfo` (javadoc string + optional signature).

Look at how `bbj-hover.ts` handles this at lines 79-98: it checks `isDocumented(node)` and `node.docu`, then falls back to async `javadocProvider.getDocumentation()`. For the completion provider (synchronous context), use the pre-populated `node.docu` field if available.

Replace lines 143-148 with:
```typescript
if (nodeDescription.node) {
    // Build documentation from node's pre-populated docu field or header
    const node = nodeDescription.node;
    if (isDocumented(node) && node.docu) {
        const parts: string[] = [];
        if (node.docu.signature) {
            parts.push(`\`\`\`java\n${node.docu.signature}\n\`\`\``);
        }
        if (node.docu.javadoc) {
            parts.push(node.docu.javadoc);
        }
        if (parts.length > 0) {
            superImpl.documentation = { kind: 'markdown', value: parts.join('\n\n') };
        }
    }
    if (!superImpl.documentation) {
        const content = documentationHeader(node);
        if (content) {
            superImpl.documentation = { kind: 'markdown', value: content };
        }
    }
}
```

Add `isDocumented` to the imports from `./generated/ast.js`.

Delete both TODO comments (lines 132 and 144). Per user decision: after implementing, delete the TODO comment entirely.
  </action>
  <verify>Run `npm test` — all tests pass. Grep for `TODO` in `bbj-completion-provider.ts` — zero matches (only the feature-level TODOs should remain, not the two actionable ones on lines 132 and 144). Build succeeds: `npm run build` or `npm run langium:generate && npm run build`.</verify>
  <done>Both TODO comments removed from bbj-completion-provider.ts. Completion items show Javadoc documentation (signature + description) from pre-populated node.docu field when available, with fallback to documentationHeader. No test regressions.</done>
</task>

<task type="auto">
  <name>Task 2: Implement TODO-02 — Java connection error notification</name>
  <files>bbj-vscode/src/language/java-interop.ts, bbj-vscode/src/language/bbj-notifications.ts</files>
  <action>
**TODO-02 (`java-interop.ts:78` — send error message to client):**

When `connect()` fails to create a socket connection to the Java backend service (line 77 catch block), it currently only logs to console.error. The user wants an Error-level `window/showMessage` notification sent to the IDE.

**Step 1: Add notification function to `bbj-notifications.ts`**

Add a new exported function `notifyJavaConnectionError(message: string)` to `bbj-notifications.ts`. Follow the same pattern as `notifyBbjcplAvailability()`:
- Use the module-level `_connection` (already set by `initNotifications()`)
- Use `_connection?.window.showErrorMessage(message)` to send an Error-level notification
- Add a deduplication guard so repeated connection failures don't spam the user (use a boolean flag like `javaConnectionErrorShown` — only show once per session, reset when... actually, per user decision this should be non-blocking but prominent, so show it once per connection attempt failure)

```typescript
/**
 * Send a window/showMessage Error notification for Java connection failure.
 * Non-blocking but prominent — helps users understand they need to check
 * the Java service / BBjServices.
 */
export function notifyJavaConnectionError(errorDetail: string): void {
    _connection?.window.showErrorMessage(
        `Failed to connect to the Java interop service. ` +
        `Check that BBj Services is running and the interop host/port settings are correct. ` +
        `(${errorDetail})`
    );
}
```

**Step 2: Wire into `java-interop.ts` connect() method**

In `java-interop.ts`, import `notifyJavaConnectionError` from `./bbj-notifications.js`.

Replace lines 77-81:
```typescript
} catch (e) {
    // TODO send error message to the client.
    // Allow the user to retry the connection.
    console.error('Failed to connect to the Java service.', e)
    return Promise.reject(e);
}
```

With:
```typescript
} catch (e) {
    const detail = e instanceof Error ? e.message : String(e);
    notifyJavaConnectionError(detail);
    console.error('Failed to connect to the Java service.', e);
    return Promise.reject(e);
}
```

Delete the TODO comment. Per user decision: after implementing, delete the TODO comment entirely.

**Important constraint from STATE.md:** `bbj-notifications.ts` is an isolation module — importing `main.ts` from shared services crashes tests. The notification module pattern (module-level `_connection` set via `initNotifications()`) must be preserved. Our change adds a new function to this module, which is safe.
  </action>
  <verify>Run `npm test` — all tests pass. Grep for `TODO` in `java-interop.ts` line 78 area — the actionable TODO is gone (note: line 407 has a separate `TODO check types of parameters` which is in REQUIREMENTS.md as FEAT-02 / out of scope). Build succeeds.</verify>
  <done>TODO-02 implemented: `notifyJavaConnectionError()` added to bbj-notifications.ts, wired into java-interop.ts connect() catch block. Error-level window/showMessage sent to IDE on connection failure with guidance about checking BBj Services. TODO comment removed. No test regressions.</done>
</task>

</tasks>

<verification>
1. `npm test` passes with zero failures
2. `grep -n "TODO" bbj-vscode/src/language/bbj-completion-provider.ts` — no matches on lines 132 or 144 (only unrelated TODOs if any)
3. `grep -n "TODO" bbj-vscode/src/language/java-interop.ts` — the line 78 TODO is gone (line 407 FEAT-02 TODO remains, it's out of scope)
4. `bbj-notifications.ts` exports `notifyJavaConnectionError` function
5. `npm run build` succeeds (TypeScript compilation)
</verification>

<success_criteria>
Both actionable TODOs (TODO-01 and TODO-02) are implemented with working code. Java method completion items show Javadoc documentation when available. Java connection failures produce an Error-level IDE notification. All TODO comments for these items are deleted. No test regressions.
</success_criteria>

<output>
After completion, create `.planning/phases/56-production-fixme-todo-resolution/56-02-SUMMARY.md`
</output>
