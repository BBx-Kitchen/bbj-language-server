---
phase: 21-preview-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-intellij/build.gradle.kts
  - .github/workflows/preview.yml
autonomous: true

must_haves:
  truths:
    - "Push to main triggers IntelliJ plugin build in addition to VS Code build"
    - "IntelliJ plugin version matches VS Code version from package.json"
    - "IntelliJ build waits for VS Code build to complete (downloads main.cjs artifact)"
    - "IntelliJ .zip artifact is downloadable from workflow run"
  artifacts:
    - path: "bbj-intellij/build.gradle.kts"
      provides: "Dynamic version injection via -Pversion flag"
      contains: "providers.gradleProperty"
    - path: ".github/workflows/preview.yml"
      provides: "Two-job workflow with artifact sharing"
      contains: "needs: publish-preview"
  key_links:
    - from: ".github/workflows/preview.yml"
      to: "bbj-intellij/build.gradle.kts"
      via: "Gradle -Pversion flag"
      pattern: "-Pversion="
    - from: ".github/workflows/preview.yml (build-intellij)"
      to: ".github/workflows/preview.yml (publish-preview)"
      via: "needs dependency and artifact download"
      pattern: "needs:.*publish-preview"
---

<objective>
Add IntelliJ plugin build to the preview workflow with version synchronization.

Purpose: Enable automatic IntelliJ plugin builds on every push to main, synchronized with VS Code releases. Both extensions will have matching versions from package.json.

Output: Updated preview.yml with two-job workflow (VS Code + IntelliJ) and modified build.gradle.kts accepting version via Gradle property.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-preview-workflow/21-RESEARCH.md

@.github/workflows/preview.yml
@bbj-intellij/build.gradle.kts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable dynamic version injection in Gradle build</name>
  <files>bbj-intellij/build.gradle.kts</files>
  <action>
Modify build.gradle.kts to accept version from Gradle property with fallback to hardcoded default:

1. Replace the hardcoded `version = "0.1.0"` line with:
```kotlin
version = providers.gradleProperty("version").getOrElse("0.1.0")
```

This allows CI to pass `-Pversion=X.Y.Z` while preserving the 0.1.0 default for local development.

Do NOT use `providers.systemProperty` - Gradle property is simpler and sufficient.
Do NOT change any other part of build.gradle.kts.
  </action>
  <verify>
Run from bbj-intellij directory:
```bash
./gradlew properties | grep "^version:"
# Should show: version: 0.1.0 (default)

./gradlew properties -Pversion=1.2.3 | grep "^version:"
# Should show: version: 1.2.3 (injected)
```
  </verify>
  <done>Gradle build accepts -Pversion flag and falls back to 0.1.0 when not provided</done>
</task>

<task type="auto">
  <name>Task 2: Add IntelliJ build job to preview workflow</name>
  <files>.github/workflows/preview.yml</files>
  <action>
Modify preview.yml to add a second job that builds the IntelliJ plugin:

1. Rename the existing job from `publish-preview` to `build-vscode` (or keep name but add outputs)

2. Add outputs to the VS Code job to expose the bumped version:
```yaml
outputs:
  version: ${{ steps.bump.outputs.version }}
```

3. In the version bump step, add an id and output the new version:
```yaml
- name: Bump patch version
  id: bump
  # ... existing bump logic ...
  echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
```

4. After the VS Code publish step, add artifact upload for main.cjs:
```yaml
- name: Upload language server
  uses: actions/upload-artifact@v4
  with:
    name: language-server
    path: bbj-vscode/out/language/main.cjs
    retention-days: 7
```

5. Add new job `build-intellij` that:
- Uses `needs: publish-preview` (or the renamed job name)
- Runs on ubuntu-latest
- Checks out the code
- Downloads the language-server artifact to bbj-vscode/out/language/
- Sets up Java 17 (required for Gradle)
- Runs `./gradlew buildPlugin -Pversion=${{ needs.publish-preview.outputs.version }}`
- Uploads the built plugin ZIP as artifact

Full new job:
```yaml
build-intellij:
  runs-on: ubuntu-latest
  needs: publish-preview

  steps:
    - uses: actions/checkout@v4

    - name: Download language server
      uses: actions/download-artifact@v5
      with:
        name: language-server
        path: bbj-vscode/out/language/

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Build IntelliJ plugin
      working-directory: bbj-intellij
      run: ./gradlew buildPlugin -Pversion=${{ needs.publish-preview.outputs.version }}

    - name: Upload IntelliJ plugin
      uses: actions/upload-artifact@v4
      with:
        name: intellij-plugin
        path: bbj-intellij/build/distributions/*.zip
        retention-days: 7
```

IMPORTANT: Use actions/upload-artifact@v4 and actions/download-artifact@v5 (NOT v3 - deprecated).
IMPORTANT: The IntelliJ job MUST have `needs: publish-preview` to ensure sequential execution.
IMPORTANT: Download artifact path must be `bbj-vscode/out/language/` so Gradle finds main.cjs.
  </action>
  <verify>
1. Validate YAML syntax:
```bash
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/preview.yml'))"
# Should complete without error
```

2. Verify job structure:
```bash
grep -A2 "needs:" .github/workflows/preview.yml
# Should show: needs: publish-preview (or equivalent)

grep "upload-artifact@v4" .github/workflows/preview.yml
# Should show two matches (VS Code and IntelliJ uploads)

grep "download-artifact@v5" .github/workflows/preview.yml
# Should show one match (IntelliJ job)

grep "\-Pversion=" .github/workflows/preview.yml
# Should show version injection
```

3. Full workflow test requires pushing to main (will be verified after commit).
  </verify>
  <done>
- preview.yml has two jobs: VS Code build/publish and IntelliJ build
- IntelliJ job depends on VS Code job via `needs`
- Version passed from VS Code job to IntelliJ job via outputs
- main.cjs shared via artifact upload/download
- IntelliJ .zip uploaded as artifact
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Local Gradle verification:
```bash
cd bbj-intellij
./gradlew properties -Pversion=0.7.5 | grep "^version:"
# Expect: version: 0.7.5
```

2. YAML structure verification:
```bash
grep -E "^  (publish-preview|build-vscode|build-intellij):" .github/workflows/preview.yml
# Expect: Two job names listed
```

3. Full workflow test (post-merge):
- Push any change to main branch
- Verify GitHub Actions shows both jobs running
- Verify IntelliJ job waits for VS Code job
- Download intellij-plugin artifact and verify version in filename matches VS Code version
</verification>

<success_criteria>
- [ ] build.gradle.kts accepts -Pversion flag with 0.1.0 fallback
- [ ] preview.yml has two jobs with dependency relationship
- [ ] VS Code job outputs bumped version
- [ ] IntelliJ job downloads main.cjs artifact before build
- [ ] IntelliJ job passes version via -Pversion flag
- [ ] IntelliJ .zip uploaded as workflow artifact
- [ ] YAML syntax valid
</success_criteria>

<output>
After completion, create `.planning/phases/21-preview-workflow/21-01-SUMMARY.md`
</output>
