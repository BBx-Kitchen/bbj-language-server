---
phase: 02-syntax-highlighting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-intellij/build.gradle.kts
  - bbj-intellij/src/main/resources/textmate/bbj-bundle/package.json
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjTextMateBundleProvider.java
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
autonomous: true

must_haves:
  truths:
    - "BBj keywords appear in distinct color from identifiers when opening a .bbj file"
    - "String literals and comments display in different colors from code"
    - "Syntax highlighting appears immediately (no language server needed)"
    - "Bracket matching works when cursor is on a bracket"
    - "Comment toggling via Ctrl+/ (Cmd+/ on macOS) toggles REM comments"
  artifacts:
    - path: "bbj-intellij/build.gradle.kts"
      provides: "TextMate bundled plugin dependency and Gradle copy task for grammar sync"
      contains: "bundledPlugin.*org.jetbrains.plugins.textmate"
    - path: "bbj-intellij/src/main/resources/textmate/bbj-bundle/package.json"
      provides: "VS Code-format bundle descriptor mapping grammars to languages"
      contains: "source.bbj"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjTextMateBundleProvider.java"
      provides: "TextMate bundle registration extracting grammar from resources to temp dir"
      exports: ["BbjTextMateBundleProvider"]
    - path: "bbj-intellij/src/main/resources/META-INF/plugin.xml"
      provides: "TextMate plugin dependency and extension registrations"
      contains: "org.jetbrains.plugins.textmate"
  key_links:
    - from: "bbj-intellij/build.gradle.kts"
      to: "bbj-vscode/syntaxes/"
      via: "Gradle Copy task at processResources"
      pattern: "copyTextMateBundle"
    - from: "BbjTextMateBundleProvider.java"
      to: "textmate/bbj-bundle/"
      via: "ClassLoader.getResource()"
      pattern: "getResource.*textmate/bbj-bundle"
    - from: "plugin.xml"
      to: "TextMateSyntaxHighlighterFactory"
      via: "lang.syntaxHighlighterFactory extension"
      pattern: "TextMateSyntaxHighlighterFactory"
    - from: "package.json"
      to: "syntaxes/*.tmLanguage.json"
      via: "contributes.grammars path references"
      pattern: "syntaxes/bbj.tmLanguage.json"
---

<objective>
Integrate the existing BBj TextMate grammar from bbj-vscode into the IntelliJ plugin so BBj code displays with full syntax highlighting immediately upon opening a file, without any language server dependency.

Purpose: This is the first user-visible feature beyond file recognition. Developers opening BBj code in IntelliJ will see keywords, strings, comments, and other tokens colored appropriately using the same grammar that powers VS Code highlighting.

Output: Working syntax highlighting for .bbj, .bbl, .bbjt, .src, and .bbx files, plus bracket matching, auto-closing pairs, and comment toggling via language-configuration.json.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-syntax-highlighting/02-RESEARCH.md
@bbj-intellij/build.gradle.kts
@bbj-intellij/src/main/resources/META-INF/plugin.xml
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjLanguage.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjFileType.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build system and TextMate bundle descriptor</name>
  <files>
    bbj-intellij/build.gradle.kts
    bbj-intellij/src/main/resources/textmate/bbj-bundle/package.json
  </files>
  <action>
  Update build.gradle.kts to:
  1. Add `bundledPlugin("org.jetbrains.plugins.textmate")` inside the `intellijPlatform` dependencies block, after `intellijIdeaCommunity("2024.2")`.

  2. Add a Gradle Copy task that copies grammar and language-configuration files from bbj-vscode at compile time:
  ```kotlin
  val copyTextMateBundle by tasks.registering(Copy::class) {
      from("${projectDir}/../bbj-vscode/") {
          include("syntaxes/bbj.tmLanguage.json")
          include("syntaxes/bbx.tmLanguage.json")
          include("bbj-language-configuration.json")
          include("bbx-language-configuration.json")
      }
      into(layout.buildDirectory.dir("resources/main/textmate/bbj-bundle"))
  }

  tasks.named("processResources") {
      dependsOn(copyTextMateBundle)
  }
  ```

  3. Create a static `package.json` at `src/main/resources/textmate/bbj-bundle/package.json`. This file is a VS Code-format bundle descriptor that IntelliJ's TextMate engine requires to recognize the bundle. It maps language IDs to grammar files and language configurations:
  ```json
  {
    "name": "bbj-textmate-bundle",
    "contributes": {
      "languages": [
        {
          "id": "bbj",
          "extensions": [".bbj", ".bbl", ".bbjt", ".src"],
          "configuration": "./bbj-language-configuration.json"
        },
        {
          "id": "bbx",
          "extensions": [".bbx"],
          "configuration": "./bbx-language-configuration.json"
        }
      ],
      "grammars": [
        {
          "language": "bbj",
          "scopeName": "source.bbj",
          "path": "./syntaxes/bbj.tmLanguage.json"
        },
        {
          "language": "bbx",
          "scopeName": "source.bbx",
          "path": "./syntaxes/bbx.tmLanguage.json"
        }
      ]
    }
  }
  ```

  IMPORTANT: The package.json goes in `src/main/resources/textmate/bbj-bundle/` (static resource, checked into repo). The grammar files go into `build/resources/main/textmate/bbj-bundle/` (copied at build time from bbj-vscode, NOT checked in). Both end up merged in the same resource path in the final JAR.

  Do NOT copy the grammar files into src/main/resources. They must come from bbj-vscode at build time to stay in sync.
  </action>
  <verify>
  Run `cd bbj-intellij && ./gradlew processResources --no-daemon` and verify:
  1. Build succeeds without errors
  2. `build/resources/main/textmate/bbj-bundle/package.json` exists (from static resource)
  3. `build/resources/main/textmate/bbj-bundle/syntaxes/bbj.tmLanguage.json` exists (from copy task)
  4. `build/resources/main/textmate/bbj-bundle/syntaxes/bbx.tmLanguage.json` exists (from copy task)
  5. `build/resources/main/textmate/bbj-bundle/bbj-language-configuration.json` exists (from copy task)
  6. `build/resources/main/textmate/bbj-bundle/bbx-language-configuration.json` exists (from copy task)
  </verify>
  <done>
  Gradle build copies TextMate grammar and language-configuration files from bbj-vscode into the plugin's resource output at compile time, alongside the static package.json bundle descriptor. All 6 expected files are present in the build output.
  </done>
</task>

<task type="auto">
  <name>Task 2: TextMate bundle provider and plugin.xml wiring</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjTextMateBundleProvider.java
    bbj-intellij/src/main/resources/META-INF/plugin.xml
  </files>
  <action>
  1. Create `BbjTextMateBundleProvider.java` in `src/main/java/com/basis/bbj/intellij/`. This class implements `org.jetbrains.plugins.textmate.api.TextMateBundleProvider` and extracts the bundled grammar files from the JAR's resources into a temporary directory that IntelliJ's TextMate engine can read:

  ```java
  package com.basis.bbj.intellij;

  import com.intellij.openapi.application.PathManager;
  import org.jetbrains.annotations.NotNull;
  import org.jetbrains.plugins.textmate.api.TextMateBundleProvider;

  import java.io.IOException;
  import java.io.InputStream;
  import java.net.URL;
  import java.nio.file.Files;
  import java.nio.file.Path;
  import java.util.List;
  import java.util.Objects;

  public class BbjTextMateBundleProvider implements TextMateBundleProvider {
      private static final String BUNDLE_RESOURCE_PATH = "textmate/bbj-bundle/";
      private static final List<String> BUNDLE_FILES = List.of(
          "package.json",
          "bbj-language-configuration.json",
          "bbx-language-configuration.json",
          "syntaxes/bbj.tmLanguage.json",
          "syntaxes/bbx.tmLanguage.json"
      );

      @NotNull
      @Override
      public List<PluginBundle> getBundles() {
          try {
              Path bundleDir = Files.createTempDirectory(
                  Path.of(PathManager.getTempPath()), "textmate-bbj");

              for (String file : BUNDLE_FILES) {
                  URL resource = getClass().getClassLoader()
                      .getResource(BUNDLE_RESOURCE_PATH + file);
                  Objects.requireNonNull(resource,
                      "Missing TextMate bundle resource: " + BUNDLE_RESOURCE_PATH + file);
                  try (InputStream stream = resource.openStream()) {
                      Path target = bundleDir.resolve(file);
                      Files.createDirectories(target.getParent());
                      Files.copy(stream, target);
                  }
              }

              return List.of(new PluginBundle("BBj", bundleDir));
          } catch (IOException e) {
              throw new RuntimeException("Failed to extract BBj TextMate bundle", e);
          }
      }
  }
  ```

  2. Update `plugin.xml` to:
  a. Add TextMate plugin dependency: `<depends>org.jetbrains.plugins.textmate</depends>` after the existing `<depends>com.intellij.modules.platform</depends>`.

  b. Add two new extensions inside the existing `<extensions defaultExtensionNs="com.intellij">` block, AFTER the existing fileType registration:

  ```xml
  <!-- Bridge custom FileType to TextMate highlighting engine -->
  <lang.syntaxHighlighterFactory
      language="BBj"
      implementationClass="org.jetbrains.plugins.textmate.language.syntax.highlighting.TextMateSyntaxHighlighterFactory"/>

  <!-- Register TextMate grammar bundle -->
  <textmate.bundleProvider
      implementation="com.basis.bbj.intellij.BbjTextMateBundleProvider"/>
  ```

  CRITICAL: The `lang.syntaxHighlighterFactory` registration is essential. Without it, the custom BbjFileType from Phase 1 will override TextMate highlighting with an empty highlighter, resulting in no syntax colors. This bridges the custom Language/FileType to the TextMate engine.

  Do NOT use the deprecated `TextMateService.registerEnabledBundles()` API. The `textmate.bundleProvider` extension point is the current approach.
  </action>
  <verify>
  Run `cd bbj-intellij && ./gradlew buildPlugin --no-daemon` and verify:
  1. Build succeeds (compilation of BbjTextMateBundleProvider + all existing classes)
  2. Plugin ZIP exists at `build/distributions/`
  3. Inspect the plugin JAR inside the ZIP to confirm it contains:
     - `com/basis/bbj/intellij/BbjTextMateBundleProvider.class`
     - `textmate/bbj-bundle/package.json`
     - `textmate/bbj-bundle/syntaxes/bbj.tmLanguage.json`
     - `textmate/bbj-bundle/syntaxes/bbx.tmLanguage.json`
     - `textmate/bbj-bundle/bbj-language-configuration.json`
     - `textmate/bbj-bundle/bbx-language-configuration.json`
     - `META-INF/plugin.xml` containing `org.jetbrains.plugins.textmate` dependency and both new extensions
  </verify>
  <done>
  Plugin builds successfully with TextMate grammar integration. The plugin JAR contains the BbjTextMateBundleProvider class, all grammar/language-config files, and a plugin.xml that registers the TextMate bundle provider and bridges the BBj FileType to TextMate syntax highlighting.
  </done>
</task>

</tasks>

<verification>
1. `cd bbj-intellij && ./gradlew buildPlugin --no-daemon` completes with BUILD SUCCESSFUL
2. Plugin ZIP in `build/distributions/` contains all TextMate bundle files and the provider class
3. `plugin.xml` declares dependency on `org.jetbrains.plugins.textmate`
4. `plugin.xml` registers both `lang.syntaxHighlighterFactory` and `textmate.bundleProvider`
5. Grammar files are copied from bbj-vscode (not duplicated in source tree)
6. package.json maps both bbj and bbx languages to their respective grammars
</verification>

<success_criteria>
- Plugin builds without errors with TextMate dependency
- Grammar files are synced from bbj-vscode at compile time (not static copies)
- BbjTextMateBundleProvider extracts bundle to temp directory at runtime
- Custom FileType is bridged to TextMate highlighting via syntaxHighlighterFactory
- Both BBj and BBx grammars are included in the bundle
- Language configurations (bracket matching, comment toggling) are included
</success_criteria>

<output>
After completion, create `.planning/phases/02-syntax-highlighting/02-01-SUMMARY.md`
</output>
