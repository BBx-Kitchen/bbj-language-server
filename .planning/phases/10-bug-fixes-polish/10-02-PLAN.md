---
phase: 10-bug-fixes-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerService.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjStatusBarWidget.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjCompletionFeature.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDetector.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDownloader.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServer.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjHomeDetector.java
  - bbj-intellij/META-INF/plugin.xml
  - bbj-intellij/src/main/resources/icons/bbj-function.svg
  - bbj-intellij/src/main/resources/icons/bbj-variable.svg
  - bbj-intellij/src/main/resources/icons/bbj-keyword.svg
autonomous: true

must_haves:
  truths:
    - "Closing the last BBj file does not immediately kill the language server; reopening within 30 seconds reuses it"
    - "Completion popup shows distinct platform icons for functions, variables, keywords, and other symbol types"
    - "Stale bbj-intellij/META-INF/ directory no longer exists"
    - "All code paths handle Linux correctly (path separators, Node.js detection, executable permissions)"
  artifacts:
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerService.java"
      provides: "Grace period lifecycle with 30-second delayed shutdown"
      contains: "FileEditorManagerListener"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjStatusBarWidget.java"
      provides: "Idle state display during grace period"
      contains: "Idle"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjCompletionFeature.java"
      provides: "Platform icon mapping for LSP CompletionItemKind"
      contains: "AllIcons.Nodes"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java"
      provides: "Cleaned up icon constants without orphaned completion icons"
  key_links:
    - from: "BbjServerService"
      to: "FileEditorManagerListener"
      via: "Message bus subscription tracking BBj file open/close"
      pattern: "FileEditorManagerListener"
    - from: "BbjServerService"
      to: "BbjStatusBarWidget"
      via: "Status broadcast including idle state"
      pattern: "BbjServerStatusListener"
    - from: "BbjCompletionFeature"
      to: "AllIcons.Nodes"
      via: "Platform icon mapping replacing custom SVG icons"
      pattern: "AllIcons\\.Nodes"
---

<objective>
Fix LS shutdown grace period (FIX-04), wire completion icons (FIX-05), remove stale META-INF (FIX-06), and review Linux code paths (FIX-07).

Purpose: Server lifecycle polish (grace period prevents disruptive restarts), native completion icons (consistent look), codebase cleanup (stale files removed), and cross-platform correctness (Linux support).
Output: BbjServerService with 30-second grace period, BbjCompletionFeature using AllIcons.Nodes, deleted stale META-INF, Linux-safe code paths.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-bug-fixes-polish/10-CONTEXT.md
@.planning/phases/10-bug-fixes-polish/10-RESEARCH.md
@bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerService.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjStatusBarWidget.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjCompletionFeature.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDetector.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDownloader.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServer.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjHomeDetector.java
@bbj-intellij/META-INF/plugin.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement LS shutdown grace period with idle status</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerService.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjStatusBarWidget.java
  </files>
  <action>
Add a 30-second grace period to BbjServerService so the language server stays alive briefly after the last BBj file closes. If a BBj file reopens during the grace period, cancel the shutdown timer and reuse the running server.

**BbjServerService.java changes:**

1. Add imports:
```java
import com.intellij.openapi.fileEditor.FileEditorManager;
import com.intellij.openapi.fileEditor.FileEditorManagerListener;
import com.intellij.openapi.vfs.VirtualFile;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.ScheduledFuture;
import java.util.concurrent.TimeUnit;
```

2. Add fields:
```java
private static final int GRACE_PERIOD_SECONDS = 30;
private final ScheduledExecutorService gracePeriodScheduler =
    Executors.newSingleThreadScheduledExecutor(r -> {
        Thread t = new Thread(r, "BBj-LS-Grace-Period");
        t.setDaemon(true);
        return t;
    });
private ScheduledFuture<?> gracePeriodTask;
private volatile boolean inGracePeriod = false;
```

3. In the constructor, AFTER the existing `Disposer.register(project, this)`, add file editor listener:
```java
MessageBusConnection connection = project.getMessageBus().connect(this);
connection.subscribe(FileEditorManagerListener.FILE_EDITOR_MANAGER,
    new FileEditorManagerListener() {
        @Override
        public void fileOpened(@NotNull FileEditorManager source,
                              @NotNull VirtualFile file) {
            if (isBbjFile(file)) {
                cancelGracePeriod();
            }
        }

        @Override
        public void fileClosed(@NotNull FileEditorManager source,
                              @NotNull VirtualFile file) {
            if (isBbjFile(file)) {
                checkAndStartGracePeriod(source);
            }
        }
    });
```
NOTE: Use `project.getMessageBus().connect(this)` (passing `this` as Disposable parent) so the connection auto-disconnects on project close.

4. Add helper methods:
```java
private boolean isBbjFile(@NotNull VirtualFile file) {
    String ext = file.getExtension();
    return ext != null && (ext.equals("bbj") || ext.equals("bbl") ||
                           ext.equals("bbjt") || ext.equals("src") ||
                           ext.equals("bbx"));
}

private void checkAndStartGracePeriod(@NotNull FileEditorManager manager) {
    // Check if any BBj files are still open
    for (VirtualFile open : manager.getOpenFiles()) {
        if (isBbjFile(open)) {
            return; // Still have BBj files open, no grace period needed
        }
    }
    startGracePeriod();
}

private synchronized void startGracePeriod() {
    if (inGracePeriod) return;
    inGracePeriod = true;
    logToConsole("Last BBj file closed. Language server will shut down in "
        + GRACE_PERIOD_SECONDS + " seconds...",
        com.intellij.execution.ui.ConsoleViewContentType.SYSTEM_OUTPUT);

    // Notify UI of idle state
    ApplicationManager.getApplication().invokeLater(() ->
        project.getMessageBus()
            .syncPublisher(BbjServerStatusListener.TOPIC)
            .statusChanged(currentStatus) // Re-broadcast to trigger idle display
    );

    gracePeriodTask = gracePeriodScheduler.schedule(() -> {
        inGracePeriod = false;
        logToConsole("Grace period expired. Stopping language server.",
            com.intellij.execution.ui.ConsoleViewContentType.SYSTEM_OUTPUT);
        ApplicationManager.getApplication().invokeLater(() -> {
            LanguageServerManager.getInstance(project).stop("bbjLanguageServer");
        });
    }, GRACE_PERIOD_SECONDS, TimeUnit.SECONDS);
}

private synchronized void cancelGracePeriod() {
    if (!inGracePeriod) return;
    inGracePeriod = false;
    if (gracePeriodTask != null && !gracePeriodTask.isDone()) {
        gracePeriodTask.cancel(false);
        gracePeriodTask = null;
    }
    logToConsole("BBj file opened. Grace period cancelled.",
        com.intellij.execution.ui.ConsoleViewContentType.SYSTEM_OUTPUT);

    // Re-broadcast status to clear idle display
    ApplicationManager.getApplication().invokeLater(() ->
        project.getMessageBus()
            .syncPublisher(BbjServerStatusListener.TOPIC)
            .statusChanged(currentStatus)
    );
}

public boolean isInGracePeriod() {
    return inGracePeriod;
}
```

5. In the `dispose()` method, add cleanup for the scheduler:
```java
gracePeriodScheduler.shutdownNow();
```

**BbjStatusBarWidget.java changes:**

6. In the `updateStatus()` method, after determining icon and text based on ServerStatus, add a grace period check BEFORE setting the labels:
```java
// Check for grace period idle state
BbjServerService service = BbjServerService.getInstance(project);
if (service.isInGracePeriod() && status == ServerStatus.started) {
    icon = BbjIcons.STATUS_STARTING; // Dimmed/different icon for idle
    text = "BBj: Idle";
}
```
This uses the existing STATUS_STARTING icon (which has a different visual from STATUS_READY) as the "dimmed" idle indicator. Place this logic AFTER the switch statement but BEFORE `iconLabel.setIcon(icon)`.

CONTEXT.md decision: "Status bar hint during grace period -- subtle indication (e.g., dimmed icon or 'idle' text) so user knows the LS is still alive but winding down."
  </action>
  <verify>
Run `./gradlew build` from bbj-intellij/ -- build succeeds. Inspect BbjServerService.java: has FileEditorManagerListener subscription, GRACE_PERIOD_SECONDS = 30, startGracePeriod()/cancelGracePeriod() methods, isInGracePeriod() accessor. Inspect BbjStatusBarWidget.java: shows "BBj: Idle" during grace period.
  </verify>
  <done>
BbjServerService tracks BBj file open/close via FileEditorManagerListener. Last file close starts 30-second grace period timer. File reopen cancels timer and reuses running server. Status bar shows "BBj: Idle" during grace period. Build compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace completion icons with platform AllIcons and clean up orphaned resources</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjCompletionFeature.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
    bbj-intellij/src/main/resources/icons/bbj-function.svg
    bbj-intellij/src/main/resources/icons/bbj-variable.svg
    bbj-intellij/src/main/resources/icons/bbj-keyword.svg
    bbj-intellij/META-INF/plugin.xml
  </files>
  <action>
Replace custom BBj completion icons with IntelliJ platform icons (AllIcons.Nodes.*) and clean up orphaned resources.

**BbjCompletionFeature.java -- Complete rewrite:**

1. Replace the entire file content with a comprehensive CompletionItemKind-to-platform-icon mapping:

```java
package com.basis.bbj.intellij.lsp;

import com.intellij.icons.AllIcons;
import org.eclipse.lsp4j.CompletionItemKind;
import org.jetbrains.annotations.Nullable;

import javax.swing.Icon;

/**
 * Maps LSP CompletionItemKind to IntelliJ platform icons.
 * Uses native platform icons for consistency with other languages.
 */
public final class BbjCompletionFeature {

    private BbjCompletionFeature() {
    }

    /**
     * Maps a completion item kind to a platform icon.
     *
     * @param kind the LSP completion item kind
     * @return icon for the kind, or null for default LSP4IJ handling
     */
    public static @Nullable Icon getIcon(@Nullable CompletionItemKind kind) {
        if (kind == null) {
            return null;
        }

        return switch (kind) {
            case Function, Method -> AllIcons.Nodes.Method;
            case Class -> AllIcons.Nodes.Class;
            case Interface -> AllIcons.Nodes.Interface;
            case Variable -> AllIcons.Nodes.Variable;
            case Field -> AllIcons.Nodes.Field;
            case Property -> AllIcons.Nodes.Property;
            case Keyword -> AllIcons.Nodes.Tag;
            case Constant -> AllIcons.Nodes.Constant;
            case Enum -> AllIcons.Nodes.Enum;
            case EnumMember -> AllIcons.Nodes.Field;
            case Module, Package -> AllIcons.Nodes.Package;
            case Snippet -> AllIcons.Nodes.Template;
            default -> null;
        };
    }
}
```

Key mapping decisions per CONTEXT.md:
- Function/Method -> AllIcons.Nodes.Method (standard for callable symbols)
- Class -> AllIcons.Nodes.Class
- Variable -> AllIcons.Nodes.Variable (distinct from Field)
- Field -> AllIcons.Nodes.Field
- Keyword -> AllIcons.Nodes.Tag (distinct visual, recognizable)
- Constant -> AllIcons.Nodes.Constant
- Enum -> AllIcons.Nodes.Enum
- Module/Package -> AllIcons.Nodes.Package

Note: Remove the import of `com.basis.bbj.intellij.BbjIcons` -- it's no longer needed.

**BbjIcons.java -- Remove orphaned icon constants:**

2. Remove these three lines from BbjIcons.java:
```java
Icon FUNCTION = IconLoader.getIcon("/icons/bbj-function.svg", BbjIcons.class);
Icon VARIABLE = IconLoader.getIcon("/icons/bbj-variable.svg", BbjIcons.class);
Icon KEYWORD = IconLoader.getIcon("/icons/bbj-keyword.svg", BbjIcons.class);
```
Keep all other icon constants (FILE, STATUS_READY, STATUS_STARTING, STATUS_ERROR, TOOL_WINDOW, INTEROP_CONNECTED, INTEROP_DISCONNECTED, CONFIG, RUN_GUI, RUN_BUI, RUN_DWC).

**Delete orphaned SVG icon files:**

3. Delete these files:
- `bbj-intellij/src/main/resources/icons/bbj-function.svg`
- `bbj-intellij/src/main/resources/icons/bbj-variable.svg`
- `bbj-intellij/src/main/resources/icons/bbj-keyword.svg`

**Delete stale META-INF directory (FIX-06):**

4. Delete the entire `bbj-intellij/META-INF/` directory (contains an outdated plugin.xml from early development). The canonical plugin.xml is at `bbj-intellij/src/main/resources/META-INF/plugin.xml`.

Verify no other files reference the stale META-INF path before deleting.
  </action>
  <verify>
Run `./gradlew build` from bbj-intellij/ -- build succeeds. Verify BbjCompletionFeature.java imports AllIcons.Nodes (not BbjIcons). Verify BbjIcons.java has no FUNCTION/VARIABLE/KEYWORD constants. Verify bbj-function.svg, bbj-variable.svg, bbj-keyword.svg deleted. Verify bbj-intellij/META-INF/ directory no longer exists.
  </verify>
  <done>
BbjCompletionFeature maps CompletionItemKind to AllIcons.Nodes platform icons. BbjIcons.java cleaned of orphaned FUNCTION/VARIABLE/KEYWORD constants. Three orphaned SVG files deleted. Stale bbj-intellij/META-INF/ directory deleted. Build compiles.
  </done>
</task>

<task type="auto">
  <name>Task 3: Review and fix Linux code paths</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDetector.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjNodeDownloader.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServer.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjHomeDetector.java
  </files>
  <action>
Review all platform-dependent code paths for Linux correctness. This is a code review + fix pass per CONTEXT.md -- no Linux runtime testing available.

**Review checklist for each file:**

1. **BbjNodeDetector.java** -- Review Node.js detection:
   - Uses `PathEnvironmentVariableUtil.findInPath("node")` -- this is correct for Linux (searches PATH)
   - Verify `canExecute()` check works for Linux binaries -- it does (Java File API)
   - NO changes expected unless issues found

2. **BbjNodeDownloader.java** -- Review download and extraction:
   - Check `getPlatformName()`: Returns "linux" for `SystemInfo.isLinux` -- correct
   - Check `getArchitecture()`: Currently returns "x64" for Linux regardless. This is wrong for Linux ARM64 (e.g., Raspberry Pi, AWS Graviton). Fix by adding ARM64 detection for Linux:
   ```java
   private static @NotNull String getArchitecture() {
       if (SystemInfo.isAarch64) {
           return "arm64";
       }
       if (!SystemInfo.is64Bit) {
           throw new UnsupportedOperationException("32-bit systems are not supported");
       }
       return "x64";
   }
   ```
   This simplifies the method: ARM64 detection applies to ALL platforms (macOS, Linux), then falls through to x64 check.
   - Check `extractTarGz()`: Uses `tar` command -- available on all Linux distros, correct
   - Check executable permission: `targetPath.toFile().setExecutable(true)` -- correct for Linux
   - Check `getNodeDataDirectory()`: Uses `PathManager.getPluginsPath()` -- IntelliJ handles this per-platform, correct

3. **BbjLanguageServer.java** -- Review language server startup:
   - `resolveNodePath()` falls through to "node" string if all detection fails -- on Linux this will work if node is on PATH
   - `resolveServerPath()` uses `PluginManagerCore.getPlugin()` which is platform-agnostic
   - `GeneralCommandLine` with `setWorkDirectory(new File(project.getBasePath()))` -- `File` handles forward slashes on all platforms
   - NO changes expected unless issues found

4. **BbjRunActionBase.java** -- Review run command paths:
   - `getBbjExecutablePath()`: Uses `SystemInfo.isWindows ? "bbj.exe" : "bbj"` -- correct, Linux uses "bbj" same as macOS
   - Uses `new File(bbjHome, "bin/" + exeName)` -- forward slash works on Linux/macOS
   - `getClasspathArg()`: Returns `-CP<entry>` -- this is a BBj flag, NOT a Java classpath. No path separator issue here since it's a single entry name, not a file path list
   - `getWebBbjPath()`: Uses `plugin.getPluginPath().resolve("lib/tools/web.bbj")` -- Path.resolve is cross-platform, correct
   - NO changes expected unless issues found

5. **BbjHomeDetector.java** -- Review BBj home detection:
   - `getCommonLocations()`: Returns `"/usr/local/bbx", "/opt/bbx", "/opt/basis/bbj"` for non-Windows -- these are standard Linux BBj locations, correct
   - `detectFromInstallerTrace()`: Uses `Paths.get(System.getProperty("user.home"), "BASIS", "Install.properties")` -- forward slashes, works on Linux
   - `isValidBbjHome()`: Uses `new File(path, "cfg/BBj.properties")` -- cross-platform, correct
   - NO changes expected unless issues found

**Summary of expected fixes:**
- BbjNodeDownloader.java: Simplify `getArchitecture()` to detect ARM64 on ALL platforms (not just macOS)
- All other files: Confirm correct, add clarifying comments where Linux behavior differs

If any additional issues are discovered during review, fix them and document in the summary.
  </action>
  <verify>
Run `./gradlew build` from bbj-intellij/ -- build succeeds. Inspect BbjNodeDownloader.getArchitecture(): ARM64 detection covers Linux (not just macOS). Verify all files use platform-agnostic APIs: PathEnvironmentVariableUtil for PATH searches, File/Path for filesystem operations, SystemInfo for platform detection.
  </verify>
  <done>
All Linux code paths reviewed and confirmed correct or fixed. BbjNodeDownloader ARM64 detection extended to Linux. No hardcoded path separators found. PathEnvironmentVariableUtil used for PATH searches. Build compiles.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew build` in bbj-intellij/ compiles successfully
2. BbjServerService has FileEditorManagerListener tracking open BBj files
3. Grace period: 30-second timer, cancellable on file reopen
4. BbjStatusBarWidget shows "BBj: Idle" during grace period
5. BbjCompletionFeature uses AllIcons.Nodes (no BbjIcons dependency)
6. Orphaned icon files (bbj-function.svg, bbj-variable.svg, bbj-keyword.svg) deleted
7. BbjIcons.java has no FUNCTION/VARIABLE/KEYWORD constants
8. bbj-intellij/META-INF/ directory deleted
9. BbjNodeDownloader detects ARM64 on Linux (not just macOS)
10. No hardcoded path separators in any file
</verification>

<success_criteria>
- Build compiles with zero errors
- FIX-04: LS stays alive 30 seconds after last file close, reuses on reopen
- FIX-05: Completion popup uses platform AllIcons.Nodes icons
- FIX-06: Stale bbj-intellij/META-INF/ directory removed
- FIX-07: Linux paths correct (ARM64 detection, PATH-based Node.js lookup, platform-agnostic file ops)
</success_criteria>

<output>
After completion, create `.planning/phases/10-bug-fixes-polish/10-02-SUMMARY.md`
</output>
