---
phase: 10-bug-fixes-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjCommenter.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjTokenTypes.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjWordLexer.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjPairedBraceMatcher.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServerFactory.java
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
autonomous: true

must_haves:
  truths:
    - "Pressing Cmd+/ on selected lines toggles REM comment prefix at column 0"
    - "Bracket matching highlights matching parentheses, square brackets, and curly braces when cursor is adjacent"
    - "Cmd+hover no longer shows 'LSP Symbol ...' placeholder text"
  artifacts:
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjCommenter.java"
      provides: "REM line comment prefix for Cmd+/ toggling"
      contains: "REM "
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjPairedBraceMatcher.java"
      provides: "Bracket pair definitions for (), [], {}"
      contains: "BracePair"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjTokenTypes.java"
      provides: "Token types for bracket characters"
      contains: "LPAREN"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjWordLexer.java"
      provides: "Lexer emitting bracket-specific tokens"
      contains: "LPAREN"
    - path: "bbj-intellij/src/main/resources/META-INF/plugin.xml"
      provides: "Extension point registrations for braceMatcher"
      contains: "lang.braceMatcher"
  key_links:
    - from: "BbjPairedBraceMatcher"
      to: "BbjTokenTypes"
      via: "BracePair references LPAREN/RPAREN token types"
      pattern: "BbjTokenTypes\\.LPAREN"
    - from: "BbjWordLexer"
      to: "BbjTokenTypes"
      via: "Lexer emits bracket-specific token types"
      pattern: "BbjTokenTypes\\.LPAREN"
    - from: "plugin.xml"
      to: "BbjPairedBraceMatcher"
      via: "lang.braceMatcher extension point registration"
      pattern: "lang\\.braceMatcher"
---

<objective>
Fix comment toggling (FIX-01), bracket matching (FIX-02), and LSP Symbol popup (FIX-03).

Purpose: Three editor-level bugs that affect daily BBj editing experience -- comment toggling is non-functional at column 0, brackets don't highlight, and Cmd+hover shows placeholder text.
Output: Working Cmd+/ comment toggle with REM at column 0, bracket matching for (), [], {}, and suppressed or meaningful Cmd+hover content.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-bug-fixes-polish/10-CONTEXT.md
@.planning/phases/10-bug-fixes-polish/10-RESEARCH.md
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjCommenter.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjTokenTypes.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjWordLexer.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServerFactory.java
@bbj-intellij/src/main/resources/META-INF/plugin.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix comment toggling and enforce column-0 REM placement</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjCommenter.java
  </files>
  <action>
The existing BbjCommenter.java already returns "REM " from getLineCommentPrefix() -- this is correct. However, IntelliJ's default comment handler may place the prefix at indentation level rather than column 0.

To force column-0 placement per CONTEXT.md decisions:

1. Read the existing BbjCommenter.java (already implements Commenter interface with "REM " prefix).

2. The key insight: IntelliJ checks the language's CodeStyle setting `LINE_COMMENT_AT_FIRST_COLUMN` to decide placement. By default this is false (indent-aware). We need to make it true for BBj.

3. Create a new file `BbjLanguageCodeStyleSettingsProvider.java` in the same package (`com.basis.bbj.intellij`) that extends `LanguageCodeStyleSettingsProvider`:

```java
package com.basis.bbj.intellij;

import com.intellij.application.options.IndentOptionsEditor;
import com.intellij.lang.Language;
import com.intellij.psi.codeStyle.CodeStyleSettingsCustomizable;
import com.intellij.psi.codeStyle.CommonCodeStyleSettings;
import com.intellij.psi.codeStyle.LanguageCodeStyleSettingsProvider;
import org.jetbrains.annotations.NotNull;

public class BbjLanguageCodeStyleSettingsProvider extends LanguageCodeStyleSettingsProvider {
    @Override
    public @NotNull Language getLanguage() {
        return BbjLanguage.INSTANCE;
    }

    @Override
    public CommonCodeStyleSettings getDefaultCommonSettings() {
        CommonCodeStyleSettings settings = new CommonCodeStyleSettings(BbjLanguage.INSTANCE);
        settings.LINE_COMMENT_AT_FIRST_COLUMN = true;
        settings.BLOCK_COMMENT_AT_FIRST_COLUMN = true;
        return settings;
    }

    @Override
    public String getCodeSample(@NotNull SettingsType settingsType) {
        return "REM Sample BBj code\nPRINT \"Hello World\"\n";
    }
}
```

4. Register it in plugin.xml by adding inside the `<extensions defaultExtensionNs="com.intellij">` block:
```xml
<langCodeStyleSettingsProvider
    implementation="com.basis.bbj.intellij.BbjLanguageCodeStyleSettingsProvider"/>
```

5. The existing BbjCommenter is fine as-is. The comment stacking behavior (REM REM ...) is handled automatically by IntelliJ's default CommentByLineCommentHandler -- when you comment a line that already starts with "REM ", it prepends another "REM " to the beginning, producing "REM REM original". Uncommenting strips exactly one "REM " from the start.

IMPORTANT from CONTEXT.md decisions:
- REM placed at column 0, before indentation: `REM    code here`
- When commenting: always add `REM ` (with trailing space) to every line, including empty lines
- Mixed selections: comment ALL lines (stack REM if needed)
- When uncommenting: strip exactly one `REM ` (or `REM` if no space follows)
  </action>
  <verify>
Run `./gradlew build` from bbj-intellij/ directory -- build succeeds with no compilation errors. Visually verify: BbjCommenter returns "REM " prefix, BbjLanguageCodeStyleSettingsProvider sets LINE_COMMENT_AT_FIRST_COLUMN = true.
  </verify>
  <done>
BbjCommenter returns "REM " prefix. BbjLanguageCodeStyleSettingsProvider forces LINE_COMMENT_AT_FIRST_COLUMN = true for BBj language. Both registered in plugin.xml. Build compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement bracket matching with lexer token types</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjTokenTypes.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjWordLexer.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjPairedBraceMatcher.java
    bbj-intellij/src/main/resources/META-INF/plugin.xml
  </files>
  <action>
The current BbjWordLexer classifies all punctuation (including brackets) as a single `BbjTokenTypes.SYMBOL` token type. The PairedBraceMatcher needs distinct token types for each bracket character.

1. **Update BbjTokenTypes.java** -- Add 6 new token type constants for bracket pairs:
```java
public static final IElementType LPAREN = new IElementType("BBJ_LPAREN", BbjLanguage.INSTANCE);
public static final IElementType RPAREN = new IElementType("BBJ_RPAREN", BbjLanguage.INSTANCE);
public static final IElementType LBRACKET = new IElementType("BBJ_LBRACKET", BbjLanguage.INSTANCE);
public static final IElementType RBRACKET = new IElementType("BBJ_RBRACKET", BbjLanguage.INSTANCE);
public static final IElementType LBRACE = new IElementType("BBJ_LBRACE", BbjLanguage.INSTANCE);
public static final IElementType RBRACE = new IElementType("BBJ_RBRACE", BbjLanguage.INSTANCE);
```
Keep existing WORD and SYMBOL types.

2. **Update BbjWordLexer.java** -- In the `advance()` method, before the generic single-character SYMBOL fallback, add bracket character detection:
```java
} else {
    // Punctuation / operators -- single character each
    tokenEnd = tokenStart + 1;
    tokenType = switch (c) {
        case '(' -> BbjTokenTypes.LPAREN;
        case ')' -> BbjTokenTypes.RPAREN;
        case '[' -> BbjTokenTypes.LBRACKET;
        case ']' -> BbjTokenTypes.RBRACKET;
        case '{' -> BbjTokenTypes.LBRACE;
        case '}' -> BbjTokenTypes.RBRACE;
        default -> BbjTokenTypes.SYMBOL;
    };
}
```
This replaces the existing else block that always returns SYMBOL. Bracket characters now get specific token types; all other punctuation remains SYMBOL.

3. **Create BbjPairedBraceMatcher.java** -- New file at `com.basis.bbj.intellij.BbjPairedBraceMatcher`:
```java
package com.basis.bbj.intellij;

import com.intellij.lang.BracePair;
import com.intellij.lang.PairedBraceMatcher;
import com.intellij.psi.PsiFile;
import com.intellij.psi.tree.IElementType;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;

public class BbjPairedBraceMatcher implements PairedBraceMatcher {
    private static final BracePair[] PAIRS = new BracePair[]{
        new BracePair(BbjTokenTypes.LPAREN, BbjTokenTypes.RPAREN, false),
        new BracePair(BbjTokenTypes.LBRACKET, BbjTokenTypes.RBRACKET, false),
        new BracePair(BbjTokenTypes.LBRACE, BbjTokenTypes.RBRACE, true),
    };

    @Override
    public BracePair @NotNull [] getPairs() {
        return PAIRS;
    }

    @Override
    public boolean isPairedBracesAllowedBeforeType(
            @NotNull IElementType lbraceType,
            @Nullable IElementType contextType) {
        return true;
    }

    @Override
    public int getCodeConstructStart(PsiFile file, int openingBraceOffset) {
        return openingBraceOffset;
    }
}
```

4. **Register in plugin.xml** -- Add inside `<extensions defaultExtensionNs="com.intellij">`, near the existing `lang.commenter` registration:
```xml
<!-- Bracket matching for (), [], {} -->
<lang.braceMatcher language="BBj"
                    implementationClass="com.basis.bbj.intellij.BbjPairedBraceMatcher"/>
```
  </action>
  <verify>
Run `./gradlew build` from bbj-intellij/ -- build succeeds. Inspect BbjTokenTypes.java has 8 token types (WORD, SYMBOL, LPAREN, RPAREN, LBRACKET, RBRACKET, LBRACE, RBRACE). Inspect BbjWordLexer.advance() emits bracket-specific tokens. Inspect plugin.xml has lang.braceMatcher registration.
  </verify>
  <done>
BbjTokenTypes has bracket token types. BbjWordLexer emits them. BbjPairedBraceMatcher defines 3 brace pairs. Extension registered in plugin.xml. Build compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Suppress LSP Symbol hover placeholder</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServerFactory.java
  </files>
  <action>
The "LSP Symbol ..." placeholder text appears on Cmd+hover when LSP4IJ provides a quick-info tooltip before the language server responds with hover content.

The BbjLanguageServerFactory.createClientFeatures() already returns an anonymous LSPClientFeatures subclass. This is where we customize hover behavior.

**Approach:** LSP4IJ's LSPClientFeatures supports feature customization. The goal is to suppress or customize the hover feature to avoid showing placeholder text.

1. Read the current BbjLanguageServerFactory.java.

2. In the `createClientFeatures()` method, chain a hover feature customization after the existing `.setDocumentLinkFeature(...)` call. There are several approaches to try, in order of preference:

   **Option A (preferred):** Set a custom LSPHoverFeature that returns false for `isEnabled()` if the hover content would be placeholder text. Import `com.redhat.devtools.lsp4ij.client.features.LSPHoverFeature` and add:
   ```java
   .setHoverFeature(new LSPHoverFeature() {
       @Override
       public boolean isEnabled(@NotNull PsiFile file) {
           return false;
       }
   })
   ```
   This disables LSP4IJ's hover entirely for BBj files, which suppresses the placeholder. The language server's actual hover responses will still be available through standard mechanisms.

   **Option B (if setHoverFeature doesn't exist):** Check if LSPClientFeatures has a method like `setDocumentationFeature()` or override `createHoverProvider()`. Look at the LSPClientFeatures class API to find the right hook.

   **Option C (fallback):** If neither A nor B works, the placeholder may come from LSP4IJ's internal symbol-at-cursor feature. Check if there's a way to override `LSPDocumentSymbolFeature` or `setCodeLensFeature()` to suppress it.

3. Important: Test compilation. If `LSPHoverFeature` class doesn't exist in the LSP4IJ version used, check imports. The correct class may be named differently. Inspect the LSP4IJ dependency JAR for available classes:
   ```
   find bbj-intellij/.intellijPlatform -name "LSP*Feature*.class" 2>/dev/null
   ```

4. If hover suppression via LSPClientFeatures proves impossible (class not found, method not available), leave a `// TODO FIX-03: LSP4IJ hover suppression` comment explaining what was tried and why. This is LOW confidence research area per 10-RESEARCH.md.

NOTE: This fix has the lowest confidence of the three. If compilation fails after attempting the hover override, revert to the original BbjLanguageServerFactory code and add a TODO comment. Do NOT let this task block the plan.
  </action>
  <verify>
Run `./gradlew build` from bbj-intellij/ -- build succeeds. If hover suppression was implemented, verify the LSPHoverFeature import resolves. If it could not be implemented, verify a TODO comment exists in BbjLanguageServerFactory.java explaining the issue.
  </verify>
  <done>
Either: (a) LSP hover placeholder is suppressed via LSPClientFeatures customization and build compiles, or (b) a TODO comment documents what was tried and why it couldn't be implemented yet. Build compiles in either case.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew build` in bbj-intellij/ compiles successfully
2. BbjCommenter returns "REM " prefix
3. BbjLanguageCodeStyleSettingsProvider sets LINE_COMMENT_AT_FIRST_COLUMN = true
4. BbjPairedBraceMatcher defines pairs for (), [], {}
5. BbjWordLexer emits bracket-specific token types
6. plugin.xml has lang.braceMatcher and langCodeStyleSettingsProvider registrations
7. BbjLanguageServerFactory either suppresses hover or has TODO comment
</verification>

<success_criteria>
- Build compiles with zero errors
- FIX-01: BbjCommenter + CodeStyle settings ensure REM at column 0
- FIX-02: BbjPairedBraceMatcher + lexer token types enable bracket matching
- FIX-03: Hover placeholder addressed (suppressed or documented as blocked)
</success_criteria>

<output>
After completion, create `.planning/phases/10-bug-fixes-polish/10-01-SUMMARY.md`
</output>
