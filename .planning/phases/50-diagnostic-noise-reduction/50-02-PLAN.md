---
phase: 50-diagnostic-noise-reduction
plan: 02
type: execute
wave: 2
depends_on:
  - 50-01
files_modified:
  - bbj-vscode/package.json
  - bbj-vscode/src/extension.ts
  - bbj-vscode/src/language/bbj-ws-manager.ts
  - bbj-vscode/src/language/main.ts
autonomous: true
requirements:
  - DIAG-02

must_haves:
  truths:
    - "bbj.diagnostics.suppressCascading setting exists in VS Code settings with default true"
    - "bbj.diagnostics.maxErrors setting exists in VS Code settings with default 20"
    - "Changing suppressCascading to false disables all suppression without restart"
    - "Changing maxErrors to a different number caps parse errors at that number without restart"
    - "A status bar item shows when the active document has Error-severity diagnostics"
  artifacts:
    - path: "bbj-vscode/package.json"
      provides: "Two new settings in contributes.configuration"
      contains: "bbj.diagnostics.suppressCascading"
    - path: "bbj-vscode/src/extension.ts"
      provides: "initializationOptions entries and status bar item"
      contains: "suppressCascading"
    - path: "bbj-vscode/src/language/bbj-ws-manager.ts"
      provides: "Settings read from initializationOptions on server start"
      contains: "setSuppressCascading"
    - path: "bbj-vscode/src/language/main.ts"
      provides: "Settings applied on configuration change"
      contains: "setSuppressCascading"
  key_links:
    - from: "bbj-vscode/src/extension.ts"
      to: "bbj-vscode/src/language/bbj-ws-manager.ts"
      via: "initializationOptions object"
      pattern: "suppressCascading.*getConfiguration"
    - from: "bbj-vscode/src/language/bbj-ws-manager.ts"
      to: "bbj-vscode/src/language/bbj-document-validator.ts"
      via: "setSuppressCascading() and setMaxErrors() function calls"
      pattern: "setSuppressCascading\\("
    - from: "bbj-vscode/src/language/main.ts"
      to: "bbj-vscode/src/language/bbj-document-validator.ts"
      via: "setSuppressCascading() and setMaxErrors() on config change"
      pattern: "setSuppressCascading\\("
---

<objective>
Wire the diagnostic suppression settings from VS Code configuration through the language server initialization and live configuration change pipeline, and add a status bar indicator when diagnostics are being suppressed.

Purpose: The core suppression logic from Plan 01 needs to be controllable by users. This plan adds two VS Code settings (`bbj.diagnostics.suppressCascading` and `bbj.diagnostics.maxErrors`), wires them through the established `initializationOptions` + `onDidChangeConfiguration` pattern, and adds a status bar hint when suppression is active.

Output: Modified `package.json` (settings schema), `extension.ts` (initializationOptions + status bar), `bbj-ws-manager.ts` (init read), `main.ts` (config change handler).
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-diagnostic-noise-reduction/50-RESEARCH.md
@.planning/phases/50-diagnostic-noise-reduction/50-01-SUMMARY.md
@bbj-vscode/package.json (lines 248-490 — settings schema)
@bbj-vscode/src/extension.ts (lines 676-704 — startLanguageClient, initializationOptions)
@bbj-vscode/src/language/bbj-ws-manager.ts (lines 33-68 — onInitialize handler)
@bbj-vscode/src/language/main.ts (lines 74-147 — onDidChangeConfiguration handler)
@bbj-vscode/src/language/bbj-document-validator.ts (exported setSuppressCascading, setMaxErrors from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add settings schema to package.json and wire through initialization and config change</name>
  <files>bbj-vscode/package.json, bbj-vscode/src/extension.ts, bbj-vscode/src/language/bbj-ws-manager.ts, bbj-vscode/src/language/main.ts</files>
  <action>
**1. package.json — Add two settings** in `contributes.configuration.properties` (after `bbj.typeResolution.warnings`):

```json
"bbj.diagnostics.suppressCascading": {
  "type": "boolean",
  "default": true,
  "description": "Suppress cascading linking and validation noise when parse errors exist. When enabled, a single syntax error shows only the actual error instead of 40+ downstream diagnostics.",
  "scope": "window"
},
"bbj.diagnostics.maxErrors": {
  "type": "number",
  "default": 20,
  "minimum": 1,
  "description": "Maximum number of parse errors displayed at once. Additional parse errors beyond this limit are hidden to reduce noise.",
  "scope": "window"
}
```

Follow existing `bbj.*` namespace conventions. Place after the `bbj.typeResolution.warnings` setting and before `bbj.configPath`.

**2. extension.ts — Add to initializationOptions** (in `startLanguageClient()`, inside the `initializationOptions` object, after the `interopPort` line):

```typescript
suppressCascading: vscode.workspace.getConfiguration("bbj").get("diagnostics.suppressCascading", true),
maxErrors: vscode.workspace.getConfiguration("bbj").get("diagnostics.maxErrors", 20),
```

**3. bbj-ws-manager.ts — Read settings on initialization:**

Add import at the top:
```typescript
import { setSuppressCascading, setMaxErrors } from "./bbj-document-validator.js";
```

In the `onInitialize` handler, after the `setTypeResolutionWarnings` block (after line 66), add:

```typescript
// Set diagnostic suppression settings
const suppressCascading = params.initializationOptions.suppressCascading;
if (suppressCascading === false) {
    setSuppressCascading(false);
    logger.info('Diagnostic cascading suppression disabled');
} else {
    setSuppressCascading(true);
    logger.info('Diagnostic cascading suppression enabled');
}

const maxErrors = params.initializationOptions.maxErrors;
if (typeof maxErrors === 'number' && maxErrors >= 1) {
    setMaxErrors(maxErrors);
    logger.info(`Max displayed errors: ${maxErrors}`);
} else {
    setMaxErrors(20);
}
```

Follow the exact same pattern as the `typeResWarnings` block just above.

**4. main.ts — Apply settings on configuration change:**

Add import at the top (add to existing imports or create new import line):
```typescript
import { setSuppressCascading, setMaxErrors } from './bbj-document-validator.js';
```

In the `onDidChangeConfiguration` handler, after the `config.debug` block (after line 96), add:

```typescript
// Apply diagnostic suppression settings (no startup gate — apply immediately)
if (config.diagnostics?.suppressCascading !== undefined) {
    setSuppressCascading(config.diagnostics.suppressCascading);
}
if (config.diagnostics?.maxErrors !== undefined) {
    setMaxErrors(config.diagnostics.maxErrors);
}
```

Place this BEFORE the `if (!workspaceInitialized)` guard so these settings apply immediately, same as the `debug` setting. The diagnostic suppression does not need Java class reload, so it should not be blocked by the startup gate.

**What to avoid and WHY:**
- Do NOT put diagnostic settings behind the `!workspaceInitialized` guard — they don't trigger Java class reload and should apply immediately.
- Do NOT create a separate configuration change handler — use the existing one in `main.ts`.
- Do NOT use `.get<boolean>()` generic in extension.ts — use the default value pattern `.get("key", defaultValue)` matching existing code.
  </action>
  <verify>
Run `npm run build` from `bbj-vscode/` to verify TypeScript compilation succeeds. Verify the settings appear in package.json by searching for `bbj.diagnostics.suppressCascading`. Verify imports compile by checking `bbj-ws-manager.ts` and `main.ts` both import from `bbj-document-validator.js`.
  </verify>
  <done>
Both settings are defined in `package.json`, passed through `initializationOptions` in `extension.ts`, read on init in `bbj-ws-manager.ts`, and applied on config change in `main.ts`. The wiring follows the exact same pattern as `typeResolutionWarnings`. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add status bar indicator for active diagnostic suppression</name>
  <files>bbj-vscode/src/extension.ts</files>
  <action>
Add a status bar item in `extension.ts` that shows when diagnostics are being suppressed.

**Status bar implementation** — add in the `activate()` function, after existing status bar or UI setup code:

```typescript
// Diagnostic suppression status bar indicator
const suppressionStatusBar = vscode.window.createStatusBarItem(
    vscode.StatusBarAlignment.Left, 100
);
suppressionStatusBar.text = '$(warning) Diagnostics filtered';
suppressionStatusBar.tooltip = 'Parse errors detected — cascading linking and validation noise is hidden. Fix parse errors to see full diagnostics.';
context.subscriptions.push(suppressionStatusBar);

// Show/hide based on whether the active document has errors
const updateSuppressionStatus = () => {
    const editor = vscode.window.activeTextEditor;
    if (!editor || editor.document.languageId !== 'bbj') {
        suppressionStatusBar.hide();
        return;
    }
    const diags = vscode.languages.getDiagnostics(editor.document.uri);
    const hasError = diags.some(
        d => d.severity === vscode.DiagnosticSeverity.Error
    );
    // Simple heuristic: show when any error exists (suppression is likely active)
    // Phase 53 can refine with a custom LSP notification if needed
    if (hasError && vscode.workspace.getConfiguration("bbj").get("diagnostics.suppressCascading", true)) {
        suppressionStatusBar.show();
    } else {
        suppressionStatusBar.hide();
    }
};

context.subscriptions.push(
    vscode.languages.onDidChangeDiagnostics(() => updateSuppressionStatus())
);
context.subscriptions.push(
    vscode.window.onDidChangeActiveTextEditor(() => updateSuppressionStatus())
);
```

**Heuristic rationale (Claude's discretion):** The extension-side `vscode.languages.getDiagnostics()` cannot distinguish parse vs semantic errors (no access to `data.code`). Using a simple heuristic — show when any error exists AND suppression is enabled — is Good Enough for Phase 50. This may show the indicator even when only semantic errors exist (where only warning suppression is active, not linking suppression), which is still informative. Phase 53 can add a custom LSP notification for precise suppression state if needed.

**Status bar format (Claude's discretion):** Simple label `$(warning) Diagnostics filtered` with a tooltip explaining the situation. Not count-based — the count would require server-side information about how many were suppressed.

**What to avoid and WHY:**
- Do NOT try to access `data.code` from `vscode.languages.getDiagnostics()` — it's not available in the VS Code extension API.
- Do NOT add a custom LSP notification in Phase 50 — it adds complexity for marginal accuracy gain. Keep it simple.
- Do NOT forget to check `languageId !== 'bbj'` — suppress the indicator for non-BBj files.
  </action>
  <verify>
Run `npm run build` from `bbj-vscode/` to verify TypeScript compilation succeeds. Search `extension.ts` for `suppressionStatusBar` to confirm it exists. Run `npm test` to verify no regressions.
  </verify>
  <done>
Status bar item exists in `extension.ts` with `$(warning) Diagnostics filtered` text, tooltip explaining suppression, visibility gated on BBj language ID + error existence + setting enabled. Listeners on `onDidChangeDiagnostics` and `onDidChangeActiveTextEditor` keep it in sync. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` in `bbj-vscode/` compiles with zero errors
2. `npm test` in `bbj-vscode/` shows no new test failures
3. `grep "bbj.diagnostics.suppressCascading" bbj-vscode/package.json` returns the setting definition
4. `grep "bbj.diagnostics.maxErrors" bbj-vscode/package.json` returns the setting definition
5. `grep "setSuppressCascading" bbj-vscode/src/language/bbj-ws-manager.ts` confirms init wiring
6. `grep "setSuppressCascading" bbj-vscode/src/language/main.ts` confirms config change wiring
7. `grep "suppressionStatusBar" bbj-vscode/src/extension.ts` confirms status bar exists
8. `grep "suppressCascading" bbj-vscode/src/extension.ts` confirms initializationOptions entry
</verification>

<success_criteria>
- Two new settings visible in VS Code settings UI under BBj configuration
- Settings flow: package.json schema -> extension.ts initializationOptions -> bbj-ws-manager.ts onInitialize -> bbj-document-validator.ts module flags
- Settings flow: VS Code settings change -> main.ts onDidChangeConfiguration -> bbj-document-validator.ts module flags
- Status bar shows "Diagnostics filtered" when active BBj file has errors and suppression is enabled
- Status bar hides when no errors, non-BBj file, or suppression disabled
- Build and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/50-diagnostic-noise-reduction/50-02-SUMMARY.md`
</output>
