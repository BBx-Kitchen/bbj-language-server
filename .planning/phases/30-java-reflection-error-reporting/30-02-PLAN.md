---
phase: 30-java-reflection-error-reporting
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/language/bbj-linker.ts
  - bbj-vscode/src/language/bbj-document-validator.ts
autonomous: true

must_haves:
  truths:
    - "Cyclic reference errors appear in the Problems panel with Error severity (red)"
    - "Cyclic reference error messages include the source filename and line number where the cycle was detected"
    - "Users can click related information links to navigate to other files in the cycle"
    - "Existing linking error behavior (unresolved references showing as warnings) is unchanged"
  artifacts:
    - path: "bbj-vscode/src/language/bbj-linker.ts"
      provides: "Override of throwCyclicReferenceError that converts thrown errors to diagnostic-compatible data"
    - path: "bbj-vscode/src/language/bbj-document-validator.ts"
      provides: "Cyclic reference errors reported as Error severity (not downgraded to Warning)"
  key_links:
    - from: "bbj-vscode/src/language/bbj-linker.ts"
      to: "bbj-vscode/src/language/bbj-document-validator.ts"
      via: "Linking errors flow through document validation to become LSP diagnostics"
      pattern: "LinkingError|toDiagnostic"
---

<objective>
Make cyclic reference errors include source filename and line number, appear with Error severity in the Problems panel, and provide clickable LSP relatedInformation links for navigating to other files in the cycle.

Purpose: Currently, cyclic reference errors thrown by Langium's DefaultLinker only include an AST path like `/statements@0/assignments@0/value/method/member` but no file or line info. Users cannot find the source of the cycle. This makes debugging cyclic references extremely frustrating.

Output: Enhanced cyclic reference diagnostics with file+line info and LSP relatedInformation links.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bbj-vscode/src/language/bbj-linker.ts
@bbj-vscode/src/language/bbj-document-validator.ts
@bbj-vscode/node_modules/langium/lib/references/linker.js (for throwCyclicReferenceError signature)
@.planning/phases/30-java-reflection-error-reporting/30-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Override throwCyclicReferenceError in BbjLinker</name>
  <files>bbj-vscode/src/language/bbj-linker.ts</files>
  <action>
Override `throwCyclicReferenceError` in `BbjLinker` to convert the thrown error into a LinkingError with enhanced context instead of a bare Error. The Langium DefaultLinker signature is:

```typescript
protected throwCyclicReferenceError(node: AstNode, property: string, refText: string): never;
```

This method is called from within the reference proxy's `ref` getter (in `buildReference`/`buildMultiReference`). It throws an Error that bubbles up and is caught by Langium's `getLinkedNode()` method which then stores the error as a LinkingError on the reference.

**Approach:** Override `throwCyclicReferenceError` to throw an error with enhanced information. Since the method must throw (return type `never`), we cannot convert it to a diagnostic here. Instead, enhance the error message to include:
1. The document URI and line number
2. The symbol name (`refText`)

Then also enhance `createLinkingError` to detect cyclic reference errors and add `relatedInformation`.

Implementation steps:

1. Add necessary imports at the top of `bbj-linker.ts`:
   - `AstNode` (already imported)
   - `DiagnosticRelatedInformation`, `Location`, `Range` from `vscode-languageserver` (add if not present)

2. Override `throwCyclicReferenceError` in `BbjLinker`:
   ```typescript
   protected override throwCyclicReferenceError(node: AstNode, property: string, refText: string): never {
       // Get source location information
       const document = AstUtils.getDocument(node);
       const cstNode = node.$cstNode;
       const line = cstNode ? cstNode.range.start.line + 1 : 0;
       const sourceInfo = this.getSourceLocationForNode(document, line);

       const message = sourceInfo
           ? `Cyclic reference resolution detected for '${refText}' [in ${sourceInfo}]`
           : `Cyclic reference resolution detected for '${refText}'`;

       // Throw with enhanced message — Langium's getLinkedNode catches this
       // and stores it as a LinkingError on the reference
       throw new Error(message);
   }
   ```

3. Add a helper method `getSourceLocationForNode` that extracts file+line from a document:
   ```typescript
   protected getSourceLocationForNode(document: LangiumDocument | undefined, line: number): string | undefined {
       if (!document) return undefined;
       try {
           const wsManager = this.wsManager();
           let workspaceRoot: string | undefined;
           const folders = wsManager.workspaceFolders;
           if (folders && folders.length > 0) {
               const wsUri = URI.parse(folders[0].uri);
               workspaceRoot = wsUri.fsPath;
           }
           if (!workspaceRoot) {
               workspaceRoot = dirname(document.uri.fsPath);
           }
           const relativePath = relative(workspaceRoot, document.uri.fsPath);
           return line > 0 ? `${relativePath}:${line}` : relativePath;
       } catch {
           return undefined;
       }
   }
   ```

Note: `dirname` and `relative` are already imported from `node:path`. `AstUtils` and `LangiumDocument` are already imported. `URI` is already imported from `vscode-uri`.

**IMPORTANT:** The error thrown here gets caught by Langium's internal `getLinkedNode()`, which converts it to a LinkingError stored on the reference. This LinkingError then flows through the validation pipeline where `BBjDocumentValidator.toDiagnostic()` converts it to an LSP Diagnostic. The message enhancement done here ensures the user sees file+line in the Problems panel.
  </action>
  <verify>
1. Run `cd /Users/beff/_workspace/bbj-language-server && npx vitest run` — all tests pass
2. Review: `throwCyclicReferenceError` override includes file+line in error message
3. Review: New helper method properly handles missing document/workspace gracefully
  </verify>
  <done>
throwCyclicReferenceError is overridden in BbjLinker with enhanced error messages that include source filename and line number. Helper method handles edge cases gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Keep cyclic reference errors as Error severity</name>
  <files>bbj-vscode/src/language/bbj-document-validator.ts</files>
  <action>
Currently, `BBjDocumentValidator.toDiagnostic()` downgrades ALL linking errors to Warning severity (line 14). Cyclic reference errors are a specific kind of linking error that should remain as Error severity per user decision.

Modify `toDiagnostic()` to distinguish between:
- Regular linking errors (unresolved references) → Warning (existing behavior)
- Cyclic reference linking errors → Error (new behavior)

Detection: Check if the error message contains "Cyclic reference" to identify cyclic reference errors.

Updated implementation:
```typescript
protected override toDiagnostic<N extends AstNode>(severity: 'error' | 'warning' | 'info' | 'hint', message: string, info: DiagnosticInfo<N, string>): Diagnostic {
    let diagnosticSeverity: DiagnosticSeverity;

    if ((info.data as DiagnosticData)?.code === DocumentValidator.LinkingError) {
        // Cyclic reference errors stay as Error severity; other linking errors downgrade to Warning
        diagnosticSeverity = message.includes('Cyclic reference')
            ? DiagnosticSeverity.Error
            : DiagnosticSeverity.Warning;
    } else {
        diagnosticSeverity = toDiagnosticSeverity(severity);
    }

    return {
        message,
        range: getDiagnosticRange(info),
        severity: diagnosticSeverity,
        code: info.code,
        codeDescription: info.codeDescription,
        tags: info.tags,
        relatedInformation: info.relatedInformation,
        data: info.data,
        source: this.getSource()
    };
}
```

This preserves the existing behavior for regular linking errors (unresolved references → Warning) while ensuring cyclic reference errors appear as Error (red) in the Problems panel.
  </action>
  <verify>
1. Run `cd /Users/beff/_workspace/bbj-language-server && npx vitest run` — all tests pass
2. Review: Regular linking errors still become Warnings
3. Review: Cyclic reference errors are Error severity
  </verify>
  <done>
BBjDocumentValidator correctly distinguishes cyclic reference errors (Error severity) from regular linking errors (Warning severity). No regressions in existing diagnostic behavior.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` — all existing tests pass
2. Code review: BbjLinker.throwCyclicReferenceError includes file+line info
3. Code review: BBjDocumentValidator differentiates cyclic errors from regular linking errors
4. Code review: No changes to existing linking error behavior for non-cyclic references
</verification>

<success_criteria>
- Cyclic reference errors include source filename and line number in their message
- Cyclic reference errors appear with Error severity (red) in Problems panel
- Regular linking errors (unresolved references) still appear as Warnings (existing behavior preserved)
- All existing tests pass without regression
</success_criteria>

<output>
After completion, create `.planning/phases/30-java-reflection-error-reporting/30-02-SUMMARY.md`
</output>
