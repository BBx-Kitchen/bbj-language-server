---
phase: 43-run-command-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/extension.ts
  - bbj-vscode/src/Commands/Commands.cjs
  - bbj-vscode/tools/web.bbj
autonomous: false

must_haves:
  truths:
    - "BUI/DWC run commands launch successfully with token authentication"
    - "Login credentials do not prompt repeatedly after initial login"
    - "Run commands use configured config.bbx path from extension settings"
    - "Token authentication error 'undefined' no longer appears"
  artifacts:
    - path: "bbj-vscode/src/extension.ts"
      provides: "Token retrieval and credential passing for runBUI/runDWC"
      contains: "getEMCredentials"
    - path: "bbj-vscode/src/Commands/Commands.cjs"
      provides: "Run command execution with config.bbx path support"
      contains: "configPath"
    - path: "bbj-vscode/tools/web.bbj"
      provides: "BUI/DWC app launcher with token auth and config path"
      contains: "BBjAdminFactory.getBBjAdmin"
  key_links:
    - from: "bbj-vscode/src/extension.ts"
      to: "bbj-vscode/src/Commands/Commands.cjs"
      via: "credentials parameter in runBUI/runDWC"
      pattern: "Commands\\.run(BUI|DWC)\\(.*credentials"
    - from: "bbj-vscode/src/Commands/Commands.cjs"
      to: "bbj-vscode/tools/web.bbj"
      via: "command line arguments to web.bbj"
      pattern: "web\\.bbj.*token"
    - from: "extension settings"
      to: "bbj executable"
      via: "config.bbx path via -c flag"
      pattern: "bbj.*-c"
---

<objective>
Fix BUI/DWC run command authentication loop and enable custom config.bbx path support

Purpose: Users can launch BUI/DWC applications without repeated login prompts, using token-based authentication and custom BBj config files from extension settings. Closes GitHub issues #256, #359, and resolves #244 for run commands.

Output:
- Token authentication working end-to-end in published extension
- BUI/DWC launch completing without credential re-prompts
- Run commands respecting bbj.configPath setting
- Issue #256 documented as closed (token auth operational)
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 31 implemented configPath setting but only for language server
@.planning/phases/31-extension-settings-file-types/31-01-SUMMARY.md

# Current implementation files
@bbj-vscode/src/extension.ts
@bbj-vscode/src/Commands/Commands.cjs
@bbj-vscode/tools/web.bbj
@bbj-vscode/tools/em-login.bbj
@bbj-vscode/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix token auth credential passing</name>
  <files>
    bbj-vscode/src/extension.ts
    bbj-vscode/src/Commands/Commands.cjs
  </files>
  <action>
Diagnose and fix the "Authentication failed for user 'undefined'" error in published builds.

**Root cause analysis:**
The error message shows `user 'undefined'` which means `username!` is reaching BBjAdminFactory as undefined. In web.bbj lines 23-31, token auth should bypass username/password. The issue is likely in how credentials are passed from extension.ts to Commands.cjs.

**Fix in extension.ts (runBUI/runDWC commands, lines 414-443):**
1. Verify getEMCredentials() correctly returns {username: '__token__', password: token} format when token exists
2. Ensure credentials object is not undefined when passed to Commands.runBUI/runDWC
3. Add defensive check: if getEMCredentials() returns undefined after login attempt, log error and abort

**Fix in Commands.cjs (runWeb function, lines 46-96):**
1. Line 55-73: The credentials extraction logic is correct BUT verify it handles null/undefined credentials gracefully
2. Add validation: if (!credentials || !credentials.password) before line 57, show error and return early
3. Ensure token is extracted correctly when credentials.username === '__token__'
4. Log credential format (mask actual values) to help debug published builds: `logger.debug('Auth mode: ' + (token ? 'token' : 'password'))`

**Verification approach:**
The issue is "published version only" which suggests:
- Dev builds work (extension.ts code runs in Node context)
- Published builds fail (Commands.cjs bundled differently?)
- Check if SecretStorage API works differently in packaged VSIX

**If credentials are genuinely undefined in published builds:**
Add fallback error message in Commands.cjs runWeb():
```javascript
if (!credentials) {
  vscode.window.showErrorMessage(
    'BUI/DWC requires Enterprise Manager login. Please run "BBj: Login to Enterprise Manager" first.',
    'Login Now'
  ).then(sel => {
    if (sel === 'Login Now') vscode.commands.executeCommand('bbj.loginEM');
  });
  return;
}
```

This ensures users see actionable error instead of cryptic "user 'undefined'" from BBjAdminFactory.
  </action>
  <verify>
1. Build VSIX: `npm run package` in bbj-vscode directory
2. Install in clean VS Code: Install from .vsix file
3. Configure bbj.home setting
4. Run "BBj: Login to Enterprise Manager" command
5. Open a .bbj file, right-click > "Run as BUI"
6. Verify: Browser opens with BUI app (no repeated login prompts)
7. Check for error messages in VS Code Output panel (BBj Language Server channel)
8. Expected: No "Authentication failed for user 'undefined'" error
  </verify>
  <done>
getEMCredentials() returns valid credential object, runWeb() validates credentials before exec(), published extension launches BUI/DWC without "undefined" authentication errors, defensive error messages guide users if credentials missing
  </done>
</task>

<task type="auto">
  <name>Task 2: Add configPath support to run commands</name>
  <files>
    bbj-vscode/src/Commands/Commands.cjs
    bbj-vscode/tools/web.bbj
  </files>
  <action>
Pass the bbj.configPath setting from extension settings to bbj executable via -c flag for all run commands.

**Context from Phase 31:**
- bbj.configPath setting already exists (added in 31-01)
- Used by language server in bbj-ws-manager.ts for PREFIX resolution
- NOT yet used by run commands in Commands.cjs
- GitHub issue #244 comment: "The config still needs to be used for starting a program"

**Fix in Commands.cjs:**

**1. run() function (lines 194-228):**
Add configPath handling after line 195 (where bbj home is retrieved):
```javascript
const config = vscode.workspace.getConfiguration('bbj');
const configPath = config.get('configPath');
let configFlag = '';
if (configPath && configPath.trim() !== '') {
  configFlag = `-c"${configPath}"`;
}
```
Update cmd construction (line 212):
```javascript
const cmd = `"${bbj}" -q ${configFlag} ${sscp} -WD"${workingDir}" "${fileName}"`;
```

**2. runWeb() function (lines 46-96):**
Add configPath retrieval after line 50 (where webConfig is loaded):
```javascript
const config = vscode.workspace.getConfiguration('bbj');
const configPath = config.get('configPath') || '';
```
Pass configPath as 9th parameter to web.bbj (update line 87):
```javascript
const cmd = `"${bbj}" -q -WD"${webRunnerWorkingDir}" "${webRunnerWorkingDir}/web.bbj" - "${client}" "${name}" "${programme}" "${workingDir}" "${username}" "${password}" "${sscp}" "${token}" "${configPath}"`;
```

**Fix in web.bbj:**

**Current behavior (line 59):**
```bbj
app!.setString(app!.CONFIG_FILE, BBjAPI().getConfig().getConfigFileName())
```
This uses the runtime's current config, NOT the extension setting.

**Updated behavior:**
Add parameter extraction at top (after line 21):
```bbj
configPath! = ARGV(9,err=*next)
```
Update line 59 to use configPath if provided:
```bbj
configFile! = iff(configPath! <> null() and configPath! > "", configPath!, BBjAPI().getConfig().getConfigFileName())
app!.setString(app!.CONFIG_FILE, configFile!)
```

**Why this matters:**
- Users with custom BBj installations need non-default config.bbx paths
- Multi-environment setups (dev/staging/prod) use different configs
- Current code ignores the setting and always uses runtime default
- Language server respects the setting, but run commands don't (inconsistency)

**Backward compatibility:**
- If configPath setting is empty/null → use BBjAPI default (existing behavior)
- If configPath set → use custom path
- No breaking changes for users without custom config paths
  </action>
  <verify>
1. Open VS Code user settings (JSON)
2. Add custom config path: `"bbj.configPath": "/path/to/custom/config.bbx"`
3. Open a BBj file and run "BBj: Run Program"
4. Check process list: `ps aux | grep bbj | grep config.bbx`
5. Expected: Command includes `-c"/path/to/custom/config.bbx"` flag
6. Run "BBj: Run as BUI" and check web.bbj execution
7. Expected: BUI app uses custom config.bbx (verify via app properties in EM)
8. Remove bbj.configPath setting and re-run
9. Expected: Falls back to default config.bbx location
  </verify>
  <done>
run() command passes -c flag when configPath set, runWeb() passes configPath as 9th parameter, web.bbj uses configPath for app!.CONFIG_FILE when provided, empty/missing configPath falls back to BBjAPI default, run commands respect bbj.configPath setting consistently with language server
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify token auth and config path integration</name>
  <what-built>
Token-based authentication fixes and config.bbx path integration for BUI/DWC run commands. Fixed credential passing to prevent "undefined" auth errors, added configPath support to all run commands (run, runBUI, runDWC), and updated web.bbj to respect custom config paths.
  </what-built>
  <how-to-verify>
**Prerequisites:**
1. BBj installation with Enterprise Manager running
2. Clean VS Code installation or new workspace
3. VSIX package built from updated code

**Test Scenario 1: Token Authentication (Issue #359)**
1. Install the VSIX: `code --install-extension bbj-language-server-*.vsix`
2. Configure bbj.home pointing to your BBj installation
3. Open Command Palette and run "BBj: Login to Enterprise Manager"
4. Enter EM credentials (default: admin/admin123)
5. Expected: "Successfully logged in to Enterprise Manager" message
6. Open a .bbj file (or create test.bbj with `print "Hello BUI"`)
7. Right-click in editor > "Run as BUI"
8. Expected outcomes:
   - Browser opens with BUI application running
   - NO repeated login prompts
   - NO error: "Authentication failed for user 'undefined'"
   - VS Code Output panel (BBj Language Server) shows no auth errors
9. Close browser, right-click > "Run as DWC"
10. Expected: DWC launches without login prompt

**Test Scenario 2: Custom config.bbx Path (Issue #244)**
1. Locate your BBj config.bbx: typically `{bbj.home}/cfg/config.bbx`
2. Copy to custom location: `cp config.bbx /tmp/custom-config.bbx`
3. Edit `/tmp/custom-config.bbx` and change PREFIX line (for verification)
4. Open VS Code settings (JSON) and add:
   ```json
   "bbj.configPath": "/tmp/custom-config.bbx"
   ```
5. Open a .bbj file with `print "Config test"`
6. Right-click > "BBj: Run Program"
7. Check terminal output for bbj command
8. Expected: Command includes `-c"/tmp/custom-config.bbx"`
9. Right-click > "Run as BUI"
10. Open EM in browser (http://localhost:8888/bbjem/em)
11. Navigate to Applications tab, find your test app
12. Check Config File property
13. Expected: Shows `/tmp/custom-config.bbx` (not default location)

**Test Scenario 3: Backward Compatibility**
1. Remove bbj.configPath setting from VS Code settings
2. Restart VS Code (or reload window)
3. Right-click BBj file > "BBj: Run Program"
4. Expected: Runs successfully using default config.bbx location
5. Right-click > "Run as BUI"
6. Expected: BUI launches with default config (no errors)

**Test Scenario 4: Error Handling**
1. Clear stored EM credentials: Open Command Palette > "Developer: Reload Window"
2. Without logging in, right-click BBj file > "Run as BUI"
3. Expected: Clear error message prompting to login (NOT "user 'undefined'" error)
4. Set invalid configPath: `"bbj.configPath": "/nonexistent/config.bbx"`
5. Run program
6. Expected: Error message about invalid config path (graceful failure)

**Success Criteria:**
- [ ] BUI/DWC launches work on first try after EM login
- [ ] No repeated credential prompts during same session
- [ ] Custom config.bbx path respected in all run commands
- [ ] Default behavior preserved when configPath not set
- [ ] Error messages are actionable (no "undefined" errors)
- [ ] Issue #359 symptoms resolved (no login loop)
- [ ] Issue #244 requirement met (config.bbx from settings works)
  </how-to-verify>
  <resume-signal>
Type "approved" if all test scenarios pass, or describe any failures with error messages and unexpected behavior
  </resume-signal>
</task>

</tasks>

<verification>
After checkpoint approval:
1. Verify GitHub issues can be closed:
   - #359: BUI/DWC login loop → resolved by token auth fixes
   - #256: Token auth implemented → document as working in published builds
   - #244: config.bbx configurable → run commands now use setting
2. Test cross-platform (Windows vs Unix):
   - Windows: bbj.exe with -c flag
   - Unix/Mac: bbj with -c flag
3. Test edge cases:
   - Empty token (falls back to password auth gracefully)
   - Missing EM credentials (shows helpful error)
   - Invalid config path (fails gracefully with message)
4. Confirm no regressions:
   - Regular "Run Program" still works
   - Compile/Decompile commands unaffected
   - Language server features unchanged
</verification>

<success_criteria>
Phase complete when:
1. Published VSIX successfully launches BUI/DWC with token auth
2. No "Authentication failed for user 'undefined'" errors appear
3. Login credentials persist across BUI/DWC launches (no re-prompting)
4. bbj.configPath setting passed to bbj executable via -c flag
5. web.bbj uses custom config.bbx when configPath provided
6. Backward compatibility maintained (default config.bbx when setting empty)
7. Human verification checkpoint passes all test scenarios
8. Issues #256, #259, #244 confirmed ready to close
</success_criteria>

<output>
After completion, create `.planning/phases/43-run-command-fixes/43-01-SUMMARY.md` documenting:
- Token auth fixes (credential validation, error handling)
- config.bbx integration approach (bbj -c flag, web.bbj parameter)
- Test results from verification checkpoint
- GitHub issues ready to close
- Any discovered edge cases or limitations
</output>
