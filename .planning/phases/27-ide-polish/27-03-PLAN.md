---
phase: 27-ide-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/language/bbj-linker.ts
  - bbj-vscode/src/language/bbj-document-validator.ts
  - bbj-vscode/src/language/validations/check-classes.ts
autonomous: true

must_haves:
  truths:
    - "Linker error messages include the source filename where the unresolved reference originates"
    - "Visibility error messages include the filename of the class where the visibility restriction is declared"
    - "Error messages use workspace-relative paths (not absolute paths)"
    - "Error messages include line numbers when available (e.g., Helper.bbj:42)"
  artifacts:
    - path: "bbj-vscode/src/language/bbj-linker.ts"
      provides: "Enhanced linking error messages with source filename"
      contains: "relative"
    - path: "bbj-vscode/src/language/bbj-document-validator.ts"
      provides: "Enhanced diagnostic messages with source context"
      contains: "relative"
    - path: "bbj-vscode/src/language/validations/check-classes.ts"
      provides: "Enhanced class visibility error messages with source filename"
      contains: "relative"
  key_links:
    - from: "bbj-vscode/src/language/bbj-linker.ts"
      to: "Diagnostic messages shown in editor"
      via: "LinkingError.message consumed by DocumentValidator"
      pattern: "createLinkingError"
    - from: "bbj-vscode/src/language/validations/check-classes.ts"
      to: "Diagnostic messages shown in editor"
      via: "ValidationAcceptor accept calls"
      pattern: "accept.*error.*visible"
---

<objective>
Enhance linker and validation error messages to include source filenames and line numbers, making cross-file errors easier to understand and navigate.

Purpose: When the linker cannot resolve a reference or detects a visibility violation, the current error message gives no indication of which file is involved. Users must manually search for the reference target. Including the source filename (workspace-relative with line number) makes diagnosis immediate.
Output: Enhanced error messages in `bbj-linker.ts`, `bbj-document-validator.ts`, and `check-classes.ts` with source file context.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-ide-polish/27-RESEARCH.md
@bbj-vscode/src/language/bbj-linker.ts
@bbj-vscode/src/language/bbj-document-validator.ts
@bbj-vscode/src/language/bbj-validator.ts
@bbj-vscode/src/language/validations/check-classes.ts
@bbj-vscode/src/language/bbj-module.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance linker error messages with source filename</name>
  <files>bbj-vscode/src/language/bbj-linker.ts</files>
  <action>
Override `createLinkingError` in `BbjLinker` to include the source filename in the error message.

The `DefaultLinker.createLinkingError(refInfo)` creates a `LinkingError` with a message like:
`"Could not resolve reference to NamedElement named 'Foo'."`

Override it to append the source filename:
`"Could not resolve reference to NamedElement named 'Foo'. [in Helper.bbj:42]"`

**Implementation:**

```typescript
override createLinkingError(refInfo: ReferenceInfo): LinkingError {
    const error = super.createLinkingError(refInfo);
    // Enhance the message with source file context
    const sourceInfo = this.getSourceLocation(refInfo);
    if (sourceInfo) {
        error.message = `${error.message} [in ${sourceInfo}]`;
    }
    return error;
}
```

Add a helper method `getSourceLocation(refInfo: ReferenceInfo): string | undefined`:
1. Get the document from the reference: `AstUtils.getDocument(refInfo.container)`
2. Get workspace root from `this.wsManager()`:
   - If `wsManager` is a `BBjWorkspaceManager`, get workspace folders
   - Use `services.shared.workspace.WorkspaceManager` (already stored as `this.wsManager`)
   - Get the first workspace folder URI and convert to fsPath
3. Compute relative path: `relative(workspaceRoot, doc.uri.fsPath)`
4. Get line number from CST node:
   - If `refInfo.reference` is a `Reference` (check with `isReference`): use `refInfo.reference.$refNode?.range.start.line`
   - Add 1 for 1-based line numbers (LSP uses 0-based)
5. Return `"relativePath:lineNumber"` or just `"relativePath"` if no line info

**Required imports to add:**
- `relative` from `path` (or `node:path`)
- May need `URI` from `vscode-uri` for workspace folder path conversion

**Edge cases:**
- If workspace has no folders (single file mode), use `dirname(doc.uri.fsPath)` as fallback
- If `getSourceLocation` fails for any reason, return `undefined` and fall back to the original message without filename
- Wrap in try/catch to prevent enhanced messages from breaking linking
  </action>
  <verify>
Run `npm run build` in bbj-vscode directory to verify compilation.
Run `npm test` in bbj-vscode directory to verify existing tests pass.
  </verify>
  <done>
- `createLinkingError` override adds source filename to linking error messages
- Source filename is workspace-relative with line number
- Graceful fallback if workspace root unavailable
- Build and tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance class visibility error messages with source filename</name>
  <files>bbj-vscode/src/language/validations/check-classes.ts, bbj-vscode/src/language/bbj-validator.ts</files>
  <action>
Enhance visibility-related error messages in both `check-classes.ts` and `bbj-validator.ts` to include the source filename.

**In `check-classes.ts` (`ClassValidator`):**

1. Update `checkBBjClass` method's error messages to include the declaration file as a workspace-relative path:

Current: `"Protected class 'Foo' is not visible from this directory."`
Enhanced: `"Protected class 'Foo' (declared in Helper.bbj:10) is not visible from this directory."`

Current: `"Private class 'Foo' is not visible from this file."`
Enhanced: `"Private class 'Foo' (declared in Helper.bbj:10) is not visible from this file."`

The method already has `uriOfDeclaration` available as an absolute path. Convert it to workspace-relative using `relative()`. Get workspace root from the document URI of the usage location -- since both `uriOfUsage` and `uriOfDeclaration` are available, compute the relative path between them:
- Find common ancestor directory, or
- Simpler: use `relative(dirname(uriOfUsage), uriOfDeclaration)` for a path relative to the current file's location, OR
- Better: keep it simple and just use `basename(uriOfDeclaration)` for the filename since both absolute paths are available

Actually, for consistency with the linker approach, add a line number. The `klass` parameter is a `BbjClass` AstNode, so `klass.$cstNode?.range.start.line + 1` gives the line. Use `basename(uriOfDeclaration)` + `:lineNumber` since we don't have easy access to workspace root here.

Wait -- `dirname` and `relative` are already imported in this file. Use the declaration directory vs usage directory relationship that's already computed. The simplest approach: extract filename from `uriOfDeclaration` using `basename()` import from `path`.

Add `basename` to the existing `import { dirname, isAbsolute, relative } from 'path'` import.

Get line number: `klass.$cstNode?.range.start.line ? `:${klass.$cstNode.range.start.line + 1}` : ''`

Update the two error messages:
- Protected: ``accept("error", `Protected ${typeName} '${klass.name}' (declared in ${basename(uriOfDeclaration)}${lineInfo}) is not visible from this directory.`, info);``
- Private: ``accept("error", `Private ${typeName} '${klass.name}' (declared in ${basename(uriOfDeclaration)}${lineInfo}) is not visible from this file.`, info);``

**In `bbj-validator.ts` (`BBjValidator.checkClassReference`):**

This method has similar visibility checks (lines 165-195). Update the same way:
- Both `uriOfUsage` and `uriOfDeclaration` are already available
- Add `basename` to existing `import { dirname, isAbsolute, relative } from 'path'`
- Get line from `klass.$cstNode?.range.start.line`
- Update Protected and Private error messages to include `(declared in filename:line)`

Also update `checkMemberCallUsingAccessLevels` (line 157) which shows `"The member 'X' from the type 'Y' is not visible"`:
- The `classOfDeclaration` is available, and `member` has a ref. Get the declaration document from `AstUtils.getDocument(member)` if member is resolved.
- Enhanced: `"The member 'X' from the type 'Y' (in filename:line) is not visible"`

**Do NOT modify:**
- `checkUsedClassExists` -- this is a USE resolution warning, not a visibility error
- `checkCastTypeResolvable` -- this is a type resolution warning
- The unresolvable super warning in `checkMemberCallUsingAccessLevels` -- this is a type resolution warning

Per Claude's discretion: the linker error message detail level includes both symbol name and file, based on what information is available in each error path.
  </action>
  <verify>
Run `npm run build` in bbj-vscode directory.
Run `npm test` in bbj-vscode directory.
Verify error messages now include filename and line number by inspecting the modified accept() calls.
  </verify>
  <done>
- Protected/Private class visibility errors include `(declared in filename:line)`
- Member visibility errors include source file info when available
- Linker errors include `[in filename:line]` from Task 1
- All paths are relative (basename or workspace-relative), never absolute
- Build and tests pass
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds in bbj-vscode directory
2. `npm test` passes -- no regressions
3. `BbjLinker.createLinkingError` override includes source filename
4. `ClassValidator` visibility errors include declaration filename and line
5. `BBjValidator` visibility errors include declaration filename and line
6. All filenames are relative (not absolute paths)
7. Line numbers are 1-based (human-readable)
</verification>

<success_criteria>
- Linker "Could not resolve" errors include source filename with line number
- Class visibility "not visible" errors include declaration filename with line number
- Member visibility "not visible" errors include declaration file info
- All paths are workspace-relative or basename (never absolute)
- Build and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/27-ide-polish/27-03-SUMMARY.md`
</output>
