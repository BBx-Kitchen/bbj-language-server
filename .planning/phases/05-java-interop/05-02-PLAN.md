---
phase: 05-java-interop
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServerFactory.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjJavaInteropStatusBarWidget.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjJavaInteropStatusBarWidgetFactory.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjJavaInteropNotificationProvider.java
  - bbj-intellij/src/main/resources/icons/bbj-interop-connected.svg
  - bbj-intellij/src/main/resources/icons/bbj-interop-disconnected.svg
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
autonomous: true

must_haves:
  truths:
    - "Separate status bar widget shows java-interop connection state (Connected/Disconnected)"
    - "Status bar widget only visible when BBj file is open"
    - "Clicking status widget shows popup with host, port, and reconnect action"
    - "Persistent editor banner appears when java-interop is unreachable"
    - "Banner disappears when java-interop becomes available"
    - "Language server receives javaInteropHost and javaInteropPort in initializationOptions"
  artifacts:
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjJavaInteropStatusBarWidget.java"
      provides: "Java-interop status display in status bar"
      contains: "BbjJavaInteropStatusListener"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjJavaInteropStatusBarWidgetFactory.java"
      provides: "Widget factory registration"
      contains: "StatusBarWidgetFactory"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjJavaInteropNotificationProvider.java"
      provides: "Persistent editor banner for java-interop unavailable"
      contains: "EditorNotificationProvider"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServerFactory.java"
      provides: "javaInteropHost/Port in initializationOptions"
      contains: "javaInteropPort"
  key_links:
    - from: "BbjJavaInteropStatusBarWidget"
      to: "BbjJavaInteropService"
      via: "message bus subscription"
      pattern: "BbjJavaInteropStatusListener\\.TOPIC"
    - from: "BbjJavaInteropNotificationProvider"
      to: "BbjJavaInteropService"
      via: "getCurrentStatus() check"
      pattern: "getCurrentStatus"
    - from: "BbjLanguageServerFactory"
      to: "BbjSettings.javaInteropPort"
      via: "initializeParams override"
      pattern: "javaInteropPort"
---

<objective>
Create the java-interop status bar widget, persistent editor banner for unavailable state, and extend initializationOptions to pass java-interop configuration to the language server.

Purpose: Surfaces java-interop connection state to the user through a dedicated status bar indicator and persistent banner, matching the context decisions for separate widget and non-dismissible banner. Passes port config to LS so it knows where to connect.
Output: Status bar widget, editor banner, updated initializationOptions, icon SVGs.

Note on JAVA-02 (Java completions): The language server ALREADY implements full java-interop support.
The JavaInteropService class in java-interop.ts connects to BBjServices on port 5008, loads Java
classpath, resolves Java classes, and provides completions for Java class names and method signatures.
This is existing functionality used by the VS Code extension. The IntelliJ plugin does NOT need to
implement any new completion logic -- it just needs to:
1. Pass javaInteropHost/Port via initializationOptions (this task) so the LS can use a non-default port
2. Display connection status via the TCP health check (Plan 05-01) so the user knows if it is working

Note: The LS currently hardcodes DEFAULT_PORT=5008 and ignores initializationOptions for java-interop
port. Passing the config now is forward-compatible -- when the LS is updated to read these options,
the IntelliJ plugin will already be sending them.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-java-interop/05-01-SUMMARY.md
@bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjStatusBarWidget.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjStatusBarWidgetFactory.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjMissingHomeNotificationProvider.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServerFactory.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
@bbj-intellij/src/main/resources/META-INF/plugin.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend initializationOptions and create status bar widget</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/lsp/BbjLanguageServerFactory.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
    bbj-intellij/src/main/resources/icons/bbj-interop-connected.svg
    bbj-intellij/src/main/resources/icons/bbj-interop-disconnected.svg
    bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjJavaInteropStatusBarWidget.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjJavaInteropStatusBarWidgetFactory.java
  </files>
  <action>
    **BbjLanguageServerFactory.java:**
    - In the `initializeParams()` override inside `createClientFeatures()`, add two properties to the options JsonObject:
      ```java
      options.addProperty("javaInteropHost", "127.0.0.1");
      options.addProperty("javaInteropPort", state.javaInteropPort);
      ```
    - This passes java-interop config to the language server. The LS currently hardcodes DEFAULT_PORT=5008
      and ignores these options, but passing them now is forward-compatible for when the LS is updated
      to read configurable ports.

    **Icon SVGs** (create two new icons matching existing status icon pattern -- 13x13 viewBox, circle):
    - `bbj-interop-connected.svg`: Green circle (#50C878) -- same color as bbj-status-ready.svg but slightly smaller radius (r=4) to be visually distinct
    - `bbj-interop-disconnected.svg`: Gray circle (#888888) -- NOT red (red implies error/crash; gray implies "not available/inactive")

    **BbjIcons.java:**
    - Add two new icon constants:
      ```java
      Icon INTEROP_CONNECTED = IconLoader.getIcon("/icons/bbj-interop-connected.svg", BbjIcons.class);
      Icon INTEROP_DISCONNECTED = IconLoader.getIcon("/icons/bbj-interop-disconnected.svg", BbjIcons.class);
      ```

    **BbjJavaInteropStatusBarWidget.java** (new file, follow BbjStatusBarWidget.java pattern exactly):
    - Implement CustomStatusBarWidget
    - ID: "BbjJavaInteropStatus"
    - Panel: JPanel with FlowLayout containing icon JBLabel + text JBLabel (same as existing LSP widget)
    - Subscribe to BbjJavaInteropService.BbjJavaInteropStatusListener.TOPIC via project message bus
    - `updateStatus(InteropStatus status)` method:
      - CONNECTED: green icon (INTEROP_CONNECTED), text "Java: Connected"
      - DISCONNECTED: gray icon (INTEROP_DISCONNECTED), text "Java: Disconnected"
      - CHECKING: gray icon, text "Java: Checking..."
    - `updateVisibility()`: same logic as BbjStatusBarWidget -- only visible when BBj file is open (check file extensions bbj/bbl/bbjt/src)
    - Mouse click handler: show JPopupMenu with:
      - "Reconnect" -- calls BbjServerService.getInstance(project).restart() (full LS restart is the reconnect path per CONTEXT.md decisions)
      - "Open Settings" -- ShowSettingsUtil.getInstance().showSettingsDialog(project, "BBj")
    - Initialize with current status from BbjJavaInteropService.getInstance(project).getCurrentStatus()
    - Dispose: disconnect message bus connection

    **BbjJavaInteropStatusBarWidgetFactory.java** (new file, follow BbjStatusBarWidgetFactory.java pattern):
    - Implement StatusBarWidgetFactory
    - getId(): "BbjJavaInteropStatus"
    - getDisplayName(): "BBj Java Interop Status"
    - createWidget(Project): return new BbjJavaInteropStatusBarWidget(project)
    - isAvailable(Project): return true
  </action>
  <verify>
    Run `./gradlew buildPlugin` from bbj-intellij/ -- build compiles without errors.
    Grep for "javaInteropPort" in BbjLanguageServerFactory.java.
    Grep for "BbjJavaInteropStatusBarWidget" in BbjJavaInteropStatusBarWidgetFactory.java.
    Verify icon SVG files exist in resources/icons/.
  </verify>
  <done>
    InitializationOptions include javaInteropHost and javaInteropPort. Status bar widget displays java-interop connection state with appropriate icons. Widget shows popup on click with Reconnect and Open Settings actions. Icons created matching existing status icon style.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create editor banner and register all extensions in plugin.xml</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjJavaInteropNotificationProvider.java
    bbj-intellij/src/main/resources/META-INF/plugin.xml
  </files>
  <action>
    **BbjJavaInteropNotificationProvider.java** (new file, follow BbjMissingHomeNotificationProvider.java pattern):
    - Implement EditorNotificationProvider and DumbAware
    - `collectNotificationData()`:
      1. Return null if file is not BBj file type
      2. Get BbjJavaInteropService instance from project
      3. If currentStatus is CONNECTED or CHECKING, return null (no banner needed)
      4. If DISCONNECTED, return a function that creates EditorNotificationPanel:
         - Status: EditorNotificationPanel.Status.Warning
         - Text: "Start BBjServices for Java completions"
         - Action label: "Open Settings" linking to ShowSettingsUtil.getInstance().showSettingsDialog(project, BbjSettingsConfigurable.class)
    - The banner is non-dismissible (no close button -- this is the default for EditorNotificationPanel when you don't call createActionLabel with a close action)
    - Banner automatically disappears when BbjJavaInteropService broadcasts CONNECTED status because the service calls EditorNotifications.updateAllNotifications()

    **plugin.xml** (add ALL new extensions from this plan and Plan 01):
    - Add the status bar widget factory (after existing BbjLanguageServerStatus widget):
      ```xml
      <statusBarWidgetFactory
          id="BbjJavaInteropStatus"
          implementation="com.basis.bbj.intellij.ui.BbjJavaInteropStatusBarWidgetFactory"/>
      ```
    - Add the editor notification provider (after existing crash notification provider):
      ```xml
      <editorNotificationProvider
          implementation="com.basis.bbj.intellij.BbjJavaInteropNotificationProvider"/>
      ```
    - Note: BbjJavaInteropService was already registered in Plan 01 as a projectService. Verify it is present; if not, add:
      ```xml
      <projectService serviceImplementation="com.basis.bbj.intellij.ui.BbjJavaInteropService"/>
      ```
  </action>
  <verify>
    Run `./gradlew buildPlugin` from bbj-intellij/ -- build compiles without errors.
    Grep plugin.xml for "BbjJavaInteropStatus" (widget factory).
    Grep plugin.xml for "BbjJavaInteropNotificationProvider" (banner).
    Grep plugin.xml for "BbjJavaInteropService" (service).
  </verify>
  <done>
    Editor banner shows "Start BBjServices for Java completions" when java-interop is disconnected. Banner disappears when connection is established. All new extensions (service, widget, banner) registered in plugin.xml. Full build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew buildPlugin` succeeds without errors
2. plugin.xml contains all new registrations (service, widget factory, notification provider)
3. InitializationOptions includes javaInteropHost and javaInteropPort
4. Status bar widget subscribes to BbjJavaInteropStatusListener.TOPIC
5. Editor banner checks BbjJavaInteropService.getCurrentStatus()
6. Two new icon SVGs exist in resources/icons/
</verification>

<success_criteria>
- Build passes cleanly
- Status bar widget shows java-interop state (Connected/Disconnected) with colored icons
- Widget only visible when BBj file is open
- Widget click shows popup with Reconnect and Open Settings
- Editor banner appears when java-interop unavailable with "Start BBjServices for Java completions"
- Banner disappears when java-interop becomes available
- InitializationOptions include javaInteropHost/Port for language server
</success_criteria>

<output>
After completion, create `.planning/phases/05-java-interop/05-02-SUMMARY.md`
</output>
