---
phase: 05-java-interop
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjJavaInteropService.java
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
autonomous: true

must_haves:
  truths:
    - "Settings page shows java-interop port field with localhost label and default 5008"
    - "Port value persists across IDE restarts"
    - "Changing port triggers debounced language server restart"
    - "Java-interop connection status is checked via TCP and broadcast on message bus"
  artifacts:
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java"
      provides: "javaInteropPort field in State"
      contains: "javaInteropPort"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java"
      provides: "Port input field with static localhost label"
      contains: "javaInteropPort"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjJavaInteropService.java"
      provides: "TCP health check and status broadcast"
      contains: "BbjJavaInteropStatusListener"
  key_links:
    - from: "BbjSettingsConfigurable"
      to: "BbjServerService.scheduleRestart()"
      via: "apply() method"
      pattern: "scheduleRestart"
    - from: "BbjJavaInteropService"
      to: "message bus"
      via: "BbjJavaInteropStatusListener.TOPIC"
      pattern: "syncPublisher.*TOPIC"
---

<objective>
Add java-interop port configuration to settings and create a project-level service that monitors java-interop availability via TCP health checks, broadcasting status changes on the message bus.

Purpose: Foundation for java-interop UI components (status widget, editor banner) that need to know whether BBjServices is running. The port setting feeds into initializationOptions for the language server.
Output: Settings page with java-interop section, BbjJavaInteropService with periodic health check.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjServerService.java
@bbj-intellij/src/main/resources/META-INF/plugin.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add java-interop port to settings state and UI</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsComponent.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettingsConfigurable.java
  </files>
  <action>
    **BbjSettings.java:**
    - Add `public int javaInteropPort = 5008;` to the State class (int, not String -- port is numeric)
    - 5008 is the default matching the language server's hardcoded DEFAULT_PORT

    **BbjSettingsComponent.java:**
    - Add a new "Java Interop" TitledSeparator section to the form layout (after the "Language Server" section, before the fill component)
    - Add a static JBLabel showing "localhost" (not editable -- localhost-only per CONTEXT.md decisions)
    - Add a JBTextField for port input, defaulting to "5008"
    - Add a ComponentValidator on the port field:
      - Empty is valid (uses default 5008)
      - Must be numeric integer between 1 and 65535
      - Invalid values show ValidationInfo error
    - Add getter `getJavaInteropPort()` returning int (parse text field, default 5008 if empty/invalid)
    - Add setter `setJavaInteropPort(int port)` setting text field value
    - Layout: JBLabel "Host:" with static "localhost" text, then JBLabel "Port:" with the port text field, arranged horizontally or as separate labeled rows under the "Java Interop" separator

    **BbjSettingsConfigurable.java:**
    - Add javaInteropPort to `isModified()` comparison: `state.javaInteropPort != myComponent.getJavaInteropPort()`
    - Add javaInteropPort to `apply()`: `state.javaInteropPort = myComponent.getJavaInteropPort();`
    - Add javaInteropPort to `reset()`: `myComponent.setJavaInteropPort(state.javaInteropPort);`
    - The existing `scheduleRestart()` call in apply() already handles debounced restart when any setting changes -- no additional restart logic needed
  </action>
  <verify>
    Run `./gradlew buildPlugin` from bbj-intellij/ -- build compiles without errors.
    Grep for `javaInteropPort` in all three files to confirm wiring.
  </verify>
  <done>
    Settings page has a "Java Interop" section with static "localhost" label and editable port field defaulting to 5008. Port validates as integer 1-65535. Port persists via BbjSettings.State and changing it triggers language server restart.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BbjJavaInteropService with TCP health check</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjJavaInteropService.java
    bbj-intellij/src/main/resources/META-INF/plugin.xml
  </files>
  <action>
    **BbjJavaInteropService.java** (new file in ui/ package, following BbjServerService patterns):

    Create a project-level service that periodically checks if java-interop (BBjServices) is reachable on localhost:port via TCP socket.

    Structure:
    ```
    public final class BbjJavaInteropService implements Disposable {
        // States: CONNECTED, DISCONNECTED, CHECKING
        public enum InteropStatus { CONNECTED, DISCONNECTED, CHECKING }

        // Message bus topic for status changes
        public interface BbjJavaInteropStatusListener {
            Topic<BbjJavaInteropStatusListener> TOPIC = Topic.create(...)
            void statusChanged(InteropStatus status);
        }

        private InteropStatus currentStatus = InteropStatus.DISCONNECTED;
        private final Project project;
        private final Alarm checkAlarm;
        private long disconnectedSince = 0;  // timestamp for grace period
        private static final int CHECK_INTERVAL_MS = 5000;  // check every 5s
        private static final long GRACE_PERIOD_MS = 2000;   // 2s grace before broadcasting disconnect
    }
    ```

    Key methods:
    - `getInstance(Project project)` -- static factory via project.getService()
    - `startChecking()` -- begins periodic TCP check via Alarm. Called when language server status changes to "started" (subscribe to BbjServerStatusListener.TOPIC in constructor)
    - `stopChecking()` -- cancels alarm. Called when language server stops.
    - `checkConnection()` -- attempts TCP socket connect to localhost:port with 1000ms timeout. On success: status = CONNECTED, disconnectedSince = 0. On failure: if disconnectedSince == 0, set disconnectedSince = now, status stays CONNECTED (grace period). If now - disconnectedSince > GRACE_PERIOD_MS, status = DISCONNECTED.
    - `getCurrentStatus()` -- returns current InteropStatus
    - `broadcastStatus(InteropStatus newStatus)` -- if changed from previous, publish via message bus syncPublisher and trigger EditorNotifications.updateAllNotifications()
    - `dispose()` -- cancel alarm

    Important implementation details:
    - TCP check must NOT run on EDT. Use Alarm with ThreadToUse.POOLED_THREAD (same pattern as BbjServerService.restartAlarm)
    - Socket connect: `new Socket()`, `socket.connect(new InetSocketAddress("127.0.0.1", port), 1000)`, close immediately after. Wrap in try-catch.
    - Read port from BbjSettings.getInstance().getState().javaInteropPort at check time (not cached -- user may change it)
    - Subscribe to BbjServerService.BbjServerStatusListener.TOPIC in constructor: when server status is `started`, call `startChecking()`. When `stopped` or `stopping`, call `stopChecking()` and set status to DISCONNECTED.
    - Use ApplicationManager.invokeLater() for UI thread operations (message bus publish, editor notifications)

    **plugin.xml:**
    - Register as projectService: `<projectService serviceImplementation="com.basis.bbj.intellij.ui.BbjJavaInteropService"/>`
    - Place after the existing BbjServerService registration
  </action>
  <verify>
    Run `./gradlew buildPlugin` from bbj-intellij/ -- build compiles without errors.
    Grep for "BbjJavaInteropService" in plugin.xml to confirm registration.
    Grep for "BbjJavaInteropStatusListener" in BbjJavaInteropService.java to confirm topic exists.
  </verify>
  <done>
    BbjJavaInteropService exists as a project service. It subscribes to language server status, starts periodic TCP health checks when server is running, implements grace period for transient disconnects, and broadcasts java-interop status changes via message bus topic.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew buildPlugin` succeeds without errors
2. Settings page shows "Java Interop" section with localhost label and port field
3. BbjJavaInteropService registered in plugin.xml as projectService
4. BbjJavaInteropStatusListener.TOPIC defined for message bus broadcasting
5. Port field validates numeric input 1-65535
</verification>

<success_criteria>
- Build passes cleanly
- Settings state includes javaInteropPort with default 5008
- Settings UI has Java Interop section with static "localhost" and editable port
- Port changes trigger debounced language server restart via existing mechanism
- BbjJavaInteropService performs TCP health checks on localhost:port
- Grace period prevents flashing on transient disconnects
- Status changes broadcast via message bus topic
</success_criteria>

<output>
After completion, create `.planning/phases/05-java-interop/05-01-SUMMARY.md`
</output>
