---
phase: 58-grammar-additions
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-vscode/src/language/bbj.langium
  - bbj-vscode/src/language/bbj-token-builder.ts
  - bbj-vscode/test/parser.test.ts
  - bbj-vscode/src/language/generated/ast.ts
  - bbj-vscode/src/language/generated/grammar.ts
autonomous: true
requirements:
  - GRAM-01

must_haves:
  truths:
    - "`EXIT 0`, `EXIT 1`, and bare `EXIT` all parse without error in any program context"
    - "`EXIT myVar` and `EXIT fn(x)` parse without error (any numeric expression accepted)"
    - "Bare `EXIT` at end of line still works as a standalone statement"
    - "`RELEASE` with and without value still works identically to before"
  artifacts:
    - path: "bbj-vscode/src/language/bbj.langium"
      provides: "ExitWithNumberStatement rule using EXIT_NL and EXIT_NO_NL custom tokens"
      contains: "EXIT_NL"
    - path: "bbj-vscode/src/language/bbj-token-builder.ts"
      provides: "EXIT_NL and EXIT_NO_NL custom terminal token patterns"
      contains: "EXIT_NL"
    - path: "bbj-vscode/test/parser.test.ts"
      provides: "Parser tests for EXIT with optional numeric argument"
      contains: "EXIT 0"
  key_links:
    - from: "bbj-vscode/src/language/bbj.langium"
      to: "bbj-vscode/src/language/bbj-token-builder.ts"
      via: "EXIT_NL and EXIT_NO_NL terminal tokens referenced in grammar, built in token builder"
      pattern: "EXIT_NL|EXIT_NO_NL"
---

<objective>
Add optional numeric argument support to the EXIT verb so `EXIT 0`, `EXIT myVar`, and `EXIT fn(x)` all parse without error, while bare `EXIT` at end of line continues to work.

Purpose: Closes GRAM-01 (#376). Currently EXIT only works as a bare keyword — any numeric argument causes a parse error in valid BBj programs.

Output: Updated grammar, custom token builder, generated files, and parser tests.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/58-grammar-additions/58-CONTEXT.md

Key existing patterns to follow:
- RELEASE_NL / RELEASE_NO_NL custom token pattern in bbj-token-builder.ts (lines 81-97)
- RELEASE tokens spliced and given CATEGORIES + LONGER_ALT in buildTokens() (lines 52-57)
- ExitWithNumberStatement grammar rule at bbj.langium line 473-475
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add EXIT_NL and EXIT_NO_NL custom tokens and update grammar</name>
  <files>
    bbj-vscode/src/language/bbj-token-builder.ts
    bbj-vscode/src/language/bbj.langium
    bbj-vscode/src/language/generated/ast.ts
    bbj-vscode/src/language/generated/grammar.ts
  </files>
  <action>
Follow the RELEASE_NL / RELEASE_NO_NL pattern exactly to add EXIT_NL and EXIT_NO_NL tokens.

**In `bbj-token-builder.ts`:**

1. In `buildTerminalToken()`, add two new `else if` branches (after RELEASE_NO_NL, before RPAREN_NL):

   - `EXIT_NO_NL`: Pattern regex `/EXIT(?!\s*(;\s*|\r?\n))/i` — matches EXIT NOT followed by end-of-line/semicolon. `LINE_BREAKS: false`.
   - `EXIT_NL`: Pattern regex `/EXIT(?=\s*(;\s*|\r?\n))/i` — matches EXIT followed by end-of-line/semicolon. `LINE_BREAKS: false`.

2. In `buildTokens()`, add splice calls for both new tokens (next to the existing RELEASE splices around line 32-33):
   ```
   this.spliceToken(tokens, 'EXIT_NL');
   this.spliceToken(tokens, 'EXIT_NO_NL');
   ```

3. In `buildTokens()`, after the RELEASE CATEGORIES/LONGER_ALT block (after line 57), add the same for EXIT tokens:
   ```typescript
   const exitNl = terminalTokens.find(e => e.name === 'EXIT_NL')!;
   const exitNoNl = terminalTokens.find(e => e.name === 'EXIT_NO_NL')!;
   exitNl.CATEGORIES = [id];
   exitNoNl.CATEGORIES = [id];
   exitNl.LONGER_ALT = [idWithSuffix, id];
   exitNoNl.LONGER_ALT = [idWithSuffix, id];
   ```
   This ensures identifiers like `exitCode!` still parse as ID_WITH_SUFFIX, not as EXIT keyword.

**In `bbj.langium`:**

1. Add two terminal declarations (next to the existing RELEASE terminals, around line 926-927):
   ```
   terminal EXIT_NL: /_exit_nl/;
   terminal EXIT_NO_NL: /_exit_no_nl/;
   ```

2. Update the `ExitWithNumberStatement` rule (line 473-475) from:
   ```
   ExitWithNumberStatement:
       kind='EXIT' | RELEASE_NL | RELEASE_NO_NL exitVal=Expression
   ;
   ```
   to:
   ```
   ExitWithNumberStatement:
       EXIT_NL | EXIT_NO_NL exitVal=Expression | RELEASE_NL | RELEASE_NO_NL exitVal=Expression
   ;
   ```
   Note: `kind='EXIT'` is removed because EXIT_NL replaces the bare EXIT case, and EXIT_NO_NL handles EXIT-with-expression. The `kind` field assignment is removed from the EXIT alternatives since EXIT_NL/EXIT_NO_NL are terminals (not keywords). If the `kind` field is needed downstream, assign it like: `kind=EXIT_NL | kind=EXIT_NO_NL exitVal=Expression`. However, check generated AST first — if ExitWithNumberStatement.kind is used elsewhere, preserve it: use `{infer ExitWithNumberStatement} EXIT_NL` or just make sure downstream code doesn't depend on `kind === 'EXIT'`. Search for `kind` usage on ExitWithNumberStatement in the codebase first.

   Actually, look at the current rule more carefully. The `kind='EXIT'` assigns the string 'EXIT' to the `kind` property. With custom terminals, we need to check if anything reads `node.kind`. Search for `isExitWithNumberStatement` and `.kind` usage. If nothing checks `kind`, the simplest approach is:
   ```
   ExitWithNumberStatement:
       EXIT_NL | EXIT_NO_NL exitVal=Expression | RELEASE_NL | RELEASE_NO_NL exitVal=Expression
   ;
   ```
   If something DOES check `kind`, consider assigning: `kind=EXIT_NL` (though this would set kind to the terminal match text). The `RELEASE_NL` / `RELEASE_NO_NL` alternatives in the current rule also don't assign `kind`, so this is consistent.

3. Run `npm run langium:generate` from `bbj-vscode/` directory to regenerate `generated/ast.ts` and `generated/grammar.ts`.

4. Run `npm run build` from `bbj-vscode/` directory to verify no TypeScript errors.

5. Run `npm test` from `bbj-vscode/` directory to verify all existing tests still pass (no regressions).
  </action>
  <verify>
    `cd bbj-vscode && npm run langium:generate && npm run build && npm test` — all succeed with 0 test failures
  </verify>
  <done>
    EXIT_NL and EXIT_NO_NL tokens defined in token builder with correct regex, spliced into token order, given CATEGORIES=[id] and LONGER_ALT=[idWithSuffix, id]. Grammar rule updated. Build passes. All existing tests pass (no regressions).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add parser tests for EXIT with numeric argument</name>
  <files>
    bbj-vscode/test/parser.test.ts
  </files>
  <action>
Add a new test block to `parser.test.ts` testing GRAM-01 EXIT verb with optional numeric argument.

Import `isExitWithNumberStatement` (already imported — verify in the import line at top of file).

Add test:

```typescript
test('GRAM-01: EXIT with optional numeric argument (#376)', async () => {
    const result = await parse(`
        EXIT 0
        EXIT 1
        EXIT
        EXIT myVar
    `, { validation: true });
    expectNoParserLexerErrors(result);
    expectToContainAstNodeType(result, isExitWithNumberStatement);
});
```

Also add a non-regression test to ensure EXIT-prefixed identifiers (like `exitCode!`) still work:

```typescript
test('EXIT-prefixed identifiers parse without error', async () => {
    const result = await parse(`
        exitCode! = 0
        exitStatus = 1
        exitMode$ = "test"
    `, { validation: true });
    expectNoParserLexerErrors(result);
});
```

Run `npm test` to confirm all tests pass.
  </action>
  <verify>
    `cd bbj-vscode && npm test` — all tests pass including new EXIT tests
  </verify>
  <done>
    `EXIT 0`, `EXIT 1`, bare `EXIT`, and `EXIT myVar` all parse without error. EXIT-prefixed identifiers (`exitCode!`, `exitStatus`) still parse as variables. No regressions.
  </done>
</task>

</tasks>

<verification>
1. `EXIT 0`, `EXIT 1`, and bare `EXIT` parse without parser/lexer errors
2. `EXIT myVar` with a variable reference parses without error
3. EXIT-prefixed identifiers like `exitCode!` still lex as ID_WITH_SUFFIX (not as EXIT keyword + orphan)
4. All existing RELEASE tests still pass (RELEASE verb behavior unchanged)
5. `npm run langium:generate && npm run build && npm test` — all green
</verification>

<success_criteria>
- EXIT verb accepts any numeric expression as optional argument: `EXIT 0`, `EXIT myVar`, `EXIT fn(x)`
- Bare EXIT at end of line still works as standalone statement
- EXIT-prefixed identifiers parse correctly (LONGER_ALT prevents keyword collision)
- All 505+ existing tests pass with no regressions
- New EXIT tests added and passing
</success_criteria>

<output>
After completion, create `.planning/phases/58-grammar-additions/58-01-SUMMARY.md`
</output>
