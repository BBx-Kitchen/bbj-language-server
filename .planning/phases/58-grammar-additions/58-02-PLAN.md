---
phase: 58-grammar-additions
plan: "02"
type: execute
wave: 2
depends_on:
  - "58-01"
files_modified:
  - bbj-vscode/src/language/bbj.langium
  - bbj-vscode/test/parser.test.ts
  - bbj-vscode/src/language/generated/ast.ts
  - bbj-vscode/src/language/generated/grammar.ts
  - .planning/ROADMAP.md
autonomous: true
requirements:
  - GRAM-02
  - GRAM-03

must_haves:
  truths:
    - "A statement using the SERIAL verb parses without error and appears in the AST"
    - "`SERIAL \"myfile.dat\"` with just fileid is valid (all other args optional)"
    - "`SERIAL \"file\",10,80,MODE=\"X\",ERR=label` with full arguments parses without error"
    - "ADDR accepts any string expression (not just string literals) as fileid"
    - "ADDR is recognized as a verb (statement), confirmed in ROADMAP success criteria"
  artifacts:
    - path: "bbj-vscode/src/language/bbj.langium"
      provides: "SerialStatement grammar rule and updated AddrStatement"
      contains: "SerialStatement"
    - path: "bbj-vscode/test/parser.test.ts"
      provides: "Parser tests for SERIAL verb and ADDR with expressions"
      contains: "SERIAL"
    - path: ".planning/ROADMAP.md"
      provides: "Updated Phase 58 success criteria for ADDR (verb, not function)"
      contains: "ADDR verb"
  key_links:
    - from: "bbj-vscode/src/language/bbj.langium"
      to: "bbj-vscode/src/language/generated/ast.ts"
      via: "langium:generate produces AST types from grammar rules"
      pattern: "SerialStatement|isSerialStatement"
---

<objective>
Add the SERIAL verb to the grammar and broaden ADDR's fileid parameter from StringLiteral to Expression, so all three GRAM requirements are complete.

Purpose: Closes GRAM-02 (#375) and GRAM-03 (#377). SERIAL is a completely missing verb. ADDR exists but only accepts string literals — BBj allows string expressions. Also corrects ROADMAP success criteria that incorrectly described ADDR as a function.

Output: Updated grammar rules, regenerated AST, parser tests, updated ROADMAP.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/58-grammar-additions/58-CONTEXT.md
@.planning/phases/58-grammar-additions/58-01-SUMMARY.md

Key patterns:
- IndexedStatement (bbj.langium line 197): `'INDEXED' fileid=Expression ',' records=Expression ',' recsize=Expression Mode? Err?` — similar structure to SERIAL but with required args
- AddrStatement (bbj.langium line 642): `'ADDR' fileid=StringLiteral Err?` — needs Expression instead of StringLiteral
- Existing Mode? and Err? fragments (lines 533-543) reusable for SERIAL
- SingleStatement alternatives list (lines 27-119) — where SerialStatement must be added
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SERIAL verb and broaden ADDR fileid to Expression</name>
  <files>
    bbj-vscode/src/language/bbj.langium
    bbj-vscode/src/language/generated/ast.ts
    bbj-vscode/src/language/generated/grammar.ts
  </files>
  <action>
**GRAM-02 — Add SerialStatement rule in `bbj.langium`:**

1. Add `SerialStatement` to the `SingleStatement` alternatives list. Insert it alphabetically among the 'S' verbs, near `SortStatement` (around line 100):
   ```
   SerialStatement |
   ```

2. Add the `SerialStatement` grammar rule. Place it near `IndexedStatement` (around line 197) since they have similar structure. Use the syntax from CONTEXT.md: `SERIAL fileid{,records,recsize}{,MODE=str}{,ERR=lineref}`:
   ```
   SerialStatement:
       'SERIAL' fileid=Expression (',' records=Expression ',' recsize=Expression)? Mode? Err?
   ;
   ```
   Notes:
   - `records` and `recsize` are grouped together — if one is present, the other must be too (per BBj syntax: they always appear as a pair)
   - `Mode?` and `Err?` fragments already exist in the grammar and handle `,MODE=expr` and `,ERR=lineref` patterns
   - `fileid` is `Expression` not `StringLiteral` to allow string expressions

**GRAM-03 — Broaden ADDR fileid in `bbj.langium`:**

3. Change the `AddrStatement` rule (line 642) from:
   ```
   AddrStatement:
       'ADDR' fileid=StringLiteral Err?
   ;
   ```
   to:
   ```
   AddrStatement:
       'ADDR' fileid=Expression Err?
   ;
   ```
   This allows `ADDR myPath$` and `ADDR getPath$()` in addition to `ADDR "MYPROG"`.

4. Run `npm run langium:generate` from `bbj-vscode/` to regenerate AST and grammar files.

5. Run `npm run build` to verify no TypeScript errors.

6. Run `npm test` to verify all existing tests still pass (including existing ADDR test which uses string literals — still valid since StringLiteral is a subset of Expression).

**Update ROADMAP.md success criteria:**

7. In `.planning/ROADMAP.md`, update Phase 58 success criterion #3 from:
   ```
   3. An expression using the ADDR function parses without error and is usable in assignments and conditions
   ```
   to:
   ```
   3. The ADDR verb parses without error as a standalone statement, accepting any string expression as fileid
   ```
  </action>
  <verify>
    `cd bbj-vscode && npm run langium:generate && npm run build && npm test` — all succeed with 0 test failures. Grep for `SerialStatement` in generated/ast.ts confirms the new AST type exists.
  </verify>
  <done>
    SerialStatement grammar rule added with optional records/recsize, Mode?, and Err? clauses. AddrStatement fileid broadened from StringLiteral to Expression. ROADMAP success criteria corrected for ADDR. Build and all tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add parser tests for SERIAL verb and ADDR with expressions</name>
  <files>
    bbj-vscode/test/parser.test.ts
  </files>
  <action>
Add tests to `parser.test.ts` for GRAM-02 and GRAM-03.

Import `isSerialStatement` from the generated AST (add to the import list at the top of the file alongside existing type guards like `isAddrStatement`).

**GRAM-02 — SERIAL verb tests:**

```typescript
test('GRAM-02: SERIAL verb (#375)', async () => {
    const result = await parse(`
        SERIAL "myfile.dat"
        SERIAL "myfile.dat",10,80
        SERIAL "myfile.dat",10,80,MODE="X"
        SERIAL "myfile.dat",10,80,ERR=ErrorLabel
        SERIAL "myfile.dat",10,80,MODE="X",ERR=ErrorLabel
        SERIAL filePath$
        ErrorLabel: STOP
    `, { validation: true });
    expectNoParserLexerErrors(result);
    expectToContainAstNodeType(result, isSerialStatement);
});
```

**GRAM-03 — ADDR with expression tests:**

Update or add to the existing ADDR test. The existing test (around line 993) already tests string literals. Add a new test for expression forms:

```typescript
test('GRAM-03: ADDR with string expression (#377)', async () => {
    const result = await parse(`
        myPath$ = "MYPROG"
        ADDR myPath$
        ADDR "MYPROG", ERR=ErrorLabel
        ErrorLabel: STOP
    `, { validation: true });
    expectNoParserLexerErrors(result);
    expectToContainAstNodeType(result, isAddrStatement);
});
```

Run `npm test` to confirm all tests pass.
  </action>
  <verify>
    `cd bbj-vscode && npm test` — all tests pass including new SERIAL and ADDR tests
  </verify>
  <done>
    SERIAL verb parses with fileid-only, full arguments, MODE, ERR, and combinations. ADDR accepts variable references as fileid. All new tests pass, no regressions.
  </done>
</task>

</tasks>

<verification>
1. `SERIAL "myfile.dat"` (fileid only) parses without error
2. `SERIAL "myfile.dat",10,80` (with records and recsize) parses without error
3. `SERIAL "myfile.dat",10,80,MODE="X",ERR=label` (full form) parses without error
4. `ADDR myPath$` (string expression, not literal) parses without error
5. Existing ADDR tests with string literals still pass
6. ROADMAP success criteria updated for ADDR (verb, not function)
7. `npm run langium:generate && npm run build && npm test` — all green
</verification>

<success_criteria>
- SERIAL verb recognized by parser in all valid forms (fileid-only, with records/recsize, with MODE/ERR clauses)
- ADDR accepts any string expression as fileid (not limited to string literals)
- ROADMAP.md Phase 58 success criterion #3 corrected (ADDR is a verb, not a function)
- All 505+ existing tests pass with no regressions
- New SERIAL and ADDR tests added and passing
</success_criteria>

<output>
After completion, create `.planning/phases/58-grammar-additions/58-02-SUMMARY.md`
</output>
