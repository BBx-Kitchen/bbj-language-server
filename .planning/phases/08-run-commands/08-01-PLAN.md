---
phase: 08-run-commands
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunGuiAction.java
  - bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
  - bbj-intellij/src/main/resources/META-INF/plugin.xml
autonomous: true

must_haves:
  truths:
    - "Right-clicking a .bbj file shows 'Run As BBj Program' in the editor context menu and clicking it spawns the bbj executable"
    - "Run GUI action auto-saves the active file before launching"
    - "Run GUI action is disabled when the active file is not a BBj file type"
    - "Missing or invalid BBj home shows a notification balloon instead of silently failing"
    - "Successful launch shows a status bar message like 'Launched MyProgram.bbj (GUI)'"
  artifacts:
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java"
      provides: "Shared base class for all three run actions with settings access, auto-save, error handling, file validation"
    - path: "bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunGuiAction.java"
      provides: "GUI run action that spawns bbj executable with -q flag, classpath, working directory, and file path"
    - path: "bbj-intellij/src/main/resources/META-INF/plugin.xml"
      provides: "Action registration for bbj.runGui with EditorPopupMenu placement and notification group"
  key_links:
    - from: "BbjRunActionBase.java"
      to: "BbjSettings.getInstance()"
      via: "reads bbjHomePath and classpathEntry from application settings"
      pattern: "BbjSettings\\.getInstance\\(\\)"
    - from: "BbjRunGuiAction.java"
      to: "BbjRunActionBase.java"
      via: "extends base class, calls buildGuiCommand()"
      pattern: "extends BbjRunActionBase"
    - from: "plugin.xml"
      to: "BbjRunGuiAction"
      via: "action registration with class attribute"
      pattern: "class=\"com\\.basis\\.bbj\\.intellij\\.actions\\.BbjRunGuiAction\""
---

<objective>
Implement the GUI run action and shared run action base class. Users can right-click a BBj file and select "Run As BBj Program" to spawn the bbj executable with the current file. The action reads BBj home and classpath from settings, auto-saves the file, and shows error/success notifications.

Purpose: Establishes the run action infrastructure (base class, settings integration, error handling) that BUI/DWC actions in Plan 02 will extend.
Output: BbjRunActionBase.java, BbjRunGuiAction.java, updated plugin.xml with action registration, updated BbjSettings with auto-save setting.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-brand-icons/07-01-SUMMARY.md
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjIcons.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjFileType.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbxConfigFileType.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjHomeDetector.java
@bbj-intellij/src/main/java/com/basis/bbj/intellij/ui/BbjRestartServerAction.java
@bbj-intellij/src/main/resources/META-INF/plugin.xml
@bbj-intellij/build.gradle.kts
@bbj-vscode/src/Commands/Commands.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BbjRunActionBase and BbjRunGuiAction with settings integration</name>
  <files>
    bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/actions/BbjRunGuiAction.java
    bbj-intellij/src/main/java/com/basis/bbj/intellij/BbjSettings.java
  </files>
  <action>
Create a new `actions` package under `com.basis.bbj.intellij.actions`.

**BbjRunActionBase.java** — Abstract base class extending `AnAction`:
- Constructor takes `text`, `description`, `icon` and passes to `super(text, description, icon)`.
- `update()` method: Enable/visible only when active file has extension `.bbj`, `.bbl`, `.bbjt`, `.src`, or `.bbx`. Check via `e.getData(CommonDataKeys.VIRTUAL_FILE)` and extension comparison (same pattern as BbjRestartServerAction). Also check `e.getProject() != null`.
- Protected helper `getBbjExecutablePath()`: Reads `BbjSettings.getInstance().getState().bbjHomePath`, appends `/bin/bbj` (or `/bin/bbj.exe` on Windows via `SystemInfo.isWindows`). Returns `null` if bbjHomePath is empty or the executable file doesn't exist.
- Protected helper `getClasspathArg()`: Reads `BbjSettings.getInstance().getState().classpathEntry`. Returns `"-CP" + entry` if non-empty, otherwise `null`. Note: BBj expects `-CPvalue` concatenated (no space).
- Protected helper `autoSaveIfNeeded()`: Reads `BbjSettings.getInstance().getState().autoSaveBeforeRun`. If true, calls `FileDocumentManager.getInstance().saveAllDocuments()`. Call this BEFORE building the command.
- Protected helper `showError(Project project, String message)`: Shows a sticky notification balloon via `NotificationGroupManager.getInstance().getNotificationGroup("BBj Language Server").createNotification(message, NotificationType.ERROR).notify(project)`. Reuse the existing "BBj Language Server" notification group already registered in plugin.xml.
- Protected helper `showSuccess(Project project, String fileName, String mode)`: Shows a status bar info message via `NotificationGroupManager.getInstance().getNotificationGroup("BBj Language Server").createNotification("Launched " + fileName + " (" + mode + ")", NotificationType.INFORMATION).setExpired(true).notify(project)`. The `.setExpired(true)` prevents it from staying in the Event Log permanently — it shows briefly as a balloon then fades.
- Protected abstract method `buildCommandLine(VirtualFile file, Project project)` returning `GeneralCommandLine` or null.
- `actionPerformed()` implementation:
  1. Get project and file from event (return if null).
  2. Call `autoSaveIfNeeded()`.
  3. Call `buildCommandLine(file, project)` — if null, return (error already shown by subclass).
  4. Try: Create `OSProcessHandler(cmd)`, call `handler.startNotify()`. Show success message.
  5. Catch `ExecutionException`: Call `showError(project, "Failed to launch: " + ex.getMessage())`.

**BbjRunGuiAction.java** — Extends BbjRunActionBase:
- Constructor: `super("Run As BBj Program", "Run current BBj file as GUI program", BbjIcons.RUN_GUI)`.
- Override `buildCommandLine()`:
  1. Get bbj executable path via `getBbjExecutablePath()`. If null, show error "BBj home is not configured or bbj executable not found" and return null.
  2. Create `GeneralCommandLine` with the bbj path.
  3. Add `-q` parameter (quiet mode — required, matches VSCode).
  4. Get classpath arg; if non-null, add as parameter.
  5. Add `-WD` + project.getBasePath() as parameter (working directory — per phase context: "Working directory for all run commands: IntelliJ project root"). Note: VSCode uses `path.dirname(fileName)` but phase decision says project root.
  6. Add `file.getPath()` as the file parameter.
  7. Set `cmd.setWorkDirectory(project.getBasePath())`.
  8. Return cmd.

  The resulting command matches the VSCode pattern: `"bbj" -q "-CPclasspath" -WD"/project/root" "/path/to/file.bbj"`

**BbjSettings.java** — Add one field to the State class:
- Add `public boolean autoSaveBeforeRun = true;` to the `State` inner class. Default true per success criteria ("Active file is auto-saved before run execution").

Do NOT use `getActionUpdateThread()` override — the default `ActionUpdateThread.BGT` (background thread) is correct for update() since we only check file extension (cheap operation). However, if the IntelliJ Platform version requires it explicitly, add: `@Override public ActionUpdateThread getActionUpdateThread() { return ActionUpdateThread.BGT; }` in BbjRunActionBase.
  </action>
  <verify>
Run `cd /Users/beff/_workspace/bbj-language-server/bbj-intellij && ./gradlew compileJava` — must compile without errors. Verify files exist:
- `src/main/java/com/basis/bbj/intellij/actions/BbjRunActionBase.java`
- `src/main/java/com/basis/bbj/intellij/actions/BbjRunGuiAction.java`
- BbjSettings.State now has `autoSaveBeforeRun` field.
  </verify>
  <done>BbjRunGuiAction exists, extends BbjRunActionBase, builds a GeneralCommandLine matching the VSCode `Commands.run` pattern, handles auto-save, BBj home validation, classpath, and error notifications. Compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Register GUI run action in plugin.xml with context menu placement</name>
  <files>
    bbj-intellij/src/main/resources/META-INF/plugin.xml
  </files>
  <action>
Add the GUI run action registration to the existing `<actions>` block in plugin.xml. Place it AFTER the existing `bbj.restartLanguageServer` action.

Add this action:
```xml
<action id="bbj.runGui"
        class="com.basis.bbj.intellij.actions.BbjRunGuiAction"
        text="Run As BBj Program"
        description="Run current BBj file as GUI program"
        icon="com.basis.bbj.intellij.BbjIcons.RUN_GUI">
    <add-to-group group-id="EditorPopupMenu" anchor="first"/>
</action>
```

Note: Do NOT add keyboard shortcut or toolbar button yet — those are wired in Plan 08-02 along with BUI/DWC to ensure all three actions are registered together in a consistent action group. The EditorPopupMenu placement alone satisfies RUN-01 (menu action) for this plan.

Do NOT add the `<keyboard-shortcut>` element here. Plan 02 will add all three shortcuts together.
  </action>
  <verify>
Run `cd /Users/beff/_workspace/bbj-language-server/bbj-intellij && ./gradlew buildPlugin` — must build without errors. Verify plugin.xml contains the `bbj.runGui` action with `EditorPopupMenu` group.
  </verify>
  <done>plugin.xml has bbj.runGui action registered with EditorPopupMenu placement. Full plugin builds cleanly. GUI run action is accessible via right-click context menu on BBj files.</done>
</task>

</tasks>

<verification>
1. `./gradlew buildPlugin` succeeds without errors
2. BbjRunActionBase has: update() with file type check, getBbjExecutablePath(), getClasspathArg(), autoSaveIfNeeded(), showError(), showSuccess(), buildCommandLine() abstract method, actionPerformed() orchestrating all steps
3. BbjRunGuiAction builds command: `bbj -q [-CPclasspath] -WD<project_root> <file_path>` matching VSCode pattern
4. BbjSettings.State has `autoSaveBeforeRun = true` default
5. plugin.xml has bbj.runGui action in EditorPopupMenu
6. Error path: empty bbjHomePath shows notification balloon
</verification>

<success_criteria>
- BbjRunGuiAction is registered and would appear in editor context menu for BBj files
- The action builds a command line matching VSCode's `Commands.run` behavior: `bbj -q -CPclasspath -WD<dir> <file>`
- Auto-save calls `FileDocumentManager.saveAllDocuments()` before launch when enabled
- Missing BBj home triggers error notification via existing "BBj Language Server" notification group
- Successful launch triggers a brief info notification "Launched <filename> (GUI)"
- `./gradlew buildPlugin` passes
</success_criteria>

<output>
After completion, create `.planning/phases/08-run-commands/08-01-SUMMARY.md`
</output>
